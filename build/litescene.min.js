function BinaryPack(){this.nextChunkPos=0;this.dataArray=null;this.chunks={}}BinaryPack.HEADER_STRING="JBIN";BinaryPack.CHUNK_CODE_SIZE=16;
BinaryPack.CODES={Int8Array:{code:"I1",bytes:1},Uint8Array:{code:"i1",bytes:1},Int16Array:{code:"I2",bytes:2},Uint16Array:{code:"i2",bytes:2},Int32Array:{code:"I4",bytes:4},Uint32Array:{code:"i4",bytes:4},Float32Array:{code:"F4",bytes:4},Float64Array:{code:"F8",bytes:8},Object:{code:"OB",bytes:1},string:{code:"ST",bytes:1},number:{code:"NU",bytes:1},BinaryPack:{code:"BP",bytes:1}};
BinaryPack.prototype={reserve:function(a){this.dataArray=new Uint8Array(a||1048576);this.nextChunkPos=0},load:function(a){this.dataArray=new Uint8Array(a);this.nextChunkPos=0;this.chunks={};a={};for(var b=this.dataArray.subarray(0,4),c=!0,d=0;d<b.length;d++)if(0!=b[d]&&b[d]!=BinaryPack.HEADER_STRING.charCodeAt(d)){trace("Warning: deprecated bin format, please upgrade mesh");c=!1;break}c&&(this.nextChunkPos=4);b={};for(d in BinaryPack.CODES)b[BinaryPack.CODES[d].code]=d;for(;;){var e=this.getChunk();
if(null==e)break;this.chunks[e.code]=e;c=e.code.substring(0,2);d=e.code.substring(2,BinaryPack.CHUNK_CODE_SIZE-2);e=e.data;c=b[c];"string"==c?e=BinaryPack.typedArrayToString(e):"number"==c?e=parseFloat(BinaryPack.typedArrayToString(e)):"Object"==c?e=JSON.parse(BinaryPack.typedArrayToString(e)):"BinaryPack"==c?(e=new Uint8Array(e),e=(new BinaryPack).load(e)):(e=new Uint8Array(e),e=new window[c](e.buffer));a[d]=e}return a},save:function(a){var b=[],c=BinaryPack.HEADER_STRING.length,d;for(d in a){var e=
a[d],f=BinaryPack.getClassName(e),h=BinaryPack.CODES[f];if(null!=h){var g=h.code+d.substring(0,BinaryPack.CHUNK_CODE_SIZE-2);"number"==f?e=e.toString():"Object"==f?e=JSON.stringify(e):"BinaryPack"==f&&(e=e.getData());b.push({code:g,data:e});c+=e.length*h.bytes+BinaryPack.CHUNK_CODE_SIZE+4}}this.reserve(c);a=BinaryPack.stringToTypedArray(BinaryPack.HEADER_STRING);this._addArrayData(a);for(var k in b)a=b[k],this.addChunk(a.code,a.data);this.finalize();return this.getData()},getData:function(){return this.dataArray},
addChunk:function(a,b){if(null==this.dataArray)throw"BinaryPack needs to reserve space before adding data";"string"==typeof b&&(b=BinaryPack.stringToTypedArray(b));var c=BinaryPack.stringToTypedArray(a,BinaryPack.CHUNK_CODE_SIZE);this.dataArray.set(c,this.nextChunkPos);this.nextChunkPos+=c.length;c=new Uint32Array([b.byteLength]);c=new Uint8Array(c.buffer);this.dataArray.set(c,this.nextChunkPos);this.nextChunkPos+=c.length;this._addArrayData(b.buffer)},_addArrayData:function(a){a=new Uint8Array(a);
this.dataArray.set(a,this.nextChunkPos);this.nextChunkPos+=a.length},getChunk:function(){if(null==this.dataArray)throw"BinaryPack is empty, no data assigned";if(this.nextChunkPos==this.dataArray.length)return null;var a=BinaryPack.typedArrayToString(this.dataArray.subarray(this.nextChunkPos,this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE));if(""==a)return null;var b=this.getUint32(this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE);if(0==b)return null;var c=this.dataArray.subarray(this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE+
4,this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE+4+b);this.nextChunkPos=this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE+4+b;return""==a||0==b?null:{code:a,length:b,data:c}},finalize:function(){if(0!=this.nextChunkPos&&this.nextChunkPos!=this.dataArray.length){var a=new Uint8Array(this.nextChunkPos);a.set(this.dataArray.subarray(0,a.length),0);this.dataArray=a}},getUint32:function(a){var b=new Uint32Array(1);(new Uint8Array(b.buffer)).set(this.dataArray.subarray(a,a+4),0);return b[0]}};
BinaryPack.stringToTypedArray=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c};BinaryPack.typedArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};BinaryPack.getClassName=function(a){return"object"!=typeof a?null===a?!1:typeof a:/(\w+)\(/.exec(a.constructor.toString())[1]};
BinaryPack.linearizeArray=function(a,b){b=b||Float32Array;for(var c=a[0].length,d=null,d=new b(a.length*c),e=0;e<a.length;++e)for(var f=0;f<c;++f)d[e*c+f]=a[e][f];return d};
BinaryPack.encode64Array=function(a){var b="",c,d,e="",f,h,g="",k=0;a.constructor==ArrayBuffer&&(a=new Uint8Array(a));if(void 0==a.length)throw"binaryPacker: this input is not an array";var m=a.length;do c=a[k++],d=a[k++],e=a[k++],f=c>>2,c=(c&3)<<4|d>>4,h=(d&15)<<2|e>>6,g=e&63,isNaN(d)?h=g=64:isNaN(e)&&(g=64),b=b+keyStr[f]+keyStr[c]+keyStr[h]+keyStr[g];while(k<m);return b};
BinaryPack.decode64ToArray=function(a){var b=new Uint8Array(a.length),c,d,e="",f,h="",g=0;if(/[^A-Za-z0-9\+\/\=]/g.exec(a))throw"There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.";a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");var k=0;do c=keyStr.indexOf(a.charAt(g++)),d=keyStr.indexOf(a.charAt(g++)),f=keyStr.indexOf(a.charAt(g++)),h=keyStr.indexOf(a.charAt(g++)),c=c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|h,b[k++]=
c,64!=f&&(b[k++]=d),64!=h&&(b[k++]=e);while(g<a.length);return new Uint8Array(b.subarray(0,k))};function ByteStruct(){this.fields=[]}function WBin(){}WBin.FOUR_CC="WBIN";WBin.VERSION=0.1;WBin.CLASSNAME_SIZE=32;WBin.CHUNKNAME_SIZE=14;WBin.CODES={Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",Int32Array:"I4",Uint32Array:"i4",Float32Array:"F4",Float64Array:"F8",Object:"OB",string:"ST",number:"NU",WBin:"WB"};WBin.REVERSE_CODES={};
for(var i in WBin.CODES)WBin.REVERSE_CODES[WBin.CODES[i]]=i;
WBin.load=function(a){a=new Uint8Array(a);for(var b=a.subarray(0,4),c=0;c<b.length;c++)if(0!=b[c]&&b[c]!=WBin.FOUR_CC.charCodeAt(c))return console.err("WBin header is wrong"),null;(new Float32Array(a.subarray(4,8).buffer))[0]>WBin.VERSION&&console.log("ALERT: WBin version is higher that code version");b=WBin.Uint8ArrayToString(a.subarray(8,8+WBin.CLASSNAME_SIZE));a=a.subarray(8+WBin.CLASSNAME_SIZE);if(b&&(b=window[b])&&b.prototype.fromBinary)return b=new b,b.fromBinary(a),b;b={};for(c=0;c!=a.length;){var d=
WBin.Uint8ArrayToString(a.subarray(c,c+WBin.CHUNKNAME_SIZE+2));if(""==d)break;var e=WBin.readUint32(a,c+WBin.CHUNKNAME_SIZE+2);if(0==e)break;var c=c+(WBin.CHUNKNAME_SIZE+2+4),f=a.subarray(c,c+e),c=c+e;if(""==d||0==e)return null;f={code:d,length:e,data:f};chunks[f.code]=f;e=f.code.substring(0,2);d=f.code.substring(2,WBin.CHUNKNAME_SIZE);f=f.data;e=WBin.REVERSE_CODE[e];switch(e){case "string":f=WBin.Uint8ArrayToString(f);break;case "number":f=parseFloat(WBin.Uint8ArrayToString(f));break;case "Object":f=
JSON.parse(WBin.Uint8ArrayToString(f));break;default:f=new Uint8Array(f),f=new window[e](f.buffer)}b[d]=f}return b};
WBin.create=function(a){if(!a)throw"WBin null object passed";if(a.toBinary){var b=a.toBinary(),c=WBin.getObjectClassName(a),d=new Uint8Array(8+WBin.CLASSNAME_SIZE+b.length);d.set(WBin.stringToUint8Array(WBin.FOUR_CC));d.set((new Float32Array([WBin.VERSION])).buffer,4);d.set(WBin.stringToUint8Array(c,WBin.CLASSNAME_SIZE),8);d.set(b,8+WBin.CLASSNAME_SIZE);return d}var e=8+WBin.CLASSNAME_SIZE,b=[],f;for(f in a)if(d=a[f],null!=d){var c=WBin.getClassName(d),h=WBin.CHUNK_CODES[c];if(null!=h){var h=h+f.substring(0,
WBin.CHUNKNAME_SIZE),g=1;d.BYTES_PER_ELEMENT&&(g=d.BYTES_PER_ELEMENT);"number"==c?d=d.toString():"Object"==c&&(d=JSON.stringify(d));b.push({code:h,data:d});e+=6+BinaryPack.CHUNKNAME_SIZE+d.length*g}}d=new Uint8Array(e);d.set(WBin.stringToUint8Array(WBin.FOUR_CC));d.set((new Float32Array([WBin.VERSION])).buffer,4);a=8+WBin.CLASSNAME_SIZE;for(var k in b)e=b[k],c=e.data,"string"==typeof c&&(c=WBin.stringToUint8Array(c)),e=WBin.stringToUint8Array(e.code,WBin.CHUNKNAME_SIZE+2),d.set(e,a),a+=e.length,e=
new Uint32Array([c.byteLength]),e=new Uint8Array(e.buffer),d.set(e,a),a+=e.length,c=new Uint8Array(c.buffer),d.set(c,a),this.nextChunkPos+=c.length;return d};WBin.getObjectClassName=function(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]};WBin.stringToUint8Array=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c};
WBin.Uint8ArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};WBin.readUint32=function(a,b){var c=new Uint32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4),0);return c[0]};
var Draw={ready:!1,images:{},onRequestFrame:null,init:function(){!this.ready&&gl&&(this.color=new Float32Array(4),this.color[3]=1,this.mvp_matrix=mat4.create(),this.camera_position=vec3.create(),this.temp_matrix=mat4.create(),this.point_size=2,this.stack=new Float32Array(512),this.model_matrix=new Float32Array(this.stack.buffer,0,64),mat4.identity(this.model_matrix),this.viewprojection_matrix=mat4.create(),this.camera_stack=[],this.shader=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\t\t\t  gl_FragColor = u_color;\n\t\t\t}\t\t"),this.shader_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\t\t\t  gl_FragColor = u_color * v_color;\n\t\t\t}\t\t"),
this.shader_texture=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, v_coord);\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t"),
this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]}),this.ready=!0)},setColor:function(a){for(var b=0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=a},setLineWidth:function(a){gl.lineWidth(a)},setPointSize:function(a){this.point_size=a},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},setViewProjectionMatrix:function(a){mat4.copy(this.viewprojection_matrix,a)},setMatrix:function(a){mat4.copy(this.model_matrix,
a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b){if(a&&a.length){var c=null,c=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=c.length/3&&(b=null);c=GL.Mesh.load({vertices:c,colors:b});return this.renderMesh(c,gl.LINES,b?this.shader_color:this.shader)}},renderPoints:function(a,b){if(a&&a.length){var c=null,c=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==
Float32Array?b:this.linearize(b));c=GL.Mesh.load({vertices:c,colors:b});return this.renderMesh(c,gl.POINTS,b?this.shader_color:this.shader)}},renderRectangle:function(a,b,c){var d=new Float32Array(12);c?d.set([0.5*-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):d.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);a=GL.Mesh.load({vertices:d});return this.renderMesh(a,gl.LINE_LOOP)},renderCircle:function(a,b,c){var d=[0,1,0];b=b||100;for(var e=quat.create(),f=vec3.create(),
h=new Float32Array(3*b),g=0;g<b;g++)quat.setAxisAngle(e,d,2*Math.PI*(g/b)),vec3.transformQuat(f,[0,0,a],e),c||vec3.set(f,f[0],f[2],f[1]),h.set(f,3*g);a=GL.Mesh.load({vertices:h});return this.renderMesh(a,gl.LINE_LOOP)},renderWireSphere:function(a,b){var c=[0,1,0];b=b||100;for(var d=quat.create(),e=vec3.create(),f=new Float32Array(9*b),h=0;h<b;h++)quat.setAxisAngle(d,c,2*Math.PI*(h/b)),vec3.transformQuat(e,[0,0,a],d),f.set(e,3*h),f.set([e[0],e[2],e[1]],3*h+3*b),f.set([e[1],e[0],e[2]],3*h+6*b);c=GL.Mesh.load({vertices:f});
return this.renderMesh(c,gl.LINES)},renderWireBox:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=new Float32Array([-a,b,c,-a,b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);a=GL.Mesh.load({vertices:a,lines:b});return this.renderMesh(a,gl.LINES)},renderSolidBox:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=GL.Mesh.load({vertices:[[-a,b,-c],[-a,-b,+c],[-a,b,c],[-a,b,-c],[-a,-b,-c],[-a,-b,+c],[a,b,-c],[a,b,c],[a,-b,+c],[a,b,-c],[a,-b,+c],[a,-b,
-c],[-a,b,c],[a,-b,c],[a,b,c],[-a,b,c],[-a,-b,c],[a,-b,c],[-a,b,-c],[a,b,-c],[a,-b,-c],[-a,b,-c],[a,-b,-c],[-a,-b,-c],[-a,b,-c],[a,b,c],[a,b,-c],[-a,b,-c],[-a,b,c],[a,b,c],[-a,-b,-c],[a,-b,-c],[a,-b,c],[-a,-b,-c],[a,-b,c],[-a,-b,c]]});return this.renderMesh(a,gl.TRIANGLES)},renderGrid:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),d=0,e=-b;e<=b;e++)c.set([e*a,0,a*b],d),c.set([e*a,0,-a*b],d+3),c.set([a*b,0,e*a],d+6),c.set([-a*b,0,e*a],d+9),d+=12;c=GL.Mesh.load({vertices:c});return this.renderMesh(c,
gl.LINES)},renderCone:function(a,b,c,d){var e=[0,1,0];c=c||100;var f=quat.create(),h=vec3.create(),g=new Float32Array(3*(c+2));g.set(d?[0,0,b]:[0,b,0],0);for(b=0;b<=c;b++)quat.setAxisAngle(f,e,2*Math.PI*(b/c)),vec3.transformQuat(h,[0,0,a],f),d&&vec3.set(h,h[0],h[2],h[1]),g.set(h,3*b+3);a=GL.Mesh.load({vertices:g});return this.renderMesh(a,gl.TRIANGLE_FAN)},renderCylinder:function(a,b,c,d){d=[0,1,0];c=c||100;for(var e=quat.create(),f=vec3.create(),h=new Float32Array(6*(c+1)),g=0;g<=c;g++)quat.setAxisAngle(e,
d,2*Math.PI*(g/c)),vec3.transformQuat(f,[0,0,a],e),h.set(f,6*g+3),f[1]=b,h.set(f,6*g);a=GL.Mesh.load({vertices:h});return this.renderMesh(a,gl.TRIANGLE_STRIP)},renderImage:function(a,b,c){c=c||10;var d=null;if("string"==typeof b){d=this.images[b];if(null==d){Draw.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);Draw.images[b]=a;if(Draw.onRequestFrame)Draw.onRequestFrame()};return}if(1==d)return}this.push();this.lookAt(a,this.camera_position,[0,1,0]);this.scale(c,
c,c);d.bind(0);this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture);this.pop()},renderMesh:function(a,b,c){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";c=c||this.shader;mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,this.model_matrix);c.uniforms({u_mvp:this.mvp_matrix,u_color:this.color,u_point_size:this.point_size,u_texture:0}).draw(a,void 0==b?gl.LINES:b);return this.last_mesh=a},renderText:function(a){Draw.text_atlas||this.createTextAtlas();for(var b=
this.text_atlas,c=a.length,d=b.atlas.char_size,e=b.atlas.spacing,f=0,h=0;h<c;++h)null!=b.atlas[a.charCodeAt(h)]&&f++;for(var g=new Float32Array(18*f),f=new Float32Array(12*f),k=0,m=0,h=y=0;h<c;++h){var n=b.atlas[a.charCodeAt(h)];n?(g.set([m,y,0],18*k),g.set([m,y+d,0],18*k+3),g.set([m+d,y+d,0],18*k+6),g.set([m+d,y,0],18*k+9),g.set([m,y,0],18*k+12),g.set([m+d,y+d,0],18*k+15),f.set([n[0],n[1]],12*k),f.set([n[0],n[3]],12*k+2),f.set([n[2],n[3]],12*k+4),f.set([n[2],n[1]],12*k+6),f.set([n[0],n[1]],12*k+
8),f.set([n[2],n[3]],12*k+10),m+=e,++k):10==a.charCodeAt(h)?(m=0,y-=d):m+=d}a=GL.Mesh.load({vertices:g,coords:f});b.bind(0);return this.renderMesh(a,gl.TRIANGLES,this.shader_texture)},createTextAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,d=a.getContext("2d");d.fillStyle="white";d.font=b+"px Courier New";d.textAlign="center";for(var e=0,f=0,b=-0.3*b,h={char_size:c,spacing:0.6*c},g=6;100>g;g++){var k=String.fromCharCode(g+27);h[g+27]=[e/a.width,1-(f+c)/a.height,(e+
c)/a.width,1-f/a.height];d.fillText(k,Math.floor(e+0.5*c),Math.floor(f+c+b),c);e+=c;e+c>a.width&&(e=0,f+=c)}this.text_atlas=GL.Texture.fromImage(a,{magFilter:gl.NEAREST,minFilter:gl.LINEAR});this.text_atlas.atlas=h},linearize:function(a){for(var b=a[0].length,c=new Float32Array(a.length*b),d=a.length,e=0;e<d;++e)c.set(a[e],e*b);return c},push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-64)throw"matrices stack overflow";var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,
this.model_matrix.byteOffset+64,64);mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-64,64)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},popCamera:function(){if(0==this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},identity:function(){mat4.identity(this.model_matrix)},scale:function(a,
b,c){3==arguments.length?mat4.scale(this.model_matrix,this.model_matrix,[a,b,c]):mat4.scale(this.model_matrix,this.model_matrix,a)},translate:function(a,b,c){3==arguments.length?mat4.translate(this.model_matrix,this.model_matrix,[a,b,c]):mat4.translate(this.model_matrix,this.model_matrix,a)},rotate:function(a,b,c,d){4==arguments.length?mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,d]):mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,
a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},project:function(a,b){b=b||vec3.create();return mat4.multiplyVec3(b,this.mvp_matrix,a)}};function HitTest(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c}HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};function Octree(a){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())}
Octree.prototype={MAX_OCTREE_TRIANGLES:500,MAX_OCTREE_DEPTH:8,OCTREE_MARGIN:10,buildFromMesh:function(a){this.total_nodes=this.total_depth=0;var b=a.vertices;a=a.triangles;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;c.min=[c.min[0]-this.OCTREE_MARGIN,c.min[1]-this.OCTREE_MARGIN,c.min[2]-this.OCTREE_MARGIN];c.max=[c.max[0]+0.9*this.OCTREE_MARGIN,c.max[1]+0.9*this.OCTREE_MARGIN,c.max[2]+0.9*this.OCTREE_MARGIN];c.faces=[];c.inside=0;if(a)for(var d=0;d<a.length;d+=3){var e=new Float32Array([b[3*
a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(e,c,0)}else for(d=0;d<b.length;d+=9)e=new Float32Array(b.subarray(d,d+9)),this.addToNode(e,c,0);return c},addToNode:function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),e=!1,f;for(f in b.c){var h=b.c[f];if(this.isInsideAABB(d,h)){this.addToNode(a,h,c+1);e=!0;break}}e||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),
b.faces.length>this.MAX_OCTREE_TRIANGLES&&c<this.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var g=b.faces.concat();b.faces=null;for(f in g){a=g[f];var d=this.computeAABB(a),e=!1,k;for(k in b.c)if(h=b.c[k],this.isInsideAABB(d,h)){this.addToNode(a,h,c+1);e=!0;break}e||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}},octree_pos_ref:[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],splitNode:function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-
a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],e={};this.total_nodes+=1;e.min=[a.min[0]+b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];e.max=[e.min[0]+b[0],e.min[1]+b[1],e.min[2]+b[2]];e.faces=null;e.inside=0;a.c.push(e)}},isInsideAABB:function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0},computeAABB:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],a[1],a[2]],d=0;d<
a.length;d+=3)for(var e=0;3>e;e++)b[e]>a[d+e]&&(b[e]=a[d+e]),c[e]<a[d+e]&&(c[e]=a[d+e]);return{min:b,max:c}},trim:function(a){a=a||this.root;if(!a.c)return 1;var b=1,c=[],d;for(d in a.c)a.c[d].inside&&(c.push(a.c[d]),b+=this.trim(a.c[d]));a.c=c;return b},hitTestBox:function(a,b,c,d){var e=vec3.subtract(vec3.create(),c,a),f=vec3.subtract(vec3.create(),d,a);if(0>vec3.maxValue(e)&&0<vec3.minValue(f))return new HitTest(0,a,b);vec3.multiply(e,e,[1/b[0],1/b[1],1/b[2]]);vec3.multiply(f,f,[1/b[0],1/b[1],
1/b[2]]);var h=vec3.min(vec3.create(),e,f),e=vec3.max(vec3.create(),e,f),h=vec3.maxValue(h),e=vec3.minValue(e);return 0<h&&h<e?(a=vec3.add(vec3.create(),vec3.scale(vec3.create(),b,h),a),vec3.add(c,c,[1E-6,1E-6,1E-6]),vec3.subtract(c,c,[1E-6,1E-6,1E-6]),new HitTest(h,a,vec3.create([(a[0]>d[0])-(a[0]<c[0]),(a[1]>d[1])-(a[1]<c[1]),(a[2]>d[2])-(a[2]<c[2])]))):null},tested_boxes:0,tested_triangles:0,testRay:function(a,b,c,d){a=vec3.clone(a);b=vec3.clone(b);Octree.prototype.tested_boxes=0;Octree.prototype.tested_triangles=
0;if(!this.root)throw"Error: octree not build";window.hitTestBox=this.hitTestBox;window.hitTestTriangle=this.hitTestTriangle;window.testRayInNode=Octree.prototype.testRayInNode;c=hitTestBox(a,b,vec3.clone(this.root.min),vec3.clone(this.root.max));if(!c)return null;c=testRayInNode(this.root,a,b);if(null!=c)return b=vec3.scale(vec3.create(),b,c.t),vec3.add(b,b,a),c.pos=b,c;delete window.hitTestBox;delete window.hitTestTriangle;delete window.testRayInNode;return null},testRayInNode:function(a,b,c){var d=
null,e=null;Octree.prototype.tested_boxes+=1;if(a.faces)for(var f in a.faces)d=a.faces[f],Octree.prototype.tested_triangles+=1,d=hitTestTriangle(b,c,vec3.fromValues(d[0],d[1],d[2]),vec3.fromValues(d[3],d[4],d[5]),vec3.fromValues(d[6],d[7],d[8])),null!=d&&(e?e.mergeWith(d):e=d);var h;if(a.c)for(f in a.c)h=a.c[f],d=hitTestBox(b,c,vec3.clone(h.min),vec3.clone(h.max)),null==d||e&&d.t>e.t||(d=testRayInNode(h,b,c),null!=d&&(e?e.mergeWith(d):e=d));return e},hitTestTriangle:function(a,b,c,d,e){var f=vec3.subtract(vec3.create(),
d,c),h=vec3.subtract(vec3.create(),e,c);e=vec3.cross(vec3.create(),f,h);vec3.normalize(e,e);if(!(0<vec3.dot(e,b))){d=vec3.dot(e,vec3.subtract(vec3.create(),c,a))/vec3.dot(e,b);if(0<d){b=vec3.scale(vec3.create(),b,d);vec3.add(b,b,a);var g=vec3.subtract(vec3.create(),b,c);a=vec3.dot(h,h);c=vec3.dot(h,f);var h=vec3.dot(h,g),k=vec3.dot(f,f),f=vec3.dot(f,g),g=a*k-c*c,k=(k*h-c*f)/g,f=(a*f-c*h)/g;if(0<=k&&0<=f&&1>=k+f)return new HitTest(d,b,e)}return null}}};
var Shaders={shaders:{},globals:{},default_shader:null,init:function(a,b){this.shaders={};this.globals={};this.default_shader=null;this.global_extra_code=String.fromCharCode(10)+"#define WEBGL"+String.fromCharCode(10);this.createDefaultShaders();this.default_shader=this.get("flat");this.last_shaders_url=a=a||"data/shaders.xml";this.loadFromXML(a,!1,b)},reloadShaders:function(a){this.loadFromXML(this.last_shaders_url,!0,!0,a)},get:function(a,b){if(!a)return null;if(!b){var c=this.shaders[a];if(null!=
c)return c}var d=this.globals[a];if(null==d)return this.default_shader;var e=a,c="";if(0!=d.num_macros&&b){var e=e+":",f;for(f in b)d.macros[f]&&(e+=f+"="+b[f]+":",c+=String.fromCharCode(10)+"#define "+f+" "+b[f]+String.fromCharCode(10))}if(null!=this.shaders[e])return this.shaders[e];if(c=this.compileShader(c+d.vs_code,c+d.ps_code,e))c.global=d;return this.registerShader(c,e,a)},getGlobalShaderInfo:function(a){return this.globals[a]},compileShader:function(a,b,c){if(!gl)return null;var d=null;try{d=
new GL.Shader(this.global_extra_code+a,this.global_extra_code+b),d.name=c,console.log("Shader compiled: "+c)}catch(e){console.log("Error compiling shader: "+c);console.log(e);console.log("VS CODE\n************");a=(this.global_extra_code+a).split("\n");for(var f in a)console.log(f+": "+a[f]);console.log("PS CODE\n************");a=(this.global_extra_code+b).split("\n");for(f in a)console.log(f+": "+a[f]);return null}return d},registerShader:function(a,b,c){if(null==a)return this.shaders[b]=this.default_shader;
a.id=c;a.key=b;return this.shaders[b]=a},loadFromXML:function(a,b,c,d){c=c?"?nocache="+(new Date).getTime()+Math.floor(1E3*Math.random()):"";LS.request({url:a+c,dataType:"xml",success:function(c){console.log("Shaders XML loaded: "+a);b&&(Shaders.globals={},Shaders.shaders={});Shaders.processShadersXML(c);d&&d()},error:function(a){console.log("Error parsing Shaders XML: "+a);throw"Error parsing Shaders XML: "+a;}})},processShadersXML:function(a){a=a.querySelectorAll("shader");for(var b in a){var c=
a[b];if(c&&c.attributes){var d=c.attributes.id;if(d){var d=d.value,e="",f="";(e=c.attributes.macros)&&(e=e.value.split(","));var h={};for(b in e)h[e[b]]=!0;e=c.querySelector("code[type='vertex_shader']").textContent;f=c.querySelector("code[type='pixel_shader']").textContent;e&&f?(c=(c=c.attributes.multipass)?"1"==c.value||"true"==c.value:!1,Shaders.addGlobalShader(e,f,d,h,c)):console.log("no code in shader: "+d)}}}},addGlobalShader:function(a,b,c,d,e){var f=0,h;for(h in d)f+=1;a={vs_code:a,ps_code:b,
macros:d,num_macros:f,macros_found:{},multipass:e};return this.globals[c]=a},common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_mvp;\n\t",common_pscode:"\n\t\tprecision mediump float;\n\t",createDefaultShaders:function(){this.addGlobalShader(this.common_vscode+"\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t  gl_FragColor = vec4(u_material_color);\t\t\t}\t\t",
"flat");this.addGlobalShader(this.common_vscode+"\t\t\tvarying vec2 v_uvs;\t\t\tvoid main() {\n\t\t\t\tv_uvs = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvarying vec2 v_uvs;\t\t\tuniform sampler2D texture;\t\t\tvoid main() {\t\t\t\tgl_FragColor = u_material_color * texture2D(texture,v_uvs);\t\t\t}\t\t","texture_flat");this.addGlobalShader(this.common_vscode+"\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tcoord = a_coord;\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\t\t}\t\t",
this.common_pscode+"\t\t\tuniform sampler2D texture;\t\t\tuniform vec4 color;\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, coord) * color;\t\t\t}\t\t","screen");this.addGlobalShader(this.common_vscode+"\t\t\tvarying vec4 v_pos;\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\tv_pos = gl_Position;\t\t\t}\t\t\t",this.common_pscode+"\t\t\tprecision highp float;\t\t\tvarying vec4 v_pos;\t\t\tvec3 PackDepth24(float depth)\t\t\t{\t\t\t\tfloat depthInteger = floor(depth);\t\t\t\tfloat depthFraction = fract(depth);\t\t\t\tfloat depthUpper = floor(depthInteger / 256.0);\t\t\t\tfloat depthLower = depthInteger - (depthUpper * 256.0);\t\t\t\treturn vec3(depthUpper / 256.0, depthLower / 256.0, depthFraction);\t\t\t}\t\t\t\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t\tvec4 color = vec4(0.0);\t\t\t\tcolor.x = u_material_color.x; \t\t\t\tfloat depth = v_pos.z / v_pos.w;\t\t\t    color.yzw = PackDepth24(depth*256.0);\t\t\t  gl_FragColor = color;\t\t\t}\t\t",
"picking_depth")}},trace=window.console?console.log.bind(console):function(){};function toArray(a){return Array.apply([],a)}
var LS={_last_uid:0,generateUId:function(){return this._last_uid++},Components:{},registerComponent:function(a){for(var b in arguments)this.Components[getClassName(arguments[b])]=arguments[b],a.prototype.serialize||(a.prototype.serialize=LS._serialize),a.prototype.configure||(a.prototype.configure=LS._configure),LEvent.trigger(LS,"component_registered",arguments[b])},_configure:function(a){LS.cloneObject(a,this)},_serialize:function(){return LS.cloneObject(this)},request:function(a){var b=a.dataType||
"text";if("json"==b)b="text";else if("xml"==b)b="text";else if("binary"==b)b="arraybuffer",a.mimeType="application/octet-stream";else if("image"==b)return b=new Image,b.onload=function(){a.success&&a.success.call(this)},b.onerror=a.error,b.src=a.url,b;var c=new XMLHttpRequest;c.open(a.data?"POST":"GET",a.url,!0);b&&(c.responseType=b);a.mimeType&&c.overrideMimeType(a.mimeType);c.onload=function(b){b=this.response;if("json"==a.dataType)try{b=JSON.parse(b)}catch(c){a.error&&a.error(c)}else if("xml"==
a.dataType)try{b=(new DOMParser).parseFromString(b,"text/xml")}catch(f){a.error&&a.error(f)}a.success&&a.success.call(this,b)};c.onerror=a.error;c.send(a.data);return c}};
function extendClass(a,b){for(var c in a)b[c]=a[c];if(a.prototype)for(c in a.prototype)a.prototype.hasOwnProperty(c)&&(a.prototype.__lookupGetter__(c)?b.prototype.__defineGetter__(c,a.prototype.__lookupGetter__(c)):b.prototype[c]=a.prototype[c],a.prototype.__lookupSetter__(c)&&b.prototype.__defineSetter__(c,a.prototype.__lookupSetter__(c)))}LS.extendClass=extendClass;
function cloneObject(a,b){var c=b||{},d;for(d in a)if("_"!=d[0]&&"jQuery"!=d.substr(0,6)){var e=a[d];null==e?c[d]=null:isFunction(e)||("number"==typeof e||"string"==typeof e?c[d]=e:e.constructor==Float32Array?c[d]=Array.apply([],e):isArray(e)?c[d]&&c[d].constructor==Float32Array?c[d].set(e):c[d]=e.slice(0):c[d]=JSON.parse(JSON.stringify(e)))}return c}LS.cloneObject=cloneObject;
function getObjectClassName(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}LS.getObjectClassName=getObjectClassName;function getClassName(a){if(a&&a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}LS.getClassName=getClassName;
var Generators={generators:{},addGenerator:function(a,b){this.generators[a]=b},executeGenerator:function(a){var b=this.generators[a.action];if(!b||"function"!=typeof b)return null;try{var c=b(a);c.generator=b;return c}catch(d){trace("Error in generator: "+d)}return null}};LS.Generators=Generators;
LS.getCurveValueAt=function(a,b,c,d,e){if(e<b||e>c)return d;b=[b,d];for(var f=0,f=0;f<a.length;f+=1){var h=a[f];if(e==h[0])return h[1];if(e<h[0])return f=(e-b[0])/(h[0]-b[0]),b[1]*(1-f)+h[1]*f;b=h}h=[c,d];f=(e-b[0])/(h[0]-b[0]);return b[1]*(1-f)+h[1]*f};LS.resampleCurve=function(a,b,c,d,e){var f=[];f.length=e;for(var h=(c-b)/e,g=0;g<e;g++)f[g]=LS.getCurveValueAt(a,b,c,d,b+h*g);return f};
var ResourcesManager={path:"",ignore_cache:!1,free_data:!1,resources:{},meshes:{},textures:{},resources_being_loaded:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,formats:{js:"text",json:"json",xml:"xml",jpg:"image",png:"image",bmp:"image"},resource_parsers:{},getNoCache:function(a){return this.ignore_cache||a?"?nocache="+(new Date).getTime()+Math.floor(1E3*Math.random()):""},reset:function(){this.resources={};this.meshes={};this.textures={}},getExtension:function(a){var b=a.lastIndexOf(".");
if(-1==b)return"";var c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c).toLowerCase()},load:function(a,b,c){b=b||{};if(null!=this.resources[a])return c&&c(this.resources[a]),!0;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,callback:c});else{this.resources_being_loaded[a]=[{options:b,callback:c}];0==this.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;c=a.lastIndexOf(".")+
1;var d=a.substr(c,a.length).toLowerCase();c="";c="http://"==a.substr(0,7)?a:b.local_repository?b.local_repository+"/"+a:this.path+a;b.force_local_url&&(c=a);d=this.getNoCache();c={url:c+d,success:function(c){c=ResourcesManager.processResource(a,c,b);ResourcesManager._resource_loaded_success(a,c)},error:function(b){ResourcesManager._resource_loaded_error(a,b)}};d=this.getExtension(a);(d=this.formats[d])||(d="text");c.dataType=d;LS.request(c);return!1}},processResource:function(a,b,c){c=null;b.object_type&&
window[b.object_type]&&(c=new window[b.object_type](b));if(c)return c.fullpath||(c.fullpath=a),c.getResources&&ResourcesManager.loadResources(c.getResources({})),this.registerResource(a,c),c;console.log("Unknown resource loaded")},loadMesh:function(a,b,c){b=b||{};if(null!=this.meshes[a])return c&&c(this.meshes[a]),!0;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,callback:c});else{this.resources_being_loaded[a]=[{options:b,callback:c}];0==this.num_resources_being_loaded&&
LEvent.trigger(ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;c=a.lastIndexOf(".")+1;a.substr(c,a.length).toLowerCase();c="";c="http://"==a.substr(0,7)?a:b.local_repository?b.local_repository+"/"+a:this.path+a;b.force_local_url&&(c=a);var d=this.getNoCache();c={url:c+d,success:function(c){c=ResourcesManager.processMesh(a,c,b);ResourcesManager._resource_loaded_success(a,c)},error:function(b){ResourcesManager._resource_loaded_error(a,b)}};d=Parser.getResourceInfo(a);
c.dataType="text";d.format==Parser.JSON_FORMAT?c.dataType="json":d.format==Parser.XML_FORMAT?c.dataType="xml":d.format==Parser.BINARY_FORMAT&&(c.dataType="binary");LS.request(c);return!1}},processMesh:function(a,b,c){c=c||{};if(!gl)return null;Parser.getResourceInfo(a);var d=null,d=c.ignore_parser?b:Parser.parse(a,b,c);if(null==d)throw"Error parsing mesh: "+a;a=c.name||a;b=GL.Mesh.load(d);b.object_type="Mesh";b.info=d.info;b.metadata={};b.filename=a;b.generateMetadata();b.bounding||b.computeBounding();
this.free_data&&b.freeData();this.registerResource(a,b);return b},loadImage:function(a,b,c){b=b||{};if(null!=this.textures[a])return c&&c(this.textures[a]),!0;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:null,callback:c});else{if(":"==a[0])return console.err("loadImage: cannot load filenames starting with ':'"),null;this.resources_being_loaded[a]=[{options:null,callback:c}];0==this.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"start_loading_resources",
a);this.num_resources_being_loaded++;c="";c="http://"==a.substr(0,7)||"https://"==a.substr(0,8)||b.force_local_url?a:b.local_repository?b.local_repository+"/"+a:this.path+a;var d=this.getNoCache(),e=Parser.getResourceInfo(a);e.type==Parser.IMAGE_DATA?(e=new Image,e.type="IMG",e.onload=function(){this.onload=null;this.filename=a;b.flipY&&(this.flipY=b.flipY);var c=ResourcesManager.processImage(a,this,b);ResourcesManager._resource_loaded_success(a,c)},e.onerror=function(b){ResourcesManager._resource_loaded_error(a,
b)},e.src=c+d):e.type==Parser.NONATIVE_IMAGE_DATA?(c=this.path+a,d=this.getNoCache(),LS.request({url:c+d,dataType:"binary",success:function(c){c=Parser.parse(a,c);var d=null;c&&(d=ResourcesManager.processImage(a,c,b),ResourcesManager._resource_loaded_success(a,d));delete ResourcesManager.resources_being_loaded[a]},error:function(b){ResourcesManager._resource_loaded_error(a,b)}})):ResourcesManager._resource_loaded_error(a,"Wront file format");return!1}},processImage:function(a,b,c){if(!gl)return null;
if(b.width>this.MAX_TEXTURE_SIZE)return console.log("too big, max is "+this.MAX_TEXTURE_SIZE),null;if(b.constructor==Texture)c=b,c.filename=a,this.registerResource(a,c),console.log("DDS created");else if(b.width==b.height/6)c=Texture.cubemapFromImage(b,{wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR}),c.img=b,c.filename=a,this.registerResource(a,c),console.log("Cubemap created");else{c=gl.LINEAR;var d=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||
(d=gl.LINEAR);c=b.pixels?GL.Texture.fromMemory(b.width,b.height,b.pixels,{format:24==b.bpp?gl.RGB:gl.RGBA,flipY:b.flipY,wrapS:gl.REPEAT,wrapT:gl.REPEAT,magFilter:c,minFilter:d}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:gl.REPEAT,wrapT:gl.REPEAT,magFilter:c,minFilter:d,flipY:b.flipY});c.img=b;c.filename=a;this.registerResource(a,c)}c.filename=a;c.generateMetadata();LEvent.trigger(Scene,"change");return c},processScene:function(a,b,c){a=Parser.parse(a,b,c);if(a.meshes)for(var d in a.meshes)b=GL.Mesh.load(a.meshes[d]),
ResourcesManager.registerResource(d,b);d=new LS.SceneTree;d.configure(a);d.loadResources();return d},loadResources:function(a,b){for(var c in a)"string"==typeof c&&":"!=c[0]&&(a[c]==Mesh?this.loadMesh(c,b):a[c]==Texture?this.loadImage(c,b):this.load(c,b))},computeImageMetadata:function(a){return{width:a.width,height:a.height}},registerResource:function(a,b){b.object_type||(b.object_type=getObjectClassName(b));var c=b.object_type;"Mesh"==c?this.meshes[a]=b:"Texture"==c?this.textures[a]=b:"Material"==
c?Scene.materials[a]=b:console.log("Unknown res type: "+c);this.resources[a]=b;LEvent.trigger(this,"resource_loaded",b)},getMesh:function(a){return null!=a?this.meshes[a]:null},getTexture:function(a){return null!=a?this.textures[a]:null},_resource_loaded_success:function(a,b){LS.ResourcesManager.debug&&console.log("RES: "+a+" ---\x3e "+ResourcesManager.num_resources_being_loaded);for(var c in ResourcesManager.resources_being_loaded[a])null!=ResourcesManager.resources_being_loaded[a][c].callback&&
ResourcesManager.resources_being_loaded[a][c].callback(b);ResourcesManager.resources_being_loaded[a]&&(delete ResourcesManager.resources_being_loaded[a],ResourcesManager.num_resources_being_loaded--,0==ResourcesManager.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"end_loading_resources"))},_resource_loaded_error:function(a,b){console.log("Error loading "+a);delete ResourcesManager.resources_being_loaded[a];LEvent.trigger(ResourcesManager,"resource_not_found",a);ResourcesManager.num_resources_being_loaded--;
0==ResourcesManager.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"end_loading_resources")},require:function(a,b){function c(a){for(var b=a.shift(1);ResourcesManager._required_files[b]&&b;)b=a.shift(1);ResourcesManager._required_files[b]=!0;LS.request({url:b,success:function(d){eval(d);if(ResourcesManager._waiting_callbacks[b])for(var g in ResourcesManager._waiting_callbacks[b])ResourcesManager._waiting_callbacks[b][g]();c(a)}})}"string"==typeof a&&(a=[a]);var d=a[a.length-1];b&&(ResourcesManager._waiting_callbacks[d]?
ResourcesManager._waiting_callbacks[d].push(b):ResourcesManager._waiting_callbacks[d]=[b]);c(a)},_required_files:{},_waiting_callbacks:{}};LS.ResourcesManager=ResourcesManager;LS.RM=ResourcesManager;
function Material(a){this._uid=LS.generateUId();this.color=new Float32Array([1,1,1]);this.opacity=1;this.ambient=new Float32Array([1,1,1]);this.diffuse=new Float32Array([1,1,1]);this.emissive=new Float32Array([0,0,0]);this.backlight_factor=0;this.specular_factor=0.1;this.specular_gloss=10;this.specular_ontop=!1;this.reflection_factor=0;this.reflection_fresnel=1;this.reflection_specular=this.reflection_additive=!1;this.velvet=new Float32Array([0.5,0.5,0.5]);this.velvet_exp=0;this.velvet_additive=!1;
this.detail=[0,10,10];this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.extra_factor=0;this.extra_color=new Float32Array([0,0,0]);this.blending=Material.NORMAL;this.normalmap_factor=1;this.displacementmap_factor=0.1;this.bumpmap_factor=1;this.textures={};a&&this.configure(a)}Material.icon="mini-icon-material.png";Material.NORMAL="normal";Material.ADDITIVE_BLENDING="additive";Material.COLOR="color";Material.OPACITY="opacity";Material.BLENDING="blending";Material.AMBIENT="ambient";
Material.DIFFUSE="diffuse";Material.BACKLIGHT_FACTOR="backlight_factor";Material.EMISSIVE="emissive";Material.SPECULAR_FACTOR="specular_factor";Material.SPECULAR_GLOSS="specular_gloss";Material.SPECULAR_ON_TOP="specular_ontop";Material.REFLECTION_FACTOR="reflection_factor";Material.REFLECTION_FRESNEL="reflection_fresnel";Material.REFLECTION_ADDITIVE="reflection_additive";Material.REFLECTION_SPECULAR="reflection_specular";Material.VELVET="velvet";Material.VELVET_EXP="velvet_exp";
Material.VELVET_ADDITIVE="velvet_additive";Material.NORMALMAP_FACTOR="normalmap_factor";Material.DISPLACEMENTMAP_FACTOR="displacementmap_factor";Material.OPACITY_TEXTURE="opacity";Material.AMBIENT_TEXTURE="ambient";Material.COLOR_TEXTURE="color";Material.SPECULAR_TEXTURE="specular";Material.EMISSIVE_TEXTURE="emissive";Material.DETAIL_TEXTURE="detail";Material.REFLECTIVITY_TEXTURE="reflectivity";Material.ENVIRONMENT_TEXTURE="environment";Material.NORMAL_TEXTURE="normal";Material.BUMP_TEXTURE="bump";
Material.DISPLACEMENT_TEXTURE="displacement";Material.IRRADIANCE_TEXTURE="irradiance";Material.EXTRA_TEXTURE="extra";Material.TEXTURE_CHANNELS=[Material.COLOR_TEXTURE,Material.OPACITY_TEXTURE,Material.AMBIENT_TEXTURE,Material.SPECULAR_TEXTURE,Material.EMISSIVE_TEXTURE,Material.DETAIL_TEXTURE,Material.NORMAL_TEXTURE,Material.DISPLACEMENT_TEXTURE,Material.BUMP_TEXTURE,Material.REFLECTIVITY_TEXTURE,Material.ENVIRONMENT_TEXTURE,Material.IRRADIANCE_TEXTURE,Material.EXTRA_TEXTURE];Material.COORDS_UV0="0";
Material.COORDS_UV1="1";Material.COORDS_UV_TRANSFORMED="transformed";Material.COORDS_SCREEN="screen";Material.COORDS_POLAR="polar";Material.COORDS_POLAR_REFLECTED="polar_reflected";Material.COORDS_WORLDXZ="worldxz";Material.COORDS_WORLDXY="worldxy";Material.COORDS_WORLDYZ="worldyz";
Material.TEXTURE_COORDINATES=[Material.COORDS_UV0,Material.COORDS_UV1,Material.COORDS_UV_TRANSFORMED,Material.COORDS_SCREEN,Material.COORDS_POLAR,Material.COORDS_POLAR_REFLECTED,Material.COORDS_WORLDXY,Material.COORDS_WORLDXZ,Material.COORDS_WORLDYZ];Material.DEFAULT_UVS={normal:Material.COORDS_UV0,displacement:Material.COORDS_UV0,environment:Material.COORDS_POLAR_REFLECTED,irradiance:Material.COORDS_POLAR};Material.prototype.getShader=function(a,b,c){return Shaders.get(a,b)};
Material.prototype.getSurfaceShaderMacros=function(a,b,c,d,e,f,h){for(var g in f.textures)!(b=Material.prototype.getTexture.call(f,g))||"environment"==g&&0>=this.reflection_factor||(c=this.textures[g+"_uvs"]||Material.DEFAULT_UVS[g]||"0",a["USE_"+g.toUpperCase()+(b.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+c);for(g in this.textures)if(b=this.getTexture(g)){c=this.textures[g+"_uvs"]||Material.DEFAULT_UVS[g]||"0";if("environment"==g){if(0>=this.reflection_factor)continue}else if("normal"==
g){0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(a.USE_NORMAL_TEXTURE="uvs_"+c,0!=this.normalmap_factor&&(a.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(a.USE_TANGENT_NORMALMAP=""));continue}else if("displacement"==g){0!=this.displacementmap_factor&&gl.derivatives_supported&&(a.USE_DISPLACEMENT_TEXTURE="uvs_"+c,1!=this.displacementmap_factor&&(a.USE_DISPLACEMENTMAP_FACTOR=""));continue}else if("bump"==g){0!=this.bump_factor&&
gl.derivatives_supported&&(a.USE_BUMP_TEXTURE="uvs_"+c,1!=this.bumpmap_factor&&(a.USE_BUMPMAP_FACTOR=""));continue}a["USE_"+g.toUpperCase()+(b.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+c}!0==e.flags.alpha_test&&(a.USE_ALPHA_TEST="0.5");this.velvet&&this.velvet_exp&&(a.USE_VELVET="");this.emissive_material&&(a.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&(a.USE_SPECULAR_ONTOP="");this.specular_on_alpha&&(a.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&(a.USE_SPECULAR_IN_REFLECTION=
"");0.001<this.backlight_factor&&(a.USE_BACKLIGHT="");d=d.mesh;"a_normal"in d.vertexBuffers||(a.NO_NORMALS="");"a_coord"in d.vertexBuffers||(a.NO_COORDS="");"a_color"in d.vertexBuffers&&(a.USE_COLOR_STREAM="");"a_tangent"in d.vertexBuffers&&(a.USE_TANGENT_STREAM="");if(this.extra_macros)for(var k in this.extra_macros)a[k]=this.extra_macros[k]};
Material.prototype.getLightShaderMacros=function(a,b,c,d,e,f,h,g){b=h.settings.enable_shadows&&c.cast_shadows&&c._shadowMap&&null!=c._lightMatrix&&!g.shadows_disabled;c.use_diffuse&&!this.constant_diffuse&&(a.USE_DIFFUSE_LIGHT="");c.use_specular&&0<this.specular_factor&&(a.USE_SPECULAR_LIGHT="");c.type==Light.DIRECTIONAL?a.USE_DIRECTIONAL_LIGHT="":c.type==Light.SPOT&&(a.USE_SPOT_LIGHT="");c.spot_cone&&(a.USE_SPOT_CONE="");c.linear_attenuation&&(a.USE_LINEAR_ATTENUATION="");c.range_attenuation&&(a.USE_RANGE_ATTENUATION=
"");(d=c.projective_texture)&&d.constructor==String&&(d=ResourcesManager.textures[d]);d&&(a.USE_PROJECTIVE_LIGHT="");if(0.001>vec3.squaredLength(c.color)||f.flags.ignore_lights)a.USE_AMBIENT_ONLY="";0.001<c.offset&&(a.USE_LIGHT_OFFSET="");b&&!1!=f.flags.receive_shadows&&(a.USE_SHADOW_MAP="",c.hard_shadows&&(a.USE_HARD_SHADOWS=""),c._shadowMap&&c._shadowMap.texture_type==gl.TEXTURE_CUBE_MAP&&(a.USE_SHADOW_CUBEMAP=""),a.SHADOWMAP_OFFSET="")};
Material.prototype.getFlatShaderMacros=function(a,b,c,d,e,f,h){for(var g in this.textures)if(b=this.getTexture(g)){c=this.textures[g+"_uvs"]||Material.DEFAULT_UVS[g]||"0";if("environment"==g){if(0>=this.reflection_factor)continue}else if("normal"==g){0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(a.USE_NORMAL_TEXTURE="uvs_"+c,0!=this.normalmap_factor&&(a.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(a.USE_TANGENT_NORMALMAP=
""));continue}else if("displacement"==g){0!=this.displacementmap_factor&&gl.derivatives_supported&&(a.USE_DISPLACEMENT_TEXTURE="uvs_"+c,1!=this.displacementmap_factor&&(a.USE_DISPLACEMENTMAP_FACTOR=""));continue}else if("bump"==g){0!=this.bump_factor&&gl.derivatives_supported&&(a.USE_BUMP_TEXTURE="uvs_"+c,1!=this.bumpmap_factor&&(a.USE_BUMPMAP_FACTOR=""));continue}a["USE_"+g.toUpperCase()+(b.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+c}!0==e.flags.alpha_test&&(a.USE_ALPHA_TEST="0.5");
this.velvet&&this.velvet_exp&&(a.USE_VELVET="");this.emissive_material&&(a.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&(a.USE_SPECULAR_ONTOP="");this.specular_on_alpha&&(a.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&(a.USE_SPECULAR_IN_REFLECTION="");0.001<this.backlight_factor&&(a.USE_BACKLIGHT="");d=d.mesh;"a_normal"in d.vertexBuffers||(a.NO_NORMALS="");"a_coord"in d.vertexBuffers||(a.NO_COORDS="");"a_color"in d.vertexBuffers&&(a.USE_COLOR_STREAM="");"a_tangent"in d.vertexBuffers&&(a.USE_TANGENT_STREAM=
"");if(this.extra_macros)for(var k in this.extra_macros)a[k]=this.extra_macros[k]};Material.prototype.getSceneShaderMacros=function(a,b,c,d,e,f){f.camera.type==Camera.ORTHOGRAPHIC&&(a.USE_ORTHOGRAPHIC_CAMERA="");f.clipping_plane&&(a.USE_CLIPPING_PLANE="");f.brightness_factor&&1!=f.brightness_factor&&(a.USE_BRIGHTNESS_FACTOR="");f.colorclip_factor&&(a.USE_COLORCLIP_FACTOR="")};
Material.prototype.fillSurfaceUniforms=function(a,b,c,d,e,f){b.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.opacity]);b.u_ambient_color=d.flags.ignore_lights?[1,1,1]:[e.ambient_color[0]*this.ambient[0],e.ambient_color[1]*this.ambient[1],e.ambient_color[2]*this.ambient[2]];b.u_diffuse_color=this.diffuse;b.u_emissive_color=this.emissive||[0,0,0];b.u_specular=[this.specular_factor,this.specular_gloss];b.u_reflection_info=[this.reflection_additive?-this.reflection_factor:
this.reflection_factor,this.reflection_fresnel];b.u_backlight_factor=this.backlight_factor;b.u_normalmap_factor=this.normalmap_factor;b.u_displacementmap_factor=this.displacementmap_factor;b.u_bumpmap_factor=this.bumpmap_factor;b.u_velvet_info=[this.velvet[0],this.velvet[1],this.velvet[2],this.velvet_additive?this.velvet_exp:-this.velvet_exp];b.u_detail_info=this.detail;b.u_texture_matrix=this.uvs_matrix;a=0;for(var h in e.textures)if(c=Material.prototype.getTexture.call(e,h))(b[h+(c.texture_type==
gl.TEXTURE_2D?"_texture":"_cubemap")]=c.bind(a),a+=1,"environment"==h&&0>=this.reflection_factor||(d=this.textures[h+"_uvs"]||Material.DEFAULT_UVS[h]||"0",d!=Material.COORDS_POLAR_REFLECTED&&d!=Material.COORDS_POLAR))||(c.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));for(h in this.textures)if(c=this.getTexture(h)){b[h+(c.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=c.bind(a);d=this.textures[h+"_uvs"]||Material.DEFAULT_UVS[h]||"0";a+=1;if("environment"==
h)if(0>=this.reflection_factor)continue;else if("normal"==h)continue;else if("displacement"==h)continue;else if("bump"==h)continue;else"irradiance"==h&&(c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),c.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),c.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE));c.texture_type!=gl.TEXTURE_2D||d!=Material.COORDS_POLAR_REFLECTED&&d!=Material.COORDS_POLAR||(c.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR))}};
Material.prototype.fillLightUniforms=function(a,b,c,d,e,f,h){a=f.settings.enable_shadows&&c.cast_shadows&&c._shadowMap&&null!=c._lightMatrix&&!h.shadows_disabled;(e=c.projective_texture)&&e.constructor==String&&(e=ResourcesManager.textures[e]);e&&(b.light_texture=e.bind(11));if(c.type==Light.DIRECTIONAL||c.type==Light.SPOT)b.u_light_front=c.getFront();c.type==Light.SPOT&&(b.u_light_angle=[c.angle*DEG2RAD,c.angle_end*DEG2RAD,Math.cos(0.5*c.angle*DEG2RAD),Math.cos(0.5*c.angle_end*DEG2RAD)]);b.u_light_pos=
c.getPosition();b.u_light_color=vec3.scale(vec3.create(),c.color,c.intensity);b.u_light_att=[c.att_start,c.att_end];b.u_light_offset=c.offset;c._lightMatrix&&(b.u_lightMatrix=mat4.multiply(mat4.create(),c._lightMatrix,d.matrix));a&&(b.u_shadow_params=[1/c._shadowMap.width,c.shadow_bias],b.shadowMap=c._shadowMap.bind(10))};
Material.prototype.configure=function(a){for(var b in a){var c=a[b],d=null;switch(b){case "opacity":case "backlight_factor":case "specular_factor":case "specular_gloss":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "blending":case "normalmap_factor":case "displacementmap_factor":case "extra_factor":case "specular_ontop":case "reflection_specular":d=c;break;case "color":case "ambient":case "diffuse":case "emissive":case "velvet":case "detail":case "extra_color":d=
new Float32Array(c);break;case "textures":this.textures=a.textures;continue;case "transparency":this.opacity=1-c;default:continue}this[b]=d}a.uvs_matrix&&9==a.uvs_matrix.length&&(this.uvs_matrix=new Float32Array(a.uvs_matrix))};Material.prototype.serialize=function(){return cloneObject(this)};
Material.prototype.loadAndSetTexture=function(a,b,c){c=c||{};b=b||Material.COLOR_TEXTURE;var d=this;if("string"===typeof a)":"!=a[0]?ResourcesManager.loadImage(a,c,function(a){d.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};
Material.prototype.setTexture=function(a,b,c){b=b||Material.COLOR_TEXTURE;a?(this.textures[b]=a,c&&(this.textures[b+"_uvs"]=c)):(delete this.textures[b],delete this.textures[b+"_uvs"]);a&&a.constructor==String&&ResourcesManager.loadImage(a)};Material.prototype.getTexture=function(a){return(a=this.textures[a])?a.constructor==String?ResourcesManager.textures[a]:a.constructor==Texture?a:null:null};
Material.prototype.getResources=function(a){for(var b in this.textures)"string"==typeof this.textures[b]&&"_uvs"!=b.substr(-4)&&(a[this.textures[b]]=Texture);return a};Material.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)ResourcesManager.loadImage(a[b])};Material.prototype.getRenderer=function(){return this.renderer||Renderer._default_renderer};Material.prototype.registerMaterial=function(a){this.name=a;Scene.materials[a]=this;this.material=a};LS.Material=Material;
function ComponentContainer(){}ComponentContainer.prototype.configureComponents=function(a){if(a.components)for(var b in a.components){var c=a.components[b],d=c[0];"Transform"==d&&0==b?this.transform.configure(c[1]):window[d]?(c=new window[d](c[1]),this.addComponent(c)):trace("Unknown component found: "+d)}};
ComponentContainer.prototype.serializeComponents=function(a){if(this._components){a.components=[];for(var b in this._components){var c=this._components[b];c.serialize&&a.components.push([getObjectClassName(c),c.serialize()])}}};ComponentContainer.prototype.addComponent=function(a){a._root=this;if(a.onAddedToNode)a.onAddedToNode(this);this._components||(this._components=[]);if(-1!=this._components.indexOf(a))throw"inserting the same component twice";this._components.push(a);return a};
ComponentContainer.prototype.removeComponent=function(a){a._root=null;if(a.onRemovedFromNode)a.onRemovedFromNode(this);LEvent.unbindAll(this,a);a=this._components.indexOf(a);-1!=a&&this._components.splice(a,1)};ComponentContainer.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0])};
ComponentContainer.prototype.getComponent=function(a){if(this._components){for(var b in this._components)if(this._components[b].constructor==a)return this._components[b];return null}};ComponentContainer.prototype.processActionInComponents=function(a,b){if(this._components)for(var c=0;c<this._components.length;++c)if(this._components[c][a]&&"function"==typeof this._components[c][a])this._components[c][a](b)};function CompositePattern(){}CompositePattern.prototype.compositeCtor=function(){};
CompositePattern.prototype.addChild=function(a,b,c){function d(a){if(a._children)for(var b in a._children){var c=a._children[b];c._on_tree||(LEvent.trigger(c._on_tree,"treeItemAdded",c),c._on_tree=a._on_tree);d(c)}}for(var e=this;e._parentNode;){if(e==a)throw"addChild: Cannot insert a node as his own child";e=e._parentNode}a._parentNode&&a._parentNode.removeChild(a,c);a._parentNode=this;this._children?void 0==b?this._children.push(a):this._children.splice(b,0,a):this._children=[a];a._on_tree=this._on_tree;
this._onChildAdded&&this._onChildAdded(a,c);LEvent.trigger(this,"childAdded",a);this._on_tree&&(LEvent.trigger(this._on_tree,"treeItemAdded",a),d(a))};
CompositePattern.prototype.removeChild=function(a,b){function c(a){if(a._children)for(var b in a._children){var d=a._children[b];d._on_tree&&(LEvent.trigger(d._on_tree,"treeItemRemoved",d),d._on_tree=null);c(d)}}if(!this._children||a._parentNode!=this||a._parentNode!=this)return!1;var d=this._children.indexOf(a);if(-1==d)return!1;this._children.splice(d,1);this._onChildRemoved&&this._onChildRemoved(a,b);LEvent.trigger(this,"childRemoved",a);a._on_tree&&(LEvent.trigger(a._on_tree,"treeItemRemoved",
a),c(a));a._on_tree=null;return!0};CompositePattern.prototype.serializeChildren=function(){var a=[];if(this._children)for(var b in this._children)a.push(this._children[b].serialize());return a};CompositePattern.prototype.configureChildren=function(a){if(a.children)for(var b in a.children){var c=new this.constructor(a.children[b].id);this.addChild(c);c.configure(a.children[b])}};CompositePattern.prototype.getParent=function(){return this._parentNode};
CompositePattern.prototype.getChildren=function(){return this._children||[]};Object.defineProperty(CompositePattern.prototype,"parentNode",{enumerable:!0,get:function(){return this._parentNode},set:function(a){}});CompositePattern.prototype.childNodes=function(){return this._children||[]};Object.defineProperty(CompositePattern.prototype,"childNodes",{enumerable:!0,get:function(){return this._children||[]},set:function(a){}});
function Transform(a){this._position=vec3.create();this._rotation=quat.create();this._scale=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._dirty=!1;a&&this.configure(a)}Transform.temp_matrix=mat4.create();Transform.icon="mini-icon-gizmo.png";Transform.prototype.onAddedToNode=function(a){a.transform||(a.transform=this)};Transform.prototype.onRemovedFromNode=function(a){a.transform==this&&delete a.transform};Transform.prototype.copyFrom=function(a){this.configure(a.serialize())};
Transform.prototype.configure=function(a){a.position&&vec3.copy(this._position,a.position);a.scale&&vec3.copy(this._scale,a.scale);a.rotation&&4==a.rotation.length&&quat.copy(this._rotation,a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);var b=quat.setAngleAxis(quat.create(),[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,
[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._dirty=!0;this._on_change()};Transform.prototype.serialize=function(){return{position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]]}};
Transform.prototype.identity=function(){vec3.copy(this._position,[0,0,0]);quat.copy(this._rotation,[0,0,0,1]);vec3.copy(this._scale,[1,1,1]);mat4.identity(this._local_matrix);mat4.identity(this._global_matrix);this._dirty=!1};Transform.prototype.reset=Transform.prototype.identity;Transform.prototype.getPosition=function(a){return a?vec3.copy(a,this._position):vec3.clone(this._position)};
Transform.prototype.getPositionGlobal=function(a){if(this._parent){var b=vec3.create();return mat4.multiplyVec3(b||a,this.getGlobalMatrix(),b)}return a?vec3.copy(a,this._position):vec3.clone(this._position)};Transform.prototype.getRotation=function(){return quat.clone(this._rotation)};Transform.prototype.getRotationGlobal=function(){if(this._parent){for(var a=this._parent,b=quat.clone(this._rotation);a;)quat.multiply(b,a._rotation,b),a=a._parent;return b}return quat.clone(this._rotation)};
Transform.prototype.getScale=function(){return vec3.clone(this._scale)};Transform.prototype.getScaleGlobal=function(){if(this._parent){for(var a=this,b=vec3.clone(this._scale);a._parent;)vec3.multiply(b,b,a._scale),a=a._parent;return b}return vec3.clone(this._scale)};Transform.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,this._rotation,this._position);mat4.scale(this._local_matrix,this._local_matrix,this._scale);this._dirty=!1};
Transform.prototype.updateGlobalMatrix=function(){this._dirty&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,this._parent.updateGlobalMatrix(),this._local_matrix):mat4.copy(this._local_matrix,this._global_matrix);return this._global_matrix};Transform.prototype.getLocalMatrix=function(){this._dirty&&this.updateMatrix();return mat4.clone(this._local_matrix)};Transform.prototype.getLocalMatrixRef=function(){this._dirty&&this.updateMatrix();return this._local_matrix};
Transform.prototype.getGlobalMatrix=function(a){this._dirty&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,this._parent.getGlobalMatrix(),this._local_matrix):this._global_matrix.set(this._local_matrix);a.set(this._global_matrix);return a};Transform.prototype.getGlobalRotation=function(a){a=a||quat.create();a.set(this._rotation);for(var b=this._parent;b;)quat.multiply(a,a,b._rotation),b=b._parent;return a};
Transform.prototype.getGlobalRotationMatrix=function(a){for(var b=quat.clone(this._rotation),c=this._parent;c;)quat.multiply(b,b,c._rotation),c=c._parent;a=a||mat4.create();return mat4.fromQuat(a,b)};Transform.prototype.getGlobalMatrixRef=function(){return this._global_matrix};Transform.prototype.getMatrixWithoutScale=function(){var a=this.getPositionGlobal();return mat4.fromRotationTranslation(mat4.create(),this.getRotationGlobal(),a)};
Transform.prototype.getMatrixWithoutRotation=function(){var a=this.getPositionGlobal();return mat4.clone([1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1])};Transform.prototype.getNormalMatrix=function(a){this._dirty&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,this._parent.getGlobalMatrix(),this._local_matrix):a.set(this._local_matrix);return mat4.transpose(a,mat4.invert(a,a))};
Transform.prototype.fromMatrix=function(a){var b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var c=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(c,b,[1,0,0]));this._scale[1]=vec3.length(mat4.rotateVec3(c,b,[0,1,0]));this._scale[2]=vec3.length(mat4.rotateVec3(c,b,[0,0,1]));mat4.scale(mat4.create(),b,[1/this._scale[0],1/this._scale[1],1/this._scale[2]]);b=mat3.fromMat4(mat3.create(),b);mat3.transpose(b,b);quat.fromMat3(this._rotation,b);quat.normalize(this._rotation,this._rotation);
a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._dirty=!1;this._on_change()};Transform.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._dirty=!0;this._on_change()};Transform.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._dirty=!0;this._on_change()};Transform.prototype.setRotation=function(a){quat.copy(this._rotation,a);this._dirty=!0;this._on_change()};
Transform.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scale,a,b,c):vec3.set(this._scale,a,a,a);this._dirty=!0;this._on_change()};Transform.prototype.translate=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._dirty=!0;this._on_change()};
Transform.prototype.translateLocal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,this.transformVector([a,b,c])):vec3.add(this._position,this._position,this.transformVector(a));this._dirty=!0;this._on_change()};Transform.prototype.rotate=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._dirty=!0;this._on_change()};
Transform.prototype.rotateLocal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,this._rotation,c);this._dirty=!0;this._on_change()};Transform.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scale,this._scale,[a,b,c]):vec3.multiply(this._scale,this._scale,a);this._dirty=!0;this._on_change()};
Transform.interpolate=function(a,b,c,d){vec3.lerp(d._scale,a._scale,b._scale,c);vec3.lerp(d._position,a._position,b._position,c);quat.slerp(d._rotation,a._rotation,b._rotation,c);this._dirty=!0;this._on_change()};Transform.prototype.lookAt=function(a,b,c){var d=mat4.create();if(this._parent){var e=this._parent.getGlobalMatrix();a=mat4.multiplyVec3(vec3.create(),e,a);b=mat4.multiplyVec3(vec3.create(),e,b);c=mat4.multiplyVec3(vec3.create(),e,c)}mat4.lookAt(d,a,b,c);mat4.invert(d,d);this.fromMatrix(d)};
Transform.prototype._on_change=function(){this._dirty=!0;LEvent.trigger(this,"changed",this);this._root&&LEvent.trigger(this._root,"transformChanged",this)};Transform.prototype.getFront=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(0,0,1),this.getRotationGlobal())};Transform.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(0,1,0),this.getRotationGlobal())};
Transform.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(1,0,0),this.getRotationGlobal())};Transform.prototype.transformPoint=function(a,b){b=b||vec3.create();this._dirty&&this.updateMatrix();return mat4.multiplyVec3(b,this._local_matrix,a)};Transform.prototype.transformPointGlobal=function(a,b){b=b||vec3.create();this._dirty&&this.updateMatrix();return mat4.multiplyVec3(b,this.getGlobalMatrix(),a)};
Transform.prototype.transformVector=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this._rotation)};Transform.prototype.transformVectorGlobal=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this.getRotationGlobal())};
Transform.prototype.applyMatrixTransform=function(a,b){if(b&&this._parent){var c=this.getGlobalMatrix(),d=mat4.multiply(mat4.create(),a,c);mat4.invert(c,c);mat4.multiply(d,c,d);mat4.multiply(this._local_matrix,this._local_matrix,d)}else mat4.multiply(this._local_matrix,this._local_matrix,a);this.fromMatrix(this._local_matrix)};LS.registerComponent(Transform);LS.Transform=Transform;
function Camera(a){this._type=Camera.PERSPECTIVE;this._eye=vec3.fromValues(0,100,100);this._center=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=1;this._far=1E3;this._aspect=1;this._fov=45;this._frustrum_size=50;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();a&&this.configure(a)}Camera.icon="mini-icon-camera.png";Camera.PERSPECTIVE=1;Camera.ORTHOGRAPHIC=2;
Object.defineProperty(Camera.prototype,"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._dirty_matrices=!0);this._type=a}});Object.defineProperty(Camera.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._dirty_matrices=!0}});Object.defineProperty(Camera.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._dirty_matrices=!0}});
Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._dirty_matrices=!0);this._near=a}});Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._dirty_matrices=!0);this._far=a}});Object.defineProperty(Camera.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._dirty_matrices=!0);this._aspect=a}});
Object.defineProperty(Camera.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._dirty_matrices=!0);this._fov=a}});Object.defineProperty(Camera.prototype,"frustrum_size",{get:function(){return this._frustrum_size},set:function(a){this._frustrum_size!=a&&(this._dirty_matrices=!0);this._frustrum_size=a}});Camera.prototype.onAddedToNode=function(a){a.camera||(a.camera=this)};Camera.prototype.onRemovedFromNode=function(a){a.camera==this&&delete a.camera};
Camera.prototype.lookAt=function(a,b,c){vec3.copy(this._eye,a);vec3.copy(this._center,b);vec3.copy(this._up,c);this._dirty_matrices=!0};
Camera.prototype.updateMatrices=function(){this.type==Camera.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,0.5*-this._frustrum_size*this._aspect,0.5*this._frustrum_size*this._aspect,0.5*-this._frustrum_size,0.5*this._frustrum_size,this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._aspect,this._near,this._far);mat4.lookAt(this._view_matrix,this._eye,this._center,this._up);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,
this._view_matrix);this._dirty_matrices=!1};Camera.prototype.getModelMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._model_matrix)};Camera.prototype.getViewMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._view_matrix)};Camera.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};
Camera.prototype.getViewProjectionMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._viewprojection_matrix)};Camera.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};
Camera.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._dirty_matrices&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};
Camera.prototype.getLocalVector=function(a,b){b=b||vec3.create();this._dirty_matrices&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.rotateVec3(b,c,a)};Camera.prototype.getEye=function(){return vec3.clone(this._eye)};Camera.prototype.getCenter=function(){return vec3.clone(this._center)};Camera.prototype.setEye=function(a){return vec3.copy(this._eye,a)};
Camera.prototype.setCenter=function(a){return vec3.copy(this._center,a)};Camera.prototype.getGlobalFront=function(a){a=a||vec3.create();vec3.subtract(a,this._center,this._eye);vec3.normalize(a,a);this._root&&this._root.transform&&this._root.transform.transformVector(a,a);return a};
Camera.prototype.getGlobalTop=function(a){a=a||vec3.create();vec3.subtract(a,this._center,this._eye);vec3.normalize(a,a);var b=vec3.cross(vec3.create(),a,this._up);vec3.cross(a,a,b);vec3.scale(a,a,-1);this._root&&this._root.transform&&this._root.transform.transformVector(a,a);return a};Camera.prototype.move=function(a){vec3.add(this._center,this._center,a);vec3.add(this._eye,this._eye,a);this._dirty_matrices=!0};
Camera.prototype.rotate=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a),d=vec3.subtract(vec3.create(),this._center,this._eye);vec3.transformQuat(d,d,c);vec3.add(this._center,this._eye,d);this._dirty_matrices=!0};Camera.prototype.orbit=function(a,b,c){c=c||this._center;a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._eye,c);vec3.transformQuat(b,b,a);vec3.add(this._eye,c,b);this._dirty_matrices=!0};
Camera.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._dirty_matrices=!0};Camera.prototype.project=function(a,b,c){b=b||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();c=mat4.multiplyVec3(c||vec3.create(),this._viewprojection_matrix,a);c[0]/=c[2];c[1]/=c[2];vec3.set(c,0.5*(c[0]+1)*b[2]+b[0],0.5*(c[1]+1)*b[3]+b[1],c[2]);return c};
Camera.prototype.unproject=function(a,b,c){b=b||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();return gl.unproject(c||vec3.create(),a,this._view_matrix,this._projection_matrix,b)};
Camera.prototype.getRayInPixel=function(a,b,c){c=c||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();var d=this.getEye();a=vec3.unproject(vec3.create(),[a,b,1],this._view_matrix,this._projection_matrix,c);a=vec3.subtract(vec3.create(),a,d);vec3.normalize(a,a);return{start:d,direction:a}};Camera.prototype.configure=function(a){LS.cloneObject(a,this);this.updateMatrices()};Camera.prototype.serialize=function(){return cloneObject(this)};LS.registerComponent(Camera);
LS.Camera=Camera;
function Light(a){this._uid=LS.generateUId();this.position=vec3.create();this.target=vec3.fromValues(0,0,1);this.up=vec3.fromValues(0,1,0);this.enabled=!0;this.near=1;this.far=1E3;this.angle=45;this.angle_end=60;this.use_specular=this.use_diffuse=!0;this.target_in_world_coords=this.range_attenuation=this.linear_attenuation=!1;this.att_start=0;this.att_end=1E3;this.offset=0;this.spot_cone=!0;this.color=[1,1,1];this.intensity=1;this.cast_shadows=!1;this.shadow_bias=0.005;this.shadowmap_resolution=1024;
this.type=Light.OMNI;this.frustrum_size=50;a&&(this.configure(a),a.shadowmap_resolution&&(this.shadowmap_resolution=parseInt(a.shadowmap_resolution)))}Light.OMNI=1;Light.SPOT=2;Light.DIRECTIONAL=3;Light.DEFAULT_SHADOWMAP_RESOLUTION=1024;Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=50;Light.prototype.onAddedToNode=function(a){a.light||(a.light=this);LEvent.bind(a,"beforeRender",this.onBeforeRender,this)};Light.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light};
Light.prototype.onBeforeRender=function(){this.projective_texture&&this.enabled&&this.computeLightMatrices()};Light._temp_matrix=mat4.create();Light._temp2_matrix=mat4.create();Light._temp3_matrix=mat4.create();Light._temp_position=vec3.create();Light._temp_target=vec3.create();Light._temp_up=vec3.create();Light._temp_front=vec3.create();
Light.prototype.computeLightMatrices=function(a,b,c){var d=this.getPosition(Light._temp_position),e=this.getTarget(Light._temp_target),f=this.getUp(Light._temp_up),h=this.getFront(Light._temp_front);0.999<Math.abs(vec3.dot(h,f))&&vec3.set(f,0,0,1);b||(b=Light._temp_matrix);a||(a=Light._temp2_matrix);c||(c=Light._temp3_matrix);h=this.frustrum_size||Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;this.type==Light.DIRECTIONAL?mat4.ortho(b,-0.5*h,0.5*h,-0.5*h,0.5*h,this.near,this.far):mat4.perspective(b,(this.angle_end||
45)*DEG2RAD,1,this.near,this.far);mat4.lookAt(a,d,e,f);this.type==Light.DIRECTIONAL&&this.cast_shadows&&this.enabled&&(d=h/(this.shadowmap_resolution||Light.DEFAULT_SHADOWMAP_RESOLUTION),a[12]=Math.floor(a[12]/d)*d,a[13]=Math.floor(a[13]/d)*d);mat4.multiply(c,b,a);this._lightMatrix||(this._lightMatrix=mat4.create());mat4.copy(this._lightMatrix,c)};
Light.prototype.serialize=function(){this.position=vec3.toArray(this.position);this.target=vec3.toArray(this.target);this.color=vec3.toArray(this.color);return cloneObject(this)};Light.prototype.configure=function(a){LS.cloneObject(a,this)};Light.prototype.getPosition=function(a){return this._root&&this._root.transform?this._root.transform.transformPointGlobal(this.position,a||vec3.create()):vec3.clone(this.position)};
Light.prototype.getTarget=function(a){return this._root&&this._root.transform&&!this.target_in_world_coords?this._root.transform.transformPointGlobal(this.target,a||vec3.create()):vec3.clone(this.target)};Light.prototype.getUp=function(a){return this._root&&this._root.transform?this._root.transform.transformVector(this.up,a||vec3.create()):vec3.clone(this.up)};Light.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this.getPosition(),this.getTarget());vec3.normalize(a,a);return a};
Light.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=Texture);return a};LS.registerComponent(Light);LS.Light=Light;function MeshRenderer(a){this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.primitive=this.material=null;this.two_sided=!1;a&&this.configure(a);MeshRenderer._identity||(MeshRenderer._identity=mat4.create())}MeshRenderer.icon="mini-icon-teapot.png";MeshRenderer["@mesh"]={widget:"mesh"};MeshRenderer["@lod_mesh"]={widget:"mesh"};
MeshRenderer["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4}};MeshRenderer["@submesh_id"]={widget:"combo",values:function(){var a=this.component.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};MeshRenderer.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
MeshRenderer.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};MeshRenderer.prototype.configure=function(a){this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material))};
MeshRenderer.prototype.serialize=function(){var a={mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());null!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};MeshRenderer.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};
MeshRenderer.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};MeshRenderer.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};
MeshRenderer.prototype.onCollectInstances=function(a,b,c){a=this.getMesh();if(!a)return null;this._root&&(c=this._render_instance||new RenderInstance(this._root,this),this._root.transform.getGlobalMatrix(c.matrix),mat4.multiplyVec3(c.center,c.matrix,vec3.create()),c.mesh=a,-1!=this.submesh_id&&null!=this.submesh_id&&(c.submesh_id=this.submesh_id),c.primitive=null==this.primitive?gl.TRIANGLES:this.primitive,c.material=this.material||this._root.getMaterial(),this.two_sided&&c.enableFlag(RenderInstance.TWO_SIDED),
b.push(c))};LS.registerComponent(MeshRenderer);LS.MeshRenderer=MeshRenderer;function Rotator(a){this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45}Rotator.icon="mini-icon-rotator.png";Rotator.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Rotator.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};
Rotator.prototype.onUpdate=function(a,b){if(this._root){var c=this._root._on_scene;this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var d=quat.setAxisAngle(quat.create(),this.axis,Math.sin(2*this.speed*Scene._global_time*Math.PI)*this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,d,this._default);this._root.transform._dirty=!0}else this.local_space?this._root.transform.rotateLocal(this.speed*b,this.axis):this._root.transform.rotate(this.speed*
b,this.axis);c&&LEvent.trigger(c,"change")}};LS.registerComponent(Rotator);function CameraController(a){this.speed=10;this.wheel_speed=this.rot_speed=1;this.smooth=!1;this.cam_type="orbit";this._moving=vec3.fromValues(0,0,0);this.orbit_center=null;this.configure(a)}CameraController.icon="mini-icon-cameracontroller.png";
CameraController.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"mousewheel",this.onMouse,this);LEvent.bind(a,"keydown",this.onKey,this);LEvent.bind(a,"keyup",this.onKey,this);LEvent.bind(a,"update",this.onUpdate,this)};
CameraController.prototype.onUpdate=function(a){if(this._root){if(!this._root.transform&&this._root.camera&&(a=this._root.camera,"fps"==this.cam_type&&(0!=this._moving[0]||0!=this._moving[1]||0!=this._moving[2]))){var b=a.getLocalVector(this._moving);vec3.scale(b,b,this.speed*(this._move_fast?10:1));a.move(b);a.updateMatrices()}this.smooth&&Scene.refresh()}};
CameraController.prototype.onMouse=function(a,b){if(this._root){var c=this._root.camera;if(c)if("mousewheel"==b.eventType)c.orbitDistanceFactor(1+-0.001*b.wheel*this.wheel_speed,this.orbit_center),c.updateMatrices();else if(b.dragging&&!this._root.transform)if("fps"==this.cam_type){c.rotate(-b.deltax*this.rot_speed,[0,1,0]);c.updateMatrices();var d=c.getLocalVector([1,0,0]);c.rotate(-b.deltay*this.rot_speed,d);c.updateMatrices()}else"orbit"==this.cam_type&&(b.ctrlKey?(d=c.getLocalVector([0.1*this.speed*
-b.deltax,0.1*this.speed*b.deltay,0]),c.move(d),c.updateMatrices()):(c.orbit(-b.deltax*this.rot_speed,[0,1,0],this.orbit_center),c.updateMatrices(),d=c.getLocalVector([1,0,0]),c.orbit(-b.deltay*this.rot_speed,d,this.orbit_center)))}};
CameraController.prototype.onKey=function(a,b){this._root&&(87==b.keyCode?this._moving[2]="keydown"==b.type?-1:0:83==b.keyCode?this._moving[2]="keydown"==b.type?1:0:65==b.keyCode?this._moving[0]="keydown"==b.type?-1:0:68==b.keyCode?this._moving[0]="keydown"==b.type?1:0:16==b.keyCode&&(this._move_fast="keydown"==b.type?!0:!1))};LS.registerComponent(CameraController);function NodeManipulator(a){this.rot_speed=[1,1];this.smooth=!1;this.configure(a)}NodeManipulator.icon="mini-icon-rotator.png";
NodeManipulator.prototype.onAddedToNode=function(a){a.interactive=!0;LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"update",this.onUpdate,this)};NodeManipulator.prototype.onUpdate=function(a){this._root&&this._root.transform&&this.smooth&&Scene.refresh()};NodeManipulator.prototype.onMouse=function(a,b){this._root&&this._root.transform&&b.dragging&&(this._root.transform.rotate(b.deltax*this.rot_speed[0],[0,1,0]),this._root.transform.rotateLocal(-b.deltay*this.rot_speed[1],[1,0,0]))};LS.registerComponent(NodeManipulator);
function FaceTo(a){this.scale=1;this.target=null;this.reverse=this.cylindrical=!1}FaceTo.icon="mini-icon-billboard.png";FaceTo["@target"]={type:"node"};FaceTo.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updateOrientation,this)};
FaceTo.prototype.updateOrientation=function(a,b){if(this._root){var c=this._root._on_scene,d=null;if(this.target){d=c.getNode(this.target);if(!d)return;d=d.transform.getPosition()}else d=b.camera.getEye();var c=this._root.transform.getPosition(),e=b.camera.getLocalVector([0,1,0]);this.cylindrical&&(d[1]=c[1],e.set([0,1,0]));this.reverse||vec3.subtract(d,c,d);this._root.transform.lookAt(c,d,e);this._root.transform.setScale(this.scale)}};LS.registerComponent(FaceTo);
function FogFX(a){this.enabled=!0;this.start=100;this.end=1E3;this.density=0.001;this.type=FogFX.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);a&&this.configure(a)}FogFX.icon="mini-icon-fog.png";FogFX.LINEAR=1;FogFX.EXP=2;FogFX.EXP2=3;FogFX["@color"]={type:"color"};FogFX["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};FogFX["@type"]={type:"enum",values:{linear:FogFX.LINEAR,exponential:FogFX.EXP,"exponential 2":FogFX.EXP2}};
FogFX.prototype.onAddedToNode=function(a){LEvent.bind(Scene,"fillLightUniforms",this.fillUniforms,this);LEvent.bind(Scene,"fillMacros",this.fillMacros,this)};FogFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"fillLightUniforms",this.fillUniforms,this);LEvent.unbind(Scene,"fillMacros",this.fillMacros,this)};FogFX.prototype.fillUniforms=function(a,b){this.enabled&&(b.uniforms.u_fog_info=[this.start,this.end,this.density],b.uniforms.u_fog_color=b.light==b.lights[0]?this.color:[0,0,0])};
FogFX.prototype.fillMacros=function(a,b){if(this.enabled){var c=b.macros;c.USE_FOG="";switch(this.type){case FogFX.EXP:c.USE_FOG_EXP="";break;case FogFX.EXP2:c.USE_FOG_EXP2=""}}};LS.registerComponent(FogFX);function FollowNode(a){this.node_name="";this.follow_camera=this.fixed_y=!1;a&&this.configure(a)}FollowNode.icon="mini-icon-follow.png";FollowNode.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updatePosition,this)};
FollowNode.prototype.updatePosition=function(a,b){if(this._root){var c=null;if(this.follow_camera)c=b.camera.getEye();else{c=Scene.getNode(this.node_name);if(!c)return;c=c.transform.getPosition()}this.fixed_y&&(c[1]=this._root.transform._position[1]);this._root.transform.setPosition(c)}};LS.registerComponent(FollowNode);
function GeometricPrimitive(a){this.two_sided=!1;this.geometry=GeometricPrimitive.CUBE;this.align_z=!1;GeometricPrimitive.MESHES||(GeometricPrimitive.MESHES={});a&&this.configure(a)}GeometricPrimitive.CUBE=1;GeometricPrimitive.PLANE=2;GeometricPrimitive.CYLINDER=3;GeometricPrimitive.SPHERE=4;GeometricPrimitive.MESHES=null;GeometricPrimitive.icon="mini-icon-cube.png";
GeometricPrimitive["@geometry"]={type:"enum",values:{Cube:GeometricPrimitive.CUBE,Plane:GeometricPrimitive.PLANE,Cylinder:GeometricPrimitive.CYLINDER,Sphere:GeometricPrimitive.SPHERE}};GeometricPrimitive.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};GeometricPrimitive.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
GeometricPrimitive.prototype.configure=function(a){cloneObject(a,this)};GeometricPrimitive.prototype.serialize=function(){return cloneObject(this)};
GeometricPrimitive.prototype.onCollectInstances=function(a,b){var c=null;if(this._root){if(this.geometry==GeometricPrimitive.CUBE)GeometricPrimitive.MESHES[GeometricPrimitive.CUBE]||(GeometricPrimitive.MESHES[GeometricPrimitive.CUBE]=GL.Mesh.cube({normals:!0,coords:!0})),c=GeometricPrimitive.MESHES[GeometricPrimitive.CUBE];else if(this.geometry==GeometricPrimitive.PLANE)GeometricPrimitive.MESHES[GeometricPrimitive.PLANE]||(GeometricPrimitive.MESHES[GeometricPrimitive.PLANE]=GL.Mesh.plane({xz:!0,normals:!0,
coords:!0})),c=GeometricPrimitive.MESHES[GeometricPrimitive.PLANE];else if(this.geometry==GeometricPrimitive.CYLINDER)GeometricPrimitive.MESHES[GeometricPrimitive.CYLINDER]||(GeometricPrimitive.MESHES[GeometricPrimitive.CYLINDER]=GL.Mesh.cylinder({normals:!0,coords:!0})),c=GeometricPrimitive.MESHES[GeometricPrimitive.CYLINDER];else if(this.geometry==GeometricPrimitive.SPHERE)GeometricPrimitive.MESHES[GeometricPrimitive.SPHERE]||(GeometricPrimitive.MESHES[GeometricPrimitive.SPHERE]=GL.Mesh.sphere({"long":32,
lat:32,normals:!0,coords:!0})),c=GeometricPrimitive.MESHES[GeometricPrimitive.SPHERE];else return null;var d=this._render_instance||new RenderInstance(this._root,this);this._root.transform.getGlobalMatrix(d.matrix);this.align_z&&mat4.rotateX(d.matrix,d.matrix,-0.5*Math.PI);mat4.multiplyVec3(d.center,d.matrix,vec3.create());this._root.mesh=c;d.mesh=c;d.material=this.material||this._root.getMaterial();this.two_sided&&d.enableFlag(RenderInstance.TWO_SIDED);b.push(d)}};LS.registerComponent(GeometricPrimitive);
function GraphComponent(a){this.force_redraw=this.enabled=!0;this.on_event="update";this._graph=new LGraph;a?this.configure(a):(a=LiteGraph.createNode("scene/node"),this._graph.add(a))}GraphComponent["@on_event"]={type:"enum",values:["start","update"]};GraphComponent.icon="mini-icon-graph.png";GraphComponent.prototype.configure=function(a){this.enabled=!!a.enabled;if(a.graph_data)try{var b=JSON.parse(a.graph_data);this._graph.configure(b)}catch(c){console.err("Error parsing Graph data")}};
GraphComponent.prototype.serialize=function(){return{enabled:this.enabled,force_redraw:this.force_redraw,graph_data:JSON.stringify(this._graph.serialize())}};GraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;this._onStart_bind=this.onStart.bind(this);this._onUpdate_bind=this.onUpdate.bind(this);LEvent.bind(a,"start",this._onStart_bind);LEvent.bind(a,"update",this._onUpdate_bind)};
GraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"start",this._onStart_bind);LEvent.unbind(a,"update",this._onUpdate_bind)};GraphComponent.prototype.onStart=function(a){"start"==this.on_event&&this.runGraph()};GraphComponent.prototype.onUpdate=function(a,b){"update"==this.on_event&&this.runGraph()};GraphComponent.prototype.runGraph=function(){this._root._on_tree&&this.enabled&&(this._graph&&this._graph.runStep(1),this.force_redraw&&LEvent.trigger(this._root._on_tree,"change"))};
LS.registerComponent(GraphComponent);window.GraphComponent=GraphComponent;
function FXGraphComponent(a){this.enabled=!0;this.use_antialiasing=this.use_high_precision=this.use_viewport_size=!1;this._graph=new LGraph;a?this.configure(a):(this._graph_color_texture_node=LiteGraph.createNode("texture/texture","Color Buffer"),this._graph_color_texture_node.ignore_remove=!0,this._graph_depth_texture_node=LiteGraph.createNode("texture/texture","Depth Buffer"),this._graph_depth_texture_node.ignore_remove=!0,this._graph_depth_texture_node.pos[1]=200,this._graph.add(this._graph_color_texture_node),
this._graph.add(this._graph_depth_texture_node),this._graph_viewport_node=LiteGraph.createNode("texture/toviewport","Viewport"),this._graph_viewport_node.pos[0]=200,this._graph.add(this._graph_viewport_node),this._graph_color_texture_node.connect(0,this._graph_viewport_node));null==FXGraphComponent.high_precision_format&&(FXGraphComponent.high_precision_format=gl.HALF_FLOAT_OES)}FXGraphComponent.icon="mini-icon-graph.png";FXGraphComponent.buffer_size=[1024,512];
FXGraphComponent.prototype.configure=function(a){a.graph_data&&(this.enabled=!!a.enabled,this.use_viewport_size=!!a.use_viewport_size,this.use_high_precision=!!a.use_high_precision,this.use_antialiasing=!!a.use_antialiasing,this._graph.configure(JSON.parse(a.graph_data)),this._graph_color_texture_node=this._graph.findNodesByName("Color Buffer")[0],this._graph_depth_texture_node=this._graph.findNodesByName("Depth Buffer")[0],this._graph_viewport_node=this._graph.findNodesByName("Viewport")[0])};
FXGraphComponent.prototype.serialize=function(){return{enabled:this.enabled,use_antialiasing:this.use_antialiasing,use_high_precision:this.use_high_precision,use_viewport_size:this.use_viewport_size,graph_data:JSON.stringify(this._graph.serialize())}};FXGraphComponent.prototype.getResources=function(a){var b=this._graph.findNodesByType("texture/texture"),c;for(c in b)b[c].properties.name&&(a[b[c].properties.name]=Texture);return a};
FXGraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;this._onBeforeRender_bind=this.onBeforeRender.bind(this);LEvent.bind(Scene,"beforeRender",this._onBeforeRender_bind);this._onAfterRender_bind=this.onAfterRender.bind(this);LEvent.bind(Scene,"afterRender",this._onAfterRender_bind)};
FXGraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"beforeRender",this._onBeforeRender_bind);LEvent.unbind(Scene,"afterRender",this._onAfterRender_bind);Renderer.color_rendertarget=null;Renderer.depth_rendertarget=null};
FXGraphComponent.prototype.onBeforeRender=function(a,b){if(this._graph){var c=!1;this._graph_depth_texture_node&&this._graph_depth_texture_node.isOutputConnected(0)&&(c=!0);var d=FXGraphComponent.buffer_size[0],e=FXGraphComponent.buffer_size[1];this.use_viewport_size&&(e=gl.getParameter(gl.VIEWPORT),d=e[2],e=e[3]);var f=this.use_high_precision?FXGraphComponent.high_precision_format:gl.UNSIGNED_BYTE;gl.half_float_ext||(f=gl.UNSIGNED_BYTE);this.color_texture&&this.color_texture.width==d&&this.color_texture.height==
e&&this.color_texture.type==f||(this.color_texture=new GL.Texture(d,e,{format:gl.RGB,filter:gl.LINEAR,type:f}),ResourcesManager.textures[":color_buffer"]=this.color_texture);this.depth_texture&&this.depth_texture.width==d&&this.depth_texture.height==e||!c||(this.depth_texture=new GL.Texture(d,e,{filter:gl.NEAREST,format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_SHORT}),ResourcesManager.textures[":depth_buffer"]=this.depth_texture);this.enabled?(Renderer.color_rendertarget=this.color_texture,Renderer.depth_rendertarget=
c?this.depth_texture:null):(Renderer.color_rendertarget=null,Renderer.depth_rendertarget=null)}};
FXGraphComponent.prototype.onAfterRender=function(a,b){this._graph&&this.enabled&&(this._graph_color_texture_node||(this._graph_color_texture_node=this._graph.findNodesByName("Color Buffer")[0]),this._depth_depth_texture_node||(this._depth_depth_texture_node=this._graph.findNodesByName("Depth Buffer")[0]),this._graph_color_texture_node&&(this._graph_color_texture_node.properties.name=":color_buffer",this._graph_depth_texture_node&&(this._graph_depth_texture_node.properties.name=":depth_buffer"),this._graph_viewport_node&&
(this._graph_viewport_node.properties.antialiasing=this.use_antialiasing),this._graph.runStep(1)))};LS.registerComponent(FXGraphComponent);window.FXGraphComponent=FXGraphComponent;function KnobComponent(a){this.value=a.value||0;this.delta=a.delta||0.01;this.steps=a.steps||0;this.min_value=a.min_value||0;this.max_value=a.max_value||1;this.min_angle=a.min_angle||-120;this.max_angle=a.max_angle||120;this.axis=a.axis||[0,0,1];a&&this.configure(a)}KnobComponent.icon="mini-icon-knob.png";
KnobComponent.prototype.configure=function(a){cloneObject(a,this)};KnobComponent.prototype.serialize=function(){return cloneObject(this)};KnobComponent.prototype.onAddedToNode=function(a){a.interactive=!0;LEvent.bind(a,"mousemove",this.onmousemove,this);this.updateKnob()};
KnobComponent.prototype.updateKnob=function(){this._root&&(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+(this.max_angle-this.min_angle)*(this.value/(this.max_value-this.min_value)))*DEG2RAD),this._root.transform._dirty=!0)};
KnobComponent.prototype.onmousemove=function(a,b){this.value-=b.deltay*this.delta;this.value>this.max_value?this.value=this.max_value:this.value<this.min_value&&(this.value=this.min_value);this.updateKnob();LEvent.trigger(this,"change",this.value);this._root&&LEvent.trigger(this._root,"knobChange",this.value);a.stopPropagation()};LS.registerComponent(KnobComponent);
function ParticleEmissor(a){this.max_particles=1024;this.warm_up_time=0;this.emissor_type=ParticleEmissor.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=[10,10,10];this.emissor_mesh=null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this.particle_start_color=[1,1,1];this.particle_end_color=[1,1,1];this.particle_opacity_curve=[[0.5,1]];this.texture_grid_size=1;this.physics_gravity=[0,0,0];this.physics_friction=0;this.opacity=
1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.stop_update=!1;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=
this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;this.createMesh()}ParticleEmissor.icon="mini-icon-particles.png";ParticleEmissor.BOX_EMISSOR=1;ParticleEmissor.SPHERE_EMISSOR=2;ParticleEmissor.MESH_EMISSOR=3;ParticleEmissor.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
ParticleEmissor.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this);LEvent.unbind(a,"start",this.onStart,this);LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ParticleEmissor.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};
ParticleEmissor.prototype.createParticle=function(a){a=a||{};switch(this.emissor_type){case ParticleEmissor.BOX_EMISSOR:a.pos=vec3.fromValues(this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5));break;case ParticleEmissor.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-1);a.pos=vec3.fromValues(Math.sin(c)*Math.cos(b),Math.sin(c)*Math.sin(b),Math.cos(c));vec3.multiply(a.pos,a.pos,this.emissor_size);break;
case ParticleEmissor.MESH_EMISSOR:(b=this.emissor_mesh)&&b.constructor==String&&(b=ResourcesManager.getMesh(this.emissor_mesh));b&&b.vertices?(c=3*Math.floor(Math.random()*b.vertices.length/3),a.pos=vec3.fromValues(b.vertices[c],b.vertices[c+1],b.vertices[c+2])):a.pos=vec3.create();break;default:a.pos=vec3.create()}vec3.add(a.pos,a.pos,this.follow_emitter?[0,0,0]:this._emissor_pos);a.vel=vec3.fromValues(Math.random()-0.5,Math.random()-0.5,Math.random()-0.5);a.life=this.particle_life;a.id=this._last_id;
a.angle=0;a.rot=this.particle_rotation+0.25*this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a.vel,a.vel,this.particle_speed);return a};ParticleEmissor.prototype.onStart=function(a){if(!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};
ParticleEmissor.prototype.onUpdate=function(a,b,c){this._root.transform.getPositionGlobal(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var d=vec3.clone(this.physics_gravity),e=this.physics_friction;a=[];for(var f=vec3.create(),h=0;h<this._particles.length;++h){var g=this._particles[h];vec3.copy(f,g.vel);vec3.add(f,d,f);vec3.scale(f,f,b);e&&(f[0]-=f[0]*e,f[1]-=f[1]*e,f[2]-=f[2]*e);vec3.add(g.pos,f,g.pos);g.angle+=g.rot*b;g.life-=b;0<g.life&&a.push(g)}if(0!=this.emissor_rate)for(b=
(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),h=0;h<b;h++)g=this.createParticle(),a.length<this.max_particles&&a.push(g);this._particles=a}this.align_always||c||this.updateMesh(Scene.current_camera);LEvent.trigger(Scene,"change")};
ParticleEmissor.prototype.createMesh=function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);for(var a=0;a<this.max_particles;a++)this._coords.set([1,1,0,1,1,0,0,1,0,0,1,0],12*a),this._colors.set([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],24*a);this._computed_grid_size=1;this._mesh=Mesh.load({vertices:this._vertices,coords:this._coords,
colors:this._colors,stream_type:gl.STREAM_DRAW});this._mesh_maxparticles=this.max_particles}};
ParticleEmissor.prototype.updateMesh=function(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,d=a.getLocalVector([0,0,1]),e=a.getLocalVector([1,0,0]),f=a.getLocalVector([0,1,0]);a=vec3.create();var h=vec3.fromValues(-1,0,-1),g=vec3.fromValues(1,0,-1),k=vec3.fromValues(-1,0,1),m=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(h,f,e),vec3.add(g,f,e),vec3.scale(k,g,-1),vec3.scale(m,h,-1));var e=vec3.create(),f=vec3.create(),n=
vec3.create(),l=vec3.create(),r=this._particles;if(this.sort_in_z){for(var r=this._particles.concat(),p=geo.createPlane(b,d),t=Math.sqrt(p[0]*p[0]+p[1]*p[1]+p[2]*p[2]),b=0;b<r.length;++b)r[b]._dist=Math.abs(vec3.dot(r[b].pos,p)+p[3])/t;r.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0});this._particles=r}0==this.particle_life&&(this.particle_life=1E-4);var p=new Float32Array([1,1,1,1]),t=new Float32Array(this.particle_start_color),w=new Float32Array(this.particle_end_color),s=!1;
(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size)&&!this.stop_update&&(s=!0,this._computed_grid_size=this.texture_grid_size);for(var u=1/this.texture_grid_size,q=0,v=0,D=this.texture_grid_size<<2,H=this.animated_texture,E=this.loop_animation,F=Scene._global_time*this.animation_fps,A=new Float32Array(60*this.particle_life<<0),C=new Float32Array(60*this.particle_life<<0),B=1/(60*this.particle_life),b=0;b<A.length;b+=1)A[b]=LS.getCurveValueAt(this.particle_opacity_curve,0,
1,0,b*B),C[b]=LS.getCurveValueAt(this.particle_size_curve,0,1,0,b*B);for(var B=quat.create(),x=q=b=0;x<r.length;++x)if(v=r[x],!(0>=v.life)){var q=1-v.life/this.particle_life,z=A[q*A.length<<0];this.independent_color&&v.c?vec3.clone(p,v.c):vec3.lerp(p,t,w,q);this.premultiplied_alpha?(vec3.scale(p,p,z),p[3]=1):p[3]=z;if(!(0.001>z)&&(z=this.particle_size*C[q*C.length<<0],!(Math.abs(z)<c)&&(vec3.scale(n,k,z),vec3.scale(f,g,z),vec3.scale(e,h,z),vec3.scale(l,m,z),0!=v.angle&&(quat.setAxisAngle(B,d,v.angle*
DEG2RAD),vec3.transformQuat(n,n,B),vec3.transformQuat(f,f,B),vec3.transformQuat(e,e,B),vec3.transformQuat(l,l,B)),vec3.add(a,v.pos,f),this._vertices.set(a,18*b),vec3.add(a,v.pos,e),this._vertices.set(a,18*b+3),vec3.add(a,v.pos,l),this._vertices.set(a,18*b+6),vec3.add(a,v.pos,e),this._vertices.set(a,18*b+9),vec3.add(a,v.pos,n),this._vertices.set(a,18*b+12),vec3.add(a,v.pos,l),this._vertices.set(a,18*b+15),this._colors.set(p,24*b),this._colors.set(p,24*b+4),this._colors.set(p,24*b+8),this._colors.set(p,
24*b+12),this._colors.set(p,24*b+16),this._colors.set(p,24*b+20),s&&(q=(H?(E?F:q)*D<<0:v.id)%D*u,v=1-(q<<0)*u-u,q%=1,this._coords.set([q+u,v+u,q,v+u,q+u,v,q,v+u,q,v,q+u,v],12*b)),++b,18*b>=this._vertices.length)))break}this._visible_particles=b;this._mesh.vertexBuffers.a_vertex.data=this._vertices;this._mesh.vertexBuffers.a_color.data=this._colors;this._mesh.vertexBuffers.a_vertex.compile();this._mesh.vertexBuffers.a_color.compile();s&&(this._mesh.vertexBuffers.a_coord.data=this._coords,this._mesh.vertexBuffers.a_coord.compile())};
ParticleEmissor._identity=mat4.create();
ParticleEmissor.prototype.onCollectInstances=function(a,b,c,d){if(this._root){this.align_always&&this.updateMesh(d);this._material||(this._material=new Material({opacity:this.opacity-0.01,shader:"lowglobalshader"}));this._material.opacity=this.opacity-0.01;this._material.setTexture(this.texture);this._material.blending=this.additive_blending?Material.ADDITIVE_BLENDING:Material.NORMAL;this._material.soft_particles=this.soft_particles;this._material.constant_diffuse=!0;if(!this._mesh)return null;a=
this._render_instance||new RenderInstance(this._root,this);this.follow_emitter?mat4.translate(a.matrix,ParticleEmissor._identity,this._root.transform._position):mat4.copy(a.matrix,ParticleEmissor._identity);a.mesh=this._mesh;a.material=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;a.length=6*this._visible_particles;mat4.multiplyVec3(a.center,a.matrix,vec3.create());b.push(a)}};LS.registerComponent(ParticleEmissor);
function RealtimeReflector(a){this.texture_size=512;this.brightness_factor=1;this.colorclip_factor=0;this.clip_offset=0.5;this.rt_name="";this.use_mesh_info=this.use_cubemap=!1;this.refresh_rate=1;this._rt=null;a&&this.configure(a)}RealtimeReflector.icon="mini-icon-reflector.png";RealtimeReflector["@texture_size"]={type:"enum",values:[64,128,256,512,1024,2048]};
RealtimeReflector.prototype.onAddedToNode=function(a){this._bind_onRenderRT||(this._bind_onRenderRT=this.onRenderRT.bind(this));LEvent.bind(a,"afterRenderShadows",this._bind_onRenderRT,this)};RealtimeReflector.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"afterRenderShadows",this._bind_onRenderRT,this)};
RealtimeReflector.prototype.onRenderRT=function(a,b){if(this._root&&(this.refresh_rate<<=0,0!=Scene._frame&&0==Scene._frame%this.refresh_rate||!this._rt)){isPowerOfTwo(this.texture_size)||(this.texture_size=256);var c=this.use_cubemap?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;this._rt&&this._rt.width==this.texture_size&&this._rt.texture_type==c||(this._rt=new Texture(this.texture_size,this.texture_size,{texture_type:c}));var c=this._root.transform.getPositionGlobal(),d=this._root.transform.getTop();if(this.use_mesh_info){var e=
this._root.getMesh();e&&(c=this._root.transform.transformPointGlobal([e.vertices[0],e.vertices[1],e.vertices[2]]),d=this._root.transform.transformVectorGlobal([e.normals[0],e.normals[1],e.normals[2]]))}var e=new Camera(b.serialize()),f=this._root.flags.visible;this._root.flags.visible=!1;this.use_cubemap?(e.eye=c,Renderer.renderSceneMeshesToRT(e,this._rt,{is_rt:!0,is_reflection:!0,brightness_factor:this.brightness_factor,colorclip_factor:this.colorclip_factor})):(e.fov=b.fov,e.aspect=b.aspect,e.eye=
geo.reflectPointInPlane(b.eye,c,d),e.center=geo.reflectPointInPlane(b.center,c,d),e.up=geo.reflectPointInPlane(b.up,[0,0,0],d),vec3.add(c,c,vec3.scale(vec3.create(),d,-this.clip_offset)),c=[d[0],d[1],d[2],vec3.dot(c,d)],Renderer.renderSceneMeshesToRT(e,this._rt,{clipping_plane:c,is_rt:!0,is_reflection:!0,brightness_factor:this.brightness_factor,colorclip_factor:this.colorclip_factor}));this._root.flags.visible=f;this.rt_name&&ResourcesManager.registerResource(this.rt_name,this._rt);this._root.material&&
this._root.material.setTexture(this.rt_name?this.rt_name:this._rt,Material.ENVIRONMENT_TEXTURE,Material.COORDS_SCREEN)}};LS.registerComponent(RealtimeReflector);function ScriptComponent(a){this.enabled=!0;this.code="function update(dt)\n{\n\tScene.refresh();\n}";this._component=null;this.configure(a);this.code&&this.processCode()}ScriptComponent.icon="mini-icon-script.png";ScriptComponent["@code"]={type:"script"};ScriptComponent.valid_callbacks=["start","update"];
ScriptComponent.prototype.processCode=function(){var a=this.component_name||"__last_component",b=this.code,c="",d;for(d in ScriptComponent.valid_callbacks)c+="\tif(typeof("+ScriptComponent.valid_callbacks[d]+") != 'undefined') this."+ScriptComponent.valid_callbacks[d]+" = "+ScriptComponent.valid_callbacks[d]+";\n";b="function "+a+"(component, node) {\n"+b+"\n"+(c+("\n}\nwindow."+a+" = "+a+";\n"));try{this._last_executed_code=b,eval(b),this._component_class=window[a],this._component=new this._component_class(this,
this._root)}catch(e){this._component=this._component_class=null,trace("Error in script\n"+e),trace(this._last_executed_code)}};ScriptComponent.prototype.onAddedToNode=function(a){this._onStart_bind=this.onStart.bind(this);this._onUpdate_bind=this.onUpdate.bind(this);LEvent.bind(Scene,"start",this._onStart_bind);LEvent.bind(Scene,"update",this._onUpdate_bind)};ScriptComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"start",this._onStart_bind);LEvent.unbind(Scene,"update",this._onUpdate_bind)};
ScriptComponent.prototype.onStart=function(){this.processCode();this.enabled&&this._component&&this._component.start&&this._component.start()};ScriptComponent.prototype.onUpdate=function(a,b){this.enabled&&this._component&&this._component.update&&this._component.update(b)};LS.registerComponent(ScriptComponent);function TerrainRenderer(a){this.height=2;this.subdivisions=this.size=10;this.heightmap=null;this.auto_update=!0;this._mesh=null;this.action="Update";a&&this.configure(a)}
TerrainRenderer.icon="mini-icon-terrain.png";TerrainRenderer.prototype.configure=function(a){cloneObject(a,this)};TerrainRenderer.prototype.serialize=function(){return cloneObject(this)};TerrainRenderer.prototype.getResources=function(a){this.heightmap&&(a[this.heightmap]=Texture)};TerrainRenderer["@subdivisions"]={widget:"number",min:1,max:255,step:1};TerrainRenderer["@heightmap"]={widget:"texture"};TerrainRenderer["@action"]={widget:"button",callback:function(){this.options.component.updateMesh()}};
TerrainRenderer.prototype.updateMesh=function(){trace("updating terrain mesh...");if(this.heightmap){var a="string"==typeof this.heightmap?ResourcesManager.textures[this.heightmap]:this.heightmap;if(a){var b=a.img;if(b){this.subdivisions>b.width&&(this.subdivisions=b.width);this.subdivisions>b.height&&(this.subdivisions=b.height);255<this.subdivisions&&(this.subdivisions=255);var a=this.size,c=this.subdivisions<<0,d=this.height,e=createCanvas(c,c),f=e.getContext("2d");f.drawImage(b,0,0,b.width,b.height,
0,0,e.width,e.height);for(var b=f.getImageData(0,0,e.width,e.height).data,e=[],f=[],h=[],g=[],k=detailX=c-1,m,n=a/(c-1),l=0;l<=k;l++)for(var r=l/k,p=0;p<=detailX;p++){var t=p/detailX;m=b[4*l*c+4*p]/255;f.push(a*(2*t-1),m*d,a*(2*r-1));g.push(t,1-r);0==p||0==l||p==detailX-1||l==k-1?h.push(0,1,0):(m=[-(b[4*l*c+4*(p+1)]/255-b[4*l*c+4*(p-1)]/255)*d,2*n,-(b[4*(l+1)*c+4*p]/255-b[4*(l-1)*c+4*p]/255)*d],vec3.normalize(m,m),h.push(m[0],m[1],m[2]));p<detailX&&l<k&&(m=p+l*(detailX+1),e.push(m+1,m,m+detailX+1),
e.push(m+1,m+detailX+1,m+detailX+2))}this._mesh=Mesh.load({triangles:e,vertices:f,normals:h,coords:g});this._info=[this.heightmap,this.size,this.height,this.subdivisions,this.smooth]}}}};TerrainRenderer.PLANE=null;
TerrainRenderer.prototype.getRenderInstance=function(){!this._mesh&&this.heightmap&&this.updateMesh();this.auto_update&&this._info&&(this._info[0]==this.heightmap&&this._info[1]==this.size&&this._info[2]==this.height&&this._info[3]==this.subdivisions&&this._info[4]==this.smooth||this.updateMesh());var a=this._render_instance||new RenderInstance;if(!this._mesh)return TerrainRenderer.PLANE||(TerrainRenderer.PLANE=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),a.mesh=TerrainRenderer.PLANE,a;a.mesh=this._mesh;
this._root.transform.getGlobalMatrix(a.matrix);mat4.multiplyVec3(a.center,a.matrix,vec3.create());return a};LS.registerComponent(TerrainRenderer);function Cloner(a){this.count=[10,1,1];this.size=[100,100,100];this.material=this.lod_mesh=this.mesh=null;this.mode=Cloner.GRID_MODE;a&&this.configure(a);Cloner._identity||(Cloner._identity=mat4.create())}Cloner.GRID_MODE=1;Cloner.RADIAL_MODE=2;Cloner.icon="mini-icon-teapot.png";Cloner["@mesh"]={widget:"mesh"};Cloner["@lod_mesh"]={widget:"mesh"};
Cloner["@mode"]={widget:"combo",values:{Grid:1,Radial:2}};Cloner["@count"]={widget:"vector3",min:1,step:1};Cloner.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Cloner.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Cloner.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};
Cloner.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};Cloner.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};
Cloner.prototype.onCollectInstances=function(a,b){var c=this.getMesh();if(!c)return null;if(this._root){var d=this.count[0]*this.count[1]*this.count[2];if(!this._RIs||this._RIs.length!=d){this._RIs?this._RIs.length=d:this._RIs=Array(d);for(var e=0;e<d;++e)this._RIs[e]||(this._RIs[e]=new RenderInstance(this._root,this))}var d=this._RIs,f=this._root.transform.getGlobalMatrix(mat4.create()),h=this.material||this._root.getMaterial(),g=vec3.scale(vec3.create(),this.size,0.5),k=[0,0,0];1<this.count[0]?
k[0]=this.size[0]/(this.count[0]-1):g[0]=0;1<this.count[1]?k[1]=this.size[1]/(this.count[1]-1):g[1]=0;1<this.count[2]?k[2]=this.size[2]/(this.count[2]-1):g[2]=0;for(var e=0,m=vec3.create(),n=vec3.create(),l=0;l<this.count[0];++l)for(var r=0;r<this.count[1];++r)for(var p=0;p<this.count[2];++p){var t=d[e];t.mesh=c;t.material=h;m.set([l*k[0]-g[0],r*k[1]-g[1],p*k[2]-g[2]]);mat4.translate(t.matrix,f,m);mat4.multiplyVec3(t.center,t.matrix,n);++e;b.push(t)}}};LS.registerComponent(Cloner);LS.Cloner=Cloner;
if("undefined"!=typeof LiteGraph){var LGraphTransform=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id);this.addInput("Transform","Transform");this.addOutput("Position","vec3")};LGraphTransform.title="Transform";LGraphTransform.desc="Transform info of a node";LGraphTransform.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);
for(var b in this.inputs){var c=this.inputs[b],d=this.getInputData(b);if(void 0!=d)switch(c.name){case "Position":a.transform.setPosition(d);break;case "Rotation":a.transform.setRotation(d);break;case "Scale":a.transform.setScale(d)}}for(b in this.outputs)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Position":this.setOutputData(b,a.transform.getPosition());break;case "Rotation":this.setOutputData(b,a.transform.getRotation());break;case "Scale":this.setOutputData(b,a.transform.getScale(scale))}};
LGraphTransform.prototype.onGetInputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LGraphTransform.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LiteGraph.registerNodeType("scene/transform",LGraphTransform);window.LGraphTransform=LGraphTransform;var LGraphSceneNode=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id)};
LGraphSceneNode.title="SceneNode";LGraphSceneNode.desc="Node on the scene";LGraphSceneNode.prototype.getNode=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);return a};LGraphSceneNode.prototype.onExecute=function(){var a=this.getNode(),b;for(b in this.inputs){var c=this.inputs[b],d=this.getInputData(b);if(void 0!=d)switch(c.name){case "Transform":a.transform.copyFrom(d);break;case "Material":a.material=d;break;case "Visible":a.flags.visible=
d}}for(b in this.outputs)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Transform":this.setOutputData(b,a.getTransform());break;case "Material":this.setOutputData(b,a.getMaterial());break;case "Light":this.setOutputData(b,a.getLight());break;case "Camera":this.setOutputData(b,a.getCamera());break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible)}};LGraphSceneNode.prototype.onGetInputs=function(){return[["Transform","Transform"],
["Material","Material"],["Mesh","Mesh"],["Enabled","boolean"]]};LGraphSceneNode.prototype.onGetOutputs=function(){var a=[["Transform","Transform"],["Material","Material"],["Mesh","Mesh"],["Enabled","boolean"]],b=this.getNode();b.light&&a.push(["Light","Light"]);b.camera&&a.push(["Camera","Camera"]);return a};LiteGraph.registerNodeType("scene/node",LGraphSceneNode);window.LGraphSceneNode=LGraphSceneNode;var LGraphMaterial=function(){this.properties={mat_name:""};this.addInput("Material","Material");
this.size=[100,20]};LGraphMaterial.title="Material";LGraphMaterial.desc="Material of a node";LGraphMaterial.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);var b=null;a&&(b=a.getMaterial());a=this.findInputSlot("Material");-1!=a&&(b=this.getInputData(a));b||(b=new Material);for(var c in this.inputs){var d=this.inputs[c],a=this.getInputData(c);if(void 0!=a)switch(d.name){case "Alpha":b.alpha=a;break;case "Specular f.":b.specular_factor=
a;break;case "Diffuse":vec3.copy(b.diffuse,a);break;case "Ambient":vec3.copy(b.ambient,a);break;case "Emissive":vec3.copy(b.emissive,a);break;case "UVs trans.":b.uvs_matrix.set(a);break;default:"Tex."==d.name.substr(0,4)&&(d=d.name.substr(4),b.setTexture(a,d))}}for(c in this.outputs)if(a=this.outputs[c],a.links&&a.links.length){switch(a.name){case "Material":a=b;break;case "Alpha":a=b.alpha;break;case "Specular f.":a=b.specular_factor;break;case "Diffuse":a=b.diffuse;break;case "Ambient":a=b.ambient;
break;case "Emissive":a=b.emissive;break;case "UVs trans.":a=b.uvs_matrix;break;default:continue}this.setOutputData(c,a)}};LGraphMaterial.prototype.onGetInputs=function(){var a=[["Material","Material"],["Alpha","number"],["Specular f.","number"],["Diffuse","color"],["Ambient","color"],["Emissive","color"],["UVs trans.","texmatrix"]],b;for(b in Material.TEXTURE_CHANNELS)a.push(["Tex."+Material.TEXTURE_CHANNELS[b],"Texture"]);return a};LGraphMaterial.prototype.onGetOutputs=function(){var a=[["Material",
"Material"],["Alpha","number"],["Specular f.","number"],["Diffuse","color"],["Ambient","color"],["Emissive","color"],["UVs trans.","texmatrix"]],b;for(b in Material.TEXTURE_CHANNELS)a.push(["Tex."+Material.TEXTURE_CHANNELS[b],"Texture"]);return a};LiteGraph.registerNodeType("scene/material",LGraphMaterial);window.LGraphMaterial=LGraphMaterial;var LGraphLight=function(){this.properties={mat_name:""};this.addInput("Light","Light");this.addOutput("Intensity","number");this.addOutput("Color","color")};
LGraphLight.title="Light";LGraphLight.desc="Light from a scene";LGraphLight.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);var b=null;a&&(b=a.getLight());a=this.findInputSlot("Light");-1!=a&&(b=this.getInputData(a));if(b){for(var c in this.inputs){var a=this.inputs[c],d=this.getInputData(c);if(void 0!=d)switch(a.name){case "Intensity":b.intensity=d;break;case "Color":vec3.copy(b.color,d);break;case "Eye":vec3.copy(b.eye,
d);break;case "Center":vec3.copy(b.center,d)}}for(c in this.outputs)if(a=this.outputs[c],a.links&&a.links.length)switch(a.name){case "Light":this.setOutputData(c,b);break;case "Intensity":this.setOutputData(c,b.intensity);break;case "Color":this.setOutputData(c,b.color);break;case "Eye":this.setOutputData(c,b.eye);break;case "Center":this.setOutputData(c,b.center)}}};LGraphLight.prototype.onGetInputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center",
"vec3"]]};LGraphLight.prototype.onGetOutputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};LiteGraph.registerNodeType("scene/light",LGraphLight);window.LGraphLight=LGraphLight;var LGraphScene=function(){this.addOutput("Time","number")};LGraphScene.title="Scene";LGraphScene.desc="Scene";LGraphScene.prototype.onExecute=function(){for(var a in this.inputs){var b=this.inputs[a],c=this.getInputData(a);if(void 0!=c)switch(b.name){case "Ambient color":vec3.copy(Scene.ambient_color,
c);break;case "Bg Color":vec3.copy(Scene.background_color,c)}}for(a in this.outputs)if(b=this.outputs[a],b.links&&b.links.length)switch(b.name){case "Light":this.setOutputData(a,Scene.light);break;case "Camera":this.setOutputData(a,Scene.camera);break;case "Ambient color":this.setOutputData(a,Scene.ambient_color);break;case "Bg Color":this.setOutputData(a,Scene.background_color);break;case "Time":this.setOutputData(a,Scene._time);break;case "Elapsed":this.setOutputData(a,null!=Scene._last_dt?Scene._last_dt:
0);break;case "Frame":this.setOutputData(a,null!=Scene._frame?Scene._frame:0)}};LGraphScene.prototype.onGetOutputs=function(){return[["Light","Light"],["Camera","Camera"],["Ambient color","color"],["Bg Color","color"],["Elapsed","number"],["Frame","number"]]};LiteGraph.registerNodeType("scene/scene",LGraphScene);window.LGraphScene=LGraphScene;var LGraphGlobal=function(){this.addOutput("Value","number");this.properties={name:"myvar",value:0,min:0,max:1}};LGraphGlobal.title="Global";LGraphGlobal.desc=
"Global var for the graph";LGraphGlobal.prototype.onExecute=function(){this.properties.name&&this.setOutputData(0,this.properties.value)};LiteGraph.registerNodeType("scene/global",LGraphGlobal);window.LGraphGlobal=LGraphGlobal}
if("undefined"!=typeof LiteGraph){var LGraphTexture=function(){this.addOutput("Texture","Texture");this.properties={name:""}};LGraphTexture.title="Texture";LGraphTexture.desc="Texture";LGraphTexture.prototype.onExecute=function(){if(this.properties.name){var a=ResourcesManager.textures[this.properties.name];a||":"==this.properties.name[0]||ResourcesManager.loadImage(this.properties.name);this.setOutputData(0,a)}};LiteGraph.registerNodeType("texture/texture",LGraphTexture);window.LGraphTexture=LGraphTexture;
var LGraphTextureSave=function(){this.addInput("Texture","Texture");this.properties={name:""}};LGraphTextureSave.title="Save";LGraphTextureSave.desc="Save a texture in the repository";LGraphTextureSave.prototype.onExecute=function(){if(this.properties.name){var a=this.getInputData(0);a&&(ResourcesManager.textures[this.properties.name]=a)}};LiteGraph.registerNodeType("texture/save",LGraphTextureSave);window.LGraphTextureSave=LGraphTextureSave;var LGraphTextureOperation=function(){this.addInput("Texture",
"Texture");this.addInput("TextureB","Texture");this.addInput("value","number");this.addOutput("Texture","Texture");this.help="<p>pixelcode must be vec3</p>\t\t\t<p>uvcode must be vec2, is optional</p>\t\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture</p><p><strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time</p><p><strong>value:</strong> input value</p>";this.properties={value:1,uvcode:"",pixelcode:"color + colorB * value"};this.widgets_info={uvcode:{widget:"textarea",
height:100},pixelcode:{widget:"textarea",height:100}}};LGraphTextureOperation.title="Operation";LGraphTextureOperation.desc="Texture shader operation";LGraphTextureOperation.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var c=512,d=512,e=gl.UNSIGNED_BYTE;a?(c=a.width,d=a.height,e=a.type):b&&(c=b.width,d=b.height,e=b.type);this._tex&&this._tex.width==c&&this._tex.height==d&&this._tex.type==e||(this._tex=new GL.Texture(c,
d,{type:e,format:gl.RGBA,filter:gl.LINEAR}));e="";this.properties.uvcode&&(e="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(e=this.properties.uvcode));var f="";this.properties.pixelcode&&(f="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";")&&(f=this.properties.pixelcode));var h=this._shader;h&&this._shader_code==e+"|"+f||(this._shader=new GL.Shader(LGraphTextureOperation.vertex_shader,LGraphTextureOperation.pixel_shader,{UV_CODE:e,PIXEL_CODE:f}),
this._shader_code=e+"|"+f,h=this._shader);if(h){this.boxcolor="green";var g=this.getInputData(2);null!=g?this.properties.value=g:g=parseFloat(this.properties.value);this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a&&a.bind(0);b&&b.bind(1);var e=Mesh.getScreenQuad();h.uniforms({texture:0,textureB:1,value:g,texSize:[c,d],time:Scene._global_time-Scene._start_time}).draw(e)});this.setOutputData(0,this._tex)}else this.boxcolor="red"}};LGraphTextureOperation.vertex_shader=
"precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tcoord = a_coord; gl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureOperation.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D texture;\n\t\t\tuniform sampler2D textureB;\n\t\t\tvarying vec2 coord;\n\t\t\tuniform vec2 texSize;\n\t\t\tuniform float time;\n\t\t\tuniform float value;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = coord;\n\t\t\t\tUV_CODE;\n\t\t\t\tvec3 color = texture2D(texture, uv).rgb;\n\t\t\t\tvec3 colorB = texture2D(textureB, uv).rgb;\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tPIXEL_CODE;\n\t\t\t\tgl_FragColor = vec4(result, 1.0);\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/operation",LGraphTextureOperation);window.LGraphTextureOperation=LGraphTextureOperation;var LGraphTextureShader=function(){this.addOutput("Texture","Texture");this.properties={code:"",width:512,height:512};this.properties.code="\nvoid main() {\n  vec2 uv = coord;\n  vec3 color = vec3(0.0);\n//your code here\n\ngl_FragColor = vec4(color, 1.0);\n}\n";this.widgets_info={code:{widget:"textarea",height:100}}};LGraphTextureShader.title="Shader";LGraphTextureShader.desc=
"Texture shader";LGraphTextureShader.prototype.onExecute=function(){if(this._shader_code!=this.properties.code)if(this._shader_code=this.properties.code,this._shader=new GL.Shader(LGraphTextureShader.vertex_shader,LGraphTextureShader.pixel_shader+this.properties.code))this.boxcolor="green";else{this.boxcolor="red";return}this._tex&&this._tex.width==this.properties.width&&this._tex.height==this.properties.height||(this._tex=new GL.Texture(this.properties.width,this.properties.height,{format:gl.RGBA,
filter:gl.LINEAR}));var a=this._tex,b=this._shader;a.drawTo(function(){b.uniforms({texSize:[a.width,a.height],time:Scene._global_time-Scene._start_time}).draw(Mesh.getScreenQuad())});this.setOutputData(0,this._tex)};LGraphTextureShader.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tcoord = a_coord; gl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureShader.pixel_shader=
"precision highp float;\n\t\t\t\n\t\t\tvarying vec2 coord;\n\t\t\tuniform float time;\n\t\t\t";LiteGraph.registerNodeType("texture/shader",LGraphTextureShader);window.LGraphTextureShader=LGraphTextureShader;var LGraphTexturePreview=function(){this.addInput("Texture","Texture");this.properties={flipY:!1};this.size=[LGraphTexturePreview.img_size,LGraphTexturePreview.img_size]};LGraphTexturePreview.title="Preview";LGraphTexturePreview.desc="Show a texture in the graph canvas";LGraphTexturePreview.img_size=
256;LGraphTexturePreview.prototype.onDrawBackground=function(a){var b=this.getInputData(0);if(b){var c=LGraphTexturePreview.img_size,d=b;if(b.width>c||b.height>c)d=this._temp_tex,this._temp_tex||(this._temp_tex=d=new GL.Texture(c,c,{minFilter:gl.NEAREST})),b.copyTo(d);b=this._canvas;b||(this._canvas=b=createCanvas(c,c));d&&d.toCanvas(b);a.save();this.properties.flipY&&(a.translate(0,this.size[1]),a.scale(1,-1));a.drawImage(b,0,0,this.size[0],this.size[1]);a.restore()}};LiteGraph.registerNodeType("texture/preview",
LGraphTexturePreview);window.LGraphTexturePreview=LGraphTexturePreview;var LGraphTextureToViewport=function(){this.addInput("Texture","Texture");this.properties={additive:!1,antialiasing:!1};LGraphTextureToViewport._shader||(LGraphTextureToViewport._shader=new GL.Shader(LGraphTextureToViewport.vertex_shader,LGraphTextureToViewport.pixel_shader))};LGraphTextureToViewport.title="to Viewport";LGraphTextureToViewport.desc="Texture to viewport";LGraphTextureToViewport.prototype.onExecute=function(){var a=
this.getInputData(0);if(a)if(this.properties.additive?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)):gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this.properties.antialiasing){gl.getParameter(gl.VIEWPORT);a&&a.bind(0);var b=Mesh.getScreenQuad();LGraphTextureToViewport._shader.uniforms({texture:0,uViewportSize:[a.width,a.height],inverseVP:[1/a.width,1/a.height]}).draw(b)}else a.toViewport()};LGraphTextureToViewport.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureToViewport.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 uViewportSize;\n\t\t\tuniform vec2 inverseVP;\n\t\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\t\n\t\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t\t{\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\t\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\t\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\t\n\t\t\t\tvec2 dir;\n\t\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\t\n\t\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\t\n\t\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\t\t\t\t\n\t\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\t\t\t\t\n\t\t\t\treturn vec4(rgbA,1.0);\n\t\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\t\telse\n\t\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\t\treturn color;\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/toviewport",LGraphTextureToViewport);window.LGraphTextureToViewport=LGraphTextureToViewport;var LGraphTextureCopy=function(){this.addInput("Texture","Texture");this.addOutput("","Texture");this.properties={size:0,low_precision:!1}};LGraphTextureCopy.title="Copy";LGraphTextureCopy.desc="Copy Texture";LGraphTextureCopy.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=a.width,c=a.height;0!=this.properties.size&&(c=b=this.properties.size);var d=
this._temp_texture,e=this.properties.low_precision?gl.UNSIGNED_BYTE:a.type;d&&d.width==b&&d.height==c&&d.type==e||(this._temp_texture=new GL.Texture(b,c,{type:e,format:gl.RGBA,filter:gl.LINEAR}));a.copyTo(this._temp_texture);this.setOutputData(0,this._temp_texture)}};LiteGraph.registerNodeType("texture/copy",LGraphTextureCopy);window.LGraphTextureCopy=LGraphTextureCopy;var LGraphTextureChannels=function(){this.addInput("Texture","Texture");this.addOutput("R","Texture");this.addOutput("G","Texture");
this.addOutput("B","Texture");this.addOutput("A","Texture");this.properties={};LGraphTextureChannels._shader||(LGraphTextureChannels._shader=new GL.Shader(LGraphTextureChannels.vertex_shader,LGraphTextureChannels.pixel_shader))};LGraphTextureChannels.title="Channels";LGraphTextureChannels.desc="Split texture channels";LGraphTextureChannels.prototype.onExecute=function(){var a=this.getInputData(0);if(a){this._channels||(this._channels=Array(4));for(var b=0,c=0;4>c;c++)this.isOutputConnected(c)?(this._channels[c]&&
this._channels[c].width==a.width&&this._channels[c].height==a.height&&this._channels[c].type==a.type||(this._channels[c]=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR})),b++):this._channels[c]=null;if(b){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);for(var d=Mesh.getScreenQuad(),e=LGraphTextureChannels._shader,f=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],c=0;4>c;c++)this._channels[c]&&(this._channels[c].drawTo(function(){a.bind(0);e.uniforms({u_texture:0,u_mask:f[c]}).draw(d)}),
this.setOutputData(c,this._channels[c]))}}};LGraphTextureChannels.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureChannels.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/channels",LGraphTextureChannels);window.LGraphTextureChannels=LGraphTextureChannels;var LGraphTextureMix=function(){this.addInput("A","Texture");this.addInput("B","Texture");this.addInput("Mixer","Texture");this.addOutput("Texture","Texture");this.properties={};LGraphTextureMix._shader||(LGraphTextureMix._shader=new GL.Shader(LGraphTextureMix.vertex_shader,LGraphTextureMix.pixel_shader))};LGraphTextureMix.title="Mix";LGraphTextureMix.desc="Generates a texture mixing two textures";
LGraphTextureMix.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2);if(a&&b&&c){this._temp_texture&&this._temp_texture.width==a.width&&this._temp_texture.height==a.height&&this._temp_texture.type==a.type||(this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var d=Mesh.getScreenQuad(),e=LGraphTextureMix._shader;this._temp_texture.drawTo(function(){a.bind(0);
b.bind(1);c.bind(2);e.uniforms({u_textureA:0,u_textureB:1,u_textureMix:2}).draw(d)});this.setOutputData(0,this._temp_texture)}};LGraphTextureMix.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureMix.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_textureA;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform sampler2D u_textureMix;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), texture2D(u_textureMix, v_coord) );\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/mix",LGraphTextureMix);window.LGraphTextureMix=LGraphTextureMix;var LGraphTextureDepthRange=function(){this.addInput("Texture","Texture");this.addInput("Distance","number");this.addInput("Range","number");this.addOutput("Texture","Texture");this.properties={distance:100,range:50};LGraphTextureDepthRange._shader||(LGraphTextureDepthRange._shader=new GL.Shader(LGraphTextureDepthRange.vertex_shader,LGraphTextureDepthRange.pixel_shader))};LGraphTextureDepthRange.title=
"Depth Range";LGraphTextureDepthRange.desc="Generates a texture with a depth range";LGraphTextureDepthRange.prototype.onExecute=function(){var a=this.getInputData(0);if(a){this._temp_texture&&this._temp_texture.width==a.width&&this._temp_texture.height==a.height||(this._temp_texture=new GL.Texture(a.width,a.height,{format:gl.RGBA,filter:gl.LINEAR}));var b=this.properties.distance;this.isInputConnected(1)&&(b=this.getInputData(1),this.properties.distance=b);var c=this.properties.range;this.isInputConnected(2)&&
(c=this.getInputData(2),this.properties.range=c);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var d=Mesh.getScreenQuad(),e=LGraphTextureDepthRange._shader;this._temp_texture.drawTo(function(){a.bind(0);e.uniforms({texture:0,u_distance:b,u_range:c,u_camera_planes:[Renderer.active_camera.near,Renderer.active_camera.far]}).draw(d)});this.setOutputData(0,this._temp_texture)}};LGraphTextureDepthRange.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureDepthRange.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_distance;\n\t\t\tuniform float u_range;\n\t\t\t\n\t\t\tfloat LinearDepth()\n\t\t\t{\n\t\t\t\tfloat n = u_camera_planes.x;\n\t\t\t\tfloat f = u_camera_planes.y;\n\t\t\t\treturn (2.0 * n) / (f + n - texture2D(u_texture, v_coord).x * (f - n));\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat diff = abs(LinearDepth() * u_camera_planes.y - u_distance);\n\t\t\t\tfloat dof = 1.0;\n\t\t\t\tif(diff <= u_range)\n\t\t\t\t\tdof = diff / u_range;\n\t\t\t   gl_FragColor = vec4(dof);\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/depth_range",LGraphTextureDepthRange);window.LGraphTextureDepthRange=LGraphTextureDepthRange;var LGraphTextureBlur=function(){this.addInput("Texture","Texture");this.addInput("Iterations","number");this.addInput("Intensity","number");this.addOutput("Blurred","Texture");this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1]};LGraphTextureBlur._shader||(LGraphTextureBlur._shader=new GL.Shader(LGraphTextureBlur.vertex_shader,LGraphTextureBlur.pixel_shader))};
LGraphTextureBlur.title="Blur";LGraphTextureBlur.desc="Blur a texture";LGraphTextureBlur.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=this._temp_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}),this._final_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));b=this.properties.iterations;this.isInputConnected(1)&&(b=this.getInputData(1),
this.properties.iterations=b);b=Math.floor(b);if(0==b)this.setOutputData(0,a);else{var c=this.properties.intensity;this.isInputConnected(2)&&(c=this.getInputData(2),this.properties.intensity=c);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);for(var d=Mesh.getScreenQuad(),e=LGraphTextureBlur._shader,f=this.properties.scale||[1,1],h=a,g=this.properties.preserve_aspect?Renderer.active_camera.aspect:1,a=0;a<b;++a)this._temp_texture.drawTo(function(){h.bind(0);e.uniforms({texture:0,u_intensity:1,u_offset:[0,
g/h.height*f[1]]}).draw(d)}),this._temp_texture.bind(0),this._final_texture.drawTo(function(){e.uniforms({texture:0,u_intensity:c,u_offset:[1/h.width*f[0],0]}).draw(d)}),h=this._final_texture;this.setOutputData(0,this._final_texture)}}};LGraphTextureBlur.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureBlur.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/blur",LGraphTextureBlur);window.LGraphTextureBlur=LGraphTextureBlur;var LGraphTextureWebcam=function(){this.addOutput("Webcam","Texture");this.properties={}};LGraphTextureWebcam.title="Webcam";LGraphTextureWebcam.desc="Webcam texture";LGraphTextureWebcam.prototype.openStream=function(){function a(a){trace("Webcam rejected",a);b._webcam_stream=!1;b.box_color="red"}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||
navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;if(navigator.getUserMedia){this._waiting_confirmation=!0;navigator.getUserMedia({video:!0},this.streamReady.bind(this),a);var b=this}};LGraphTextureWebcam.prototype.streamReady=function(a){this._webcam_stream=a;var b=this._video;b||(b=document.createElement("video"),b.autoplay=!0,b.src=window.URL.createObjectURL(a),this._video=b,b.onloadedmetadata=function(a){console.log(a)})};LGraphTextureWebcam.prototype.onExecute=function(){null!=
this._webcam_stream||this._waiting_confirmation||this.openStream();if(this._video&&this._video.videoWidth){var a=this._video.videoWidth,b=this._video.videoHeight,c=this._temp_texture;c&&c.width==a&&c.height==b||(this._temp_texture=new GL.Texture(a,b,{format:gl.RGB,filter:gl.LINEAR}));this._temp_texture.uploadImage(this._video);this.setOutputData(0,this._temp_texture)}};LiteGraph.registerNodeType("texture/webcam",LGraphTextureWebcam);window.LGraphTextureWebcam=LGraphTextureWebcam}
RenderInstance.TWO_SIDED=1;function RenderInstance(a,b){this._key="";this._uid=LS.generateUId();this.mesh=null;this.node=a;this.component=b;this.primitive=gl.TRIANGLES;this.material=null;this.flags=0;this.matrix=mat4.create();this.normal_matrix=mat4.create();this.center=vec3.create();this.oobb_center=vec3.create();this.oobb_halfsize=vec3.create();this.aabb_center=vec3.create();this.aabb_halfsize=vec3.create()}
RenderInstance.prototype.generateKey=function(a,b){return this._key=a+"|"+this.node._uid+"|"+this.material._uid+"|"};RenderInstance.prototype.enableFlag=function(a){this.flags|=1<<a};RenderInstance.prototype.disableFlag=function(a){this.flags&=1<<a};RenderInstance.prototype.isFlag=function(a){return this.flags&1<<a};RenderInstance.prototype.computeNormalMatrix=function(){var a=mat4.invert(this.normal_matrix,this.matrix);a&&mat4.transpose(this.normal_matrix,a)};
RenderInstance.prototype.computeBounding=function(){if(this.mesh&&this.mesh.bounding){var a=vec3.create(),b=this.matrix,c=this.mesh.bounding.aabb_max,d=this.mesh.bounding.aabb_min,e=vec3.create(),f=vec3.create();mat4.multiplyVec3(e,b,c);f.set(e);mat4.multiplyVec3(a,b,[c[0],c[1],d[2]]);vec3.max(e,a,e);vec3.min(f,a,f);mat4.multiplyVec3(a,b,[c[0],d[1],c[2]]);vec3.max(e,a,e);vec3.min(f,a,f);mat4.multiplyVec3(a,b,[c[0],d[1],d[2]]);vec3.max(e,a,e);vec3.min(f,a,f);mat4.multiplyVec3(a,b,[d[0],c[1],c[2]]);
vec3.max(e,a,e);vec3.min(f,a,f);mat4.multiplyVec3(a,b,[d[0],c[1],d[2]]);vec3.max(e,a,e);vec3.min(f,a,f);mat4.multiplyVec3(a,b,[d[0],d[1],c[2]]);vec3.max(e,a,e);vec3.min(f,a,f);mat4.multiplyVec3(a,b,[d[0],d[1],d[2]]);vec3.max(e,a,e);vec3.min(f,a,f);this.aabb_center.set([0.5*(e[0]+f[0]),0.5*(e[1]+f[1]),0.5*(e[2]+f[2])]);vec3.sub(this.aabb_halfsize,e,this.aabb_center)}};
RenderInstance.prototype.render=function(a){null!=this.submesh_id&&-1!=this.submesh_id&&this.mesh.info.groups&&this.mesh.info.groups.length>this.submesh_id?a.drawRange(this.mesh,this.primitive,this.mesh.info.groups[this.submesh_id].start,this.mesh.info.groups[this.submesh_id].length):this.start||this.length?a.drawRange(this.mesh,this.primitive,this.start||0,this.length):a.draw(this.mesh,this.primitive)};
var Renderer={color_rendertarget:null,depth_rendertarget:null,generate_shadowmaps:!0,sort_nodes_in_z:!0,z_pass:!1,_renderkeys:{},_current_scene:null,_default_material:new Material,_visible_lights:[],_visible_meshes:[],_opaque_meshes:[],_alpha_meshes:[],reset:function(){this.depth_rendertarget=this.color_rendertarget=null},render:function(a,b,c){function d(){gl.clearColor(a.background_color[0],a.background_color[1],a.background_color[2],3<a.background_color.length?a.background_color[3]:1);!0!=c.ignore_clear&&
gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.enableCamera(b);LEvent.trigger(a,"beforeRenderScene",b);a.sendEventToNodes("beforeRenderScene",b);Renderer.renderSceneMeshes("main",c);LEvent.trigger(a,"afterRenderScene",b);a.sendEventToNodes("afterRenderScene",b)}c=c||{};this._current_scene=a=a||Scene;LEvent.trigger(Scene,"beforeRender",b);a.sendEventToNodes("beforeRender",b);if(a.light&&a.light.onBeforeRender)a.light.onBeforeRender();this.updateVisibleLights(a,c.nodes);!a.settings.enable_shadows||
c.skip_shadowmaps||!this.generate_shadowmaps||c.shadows_disabled||c.lights_disabled||this.renderShadowMaps();LEvent.trigger(Scene,"afterRenderShadows",b);a.sendEventToNodes("afterRenderShadows",b);a.settings.enable_rts&&!c.skip_rts&&0<a.rt_cameras.length&&this.renderRTCameras();a.active_viewport=a.viewport||[0,0,gl.canvas.width,gl.canvas.height];a.current_camera.aspect=a.active_viewport[2]/a.active_viewport[3];this.color_rendertarget&&this.depth_rendertarget?Texture.drawToColorAndDepth(this.color_rendertarget,
this.depth_rendertarget,d):this.color_rendertarget?this.color_rendertarget.drawTo(d):(gl.viewport(a.active_viewport[0],a.active_viewport[1],a.active_viewport[2],a.active_viewport[3]),d(),gl.viewport(0,0,gl.canvas.width,gl.canvas.height));LEvent.trigger(Scene,"afterRender",b);Scene.sendEventToNodes("afterRender",b);if(a.light&&a.light.onAfterRender)a.light.onAfterRender();Scene._frame+=1;Scene._must_redraw=!1},_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),
_mvp_matrix:mat4.create(),_temp_matrix:mat4.create(),_world_model:mat4.create(),_object_model:mat4.create(),_normal_model:mat4.create(),enableCamera:function(a){a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);this.active_camera=a},renderSceneMeshes:function(a,b){var c=this.current_scene||Scene;b=b||{};b.camera=this.active_camera;b.step=a;LEvent.trigger(c,"beforeRenderPass",
b);c.sendEventToNodes("beforeRenderPass",b);if(c.textures.background){var d=null;"string"==typeof c.textures.background&&(d=LS.ResourcesManager.textures[c.textures.background]);d&&(gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),d.toViewport())}gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);gl.lineWidth(1);this.updateVisibleMeshes(c,b);var d=this._visible_lights,e;for(e in this._visible_meshes){var f=this._visible_meshes[e];b.is_shadowmap?this.renderShadowPassInstance(a,f,b):b.is_picking?
this.renderPickingInstance(a,f,b):this.renderMultiPassInstance(a,f,d,b)}LEvent.trigger(c,"afterRenderPass",b);c.sendEventToNodes("afterRenderPass",b);c.textures.foreground&&(d=null,"string"==typeof c.textures.foreground&&(d=LS.ResourcesManager.textures[c.textures.foreground]),d&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.disable(gl.DEPTH_TEST),d.toViewport()));gl.depthFunc(gl.LEQUAL);gl.depthMask(!0);gl.disable(gl.BLEND);gl.frontFace(gl.CCW)},renderMultiPassInstance:function(a,
b,c,d){var e=d.scene||Scene,f=b.node,h=b.material;this._object_model.set(b.matrix);this._normal_model.set(b.normal_matrix);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,this._object_model);var g={u_camera_eye:this.active_camera.eye,u_camera_planes:[this.active_camera.near,this.active_camera.far],u_time:e.current_time||0.001*(new Date).getTime()};g.u_mvp=this._mvp_matrix;g.u_model=this._object_model;g.u_normal_model=this._normal_model;this.enableInstanceFlags(b,f,d);h.blending==Material.ADDITIVE_BLENDING?
(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)):0.999>h.opacity?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)):gl.disable(gl.BLEND);for(var k=c.length,m=0;m<k;m++){var n=c[m];b.generateKey(a,d);var l=null;if(!l){var l=b.material.shader||"globalshader",r={};b.material.getSurfaceShaderMacros(r,a,l,b,f,e,d);b.material.getLightShaderMacros(r,a,n,b,l,f,e,d);b.material.getSceneShaderMacros(r,a,b,f,e,d);0==m&&(r.FIRST_PASS="");m==k-1&&(r.LAST_PASS="");l=Shaders.get(l,r)}b.material.fillSurfaceUniforms(l,
g,b,f,e,d);b.material.fillLightUniforms(l,g,n,b,f,e,d);0<m&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthFunc(gl.LEQUAL),f.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST));h.depth_func&&gl.depthFunc(gl[h.depth_func]);l.uniforms(g);b.render(l);if(l.global&&!l.global.multipass)break}},renderShadowPassInstance:function(a,b,c){var d=b.node;a=b.material;this._object_model.set(b.matrix);this._normal_model.set(b.normal_matrix);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,
this._object_model);this.enableInstanceFlags(b,d,c);if(!0==d.flags.alpha_shadows&&(a.getTexture("color")||a.getTexture("opacity"))){c={USE_ALPHA_TEST:"0.5"};if(d=a.getTexture("color"))c.USE_COLOR_TEXTURE="uvs_"+(a.textures.color_uvs||Material.DEFAULT_UVS.color||"0"),d.bind(0);if(d=a.getTexture("opacity"))c.USE_OPACITY_TEXTURE="uvs_"+(a.textures.opacity_uvs||Material.DEFAULT_UVS.opacity||"0"),d.bind(1);shader=Shaders.get("depth",c);shader.uniforms({u_mvp:this._mvp_matrix,u_material_color:[0,0,0,a.opacity],
texture:0,opacity_texture:1,u_texture_matrix:[a.uvs_matrix[0],0,a.uvs_matrix[2],0,a.uvs_matrix[1],a.uvs_matrix[3],0,0,1]})}else shader=Shaders.get("depth"),shader.uniforms({u_mvp:this._mvp_matrix});b.render(shader)},renderPickingInstance:function(a,b,c){a=b.node;this._object_model.set(b.matrix);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,this._object_model);this._picking_next_color_id+=10;c=new Uint32Array(1);c[0]=this._picking_next_color_id;c=new Uint8Array(c.buffer);this._picking_nodes[this._picking_next_color_id]=
a;a=Shaders.get("flat");a.uniforms({u_mvp:this._mvp_matrix,u_material_color:new Float32Array([c[0]/255,c[1]/255,c[2]/255,1])});b.render(a)},enableInstanceFlags:function(a,b,c){a.isFlag(RenderInstance.TWO_SIDED)||b.flags.two_sided?gl.disable(gl.CULL_FACE):gl.enable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);b.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST);b.flags.depth_write?gl.depthMask(!0):gl.depthMask(!1);b.flags.flip_normals?gl.frontFace(gl.CW):gl.frontFace(gl.CCW)},updateVisibleMeshes:function(a,
b){var c=a.getNodes();b.nodes&&(c=b.nodes);var d=this.active_camera;b.current_camera=d;var d=d.getEye(),e=[],f=[],h=[],g;for(g in c){var k=c[g];LEvent.trigger(k,"computeVisibility",{camera:this.active_camera,options:b});!k.flags.visible||b.is_rt&&!1==k.flags.seen_by_reflections||!(!1!=k.flags.seen_by_camera||b.is_shadowmap||b.is_picking||b.is_reflection)||!1==k.flags.seen_by_picking&&b.is_picking||LEvent.trigger(k,"collectRenderInstances",h)}for(g in h)if(c=h[g])c.material||(c.material=this._default_material),
c.computeNormalMatrix(),c._dist=vec3.dist(c.center,d),b.force_wireframe&&(c.primitive=gl.LINES),c.primitive!=gl.LINES||c.mesh.lines||c.mesh.computeWireframe(),k=c.material,1<=k.opacity&&k.blending!=Material.ADDITIVE_BLENDING?e.push(c):f.push(c);this.sort_nodes_in_z&&(e.sort(function(a,b){return a._dist<b._dist?-1:a._dist>b._dist?1:0}),f.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0}));this._alpha_meshes=f;this._opaque_meshes=e;this._visible_meshes=e.concat(f)},null_light:null,updateVisibleLights:function(a,
b){this._visible_lights=[];b=b||a.getNodes();for(var c=0;c<b.length;++c){var d=b[c];if(d.flags.visible)for(var e in d._components)d._components[e].constructor===Light&&d._components[e].enabled&&this._visible_lights.push(d._components[e])}0==this._visible_lights.length&&(this.null_light||(this.null_light=new Light,this.null_light.color=[0,0,0]),this._visible_lights.push(this.null_light))},renderSceneMeshesToRT:function(a,b,c){function d(){gl.clearColor(Scene.background_color[0],Scene.background_color[1],
Scene.background_color[2],3<Scene.background_color.length?Scene.background_color[3]:1);!0!=c.ignore_clear&&gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.renderSceneMeshes("main",c)}b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a),b.drawTo(d)):b.texture_type==gl.TEXTURE_CUBE_MAP&&this.renderToCubemap(a.getEye(),b.width,b,c,a.near,a.far)},renderShadowMaps:function(a){a=a||Scene;for(var b in this._visible_lights){var c=this._visible_lights[b];if(c.cast_shadows){var d=c.shadowmap_resolution;
d||(d=Light.DEFAULT_SHADOWMAP_RESOLUTION);var e=c.type==Light.OMNI?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;if(null==c._shadowMap||c._shadowMap.width!=d||c._shadowMap.texture_type!=e)c._shadowMap=new GL.Texture(d,d,{texture_type:e,format:gl.RGBA,magFilter:gl.NEAREST,minFilter:gl.NEAREST}),ResourcesManager.textures[":shadowmap_"+c._uid]=c._shadowMap;c.type==Light.OMNI?this.renderToCubemap(c.getPosition(),d,c._shadowMap,{is_shadowmap:!0},c.near,c.far,"shadow"):(c.computeLightMatrices(this._view_matrix,this._projection_matrix,
this._viewprojection_matrix),this.active_camera=a.current_camera,c._shadowMap.unbind(),c._shadowMap.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);c._lightMatrix||(c._lightMatrix=mat4.create());mat4.copy(Renderer._viewprojection_matrix,c._lightMatrix);Renderer.renderSceneMeshes("shadow",{is_shadowmap:!0})}))}}},renderRTCameras:function(){var a=this.current_scene||Scene,b;for(b in a.rt_cameras){var c=a.rt_cameras[b];null==c.texture&&(c.texture=new GL.Texture(c.resolution||
1024,c.resolution||1024,{format:gl.RGB,magFilter:gl.LINEAR}),ResourcesManager.textures[c.id]=c.texture);this.enableCamera(c);c.texture.drawTo(function(){gl.clearColor(a.background_color[0],a.background_color[1],a.background_color[2],0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.renderSceneMeshes("rts",{is_rt:!0,clipping_plane:c.clipping_plane})})}},cubemap_camera_parameters:[{dir:[1,0,0],up:[0,1,0]},{dir:[-1,0,0],up:[0,1,0]},{dir:[0,-1,0],up:[0,0,-1]},{dir:[0,1,0],up:[0,0,1]},{dir:[0,
0,-1],up:[0,1,0]},{dir:[0,0,1],up:[0,1,0]}],renderToCubemap:function(a,b,c,d,e,f,h){b=b||256;e=e||1;f=f||1E3;h=h||"main";c&&c.constructor==Texture||(c=null);c=c||new Texture(b,b,{texture_type:gl.TEXTURE_CUBE_MAP,minFilter:gl.NEAREST});c.drawTo(function(b){var c=Renderer.cubemap_camera_parameters;"shadow"==h?gl.clearColor(0,0,0,0):gl.clearColor(Scene.background_color[0],Scene.background_color[1],Scene.background_color[2],3<Scene.background_color.length?Scene.background_color[3]:1);gl.clear(gl.COLOR_BUFFER_BIT|
gl.DEPTH_BUFFER_BIT);b=new Camera({eye:a,center:[a[0]+c[b].dir[0],a[1]+c[b].dir[1],a[2]+c[b].dir[2]],up:c[b].up,fov:90,aspect:1,near:e,far:f});Renderer.enableCamera(b);Renderer.renderSceneMeshes(h,d)});return c},_pickingMap:null,_picking_color:new Uint8Array(4),_picking_depth:0,_picking_next_color_id:0,_picking_nodes:{},renderPickingBuffer:function(a,b){var c=this.current_scene||Scene;if(null==this._pickingMap||this._pickingMap.width!=gl.canvas.width||this._pickingMap.height!=gl.canvas.height)this._pickingMap=
new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,filter:gl.NEAREST}),ResourcesManager.textures[":picking"]=this._pickingMap;b=gl.canvas.height-b;this._picking_next_color_id=0;this._pickingMap.drawTo(function(){var d=c.viewport||[0,0,gl.canvas.width,gl.canvas.height];c.current_camera.aspect=d[2]/d[3];gl.viewport(d[0],d[1],d[2],d[3]);gl.scissor(a-1,b-1,2,2);gl.enable(gl.SCISSOR_TEST);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.enableCamera(c.current_camera);
Renderer.renderSceneMeshes("picking",{is_picking:!0});gl.readPixels(a,b,1,1,gl.RGBA,gl.UNSIGNED_BYTE,Renderer._picking_color);gl.disable(gl.SCISSOR_TEST)});return this._picking_color},getNodeAtCanvasPosition:function(a,b,c){this._picking_nodes={};this.renderPickingBuffer(b,c);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes={};return a},projectToCanvas:function(a,b,c){}};LS.Renderer=Renderer;
var Parser={flipAxis:0,merge_smoothgroups:!1,safe_parsing:!1,image_extensions:["png","jpg"],nonative_image_extensions:["tga","dds"],mesh_extensions:"obj bin ase gr2 json jsmesh".split(" "),scene_extensions:["dae"],generic_extensions:["xml","js","json"],xml_extensions:["xml","dae"],json_extensions:["js","json"],binary_extensions:["bin","tga","dds"],parsers:{},registerParser:function(a){this.parsers[a.extension]=a},parse:function(a,b,c){c=c||{};var d=this.getResourceInfo(a);c.extension&&(d.extension=
c.extension);var e=this.parsers[d.extension];if(!e)return trace("Perser Error: No parser found for "+d.extension+" format"),null;d=null;if(this.safe_parsing)try{d=e.parse(b,c)}catch(f){return trace("Error parsing content",f),null}else d=e.parse(b,c);d&&(d.name=a);return d},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var e=0;e<b.width;++e)for(var f=0;f<
b.height;++f){var h=4*f*b.width+4*e,g=3*(b.height-f-1)*b.width+3*e;d.data[h+2]=a.pixels[g];d.data[h+1]=a.pixels[g+1];d.data[h+0]=a.pixels[g+2];d.data[h+3]=255}else for(e=0;e<b.width;++e)for(f=0;f<b.height;++f)h=4*f*b.width+4*e,g=4*(b.height-f-1)*b.width+4*e,d.data[h+0]=a.pixels[g+2],d.data[h+1]=a.pixels[g+1],d.data[h+2]=a.pixels[g+0],d.data[h+3]=a.pixels[g+3];c.putImageData(d,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],
a[1],a[2]],d=0;d<a.length;d+=3){var e=[a[d],a[d+1],a[d+2]];e[0]<b[0]?b[0]=e[0]:e[0]>c[0]&&(c[0]=e[0]);e[1]<b[1]?b[1]=e[1]:e[1]>c[1]&&(c[1]=e[1]);e[2]<b[2]?b[2]=e[2]:e[2]>c[2]&&(c[2]=e[2])}a={};a.aabb_min=b;a.aabb_max=c;a.aabb_center=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];a.aabb_half=[b[0]-a.aabb_center[0],b[1]-a.aabb_center[1],b[2]-a.aabb_center[2]];a.radius=Math.sqrt(a.aabb_half[0]*a.aabb_half[0]+a.aabb_half[1]*a.aabb_half[1]+a.aabb_half[2]*a.aabb_half[2]);return a},stringToTypedArray:function(a,
b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c},typedArrayToString:function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c},JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",TEXT_FORMAT:"text",MESH_DATA:"MESH",SCENE_DATA:"SCENE",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",GENERIC_DATA:"GENERIC",getResourceInfo:function(a){var b=a.substr(a.lastIndexOf(".")+1).toLowerCase();a={filename:a,
extension:b};a.format=Parser.TEXT_FORMAT;-1!=this.xml_extensions.indexOf(b)?a.format=Parser.XML_FORMAT:-1!=this.json_extensions.indexOf(b)?a.format=Parser.JSON_FORMAT:-1!=this.binary_extensions.indexOf(b)&&(a.format=Parser.BINARY_FORMAT);-1!=this.image_extensions.indexOf(b)?a.type=Parser.IMAGE_DATA:-1!=this.mesh_extensions.indexOf(b)?a.type=Parser.MESH_DATA:-1!=this.scene_extensions.indexOf(b)?a.type=Parser.SCENE_DATA:-1!=this.nonative_image_extensions.indexOf(b)?a.type=Parser.NONATIVE_IMAGE_DATA:
-1!=this.generic_extensions.indexOf(b)&&(a.type=Parser.GENERIC_DATA);return a}};Mesh.prototype.toBinary=function(){if(!window.BinaryPack)throw"BinaryPack not imported, no binary formats supported";if(this.info){var a={info:this.info};this.info.num_vertices=this.vertices.length;for(var b in this.vertexBuffers){var c=this.vertexBuffers[b];a[c.name]=c.data}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=c.data;b=new BinaryPack;b.save(a);return b.getData()}trace("Error: Mesh info not found")};
var parserASE={extension:"ase",data_type:"mesh",format:"text",parse:function(a,b){b=b||{};var c=[],d=[],e=[],f=[],h=[],g=null,g=null,k=0,m=-1,n=null,l=[],r=Parser.flipAxis;null!=b.flipAxis&&(r=b.flipAxis);for(var p=r||b.flipNormals,t=a.split("\n"),w=0;w<t.length;++w)if(g=t[w].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==g[0]&&(g=g.substr(1,g.length)),""!=g)if(g=g.split(" "),"*MESH"==g[0]){if(k+=1,f=[],h=[],1<k)break}else if("*NODE_NAME"==g[0])g[1].substr(1,g[1].length-2);else if("*MESH_VERTEX"==
g[0])r?f.push([-1*parseFloat(g[2]),parseFloat(g[4]),parseFloat(g[3])]):f.push([parseFloat(g[2]),parseFloat(g[3]),parseFloat(g[4])]);else if("*MESH_FACE"==g[0]){var s=parseInt(g[17]);m!=s&&(m=s,null!=n&&(n.length=c.length/3-n.start,0<n.length&&l.push(n)),n={name:"mat_"+s,start:c.length/3,length:-1,material:""});s=f[parseInt(g[3])];c.push(s[0],s[1],s[2]);s=f[parseInt(g[5])];c.push(s[0],s[1],s[2]);s=f[parseInt(g[7])];c.push(s[0],s[1],s[2])}else"*MESH_TVERT"==g[0]?h.push([parseFloat(g[2]),parseFloat(g[3])]):
"*MESH_TFACE"==g[0]?(s=h[parseInt(g[2])],d.push(s[0],s[1]),s=h[parseInt(g[3])],d.push(s[0],s[1]),s=h[parseInt(g[4])],d.push(s[0],s[1])):"*MESH_VERTEXNORMAL"==g[0]&&(p?e.push(-1*parseFloat(g[2]),parseFloat(g[4]),parseFloat(g[3])):e.push(parseFloat(g[2]),parseFloat(g[3]),parseFloat(g[4])));f=c.length/3-n.start;n&&1<f&&(n.length=f,l.push(n));n={info:{}};n.vertices=new Float32Array(c);0<e.length&&(n.normals=new Float32Array(e));0<d.length&&(n.coords=new Float32Array(d));n.bounding=Parser.computeMeshBounding(n.vertices);
1<l.length&&(n.info.groups=l);return n}};Parser.registerParser(parserASE);var parserBIN={extension:"bin",data_type:"mesh",format:"binary",parse:function(a,b){if(!window.BinaryPack)throw"BinaryPack not imported, no binary formats supported";a="string"==typeof a?BinaryPack.stringToTypedArray(a):new Uint8Array(a);return(new BinaryPack).load(a)}};Parser.registerParser(parserBIN);
var parserDAE={extension:"dae",data_type:"scene",format:"text",_xmlroot:null,parse:function(a,b){trace("Parsing collada");var c=(new DOMParser).parseFromString(a,"text/xml");this._xmlroot=c;for(var c=c.querySelector("visual_scene"),c=c.childNodes,d={object_type:"SceneTree",light:null,meshes:{},materials:{},root:{children:[]}},e=0;e<c.length;e++)if("node"==c[e].localName){var f=this.readNode(c[e],d,0,!0);d.root.children.push(f)}console.log(d);return d},readNode:function(a,b,c,d){var e=a.getAttribute("id");
a.getAttribute("type");for(var e={id:e,children:[]},f=0;f<a.childNodes.length;f++){var h=a.childNodes[f];if("node"==h.localName)e.children.push(this.readNode(h,b,c+1,d));else{e.model=this.readTransform(a,c,d);if("instance_geometry"==h.localName){var g=h.getAttribute("url");if(!b.meshes[g]){var k=this.readGeometry(g,d);k&&(b.meshes[g]=k)}e.mesh=g;if(g=h.querySelector("instance_material"))g=g.getAttribute("symbol"),!b.materials[g]&&(k=this.readMaterial(g))&&(k.id=g,b.materials[g]=k),e.material=g}"instance_light"==
h.localName&&(g=h.getAttribute("url"),this.readLight(e,g,d))}}return e},translate_table:{transparency:"opacity",reflectivity:"reflection_factor",specular:"specular_factor",shininess:"specular_gloss",emission:"emissive",diffuse:"color"},readMaterial:function(a){a=this._xmlroot.querySelector("library_materials material#"+a);if(!a)return null;a=a.querySelector("instance_effect");if(!a)return null;a=a.getAttribute("url");a=this._xmlroot.querySelector("library_effects effect"+a);if(!a)return null;var b=
a.querySelector("technique");if(!b)return null;a={};var c=b.querySelector("phong");if(!c)return null;for(var d=c.querySelectorAll("color"),b=0;b<d.length;++b){var e=d[b],f=e.getAttribute("sid");this.translate_table[f]&&(f=this.translate_table[f]);a[f]=this.readContentAsFloats(e).subarray(0,3);"specular_factor"==f&&(a[f]=(a[f][0]+a[f][1]+a[f][2])/3)}c=c.querySelectorAll("float");for(b=0;b<c.length;++b)d=c[b],f=d.getAttribute("sid"),this.translate_table[f]&&(f=this.translate_table[f]),a[f]=this.readContentAsFloats(d)[0],
"opacity"==f&&(a[f]=1-a[f]);return a},readLight:function(a,b){function c(a,b){for(var c in b.childNodes){var d=b.childNodes[c];if(d&&1==d.nodeType)switch(d.localName){case "color":a.color=parserDAE.readContentAsFloats(d);break;case "falloff_angle":a.angle_end=parserDAE.readContentAsFloats(d)[0],a.angle=a.angle_end-10}}}var d={},e=this._xmlroot.querySelector("library_lights "+b);if(!e)return null;var f=[],h=e.querySelector("technique_common");if(h)for(var g in h.childNodes)1==h.childNodes[g].nodeType&&
f.push(h.childNodes[g]);e=e.querySelectorAll("technique");for(g=0;g<e.length;g++)for(var k in e[g].childNodes)1==e[g].childNodes[k].nodeType&&f.push(e[g].childNodes[k]);for(g in f)switch(h=f[g],h.localName){case "point":d.type=LS.Light.OMNI;c(d,h);break;case "spot":d.type=LS.Light.SPOT;c(d,h);break;case "intensity":d.intensity=this.readContentAsFloats(h)[0]}d.position=[0,0,0];d.target=[0,-1,0];a.light=d},readTransform:function(a,b,c){for(var d=mat4.create(),e=quat.create(),f=mat4.create(),h=quat.create(),
g=vec3.create(),k=vec3.fromValues(1,1,1),m=0;m<a.childNodes.length;m++){var n=a.childNodes[m];if("matrix"==n.localName)return d=this.readContentAsFloats(n),mat4.transpose(d,d),a=new Float32Array(d.subarray(4,8)),d.set(d.subarray(8,12),4),d.set(a,8),d[10]*=-1,d[14]*=-1,d;if("translate"==n.localName){var l=this.readContentAsFloats(n);g.set(l)}else"rotate"==n.localName?(l=this.readContentAsFloats(n),4==l.length&&("jointOrientX"==n.getAttribute("sid")&&(l[3]+=90),c&&(n=l[1],l[1]=l[2],l[2]=-n),quat.setAxisAngle(h,
l.subarray(0,3),l[3]*DEG2RAD),quat.multiply(e,e,h))):"scale"==n.localName&&(l=this.readContentAsFloats(n),c&&(n=l[1],l[1]=l[2],l[2]=-n),k.set(l))}c&&0<b&&(n=g[1],g[1]=g[2],g[2]=-n);mat4.translate(d,d,g);mat4.fromQuat(f,e);mat4.multiply(d,d,f);mat4.scale(d,d,k);return d},readGeometry:function(a,b){var c=this._xmlroot.querySelector("geometry"+a);if(!c)return null;for(var d=c.querySelector("mesh"),e=[],f=d.querySelectorAll("source"),c=0;c<f.length;c++){var h=f[c];if(h.querySelector&&h.querySelector("float_array")){var g=
this.readContentAsFloats(h);e[h.getAttribute("id")]=g}}c=d.querySelector("vertices input");vertices_source=e[c.getAttribute("source").substr(1)];e[d.querySelector("vertices").getAttribute("id")]=vertices_source;for(var k=d.querySelector("polygons"),m=k.querySelectorAll("input"),h=f=d=-1,n=g=null,l=null,c=0;c<m.length;c++){var r=m[c];if(r.getAttribute){var p=r.getAttribute("semantic").toUpperCase(),t=e[r.getAttribute("source").substr(1)];"VERTEX"==p?(g=t,d=parseInt(r.getAttribute("offset"))):"NORMAL"==
p?(n=t,f=parseInt(r.getAttribute("offset"))):"TEXCOORD"==p&&(l=t,h=parseInt(r.getAttribute("offset")))}}p=[];e=[];m=[];r=[];t=0;k=k.querySelectorAll("p");for(c=0;c<k.length;c++){var w=k[c];if(!w||!w.textContent)break;for(var w=w.textContent.split(" "),s=-1,u=-1,q=-1,v=0;v<w.length;v+=3)6<v&&(p.push(p[3*s],p[3*s+1],p[3*s+2]),e.push(e[3*s],e[3*s+1],e[3*s+2]),m.push(m[2*s],m[2*s+1]),p.push(p[3*(q+1)],p[3*(q+1)+1],p[3*(q+1)+2]),e.push(e[3*(q+1)],e[3*(q+1)+1],e[3*(q+1)+2]),m.push(m[2*(q+1)],m[2*(q+1)+
1]),t+=2,u=t-1),q=u,u=3*parseInt(w[v+d]),p.push(g[u],g[u+1],g[u+2]),-1!=f&&(u=3*parseInt(w[v+f]),e.push(n[u],n[u+1],n[u+2])),-1!=h&&(u=2*parseInt(w[v+h]),m.push(l[u],l[u+1])),u=t,t+=1,0==v&&(s=u)}d={vertices:new Float32Array(p)};e.length&&(d.normals=new Float32Array(e));m.length&&(d.coords=new Float32Array(m));r.length&&(d.triangles=new Uint16Array(r));if(b){f=0;h=d.vertices;c=0;for(g=h.length;c<g;c+=3)f=h[c+1],h[c+1]=h[c+2],h[c+2]=-f;h=d.normals;c=0;for(g=h.length;c<g;c+=3)f=h[c+1],h[c+1]=h[c+2],
h[c+2]=-f}c=Parser.computeMeshBounding(d.vertices);d.bounding=c;return isNaN(c.radius)?null:d},readContentAsUInt32:function(a){if(!a)return null;a=a.textContent;a=a.replace(/\n/gi," ");a=a.trim();if(0==a.length)return null;a=a.split(" ");for(var b=new Uint32Array(a.length),c=0;c<a.length;c++)b[c]=parseInt(a[c]);return b},readContentAsFloats:function(a){if(!a)return null;var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" ");a=a.getAttribute("count")||b.length;
a=new Float32Array(a);for(var c=0;c<b.length;c++)a[c]=parseFloat(b[c]);return a},parse2:function(a,b){trace("Parsing collada");var c=(new DOMParser).parseFromString(a,"text/xml").querySelectorAll("library_geometries geometry");if(!c||0==c.length)return null;for(var d in c){var e={},f=c[d];f.getAttribute("id");if(f.querySelector){c=f.querySelector("mesh");d=c.querySelectorAll("source");for(var h in d)if(f=d[h],f.querySelector){var g=f.querySelector("float_array");if(g){for(var k=g.textContent,k=k.replace(/\n/gi,
" "),k=k.trim(),k=k.split(" "),g=new Float32Array(parseInt(g.getAttribute("count"))),m=0;m<k.length;m++)g[m]=parseFloat(k[m]);e[f.getAttribute("id")]=g}}d=c.querySelector("vertices input");vertices_source=e[d.getAttribute("source").substr(1)];e[c.querySelector("vertices").getAttribute("id")]=vertices_source;var m=c.querySelector("polygons"),n=m.querySelectorAll("input"),f=d=c=-1,l=g=k=null;for(h in n){var r=n[h];if(r.getAttribute){var p=r.getAttribute("semantic").toUpperCase(),t=e[r.getAttribute("source").substr(1)];
"VERTEX"==p?(k=t,c=parseInt(r.getAttribute("offset"))):"NORMAL"==p?(g=t,d=parseInt(r.getAttribute("offset"))):"TEXCOORD"==p&&(l=t,f=parseInt(r.getAttribute("offset")))}}var p=m.querySelectorAll("p"),t=[],e=[],n=[],r=[],w=0;for(h in p){m=p[h];if(!m||!m.textContent)break;a=m.textContent.split(" ");for(var s=-1,u=-1,q=-1,m=0;m<a.length;m+=3)6<m&&(t.push(t[3*s],t[3*s+1],t[3*s+2]),e.push(e[3*s],e[3*s+1],e[3*s+2]),n.push(n[2*s],n[2*s+1]),t.push(t[3*(q+1)],t[3*(q+1)+1],t[3*(q+1)+2]),e.push(e[3*(q+1)],e[3*
(q+1)+1],e[3*(q+1)+2]),n.push(n[2*(q+1)],n[2*(q+1)+1]),w+=2,u=w-1),q=u,u=3*parseInt(a[m+c]),t.push(k[u],k[u+1],k[u+2]),-1!=d&&(u=3*parseInt(a[m+d]),e.push(g[u],g[u+1],g[u+2])),-1!=f&&(u=2*parseInt(a[m+f]),n.push(l[u],l[u+1])),u=w,w+=1,0==m&&(s=u)}h={vertices:new Float32Array(t)};e.length&&(h.normals=new Float32Array(e));n.length&&(h.coords=new Float32Array(n));r.length&&(h.triangles=new Uint16Array(r));e=Parser.computeMeshBounding(h.vertices);h.bounding=e;return isNaN(e.radius)?null:h}}}};Parser.registerParser(parserDAE);
var parserDDS={extension:"dds",data_type:"image",format:"binary",parse:function(a,b){var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),d=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,d.handler,!0);d.texture_type=d.handler.texture_type;d.width=d.handler.width;d.height=d.handler.height;return d}};Parser.registerParser(parserDDS);
var parserJSMesh={extension:"jsmesh",data_type:"mesh",format:"text",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles="number"==typeof c.triangles[0]?
c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=Parser.computeMeshBounding(c.vertices));return c}};Parser.registerParser(parserJSMesh);
var parserOBJ={extension:"obj",data_type:"mesh",format:"text",parse:function(a,b){b=b||{};for(var c=[],d=[],e=[],f=[],h=[],g=[],k=[],m={},n=0,l=null,r=null,p=0,t=0,w=r=0,s=0,u=0,q=null,v=!1,D=!1,H=!1,E=!1,F=0,A=b.noindex?b.noindex:1E7<a.length?!0:!1,C=Parser.flipAxis||b.flipAxis,B=C||b.flipNormals,x=null,z=[],J=a.split("\n"),K=J.length,I=0;I<K;++I)if(l=J[I].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=l[0]&&""!=l)if(q=l.split(" "),E&&"v"==q[0]&&(E=!1),"v"==q[0])C?h.push(-1*parseFloat(q[1]),parseFloat(q[3]),
parseFloat(q[2])):h.push(parseFloat(q[1]),parseFloat(q[2]),parseFloat(q[3]));else if("vt"==q[0])g.push(parseFloat(q[1]),parseFloat(q[2]));else if("vn"==q[0])B?k.push(-parseFloat(q[2]),-parseFloat(q[3]),parseFloat(q[1])):k.push(parseFloat(q[1]),parseFloat(q[2]),parseFloat(q[3]));else if("f"==q[0]){if(E=!0,!(4>q.length)){for(var G=[],l=1;l<q.length;++l){if(!(q[l]in m)||A){r=q[l].split("/");if(1==r.length)r=t=p=parseInt(r[0])-1;else if(2==r.length)p=parseInt(r[0])-1,t=parseInt(r[1])-1,r=-1;else if(3==
r.length)p=parseInt(r[0])-1,t=parseInt(r[1])-1,r=parseInt(r[2])-1;else return trace("Problem parsing: unknown number of values per face"),!1;u=s=w=0;3*p+2<h.length&&(v=!0,w=h[3*p+0],s=h[3*p+1],u=h[3*p+2]);c.push(w,s,u);s=w=0;2*t+1<g.length&&(D=!0,w=g[2*t+0],s=g[2*t+1]);d.push(w,s);s=w=0;u=1;-1!=r&&(3*r+2<k.length&&(H=!0,w=k[3*r+0],s=k[3*r+1],u=k[3*r+2]),e.push(w,s,u));A||(m[q[l]]=n++)}A||(p=m[q[l]],G.push(p),F<p&&(F=p))}if(!A)for(l=2;l<G.length;l++)f.push(G[0],G[l-1],G[l])}}else"g"==q[0]||"usemtl"==
q[0]?1<q.length&&(null!=x&&(x.length=f.length-x.start,0<x.length&&z.push(x)),x={name:q[1],start:f.length,length:-1,material:""}):"usemtl"==q[0]?x&&(x.material=q[1]):"o"!=q[0]&&"s"!=q[0]&&trace("unknown code: "+l);x&&1<f.length-x.start&&(x.length=f.length-x.start,z.push(x));if((65536<F||A)&&0<f.length){console.log("Deindexing mesh...");h=new Float32Array(3*f.length);g=e&&e.length?new Float32Array(3*f.length):null;k=d&&d.length?new Float32Array(2*f.length):null;for(l=0;l<f.length;l+=1)h.set(c.slice(3*
f[l],3*f[l]+3),3*l),g&&g.set(e.slice(3*f[l],3*f[l]+3),3*l),k&&k.set(d.slice(2*f[l],2*f[l]+2),2*l);c=h;g&&(e=g);k&&(d=k);f=null}l={};v&&(l.vertices=new Float32Array(c));H&&0<e.length&&(l.normals=new Float32Array(e));D&&0<d.length&&(l.coords=new Float32Array(d));f&&0<f.length&&(l.triangles=new Uint16Array(f));l.bounding=Parser.computeMeshBounding(l.vertices);c={};1<z.length&&(c.groups=z);l.info=c;(0==l.bounding.radius||isNaN(l.bounding.radius))&&console.log("no radius found in mesh");return l}};Parser.registerParser(parserOBJ);
var parserTGA={extension:"tga",data_type:"image",format:"binary",parse:function(a,b){a="string"==typeof a?Parser.stringToTypedArray(a):new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),d=a.subarray(0,12),e=0;e<d.length;e++)if(c[e]!=d[e])return null;e=a.subarray(12,18);c={};c.width=256*e[1]+e[0];c.height=256*e[3]+e[2];c.bpp=e[4];c.bytesPerPixel=c.bpp/8;c.imageSize=c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);for(e=0;e<c.imageSize;e+=c.bytesPerPixel)d=
c.pixels[e],c.pixels[e]=c.pixels[e+2],c.pixels[e+2]=d;c.flipY=!0;c.format=32==c.bpp?"BGRA":"BGR";return c}};Parser.registerParser(parserTGA);function SceneTree(){this._uid=LS.generateUId();this._root=new LS.SceneNode("root");this._root.removeAllComponents();this._root._is_root=!0;this._root._on_tree=this;this._nodes=[this._root];LEvent.bind(this,"treeItemAdded",this.onNodeAdded.bind(this));LEvent.bind(this,"treeItemRemoved",this.onNodeRemoved.bind(this));this.init()}
SceneTree.DEFAULT_BACKGROUND_COLOR=new Float32Array([0,0,0,1]);SceneTree.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);Object.defineProperty(SceneTree.prototype,"root",{enumerable:!0,get:function(){return this._root},set:function(a){throw"Root node cannot be replaced";}});
SceneTree.prototype.init=function(){this.id="";this.materials={};this.local_repository=null;this._root.removeAllComponents();this._nodes=[this._root];this._nodes_by_id={};this.rt_cameras=[];this._root.addComponent(new Camera);this.current_camera=this._root.camera;this._root.addComponent(new Light({position:vec3.fromValues(100,100,100),target:vec3.fromValues(0,0,0)}));this.ambient_color=new Float32Array(SceneTree.DEFAULT_AMBIENT_COLOR);this.background_color=new Float32Array(SceneTree.DEFAULT_BACKGROUND_COLOR);
this.textures={};this.settings={enable_shadows:!0,enable_rts:!0};this._start_time=this._global_time=this._time=this._frame=0;this._last_dt=1/60;this._must_redraw=!0;this.selected_node&&delete this.selected_node;this.extra={};this._renderer=LS.Renderer};
SceneTree.prototype.clear=function(){for(;this._root.children&&this._root.children.length;)this._root.removeChild(this._root.children[0]);this._root.processActionInComponents("onRemovedFromNode",this);this._root.processActionInComponents("onRemovedFromScene",this);this.init();LEvent.trigger(this,"clear");LEvent.trigger(this,"change")};
SceneTree.prototype.configure=function(a){this._root.removeAllComponents();"SceneTree"!=a.object_type&&trace("Warning: object set to scene doesnt look like a propper one.");a.local_repository&&(this.local_repository=a.local_repository);a.background_color&&this.background_color.set(a.background_color);a.ambient_color&&this.ambient_color.set(a.ambient_color);a.textures&&(this.textures=a.textures);a.extra&&(this.extra=a.extra);a.root&&this.root.configure(a.root);a.nodes&&this.root.configure({children:a.nodes});
if(a.materials)for(var b in a.materials)this.materials[b]=new Material(a.materials[b]);a.components&&this._root.configureComponents(a);a.camera&&(this._root.camera?this._root.camera.configure(a.camera):this._root.addComponent(new Camera(a.camera)));a.light?this._root.light?this._root.light.configure(a.light):this._root.addComponent(new Light(a.light)):a.hasOwnProperty("light")&&this._root.light&&(this._root.removeComponent(this._root.light),this._root.light=null);LEvent.trigger(this,"configure",a);
LEvent.trigger(this,"change");this.current_camera=this._root.camera};
SceneTree.prototype.serialize=function(){var a={};a.object_type=getObjectClassName(this);a.local_repository=this.local_repository;a.ambient_color=toArray(this.ambient_color);a.background_color=toArray(this.background_color);a.textures=cloneObject(this.textures);a.extra=this.extra||{};a.root=this.root.serialize();if(this.materials){a.materials={};for(var b in this.materials)a.materials[b]=this.materials[b].serialize()}LEvent.trigger(this,"serializing",a);return a};
SceneTree.prototype.loadScene=function(a,b,c){function d(){b&&b()}var e=this,f=ResourcesManager.getNoCache(!0);LS.request({url:a+f,dataType:"json",success:function(a){e.init();e.configure(a);e.loadResources(d)},error:function(b){trace("Error loading scene: "+a+" -> "+b);c&&c(a)}})};
SceneTree.prototype.appendScene=function(a){var b=a.root.childNodes,c;for(c in a.materials)this.materials[c]=a.materials[c];for(c in b){a=b[c];var d=new LS.SceneNode(a.id);this.root.addChild(d);d.configure(a.constructor==LS.SceneNode?a.serialize():a)}};SceneTree.prototype.getCamera=function(){return this._root.camera};
SceneTree.prototype.onNodeAdded=function(a,b){if(b._on_tree&&b._on_tree!=this)throw"Cannot add a node from other scene, clone it";b.id&&-1!=b.id&&(null!=this._nodes_by_id[b.id]&&(b.id=b.id+"_"+(1E3*Math.random()).toFixed(0)),this._nodes_by_id[b.id]=b);this._nodes.push(b);b.processActionInComponents("onAddedToScene",this);LEvent.trigger(this,"nodeAdded",b);LEvent.trigger(this,"change")};
SceneTree.prototype.onNodeRemoved=function(a,b){var c=this._nodes.indexOf(b);if(-1!=c)return this._nodes.splice(c,1),b.id&&delete this._nodes_by_id[b.id],b.processActionInComponents("onRemovedFromNode",this),b.processActionInComponents("onRemovedFromScene",this),LEvent.trigger(this,"nodeRemoved",b),LEvent.trigger(this,"change"),!0};SceneTree.prototype.getNodes=function(){return this._nodes};SceneTree.prototype.getNode=function(a){return this._nodes_by_id[a]};SceneTree.prototype.getElementById=SceneTree.prototype.getNode;
SceneTree.prototype.filterNodes=function(a){var b=[],c;for(c in this._nodes)a(this._nodes[c])&&b.push(this._nodes[c]);return b};
SceneTree.prototype.loadResources=function(a){function b(){LEvent.unbind(LS.ResourcesManager,"end_loading_resources",b);a&&a()}var c={},d;for(d in this.textures)this.textures[d]&&(c[this.textures[d]]=Texture);this.light&&this.light.getResources(c);for(d in this._nodes)this._nodes[d].getResources(c);var e=0;for(d in c)++e;0==e?a&&a():(LEvent.bind(LS.ResourcesManager,"end_loading_resources",b),LS.ResourcesManager.loadResources(c))};
SceneTree.prototype.start=function(){this._state="running";this._start_time=0.001*(new Date).getTime();LEvent.trigger(this,"start",this);this.sendEventToNodes("start")};SceneTree.prototype.stop=function(){this._state="stopped";LEvent.trigger(this,"stop",this);this.sendEventToNodes("stop")};SceneTree.prototype.render=function(a,b){this._renderer.render(this,a,b)};
SceneTree.prototype.update=function(a){LEvent.trigger(this,"beforeUpdate",this);this._global_time=0.001*(new Date).getTime();this._time=this._start_time-this._global_time;this._last_dt=a;LEvent.trigger(this,"update",a);this.sendEventToNodes("update",a,!0);LEvent.trigger(this,"afterUpdate",this)};SceneTree.prototype.sendEventToNodes=function(a,b){for(var c in this._nodes)LEvent.trigger(this._nodes[c],a,b)};
SceneTree.prototype.generateUniqueNodeName=function(a){a=a||"node";for(var b=1,c=a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};SceneTree.prototype.refresh=function(){this._must_redraw=!0};SceneTree.prototype.getTime=function(){return this._global_time};
function SceneNode(a){this.id=a||"node_"+(1E4*Math.random()).toFixed(0);this._uid=LS.generateUId();this.flags={visible:!0,selectable:!0,two_sided:!1,flip_normals:!1,cast_shadows:!0,receive_shadows:!0,ignore_lights:!1,alpha_test:!1,alpha_shadows:!1,depth_test:!0,depth_write:!0};this._components=[];this.addComponent(new Transform);this.extra={}}LS.extendClass(ComponentContainer,SceneNode);LS.extendClass(CompositePattern,SceneNode);
SceneNode.prototype.setId=function(a){if(this.id==a)return!0;var b=this._on_tree;if(b){if(null!=b.getNode(a))return trace("ID already in use"),!1;this.id&&delete b._nodes_by_id[this.id];(this.id=a)&&(b._nodes_by_id[this.id]=this);LEvent.trigger(this,"id_changed",a);return!0}this.id=a};SceneNode.prototype.getResources=function(a){for(var b in this._components)this._components[b].getResources&&this._components[b].getResources(a);this.material&&(b=this.getMaterial())&&b.getResources(a);return a};
SceneNode.prototype.getTransform=function(){return this.transform};SceneNode.prototype.getMesh=function(){var a=this.mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};SceneNode.prototype.getLight=function(){return this.light};SceneNode.prototype.getCamera=function(){return this.camera};
SceneNode.prototype.getLODMesh=function(){var a=this.lod_mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.lod_mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};SceneNode.prototype.setMesh=function(a,b){this.meshrenderer?"string"==typeof a?this.meshrenderer.configure({mesh:a,submesh_id:b}):this.meshrenderer.mesh=a:this.addComponent(new MeshRenderer({mesh:a,submesh_id:b}))};
SceneNode.prototype.loadAndSetMesh=function(a,b){b=b||{};if(ResourcesManager.meshes[a]||!a){if(this.setMesh(a),b.on_complete)b.on_complete(ResourcesManager.meshes[a],this)}else{var c=this;ResourcesManager.loadMesh(a,b,function(a){c.setMesh(a.filename);c.loading-=1;0==c.loading&&(LEvent.trigger(c,"resource_loaded",c),delete c.loading);if(b.on_complete)b.on_complete(a,c)})||(this.loading?this.loading+=1:(this.loading=1,LEvent.trigger(this,"resource_loading")))}};
SceneNode.prototype.getMaterial=function(){return this.material?this.material.constructor===String?this._on_tree?this._on_tree.materials[this.material]:null:this.material:null};SceneNode.prototype.clone=function(){var a=this._on_tree;a&&a.generateUniqueNodeName(this.id);var b=new SceneNode(d);b.configure(this.serialize());for(var c in this._children){var d=a?a.generateUniqueNodeName(this._children[c].id):this._children[c].id,d=new SceneNode(d);d.configure(this._children[c].serialize());b.addChild(d)}return b};
SceneNode.prototype.configure=function(a){a.id&&this.setId(a.id);a.className&&(this.className=a.className);a.mesh&&this.addComponent(new MeshRenderer({mesh:a.mesh,submesh_id:a.submesh_id}));a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material));if(a.flags)for(var b in a.flags)this.flags[b]=a.flags[b];a.transform&&this.transform.configure(a.transform);a.light&&this.addComponent(new Light(a.light));a.camera&&this.addComponent(new Camera(a.camera));a.model&&this.transform.fromMatrix(a.model);
a.extra&&(this.extra=a.extra);a.comments&&(this.comments=a.comments);a.components&&this.configureComponents(a);this.configureChildren(a);LEvent.trigger(this,"configure",a)};
SceneNode.prototype.serialize=function(){var a={};this.id&&(a.id=this.id);this.className&&(a.className=this.className);this.mesh&&"string"==typeof this.mesh&&(a.mesh=this.mesh);null!=this.submesh_id&&(a.submesh_id=this.submesh_id);this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());this.flags&&(a.flags=cloneObject(this.flags));this.extra&&(a.extra=this.extra);this.comments&&(a.comments=this.comments);this._children&&(a.children=this.serializeChildren());
this.serializeComponents(a);LEvent.trigger(this,"serialize",a);return a};SceneNode.prototype._onChildAdded=function(a,b){if(b&&this.transform){var c=a.transform.getGlobalMatrix(),d=this.transform.getGlobalMatrix();mat4.invert(d,d);a.transform.fromMatrix(mat4.multiply(d,d,c))}this.transform&&(a.transform._parent=this.transform)};
SceneNode.prototype._onChangeParent=function(a,b){if(b&&a.transform){var c=this.transform.getGlobalMatrix(),d=a.transform.getGlobalMatrix();mat4.invert(d,d);this.transform.fromMatrix(mat4.multiply(d,d,c))}a.transform&&(this.transform._parent=a.transform)};SceneNode.prototype._onChildRemoved=function(a,b){if(this.transform)if(b){var c=a.transform.getGlobalMatrix();a.transform._parent=null;a.transform.fromMatrix(c)}else a.transform._parent=null};LS.SceneTree=SceneTree;LS.SceneNode=SceneNode;
var Scene=new SceneTree;LS.ResourcesManager=ResourcesManager;LS.Generators=Generators;LS.newMeshNode=function(a,b){var c=new SceneNode(a);c.addComponent(new MeshRenderer);c.setMesh(b);return c};LS.newLightNode=function(a){a=new SceneNode(a);a.addComponent(new Light);return a};LS.newCameraNode=function(a){a=new SceneNode(a);a.addComponent(new Camera);return a};
function Context(a){a=a||{};if(a.container_id){var b=document.getElementById(a.container_id);if(b){var c=document.createElement("canvas");c.width=b.offsetWidth;c.height=b.offsetHeight;b.appendChild(c);a.canvas=c}}this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_options={};a.resources&&(LS.ResourcesManager.path=a.resources);a.shaders&&Shaders.init(a.shaders);this.force_redraw=a.redraw||!1;this.interactive=!0;this.gl.ondraw=Context.prototype._ondraw.bind(this);this.gl.onupdate=Context.prototype._onupdate.bind(this);
this.gl.onmousedown=Context.prototype._onmouse.bind(this);this.gl.onmousemove=Context.prototype._onmouse.bind(this);this.gl.onmouseup=Context.prototype._onmouse.bind(this);this.gl.onmousewheel=Context.prototype._onmouse.bind(this);this.gl.onkeydown=Context.prototype._onkey.bind(this);this.gl.onkeyup=Context.prototype._onkey.bind(this);gl.captureMouse(!0);gl.captureKeys(!0)}Context.prototype.loadScene=function(a,b){Scene.loadScene(a,function(){Scene.start();b&&b()})};
Context.prototype._ondraw=function(){if(this.onPreDraw)this.onPreDraw();(Scene._must_redraw||this.force_redraw)&&Scene.render(Scene.current_camera,this.render_options);if(this.onDraw)this.onDraw()};Context.prototype._onupdate=function(a){if(this.onPreUpdate)this.onPreUpdate(a);Scene.update(a);if(this.onUpdate)this.onUpdate(a)};
Context.prototype._onmouse=function(a){!this.interactive||"mousedown"!=a.eventType&&"mousewheel"!=a.eventType||(this._clicked_node=Renderer.getNodeAtCanvasPosition(Scene,a.mousex,a.mousey));var b=null;this._clicked_node&&this._clicked_node.interactive&&(a.scene_node=this._clicked_node,b=LEvent.trigger(this._clicked_node,a.eventType,a));b&&b.stop||LEvent.trigger(Scene.root,a.eventType,a);"mouseup"==a.eventType&&(this._clicked_node=null);this.onMouse&&(a.scene_node=this._clicked_node,this.onMouse(a))};
Context.prototype._onkey=function(a){this.onKey&&this.onKey(a)||LEvent.trigger(Scene,a.eventType,a)};LS.Context=Context;
