function BinaryPack(){this.nextChunkPos=0;this.dataArray=null;this.chunks={}}BinaryPack.HEADER_STRING="JBIN";BinaryPack.CHUNK_CODE_SIZE=16;
BinaryPack.CODES={Int8Array:{code:"I1",bytes:1},Uint8Array:{code:"i1",bytes:1},Int16Array:{code:"I2",bytes:2},Uint16Array:{code:"i2",bytes:2},Int32Array:{code:"I4",bytes:4},Uint32Array:{code:"i4",bytes:4},Float32Array:{code:"F4",bytes:4},Float64Array:{code:"F8",bytes:8},Object:{code:"OB",bytes:1},string:{code:"ST",bytes:1},number:{code:"NU",bytes:1},BinaryPack:{code:"BP",bytes:1}};
BinaryPack.prototype={reserve:function(a){this.dataArray=new Uint8Array(a||1048576);this.nextChunkPos=0},load:function(a){this.dataArray=new Uint8Array(a);this.nextChunkPos=0;this.chunks={};a={};for(var b=this.dataArray.subarray(0,4),c=!0,d=0;d<b.length;d++)if(0!=b[d]&&b[d]!=BinaryPack.HEADER_STRING.charCodeAt(d)){trace("Warning: deprecated bin format, please upgrade mesh");c=!1;break}c&&(this.nextChunkPos=4);b={};for(d in BinaryPack.CODES)b[BinaryPack.CODES[d].code]=d;for(;;){var e=this.getChunk();
if(null==e)break;this.chunks[e.code]=e;c=e.code.substring(0,2);d=e.code.substring(2,BinaryPack.CHUNK_CODE_SIZE-2);e=e.data;c=b[c];"string"==c?e=BinaryPack.typedArrayToString(e):"number"==c?e=parseFloat(BinaryPack.typedArrayToString(e)):"Object"==c?e=JSON.parse(BinaryPack.typedArrayToString(e)):"BinaryPack"==c?(e=new Uint8Array(e),e=(new BinaryPack).load(e)):(e=new Uint8Array(e),e=new window[c](e.buffer));a[d]=e}return a},save:function(a){var b=[],c=BinaryPack.HEADER_STRING.length,d;for(d in a){var e=
a[d],f=BinaryPack.getClassName(e),g=BinaryPack.CODES[f];if(null!=g){var h=g.code+d.substring(0,BinaryPack.CHUNK_CODE_SIZE-2);"number"==f?e=e.toString():"Object"==f?e=JSON.stringify(e):"BinaryPack"==f&&(e=e.getData());b.push({code:h,data:e});c+=e.length*g.bytes+BinaryPack.CHUNK_CODE_SIZE+4}}this.reserve(c);a=BinaryPack.stringToTypedArray(BinaryPack.HEADER_STRING);this._addArrayData(a);for(var n in b)a=b[n],this.addChunk(a.code,a.data);this.finalize();return this.getData()},getData:function(){return this.dataArray},
addChunk:function(a,b){if(null==this.dataArray)throw"BinaryPack needs to reserve space before adding data";"string"==typeof b&&(b=BinaryPack.stringToTypedArray(b));var c=BinaryPack.stringToTypedArray(a,BinaryPack.CHUNK_CODE_SIZE);this.dataArray.set(c,this.nextChunkPos);this.nextChunkPos+=c.length;c=new Uint32Array([b.byteLength]);c=new Uint8Array(c.buffer);this.dataArray.set(c,this.nextChunkPos);this.nextChunkPos+=c.length;this._addArrayData(b.buffer)},_addArrayData:function(a){a=new Uint8Array(a);
this.dataArray.set(a,this.nextChunkPos);this.nextChunkPos+=a.length},getChunk:function(){if(null==this.dataArray)throw"BinaryPack is empty, no data assigned";if(this.nextChunkPos==this.dataArray.length)return null;var a=BinaryPack.typedArrayToString(this.dataArray.subarray(this.nextChunkPos,this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE));if(""==a)return null;var b=this.getUint32(this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE);if(0==b)return null;var c=this.dataArray.subarray(this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE+
4,this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE+4+b);this.nextChunkPos=this.nextChunkPos+BinaryPack.CHUNK_CODE_SIZE+4+b;return""==a||0==b?null:{code:a,length:b,data:c}},finalize:function(){if(0!=this.nextChunkPos&&this.nextChunkPos!=this.dataArray.length){var a=new Uint8Array(this.nextChunkPos);a.set(this.dataArray.subarray(0,a.length),0);this.dataArray=a}},getUint32:function(a){var b=new Uint32Array(1);(new Uint8Array(b.buffer)).set(this.dataArray.subarray(a,a+4),0);return b[0]}};
BinaryPack.stringToTypedArray=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c};BinaryPack.typedArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};BinaryPack.getClassName=function(a){return"object"!=typeof a?null===a?!1:typeof a:/(\w+)\(/.exec(a.constructor.toString())[1]};
BinaryPack.linearizeArray=function(a,b){b=b||Float32Array;for(var c=a[0].length,d=null,d=new b(a.length*c),e=0;e<a.length;++e)for(var f=0;f<c;++f)d[e*c+f]=a[e][f];return d};
BinaryPack.encode64Array=function(a){var b="",c,d,e="",f,g,h="",n=0;a.constructor==ArrayBuffer&&(a=new Uint8Array(a));if(void 0==a.length)throw"binaryPacker: this input is not an array";var k=a.length;do c=a[n++],d=a[n++],e=a[n++],f=c>>2,c=(c&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),b=b+keyStr[f]+keyStr[c]+keyStr[g]+keyStr[h];while(n<k);return b};
BinaryPack.decode64ToArray=function(a){var b=new Uint8Array(a.length),c,d,e="",f,g="",h=0;if(/[^A-Za-z0-9\+\/\=]/g.exec(a))throw"There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.";a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");var n=0;do c=keyStr.indexOf(a.charAt(h++)),d=keyStr.indexOf(a.charAt(h++)),f=keyStr.indexOf(a.charAt(h++)),g=keyStr.indexOf(a.charAt(h++)),c=c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|g,b[n++]=
c,64!=f&&(b[n++]=d),64!=g&&(b[n++]=e);while(h<a.length);return new Uint8Array(b.subarray(0,n))};function ByteStruct(){this.fields=[]}
var Draw={ready:!1,images:{},onRequestFrame:null,init:function(){!this.ready&&gl&&(this.color=new Float32Array(4),this.color[3]=1,this.mvp_matrix=mat4.create(),this.camera_position=vec3.create(),this.temp_matrix=mat4.create(),this.point_size=2,this.stack=new Float32Array(512),this.model_matrix=new Float32Array(this.stack.buffer,0,64),mat4.identity(this.model_matrix),this.viewprojection_matrix=mat4.create(),this.camera_stack=[],this.shader=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\t\t\t  gl_FragColor = u_color;\n\t\t\t}\t\t"),this.shader_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\t\t\t  gl_FragColor = u_color * v_color;\n\t\t\t}\t\t"),
this.shader_texture=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, v_coord);\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t"),
this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]}),this.ready=!0)},setColor:function(a){for(var b=0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=a},setLineWidth:function(a){gl.lineWidth(a)},setPointSize:function(a){this.point_size=a},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},setViewProjectionMatrix:function(a){mat4.copy(this.viewprojection_matrix,a)},setMatrix:function(a){mat4.copy(this.model_matrix,
a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b){if(a&&a.length){var c=null,c=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=c.length/3&&(b=null);c=GL.Mesh.load({vertices:c,colors:b});return this.renderMesh(c,gl.LINES,b?this.shader_color:this.shader)}},renderPoints:function(a,b){if(a&&a.length){var c=null,c=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==
Float32Array?b:this.linearize(b));c=GL.Mesh.load({vertices:c,colors:b});return this.renderMesh(c,gl.POINTS,b?this.shader_color:this.shader)}},renderRectangle:function(a,b,c){var d=new Float32Array(12);c?d.set([0.5*-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):d.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);a=GL.Mesh.load({vertices:d});return this.renderMesh(a,gl.LINE_LOOP)},renderCircle:function(a,b,c){var d=[0,1,0];b=b||100;for(var e=quat.create(),f=vec3.create(),
g=new Float32Array(3*b),h=0;h<b;h++)quat.setAxisAngle(e,d,2*Math.PI*(h/b)),vec3.transformQuat(f,[0,0,a],e),c||vec3.set(f,f[0],f[2],f[1]),g.set(f,3*h);a=GL.Mesh.load({vertices:g});return this.renderMesh(a,gl.LINE_LOOP)},renderWireSphere:function(a,b){var c=[0,1,0];b=b||100;for(var d=quat.create(),e=vec3.create(),f=new Float32Array(9*b),g=0;g<b;g++)quat.setAxisAngle(d,c,2*Math.PI*(g/b)),vec3.transformQuat(e,[0,0,a],d),f.set(e,3*g),f.set([e[0],e[2],e[1]],3*g+3*b),f.set([e[1],e[0],e[2]],3*g+6*b);c=GL.Mesh.load({vertices:f});
return this.renderMesh(c,gl.LINES)},renderWireBox:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=new Float32Array([-a,b,c,-a,b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);a=GL.Mesh.load({vertices:a,lines:b});return this.renderMesh(a,gl.LINES)},renderSolidBox:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=GL.Mesh.load({vertices:[[-a,b,-c],[-a,-b,+c],[-a,b,c],[-a,b,-c],[-a,-b,-c],[-a,-b,+c],[a,b,-c],[a,b,c],[a,-b,+c],[a,b,-c],[a,-b,+c],[a,-b,
-c],[-a,b,c],[a,-b,c],[a,b,c],[-a,b,c],[-a,-b,c],[a,-b,c],[-a,b,-c],[a,b,-c],[a,-b,-c],[-a,b,-c],[a,-b,-c],[-a,-b,-c],[-a,b,-c],[a,b,c],[a,b,-c],[-a,b,-c],[-a,b,c],[a,b,c],[-a,-b,-c],[a,-b,-c],[a,-b,c],[-a,-b,-c],[a,-b,c],[-a,-b,c]]});return this.renderMesh(a,gl.TRIANGLES)},renderGrid:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),d=0,e=-b;e<=b;e++)c.set([e*a,0,a*b],d),c.set([e*a,0,-a*b],d+3),c.set([a*b,0,e*a],d+6),c.set([-a*b,0,e*a],d+9),d+=12;c=GL.Mesh.load({vertices:c});return this.renderMesh(c,
gl.LINES)},renderCone:function(a,b,c,d){var e=[0,1,0];c=c||100;var f=quat.create(),g=vec3.create(),h=new Float32Array(3*(c+2));h.set(d?[0,0,b]:[0,b,0],0);for(b=0;b<=c;b++)quat.setAxisAngle(f,e,2*Math.PI*(b/c)),vec3.transformQuat(g,[0,0,a],f),d&&vec3.set(g,g[0],g[2],g[1]),h.set(g,3*b+3);a=GL.Mesh.load({vertices:h});return this.renderMesh(a,gl.TRIANGLE_FAN)},renderCylinder:function(a,b,c,d){d=[0,1,0];c=c||100;for(var e=quat.create(),f=vec3.create(),g=new Float32Array(6*(c+1)),h=0;h<=c;h++)quat.setAxisAngle(e,
d,2*Math.PI*(h/c)),vec3.transformQuat(f,[0,0,a],e),g.set(f,6*h+3),f[1]=b,g.set(f,6*h);a=GL.Mesh.load({vertices:g});return this.renderMesh(a,gl.TRIANGLE_STRIP)},renderImage:function(a,b,c){c=c||10;var d=null;if("string"==typeof b){d=this.images[b];if(null==d){Draw.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);Draw.images[b]=a;if(Draw.onRequestFrame)Draw.onRequestFrame()};return}if(1==d)return}this.push();this.lookAt(a,this.camera_position,[0,1,0]);this.scale(c,
c,c);d.bind(0);this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture);this.pop()},renderMesh:function(a,b,c){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";c=c||this.shader;mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,this.model_matrix);c.uniforms({u_mvp:this.mvp_matrix,u_color:this.color,u_point_size:this.point_size,u_texture:0}).draw(a,void 0==b?gl.LINES:b);return this.last_mesh=a},renderText:function(a){Draw.text_atlas||this.createTextAtlas();for(var b=
this.text_atlas,c=a.length,d=b.atlas.char_size,e=b.atlas.spacing,f=0,g=0;g<c;++g)null!=b.atlas[a.charCodeAt(g)]&&f++;for(var h=new Float32Array(18*f),f=new Float32Array(12*f),n=0,k=0,g=y=0;g<c;++g){var l=b.atlas[a.charCodeAt(g)];l?(h.set([k,y,0],18*n),h.set([k,y+d,0],18*n+3),h.set([k+d,y+d,0],18*n+6),h.set([k+d,y,0],18*n+9),h.set([k,y,0],18*n+12),h.set([k+d,y+d,0],18*n+15),f.set([l[0],l[1]],12*n),f.set([l[0],l[3]],12*n+2),f.set([l[2],l[3]],12*n+4),f.set([l[2],l[1]],12*n+6),f.set([l[0],l[1]],12*n+
8),f.set([l[2],l[3]],12*n+10),k+=e,++n):10==a.charCodeAt(g)?(k=0,y-=d):k+=d}a=GL.Mesh.load({vertices:h,coords:f});b.bind(0);return this.renderMesh(a,gl.TRIANGLES,this.shader_texture)},createTextAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,d=a.getContext("2d");d.fillStyle="white";d.font=b+"px Courier New";d.textAlign="center";for(var e=0,f=0,b=-0.3*b,g={char_size:c,spacing:0.6*c},h=6;100>h;h++){var n=String.fromCharCode(h+27);g[h+27]=[e/a.width,1-(f+c)/a.height,(e+
c)/a.width,1-f/a.height];d.fillText(n,Math.floor(e+0.5*c),Math.floor(f+c+b),c);e+=c;e+c>a.width&&(e=0,f+=c)}this.text_atlas=GL.Texture.fromImage(a,{magFilter:gl.NEAREST,minFilter:gl.LINEAR});this.text_atlas.atlas=g},linearize:function(a){for(var b=a[0].length,c=new Float32Array(a.length*b),d=a.length,e=0;e<d;++e)c.set(a[e],e*b);return c},push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-64)throw"matrices stack overflow";var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,
this.model_matrix.byteOffset+64,64);mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-64,64)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},popCamera:function(){if(0==this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},identity:function(){mat4.identity(this.model_matrix)},scale:function(a,
b,c){3==arguments.length?mat4.scale(this.model_matrix,this.model_matrix,[a,b,c]):mat4.scale(this.model_matrix,this.model_matrix,a)},translate:function(a,b,c){3==arguments.length?mat4.translate(this.model_matrix,this.model_matrix,[a,b,c]):mat4.translate(this.model_matrix,this.model_matrix,a)},rotate:function(a,b,c,d){4==arguments.length?mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,d]):mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,
a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},project:function(a,b){b=b||vec3.create();return mat4.multiplyVec3(b,this.mvp_matrix,a)}};function HitTest(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c}HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};function Octree(a){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())}
Octree.prototype={MAX_OCTREE_TRIANGLES:500,MAX_OCTREE_DEPTH:8,OCTREE_MARGIN:10,buildFromMesh:function(a){this.total_nodes=this.total_depth=0;var b=a.vertices;a=a.triangles;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;c.min=[c.min[0]-this.OCTREE_MARGIN,c.min[1]-this.OCTREE_MARGIN,c.min[2]-this.OCTREE_MARGIN];c.max=[c.max[0]+0.9*this.OCTREE_MARGIN,c.max[1]+0.9*this.OCTREE_MARGIN,c.max[2]+0.9*this.OCTREE_MARGIN];c.faces=[];c.inside=0;if(a)for(var d=0;d<a.length;d+=3){var e=new Float32Array([b[3*
a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(e,c,0)}else for(d=0;d<b.length;d+=9)e=new Float32Array(b.subarray(d,d+9)),this.addToNode(e,c,0);return c},addToNode:function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),e=!1,f;for(f in b.c){var g=b.c[f];if(this.isInsideAABB(d,g)){this.addToNode(a,g,c+1);e=!0;break}}e||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),
b.faces.length>this.MAX_OCTREE_TRIANGLES&&c<this.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var h=b.faces.concat();b.faces=null;for(f in h){a=h[f];var d=this.computeAABB(a),e=!1,n;for(n in b.c)if(g=b.c[n],this.isInsideAABB(d,g)){this.addToNode(a,g,c+1);e=!0;break}e||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}},octree_pos_ref:[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]],splitNode:function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-
a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],e={};this.total_nodes+=1;e.min=[a.min[0]+b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];e.max=[e.min[0]+b[0],e.min[1]+b[1],e.min[2]+b[2]];e.faces=null;e.inside=0;a.c.push(e)}},isInsideAABB:function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0},computeAABB:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],a[1],a[2]],d=0;d<
a.length;d+=3)for(var e=0;3>e;e++)b[e]>a[d+e]&&(b[e]=a[d+e]),c[e]<a[d+e]&&(c[e]=a[d+e]);return{min:b,max:c}},trim:function(a){a=a||this.root;if(!a.c)return 1;var b=1,c=[],d;for(d in a.c)a.c[d].inside&&(c.push(a.c[d]),b+=this.trim(a.c[d]));a.c=c;return b},hitTestBox:function(a,b,c,d){var e=vec3.subtract(vec3.create(),c,a),f=vec3.subtract(vec3.create(),d,a);if(0>vec3.maxValue(e)&&0<vec3.minValue(f))return new HitTest(0,a,b);vec3.multiply(e,e,[1/b[0],1/b[1],1/b[2]]);vec3.multiply(f,f,[1/b[0],1/b[1],
1/b[2]]);var g=vec3.min(vec3.create(),e,f),e=vec3.max(vec3.create(),e,f),g=vec3.maxValue(g),e=vec3.minValue(e);return 0<g&&g<e?(a=vec3.add(vec3.create(),vec3.scale(vec3.create(),b,g),a),vec3.add(c,c,[1E-6,1E-6,1E-6]),vec3.subtract(c,c,[1E-6,1E-6,1E-6]),new HitTest(g,a,vec3.create([(a[0]>d[0])-(a[0]<c[0]),(a[1]>d[1])-(a[1]<c[1]),(a[2]>d[2])-(a[2]<c[2])]))):null},tested_boxes:0,tested_triangles:0,testRay:function(a,b,c,d){a=vec3.clone(a);b=vec3.clone(b);Octree.prototype.tested_boxes=0;Octree.prototype.tested_triangles=
0;if(!this.root)throw"Error: octree not build";window.hitTestBox=this.hitTestBox;window.hitTestTriangle=this.hitTestTriangle;window.testRayInNode=Octree.prototype.testRayInNode;c=hitTestBox(a,b,vec3.clone(this.root.min),vec3.clone(this.root.max));if(!c)return null;c=testRayInNode(this.root,a,b);if(null!=c)return b=vec3.scale(vec3.create(),b,c.t),vec3.add(b,b,a),b;delete window.hitTestBox;delete window.hitTestTriangle;delete window.testRayInNode;return null},testRayInNode:function(a,b,c){var d=null,
e=null;Octree.prototype.tested_boxes+=1;if(a.faces)for(var f in a.faces)d=a.faces[f],Octree.prototype.tested_triangles+=1,d=hitTestTriangle(b,c,vec3.fromValues(d[0],d[1],d[2]),vec3.fromValues(d[3],d[4],d[5]),vec3.fromValues(d[6],d[7],d[8])),null!=d&&(e?e.mergeWith(d):e=d);var g;if(a.c)for(f in a.c)g=a.c[f],d=hitTestBox(b,c,vec3.clone(g.min),vec3.clone(g.max)),null==d||e&&d.t>e.t||(d=testRayInNode(g,b,c),null!=d&&(e?e.mergeWith(d):e=d));return e},hitTestTriangle:function(a,b,c,d,e){var f=vec3.subtract(vec3.create(),
d,c),g=vec3.subtract(vec3.create(),e,c);e=vec3.cross(vec3.create(),f,g);vec3.normalize(e,e);if(!(0<vec3.dot(e,b))){d=vec3.dot(e,vec3.subtract(vec3.create(),c,a))/vec3.dot(e,b);if(0<d){b=vec3.scale(vec3.create(),b,d);vec3.add(b,b,a);var h=vec3.subtract(vec3.create(),b,c);a=vec3.dot(g,g);c=vec3.dot(g,f);var g=vec3.dot(g,h),n=vec3.dot(f,f),f=vec3.dot(f,h),h=a*n-c*c,n=(n*g-c*f)/h,f=(a*f-c*g)/h;if(0<=n&&0<=f&&1>=n+f)return new HitTest(d,b,e)}return null}}};
var Shaders={shaders:{},globals:{},default_shader:null,init:function(a,b){this.shaders={};this.globals={};this.default_shader=null;this.global_extra_code=String.fromCharCode(10)+"#define WEBGL"+String.fromCharCode(10);this.createDefaultShaders();this.default_shader=this.get("flat");this.last_shaders_url=a=a||"data/shaders.xml";this.loadFromXML(a,!1,b)},reloadShaders:function(a){this.loadFromXML(this.last_shaders_url,!0,!0,a)},get:function(a,b){if(!a)return null;if(!b){var c=this.shaders[a];if(null!=
c)return c}var d=this.globals[a];if(null==d)return this.default_shader;var e=a,c="";if(0!=d.num_macros&&b){var e=e+":",f;for(f in b)d.macros[f]&&(e+=f+"="+b[f]+":",c+=String.fromCharCode(10)+"#define "+f+" "+b[f]+String.fromCharCode(10))}if(null!=this.shaders[e])return this.shaders[e];if(c=this.compileShader(c+d.vs_code,c+d.ps_code,e))c.global=d;return this.registerShader(c,e,a)},getGlobalShaderInfo:function(a){return this.globals[a]},compileShader:function(a,b,c){if(!gl)return null;var d=null;try{d=
new GL.Shader(this.global_extra_code+a,this.global_extra_code+b),d.name=c,trace("Shader compiled: "+c)}catch(e){trace("Error compiling shader: "+c);trace(e);trace("VS CODE\n************");a=(this.global_extra_code+a).split("\n");for(var f in a)trace(f+": "+a[f]);trace("PS CODE\n************");a=(this.global_extra_code+b).split("\n");for(f in a)trace(f+": "+a[f]);return null}return d},registerShader:function(a,b,c){if(null==a)return this.shaders[b]=this.default_shader;a.id=c;a.key=b;return this.shaders[b]=
a},loadFromXML:function(a,b,c,d){c=c?"?nocache="+(new Date).getTime()+Math.floor(1E3*Math.random()):"";LS.request({url:a+c,dataType:"xml",success:function(a){trace("Shaders XML loaded");b&&(Shaders.globals={},Shaders.shaders={});Shaders.processShadersXML(a);d&&d()},error:function(a){trace("Error parsing Shaders XML: "+a);throw"Error parsing Shaders XML: "+a;}})},processShadersXML:function(a){a=a.querySelectorAll("shader");for(var b in a){var c=a[b];if(c&&c.attributes){var d=c.attributes.id;if(d){var d=
d.value,e="",f="";(e=c.attributes.macros)&&(e=e.value.split(","));var g={};for(b in e)g[e[b]]=!0;e=c.querySelector("code[type='vertex_shader']").textContent;f=c.querySelector("code[type='pixel_shader']").textContent;e&&f?(c=(c=c.attributes.multipass)?"1"==c.value||"true"==c.value:!1,Shaders.addGlobalShader(e,f,d,g,c)):trace("no code in shader: "+d)}}}},addGlobalShader:function(a,b,c,d,e){var f=0,g;for(g in d)f+=1;a={vs_code:a,ps_code:b,macros:d,num_macros:f,macros_found:{},multipass:e};return this.globals[c]=
a},common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_mvp;\n\t",common_pscode:"\n\t\tprecision mediump float;\n\t",createDefaultShaders:function(){this.addGlobalShader(this.common_vscode+"\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t  gl_FragColor = vec4(u_material_color);\t\t\t}\t\t",
"flat");this.addGlobalShader(this.common_vscode+"\t\t\tvarying vec2 v_uvs;\t\t\tvoid main() {\n\t\t\t\tv_uvs = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvarying vec2 v_uvs;\t\t\tuniform sampler2D texture;\t\t\tvoid main() {\t\t\t\tgl_FragColor = u_material_color * texture2D(texture,v_uvs);\t\t\t}\t\t","texture_flat");this.addGlobalShader(this.common_vscode+"\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tcoord = a_coord;\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\t\t}\t\t",
this.common_pscode+"\t\t\tuniform sampler2D texture;\t\t\tuniform vec4 color;\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, coord) * color;\t\t\t}\t\t","screen");this.addGlobalShader(this.common_vscode+"\t\t\tvarying vec4 v_pos;\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\tv_pos = gl_Position;\t\t\t}\t\t\t",this.common_pscode+"\t\t\tprecision highp float;\t\t\tvarying vec4 v_pos;\t\t\tvec3 PackDepth24(float depth)\t\t\t{\t\t\t\tfloat depthInteger = floor(depth);\t\t\t\tfloat depthFraction = fract(depth);\t\t\t\tfloat depthUpper = floor(depthInteger / 256.0);\t\t\t\tfloat depthLower = depthInteger - (depthUpper * 256.0);\t\t\t\treturn vec3(depthUpper / 256.0, depthLower / 256.0, depthFraction);\t\t\t}\t\t\t\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t\tvec4 color = vec4(0.0);\t\t\t\tcolor.x = u_material_color.x; \t\t\t\tfloat depth = v_pos.z / v_pos.w;\t\t\t    color.yzw = PackDepth24(depth*256.0);\t\t\t  gl_FragColor = color;\t\t\t}\t\t",
"picking_depth")}};function trace(a){"undefined"!=typeof console&&console.log(a)}function toArray(a){return Array.apply([],a)}
var LS={_last_uid:0,generateUId:function(){return this._last_uid++},Components:{},registerComponent:function(a){for(var b in arguments)this.Components[getClassName(arguments[b])]=arguments[b],a.prototype.serialize||(a.prototype.serialize=LS._serialize),a.prototype.configure||(a.prototype.configure=LS._configure),LEvent.trigger(LS,"component_registered",arguments[b])},_configure:function(a){LS.cloneObject(a,this)},_serialize:function(){return LS.cloneObject(this)},request:function(a){var b=a.dataType||
"text";if("json"==b)b="text";else if("xml"==b)b="text";else if("binary"==b)b="arraybuffer",a.mimeType="application/octet-stream";else if("image"==b)return b=new Image,b.onload=function(){a.success&&a.success.call(this)},b.onerror=a.error,b.src=a.url,b;var c=new XMLHttpRequest;c.open(a.data?"POST":"GET",a.url,!0);b&&(c.responseType=b);a.mimeType&&c.overrideMimeType(a.mimeType);c.onload=function(b){b=this.response;if("json"==a.dataType)try{b=JSON.parse(b)}catch(c){a.error&&a.error(c)}else if("xml"==
a.dataType)try{b=(new DOMParser).parseFromString(b,"text/xml")}catch(f){a.error&&a.error(f)}a.success&&a.success.call(this,b)};c.onerror=a.error;c.send(a.data);return c}};function extendClass(a,b){for(var c in a)b[c]=a[c];if(a.prototype)for(c in a.prototype)b.prototype[c]=a.prototype[c]}LS.extendClass=extendClass;
function cloneObject(a,b){var c=b||{},d;for(d in a)if("_"!=d[0]&&"jQuery"!=d.substr(0,6)){var e=a[d];null==e?c[d]=null:isFunction(e)||("number"==typeof e||"string"==typeof e?c[d]=e:e.constructor==Float32Array?c[d]=Array.apply([],e):isArray(e)?c[d]&&c[d].constructor==Float32Array?c[d].set(e):c[d]=e.slice(0):c[d]=JSON.parse(JSON.stringify(e)))}return c}LS.cloneObject=cloneObject;
function getObjectClassName(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}LS.getObjectClassName=getObjectClassName;function getClassName(a){if(a&&a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}LS.getClassName=getClassName;
var ResourcesManager={path:"",ignore_cache:!1,free_data:!1,resources:{},meshes:{},textures:{},resources_being_loaded:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,formats:{js:"text",json:"json",xml:"xml",jpg:"image",png:"image",bmp:"image"},resource_parsers:{},getNoCache:function(a){return this.ignore_cache||a?"?nocache="+(new Date).getTime()+Math.floor(1E3*Math.random()):""},reset:function(){this.resources={};this.meshes={};this.textures={}},getExtension:function(a){var b=a.lastIndexOf(".");
if(-1==b)return"";var c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c).toLowerCase()},load:function(a,b,c){b=b||{};if(null!=this.resources[a])return c&&c(this.resources[a]),!0;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,callback:c});else{this.resources_being_loaded[a]=[{options:b,callback:c}];0==this.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;c=a.lastIndexOf(".")+
1;var d=a.substr(c,a.length).toLowerCase();c="";c="http://"==a.substr(0,7)?a:b.local_repository?b.local_repository+"/"+a:this.path+a;b.force_local_url&&(c=a);d=this.getNoCache();c={url:c+d,success:function(c){c=ResourcesManager.processResource(a,c,b);ResourcesManager._resource_loaded_success(a,c)},error:function(b){ResourcesManager._resource_loaded_error(a,b)}};d=this.getExtension(a);(d=this.formats[d])||(d="text");c.dataType=d;LS.request(c);return!1}},processResource:function(a,b,c){c=null;b.object_type&&
window[b.object_type]&&(c=new window[b.object_type](b));if(c)return c.fullpath||(c.fullpath=a),c.getResources&&ResourcesManager.loadResources(c.getResources({})),this.registerResource(a,c),c;trace("Unknown resource loaded")},loadMesh:function(a,b,c){b=b||{};if(null!=this.meshes[a])return c&&c(this.meshes[a]),!0;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,callback:c});else{this.resources_being_loaded[a]=[{options:b,callback:c}];0==this.num_resources_being_loaded&&
LEvent.trigger(ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;c=a.lastIndexOf(".")+1;a.substr(c,a.length).toLowerCase();c="";c="http://"==a.substr(0,7)?a:b.local_repository?b.local_repository+"/"+a:this.path+a;b.force_local_url&&(c=a);var d=this.getNoCache();c={url:c+d,success:function(c){c=ResourcesManager.processMesh(a,c,b);ResourcesManager._resource_loaded_success(a,c)},error:function(b){ResourcesManager._resource_loaded_error(a,b)}};d=Parser.getResourceInfo(a);
c.dataType="text";d.format==Parser.JSON_FORMAT?c.dataType="json":d.format==Parser.XML_FORMAT?c.dataType="xml":d.format==Parser.BINARY_FORMAT&&(c.dataType="binary");LS.request(c);return!1}},processMesh:function(a,b,c){c=c||{};if(!gl)return null;Parser.getResourceInfo(a);var d=null,d=c.ignore_parser?b:Parser.parse(a,b,c);if(null==d)throw"Error parsing mesh: "+a;a=c.name||a;b=GL.Mesh.load(d);b.object_type="Mesh";b.info=d.info;b.metadata={};b.filename=a;b.generateMetadata();b.bounding||b.computeBounding();
this.free_data&&b.freeData();this.registerResource(a,b);return b},loadImage:function(a,b,c){b=b||{};if(null!=this.textures[a])return c&&c(this.textures[a]),!0;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:null,callback:c});else{this.resources_being_loaded[a]=[{options:null,callback:c}];0==this.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;c="";c="http://"==a.substr(0,7)||"https://"==
a.substr(0,8)||b.force_local_url?a:b.local_repository?b.local_repository+"/"+a:this.path+a;var d=this.getNoCache();trace("Processing image: "+a);var e=Parser.getResourceInfo(a);e.type==Parser.IMAGE_DATA?(e=new Image,e.type="IMG",e.onload=function(){this.onload=null;this.filename=a;b.flipY&&(this.flipY=b.flipY);var c=ResourcesManager.processImage(a,this,b);ResourcesManager._resource_loaded_success(a,c)},e.onerror=function(b){ResourcesManager._resource_loaded_error(a,b)},e.src=c+d):e.type==Parser.NONATIVE_IMAGE_DATA?
(c=this.path+a,d=this.getNoCache(),LS.request({url:c+d,dataType:"binary",success:function(c){c=Parser.parse(a,c);var d=null;c&&(d=ResourcesManager.processImage(a,c,b),ResourcesManager._resource_loaded_success(a,d));delete ResourcesManager.resources_being_loaded[a]},error:function(b){ResourcesManager._resource_loaded_error(a,b)}})):ResourcesManager._resource_loaded_error(a,"Wront file format");return!1}},processImage:function(a,b,c){if(!gl)return null;if(b.width>this.MAX_TEXTURE_SIZE)return trace("too big, max is "+
this.MAX_TEXTURE_SIZE),null;if(b.constructor==Texture)c=b,c.filename=a,this.registerResource(a,c),trace("DDS created");else if(b.width==b.height/6)c=Texture.cubemapFromImage(b,{wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR}),c.img=b,c.filename=a,this.registerResource(a,c),trace("Cubemap created");else{c=gl.LINEAR;var d=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||(d=gl.LINEAR);c=b.pixels?GL.Texture.fromMemory(b.width,b.height,b.pixels,
{format:24==b.bpp?gl.RGB:gl.RGBA,flipY:b.flipY,wrapS:gl.REPEAT,wrapT:gl.REPEAT,magFilter:c,minFilter:d}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:gl.REPEAT,wrapT:gl.REPEAT,magFilter:c,minFilter:d,flipY:b.flipY});c.img=b;c.filename=a;this.registerResource(a,c)}c.filename=a;c.generateMetadata();LEvent.trigger(Scene,"change");return c},loadResources:function(a,b){for(var c in a)"string"==typeof c&&":"!=c[0]&&(a[c]==Mesh?this.loadMesh(c,b):a[c]==Texture?this.loadImage(c,b):this.load(c,b))},computeImageMetadata:function(a){return{width:a.width,
height:a.height}},registerResource:function(a,b){b.object_type||(b.object_type=getObjectClassName(b));var c=b.object_type;"Mesh"==c?this.meshes[a]=b:"Texture"==c?this.textures[a]=b:"Material"==c?Scene.materials[a]=b:trace("Unknown res type: "+c);this.resources[a]=b;LEvent.trigger(this,"resource_loaded",b)},getMesh:function(a){return null!=a?this.meshes[a]:null},getTexture:function(a){return null!=a?this.textures[a]:null},_resource_loaded_success:function(a,b){for(var c in ResourcesManager.resources_being_loaded[a])null!=
ResourcesManager.resources_being_loaded[a][c].callback&&ResourcesManager.resources_being_loaded[a][c].callback(b);ResourcesManager.resources_being_loaded[a]&&(delete ResourcesManager.resources_being_loaded[a],ResourcesManager.num_resources_being_loaded--,0==ResourcesManager.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"end_loading_resources"))},_resource_loaded_error:function(a,b){trace("Error loading "+a);delete ResourcesManager.resources_being_loaded[a];LEvent.trigger(ResourcesManager,
"resource_not_found",a);ResourcesManager.num_resources_being_loaded--;0==ResourcesManager.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"end_loading_resources")},require:function(a,b){function c(a){for(var b=a.shift(1);ResourcesManager._required_files[b]&&b;)b=a.shift(1);ResourcesManager._required_files[b]=!0;LS.request({url:b,success:function(d){eval(d);if(ResourcesManager._waiting_callbacks[b])for(var h in ResourcesManager._waiting_callbacks[b])ResourcesManager._waiting_callbacks[b][h]();
c(a)}})}"string"==typeof a&&(a=[a]);var d=a[a.length-1];b&&(ResourcesManager._waiting_callbacks[d]?ResourcesManager._waiting_callbacks[d].push(b):ResourcesManager._waiting_callbacks[d]=[b]);c(a)},_required_files:{},_waiting_callbacks:{}};LS.ResourcesManager=ResourcesManager;
var Generators={generators:{},addGenerator:function(a,b){this.generators[a]=b},executeGenerator:function(a){var b=this.generators[a.action];if(!b||"function"!=typeof b)return null;try{var c=b(a);c.generator=b;return c}catch(d){trace("Error in generator: "+d)}return null}};LS.Generators=Generators;
LS.getCurveValueAt=function(a,b,c,d,e){if(e<b||e>c)return d;b=[b,d];for(var f=0,f=0;f<a.length;f+=1){var g=a[f];if(e==g[0])return g[1];if(e<g[0])return f=(e-b[0])/(g[0]-b[0]),b[1]*(1-f)+g[1]*f;b=g}g=[c,d];f=(e-b[0])/(g[0]-b[0]);return b[1]*(1-f)+g[1]*f};LS.resampleCurve=function(a,b,c,d,e){var f=[];f.length=e;for(var g=(c-b)/e,h=0;h<e;h++)f[h]=LS.getCurveValueAt(a,b,c,d,b+g*h);return f};
function Material(a){this._uid=LS.generateUId();this.color=new Float32Array([1,1,1]);this.alpha=1;this.ambient=new Float32Array([1,1,1]);this.diffuse=new Float32Array([1,1,1]);this.emissive=new Float32Array([0,0,0]);this.backlight_factor=0;this.specular_factor=0.1;this.specular_gloss=10;this.specular_ontop=!1;this.reflection_factor=0;this.reflection_fresnel=1;this.reflection_specular=this.reflection_additive=!1;this.velvet=new Float32Array([0.5,0.5,0.5]);this.velvet_exp=0;this.velvet_additive=!1;
this.detail=[0,10,10];this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.extra_factor=0;this.extra_color=new Float32Array([0,0,0]);this.blending=Material.NORMAL;this.normalmap_factor=1;this.displacementmap_factor=0.1;this.bumpmap_factor=1;this.textures={};a&&this.configure(a)}Material.NORMAL="normal";Material.ADDITIVE_BLENDING="additive";Material.COLOR="color";Material.ALPHA="alpha";Material.BLENDING="blending";Material.AMBIENT="ambient";Material.DIFFUSE="diffuse";
Material.BACKLIGHT_FACTOR="backlight_factor";Material.EMISSIVE="emissive";Material.SPECULAR_FACTOR="specular_factor";Material.SPECULAR_GLOSS="specular_gloss";Material.SPECULAR_ON_TOP="specular_ontop";Material.REFLECTION_FACTOR="reflection_factor";Material.REFLECTION_FRESNEL="reflection_fresnel";Material.REFLECTION_ADDITIVE="reflection_additive";Material.REFLECTION_SPECULAR="reflection_specular";Material.VELVET="velvet";Material.VELVET_EXP="velvet_exp";Material.VELVET_ADDITIVE="velvet_additive";
Material.NORMALMAP_FACTOR="normalmap_factor";Material.DISPLACEMENTMAP_FACTOR="displacementmap_factor";Material.OPACITY_TEXTURE="opacity";Material.AMBIENT_TEXTURE="ambient";Material.COLOR_TEXTURE="color";Material.SPECULAR_TEXTURE="specular";Material.EMISSIVE_TEXTURE="emissive";Material.DETAIL_TEXTURE="detail";Material.REFLECTIVITY_TEXTURE="reflectivity";Material.ENVIRONMENT_TEXTURE="environment";Material.NORMAL_TEXTURE="normal";Material.BUMP_TEXTURE="bump";Material.DISPLACEMENT_TEXTURE="displacement";
Material.IRRADIANCE_TEXTURE="irradiance";Material.EXTRA_TEXTURE="extra";Material.TEXTURE_CHANNELS=[Material.COLOR_TEXTURE,Material.OPACITY_TEXTURE,Material.AMBIENT_TEXTURE,Material.SPECULAR_TEXTURE,Material.EMISSIVE_TEXTURE,Material.DETAIL_TEXTURE,Material.NORMAL_TEXTURE,Material.DISPLACEMENT_TEXTURE,Material.BUMP_TEXTURE,Material.REFLECTIVITY_TEXTURE,Material.ENVIRONMENT_TEXTURE,Material.IRRADIANCE_TEXTURE,Material.EXTRA_TEXTURE];Material.COORDS_UV0="0";Material.COORDS_UV1="1";
Material.COORDS_UV_TRANSFORMED="transformed";Material.COORDS_SCREEN="screen";Material.COORDS_POLAR="polar";Material.COORDS_POLAR_REFLECTED="polar_reflected";Material.COORDS_WORLDXZ="worldxz";Material.COORDS_WORLDXY="worldxy";Material.COORDS_WORLDYZ="worldyz";Material.TEXTURE_COORDINATES=[Material.COORDS_UV0,Material.COORDS_UV1,Material.COORDS_UV_TRANSFORMED,Material.COORDS_SCREEN,Material.COORDS_POLAR,Material.COORDS_POLAR_REFLECTED,Material.COORDS_WORLDXY,Material.COORDS_WORLDXZ,Material.COORDS_WORLDYZ];
Material.DEFAULT_UVS={normal:Material.COORDS_UV0,displacement:Material.COORDS_UV0,environment:Material.COORDS_POLAR_REFLECTED,irradiance:Material.COORDS_POLAR};Material.prototype.getShader=function(a,b,c){return Shaders.get(a,b)};
Material.prototype.getSurfaceShaderMacros=function(a,b,c,d,e){for(var f in scene.textures)!(b=Material.prototype.getTexture.call(scene,f))||"environment"==f&&0>=this.reflection_factor||(c=this.textures[f+"_uvs"]||Material.DEFAULT_UVS[f]||"0",a["USE_"+f.toUpperCase()+(b.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+c);for(f in this.textures)if(b=this.getTexture(f)){uniforms[f+(b.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=b.bind(last_slot);c=this.textures[f+"_uvs"]||Material.DEFAULT_UVS[f]||
"0";if("environment"==f)if(0>=this.reflection_factor)continue;else if("normal"==f){0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(a.USE_NORMAL_TEXTURE="uvs_"+c,0!=this.normalmap_factor&&(a.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(a.USE_TANGENT_NORMALMAP=""));continue}else if("displacement"==f){0!=this.displacementmap_factor&&gl.derivatives_supported&&(a.USE_DISPLACEMENT_TEXTURE="uvs_"+c,1!=this.displacementmap_factor&&
(a.USE_DISPLACEMENTMAP_FACTOR=""));continue}else if("bump"==f){0!=this.bump_factor&&gl.derivatives_supported&&(a.USE_BUMP_TEXTURE="uvs_"+c,1!=this.bumpmap_factor&&(a.USE_BUMPMAP_FACTOR=""));continue}a["USE_"+f.toUpperCase()+(b.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+c}this.velvet&&this.velvet_exp&&(a.USE_VELVET="");this.emissive_material&&(a.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&(a.USE_SPECULAR_ONTOP="");this.specular_on_alpha&&(a.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&
(a.USE_SPECULAR_IN_REFLECTION="");0.001<this.backlight_factor&&(a.USE_BACKLIGHT="");if(this.extra_macros)for(var g in this.extra_macros)a[g]=this.extra_macros[g]};
Material.prototype.getLightShaderMacros=function(a,b,c,d,e,f){c.use_diffuse&&!this.constant_diffuse&&(a.USE_DIFFUSE_LIGHT="");c.use_specular&&0<this.specular_factor&&(a.USE_SPECULAR_LIGHT="");c.type==Light.DIRECTIONAL?a.USE_DIRECTIONAL_LIGHT="":c.type==Light.SPOT&&(a.USE_SPOT_LIGHT="");c.spot_cone&&(a.USE_SPOT_CONE="");c.linear_attenuation&&(a.USE_LINEAR_ATTENUATION="");c.range_attenuation&&(a.USE_RANGE_ATTENUATION="");light_projective_texture&&(a.USE_PROJECTIVE_LIGHT="");if(0.001>vec3.squaredLength(c.color)||
node.flags.ignore_lights)a.USE_AMBIENT_ONLY="";0.001<c.offset&&(a.USE_LIGHT_OFFSET="");use_shadows&&!1!=node.flags.receive_shadows&&(a.USE_SHADOW_MAP="",c.hard_shadows&&(a.USE_HARD_SHADOWS=""),a.SHADOWMAP_OFFSET="");uniforms.MACROS=a;return uniforms};
Material.prototype.fillSurfaceUniforms=function(a,b,c,d,e,f){b.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.alpha]);b.u_ambient_color=d.flags.ignore_lights?[1,1,1]:[e.ambient_color[0]*this.ambient[0],e.ambient_color[1]*this.ambient[1],e.ambient_color[2]*this.ambient[2]];b.u_diffuse_color=this.diffuse;b.u_emissive_color=this.emissive||[0,0,0];b.u_specular=[this.specular_factor,this.specular_gloss];b.u_reflection_info=[this.reflection_additive?-this.reflection_factor:
this.reflection_factor,this.reflection_fresnel];b.u_backlight_factor=this.backlight_factor;b.u_normalmap_factor=this.normalmap_factor;b.u_displacementmap_factor=this.displacementmap_factor;b.u_bumpmap_factor=this.bumpmap_factor;b.u_velvet_info=[this.velvet[0],this.velvet[1],this.velvet[2],this.velvet_additive?this.velvet_exp:-this.velvet_exp];b.u_detail_info=this.detail;b.u_texture_matrix=this.uvs_matrix;for(var g in e.textures)if(a=Material.prototype.getTexture.call(e,g))(b[g+(a.texture_type==gl.TEXTURE_2D?
"_texture":"_cubemap")]=a.bind(last_slot),last_slot+=1,"environment"==g&&0>=this.reflection_factor||(c=this.textures[g+"_uvs"]||Material.DEFAULT_UVS[g]||"0",c!=Material.COORDS_POLAR_REFLECTED&&c!=Material.COORDS_POLAR))||(a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));for(g in this.textures)if(a=this.getTexture(g)){b[g+(a.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=a.bind(last_slot);c=this.textures[g+"_uvs"]||Material.DEFAULT_UVS[g]||"0";
last_slot+=1;if("environment"==g)if(0>=this.reflection_factor)continue;else if("normal"==g)continue;else if("displacement"==g)continue;else if("bump"==g)continue;else"irradiance"==g&&(a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),a.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE));a.texture_type!=gl.TEXTURE_2D||c!=Material.COORDS_POLAR_REFLECTED&&c!=Material.COORDS_POLAR||(a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),a.setParameter(gl.TEXTURE_MIN_FILTER,
gl.LINEAR))}};
Material.prototype.fillLightUniforms=function(a,b,c,d,e,f,g){a=f.settings.enable_shadows&&c.cast_shadows&&c._shadowMap&&null!=c._lightMatrix&&!g.shadows_disabled;(e=c.projective_texture)&&e.constructor==String&&(e=ResourcesManager.textures[e]);e&&(b.light_texture=e.bind(11));if(c.type==Light.DIRECTIONAL||c.type==Light.SPOT)b.u_light_front=c.getFront();c.type==Light.SPOT&&(b.u_light_angle=[c.angle*DEG2RAD,c.angle_end*DEG2RAD,Math.cos(0.5*c.angle*DEG2RAD),Math.cos(0.5*c.angle_end*DEG2RAD)]);b.u_light_pos=
c.getPosition();b.u_light_color=vec3.scale(vec3.create(),c.color,c.intensity);b.u_light_att=[c.att_start,c.att_end];b.u_light_offset=c.offset;c._lightMatrix&&(b.u_lightMatrix=mat4.multiply(mat4.create(),c._lightMatrix,d.matrix));a&&(b.u_shadow_params=[1/c._shadowMap.width,c.shadow_bias],b.shadowMap=c._shadowMap.bind(10))};
Material.prototype.getMaterialShaderData=function(a,b,c,d){a=this._uniforms||{};this._uniforms||(this._uniforms=a);d={};a.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.alpha]);a.u_ambient_color=b.flags.ignore_lights?[1,1,1]:[c.ambient_color[0]*this.ambient[0],c.ambient_color[1]*this.ambient[1],c.ambient_color[2]*this.ambient[2]];a.u_diffuse_color=this.diffuse;a.u_emissive_color=this.emissive||[0,0,0];a.u_specular=[this.specular_factor,this.specular_gloss];a.u_reflection_info=
[this.reflection_additive?-this.reflection_factor:this.reflection_factor,this.reflection_fresnel];a.u_backlight_factor=this.backlight_factor;a.u_normalmap_factor=this.normalmap_factor;a.u_displacementmap_factor=this.displacementmap_factor;a.u_bumpmap_factor=this.bumpmap_factor;a.u_velvet_info=[this.velvet[0],this.velvet[1],this.velvet[2],this.velvet_additive?this.velvet_exp:-this.velvet_exp];a.u_detail_info=this.detail;a.u_texture_matrix=this.uvs_matrix;b=0;for(var e in c.textures){var f=Material.prototype.getTexture.call(c,
e);if(f&&(a[e+(f.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=f.bind(b),b+=1,!("environment"==e&&0>=this.reflection_factor))){var g=this.textures[e+"_uvs"]||Material.DEFAULT_UVS[e]||"0";if(g==Material.COORDS_POLAR_REFLECTED||g==Material.COORDS_POLAR)f.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),f.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR);d["USE_"+e.toUpperCase()+(f.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+g}}for(e in this.textures)if(f=this.getTexture(e)){a[e+(f.texture_type==
gl.TEXTURE_2D?"_texture":"_cubemap")]=f.bind(b);g=this.textures[e+"_uvs"]||Material.DEFAULT_UVS[e]||"0";b+=1;if("environment"==e){if(0>=this.reflection_factor)continue}else if("normal"==e){0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(d.USE_NORMAL_TEXTURE="uvs_"+g,0!=this.normalmap_factor&&(d.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(d.USE_TANGENT_NORMALMAP=""));continue}else if("displacement"==e){0!=this.displacementmap_factor&&
gl.derivatives_supported&&(d.USE_DISPLACEMENT_TEXTURE="uvs_"+g,1!=this.displacementmap_factor&&(d.USE_DISPLACEMENTMAP_FACTOR=""));continue}else if("bump"==e){0!=this.bump_factor&&gl.derivatives_supported&&(d.USE_BUMP_TEXTURE="uvs_"+g,1!=this.bumpmap_factor&&(d.USE_BUMPMAP_FACTOR=""));continue}else"irradiance"==e&&(f.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),f.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),f.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE));f.texture_type!=gl.TEXTURE_2D||g!=
Material.COORDS_POLAR_REFLECTED&&g!=Material.COORDS_POLAR||(f.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),f.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));d["USE_"+e.toUpperCase()+(f.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+g}this.velvet&&this.velvet_exp&&(d.USE_VELVET="");this.emissive_material&&(d.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&(d.USE_SPECULAR_ONTOP="");this.specular_on_alpha&&(d.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&(d.USE_SPECULAR_IN_REFLECTION=
"");0.001<this.backlight_factor&&(d.USE_BACKLIGHT="");if(this.extra_macros)for(var h in this.extra_macros)d[h]=this.extra_macros[h];a.MACROS=d;return a};
Material.prototype.getLightShaderData=function(a,b,c,d,e){var f={},g=a.projective_texture;g&&g.constructor==String&&(g=ResourcesManager.textures[g]);g&&(f.light_texture=g.bind(11));d=d.settings.enable_shadows&&a.cast_shadows&&a._shadowMap&&null!=a._lightMatrix&&!e.shadows_disabled;if(a.type==Light.DIRECTIONAL||a.type==Light.SPOT)f.u_light_front=a.getFront();a.type==Light.SPOT&&(f.u_light_angle=[a.angle*DEG2RAD,a.angle_end*DEG2RAD,Math.cos(0.5*a.angle*DEG2RAD),Math.cos(0.5*a.angle_end*DEG2RAD)]);f.u_light_pos=
a.getPosition();f.u_light_color=vec3.scale(vec3.create(),a.color,a.intensity);f.u_light_att=[a.att_start,a.att_end];f.u_light_offset=a.offset;a._lightMatrix&&(f.u_lightMatrix=mat4.multiply(mat4.create(),a._lightMatrix,b.matrix));d&&(f.u_shadow_params=[1/a._shadowMap.width,a.shadow_bias],f.shadowMap=a._shadowMap.bind(10));b={};a.use_diffuse&&!this.constant_diffuse&&(b.USE_DIFFUSE_LIGHT="");a.use_specular&&0<this.specular_factor&&(b.USE_SPECULAR_LIGHT="");a.type==Light.DIRECTIONAL?b.USE_DIRECTIONAL_LIGHT=
"":a.type==Light.SPOT&&(b.USE_SPOT_LIGHT="");a.spot_cone&&(b.USE_SPOT_CONE="");a.linear_attenuation&&(b.USE_LINEAR_ATTENUATION="");a.range_attenuation&&(b.USE_RANGE_ATTENUATION="");g&&(b.USE_PROJECTIVE_LIGHT="");if(0.001>vec3.squaredLength(a.color)||c.flags.ignore_lights)b.USE_AMBIENT_ONLY="";0.001<a.offset&&(b.USE_LIGHT_OFFSET="");d&&!1!=c.flags.receive_shadows&&(b.USE_SHADOW_MAP="",a.hard_shadows&&(b.USE_HARD_SHADOWS=""),b.SHADOWMAP_OFFSET="");f.MACROS=b;return f};
Material.prototype.configure=function(a){for(var b in a){var c=a[b],d=null;switch(b){case "alpha":case "backlight_factor":case "specular_factor":case "specular_gloss":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "blending":case "normalmap_factor":case "displacementmap_factor":case "extra_factor":case "specular_ontop":case "reflection_specular":d=c;break;case "color":case "ambient":case "diffuse":case "emissive":case "velvet":case "detail":case "extra_color":d=
new Float32Array(c);break;case "textures":this.textures=a.textures;continue;default:continue}this[b]=d}a.uvs_matrix&&9==a.uvs_matrix.length&&(this.uvs_matrix=new Float32Array(a.uvs_matrix))};Material.prototype.serialize=function(){return cloneObject(this)};
Material.prototype.loadAndSetTexture=function(a,b,c){c=c||{};b=b||Material.COLOR_TEXTURE;var d=this;if("string"===typeof a)":"!=a[0]?ResourcesManager.loadImage(a,c,function(a){d.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};
Material.prototype.setTexture=function(a,b,c){b=b||Material.COLOR_TEXTURE;a?(this.textures[b]=a,c&&(this.textures[b+"_uvs"]=c)):(delete this.textures[b],delete this.textures[b+"_uvs"]);a&&a.constructor==String&&ResourcesManager.loadImage(a)};Material.prototype.getTexture=function(a){return(a=this.textures[a])?a.constructor==String?ResourcesManager.textures[a]:a.constructor==Texture?a:null:null};
Material.prototype.getResources=function(a){for(var b in this.textures)"string"==typeof this.textures[b]&&"_uvs"!=b.substr(-4)&&(a[this.textures[b]]=Texture);return a};Material.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)ResourcesManager.loadImage(a[b])};Material.prototype.getRenderer=function(){return this.renderer||Renderer._default_renderer};Material.prototype.registerMaterial=function(a){this.name=a;Scene.materials[a]=this;this.material=a};
function ComponentContainer(){}ComponentContainer.prototype.configureComponents=function(a){if(a.components)for(var b in a.components){var c=a.components[b],d=c[0];"Transform"==d&&0==b?this.transform.configure(c[1]):window[d]?(c=new window[d](c[1]),this.addComponent(c)):trace("Unknown component found: "+d)}};
ComponentContainer.prototype.serializeComponents=function(a){if(this._components){a.components=[];for(var b in this._components){var c=this._components[b];c.serialize&&a.components.push([getObjectClassName(c),c.serialize()])}}};ComponentContainer.prototype.addComponent=function(a){a._root=this;if(a.onAddedToNode)a.onAddedToNode(this);this._components||(this._components=[]);if(-1!=this._components.indexOf(a))throw"inserting the same component twice";this._components.push(a);return a};
ComponentContainer.prototype.removeComponent=function(a){a._root=null;if(a.onRemovedFromNode)a.onRemovedFromNode(this);a=this._components.indexOf(a);-1!=a&&this._components.splice(a,1)};ComponentContainer.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0])};ComponentContainer.prototype.getComponent=function(a){if(this._components){for(var b in this._components)if(this._components[b].constructor==a)return this._components[b];return null}};
ComponentContainer.prototype.processActionInComponents=function(a,b){if(this._components)for(var c in this._components)this._components[c].action_name&&"function"==typeof this._components[c].action_name&&this._components[c].action_name(b)};function Transform(a){this._position=vec3.create();this._rotation=quat.create();this._scale=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._dirty=!1;a&&this.configure(a)}
Transform.prototype.onAddedToNode=function(a){a.transform||(a.transform=this)};Transform.prototype.copyFrom=function(a){this.configure(a.serialize())};
Transform.prototype.configure=function(a){a.position&&vec3.copy(this._position,a.position);a.scale&&vec3.copy(this._scale,a.scale);a.rotation&&4==a.rotation.length&&quat.copy(this._rotation,a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);var b=quat.setAngleAxis(quat.create(),[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,
[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._dirty=!0;this._on_change()};Transform.prototype.serialize=function(){return{position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]]}};
Transform.prototype.identity=function(){vec3.copy(this._position,[0,0,0]);quat.copy(this._rotation,[0,0,0,1]);vec3.copy(this._scale,[1,1,1]);mat4.identity(this._local_matrix);mat4.identity(this._global_matrix);this._dirty=!1};Transform.prototype.reset=Transform.prototype.identity;Transform.prototype.getPosition=function(a){return a?vec3.copy(a,this._position):vec3.clone(this._position)};
Transform.prototype.getPositionGlobal=function(a){if(this._parent){var b=vec3.create();return mat4.multiplyVec3(b||a,this.getGlobalMatrix(),b)}return a?vec3.copy(a,this._position):vec3.clone(this._position)};Transform.prototype.getRotation=function(){return quat.clone(this._rotation)};Transform.prototype.getRotationGlobal=function(){if(this._parent){for(var a=this._parent,b=quat.clone(this._rotation);a;)quat.multiply(b,a._rotation,b),a=a._parent;return b}return quat.clone(this._rotation)};
Transform.prototype.getScale=function(){return vec3.clone(this._scale)};Transform.prototype.getScaleGlobal=function(){if(this._parent){for(var a=this,b=vec3.clone(this._scale);a._parent;)vec3.multiply(b,b,a._scale),a=a._parent;return b}return vec3.clone(this._scale)};Transform.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,this._rotation,this._position);mat4.scale(this._local_matrix,this._local_matrix,this._scale);this._dirty=!1};
Transform.prototype.updateGlobalMatrix=function(){this._dirty&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,this._parent.updateGlobalMatrix(),this._local_matrix):mat4.copy(this._local_matrix,this._global_matrix);return this._global_matrix};Transform.prototype.getLocalMatrix=function(){this._dirty&&this.updateMatrix();return mat4.clone(this._local_matrix)};Transform.prototype.getLocalMatrixRef=function(){this._dirty&&this.updateMatrix();return this._local_matrix};
Transform.prototype.getGlobalMatrix=function(){this._dirty&&this.updateMatrix();return this._parent?mat4.multiply(this._global_matrix,this._parent.getGlobalMatrix(),this._local_matrix):mat4.clone(this._local_matrix)};Transform.prototype.getGlobalMatrixRef=function(){return this._global_matrix};Transform.prototype.getMatrixWithoutScale=function(){var a=this.getPositionGlobal();return mat4.fromRotationTranslation(mat4.create(),this.getRotationGlobal(),a)};
Transform.prototype.getMatrixWithoutRotation=function(){var a=this.getPositionGlobal();return mat4.clone([1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1])};
Transform.prototype.fromMatrix=function(a){var b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var c=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(c,b,[1,0,0]));this._scale[1]=vec3.length(mat4.rotateVec3(c,b,[0,1,0]));this._scale[2]=vec3.length(mat4.rotateVec3(c,b,[0,0,1]));mat4.scale(mat4.create(),b,[1/this._scale[0],1/this._scale[1],1/this._scale[2]]);b=mat3.fromMat4(mat3.create(),b);mat3.transpose(b,b);quat.fromMat3(this._rotation,b);quat.normalize(this._rotation,this._rotation);
mat4.copy(this._local_matrix,a);this._dirty=!1;this._on_change()};Transform.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._dirty=!0;this._on_change()};Transform.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._dirty=!0;this._on_change()};Transform.prototype.setRotation=function(a){quat.copy(this._rotation,a);this._dirty=!0;this._on_change()};
Transform.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scale,a,b,c):vec3.set(this._scale,a,a,a);this._dirty=!0;this._on_change()};Transform.prototype.translate=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._dirty=!0;this._on_change()};
Transform.prototype.translateLocal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,this.transformVector([a,b,c])):vec3.add(this._position,this._position,this.transformVector(a));this._dirty=!0;this._on_change()};Transform.prototype.rotate=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._dirty=!0;this._on_change()};
Transform.prototype.rotateLocal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,this._rotation,c);this._dirty=!0;this._on_change()};Transform.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scale,this._scale,[a,b,c]):vec3.multiply(this._scale,this._scale,a);this._dirty=!0;this._on_change()};
Transform.interpolate=function(a,b,c,d){vec3.lerp(d._scale,a._scale,b._scale,c);vec3.lerp(d._position,a._position,b._position,c);quat.slerp(d._rotation,a._rotation,b._rotation,c);this._dirty=!0;this._on_change()};Transform.prototype.lookAt=function(a,b,c){var d=mat4.create();if(this._parent){var e=this._parent.getGlobalMatrix();a=mat4.multiplyVec3(vec3.create(),e,a);b=mat4.multiplyVec3(vec3.create(),e,b);c=mat4.multiplyVec3(vec3.create(),e,c)}mat4.lookAt(d,a,b,c);mat4.invert(d,d);this.fromMatrix(d)};
Transform.prototype._on_change=function(){this._dirty=!0;LEvent.trigger(this,"changed",this);this._root&&LEvent.trigger(this._root,"transformChanged",this)};Transform.prototype.getFront=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(0,0,1),this.getRotationGlobal())};Transform.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(0,1,0),this.getRotationGlobal())};
Transform.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(1,0,0),this.getRotationGlobal())};Transform.prototype.transformPoint=function(a,b){b=b||vec3.create();this._dirty&&this.updateMatrix();return mat4.multiplyVec3(b,this._local_matrix,a)};Transform.prototype.transformPointGlobal=function(a,b){b=b||vec3.create();this._dirty&&this.updateMatrix();return mat4.multiplyVec3(b,this.getGlobalMatrix(),a)};
Transform.prototype.transformVector=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this._rotation)};Transform.prototype.transformVectorGlobal=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this.getRotationGlobal())};LS.registerComponent(Transform);LS.Transform=Transform;
function Camera(a){this._type=Camera.PERSPECTIVE;this._eye=vec3.fromValues(0,100,100);this._center=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=1;this._far=1E3;this._aspect=1;this._fov=45;this._frustrum_size=50;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();a&&this.configure(a)}Camera.PERSPECTIVE=1;Camera.ORTHOGRAPHIC=2;
Object.defineProperty(Camera.prototype,"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._dirty_matrices=!0);this._type=a}});Object.defineProperty(Camera.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._dirty_matrices=!0}});Object.defineProperty(Camera.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._dirty_matrices=!0}});
Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._dirty_matrices=!0);this._near=a}});Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._dirty_matrices=!0);this._far=a}});Object.defineProperty(Camera.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._dirty_matrices=!0);this._aspect=a}});
Object.defineProperty(Camera.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._dirty_matrices=!0);this._fov=a}});Object.defineProperty(Camera.prototype,"frustrum_size",{get:function(){return this._frustrum_size},set:function(a){this._frustrum_size!=a&&(this._dirty_matrices=!0);this._frustrum_size=a}});Camera.prototype.onAddedToNode=function(a){a.camera||(a.camera=this)};Camera.prototype.onRemovedFromNode=function(a){a.camera==this&&delete a.camera};
Camera.prototype.setActive=function(){Scene.current_camera=this};Camera.prototype.lookAt=function(a,b,c){vec3.copy(this._eye,a);vec3.copy(this._center,b);vec3.copy(this._up,c);this._dirty_matrices=!0};
Camera.prototype.updateMatrices=function(){this.type==Camera.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,0.5*-this._frustrum_size*this._aspect,0.5*this._frustrum_size*this._aspect,0.5*-this._frustrum_size,0.5*this._frustrum_size,this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._aspect,this._near,this._far);mat4.lookAt(this._view_matrix,this._eye,this._center,this._up);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,
this._view_matrix);this._dirty_matrices=!1};Camera.prototype.getModelMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._model_matrix)};Camera.prototype.getViewMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._view_matrix)};Camera.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};
Camera.prototype.getViewProjectionMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._viewprojection_matrix)};Camera.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};
Camera.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._dirty_matrices&&this.updateMatrices();var c=this._model_matrix;this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};Camera.prototype.getLocalVector=function(a,b){b=b||vec3.create();this._dirty_matrices&&this.updateMatrices();var c=this._model_matrix;this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.rotateVec3(b,c,a)};
Camera.prototype.getEye=function(){return vec3.clone(this._eye)};Camera.prototype.getCenter=function(){return vec3.clone(this._center)};Camera.prototype.setEye=function(a){return vec3.copy(this._eye,a)};Camera.prototype.setCenter=function(a){return vec3.copy(this._center,a)};Camera.prototype.getGlobalFront=function(a){a=a||vec3.create();vec3.subtract(a,this._center,this._eye);vec3.normalize(a,a);this._root.transform&&this._root.transform.transformVector(a,a);return a};
Camera.prototype.getGlobalTop=function(a){a=a||vec3.create();vec3.subtract(a,this._center,this._eye);vec3.normalize(a,a);var b=vec3.cross(vec3.create(),a,this._up);vec3.cross(a,a,b);vec3.scale(a,a,-1);this._root.transform&&this._root.transform.transformVector(a,a);return a};Camera.prototype.move=function(a){vec3.add(this._center,this._center,a);vec3.add(this._eye,this._eye,a);this._dirty_matrices=!0};
Camera.prototype.rotate=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a),d=vec3.subtract(vec3.create(),this._center,this._eye);vec3.transformQuat(d,d,c);vec3.add(this._center,this._eye,d);this._dirty_matrices=!0};Camera.prototype.orbit=function(a,b,c){c=c||this._center;a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._eye,c);vec3.transformQuat(b,b,a);vec3.add(this._eye,c,b);this._dirty_matrices=!0};
Camera.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._dirty_matrices=!0};Camera.prototype.project=function(a,b,c){b=b||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();c=mat4.multiplyVec3(c||vec3.create(),this._viewprojection_matrix,a);c[0]/=c[2];c[1]/=c[2];vec3.set(c,0.5*(c[0]+1)*b[2]+b[0],0.5*(c[1]+1)*b[3]+b[1],c[2]);return c};
Camera.prototype.unproject=function(a,b,c){b=b||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();return gl.unproject(c||vec3.create(),a,this._view_matrix,this._projection_matrix,b)};
Camera.prototype.getRayInPixel=function(a,b,c){c=c||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();var d=this.getEye();a=vec3.unproject(vec3.create(),[a,b,1],this._view_matrix,this._projection_matrix,c);a=vec3.subtract(vec3.create(),a,d);vec3.normalize(a,a);return{start:d,direction:a}};Camera.prototype.configure=function(a){LS.cloneObject(a,this);this.updateMatrices()};Camera.prototype.serialize=function(){return cloneObject(this)};LS.registerComponent(Camera);
LS.Camera=Camera;
function Light(a){this._uid=LS.generateUId();this.position=vec3.create();this.target=vec3.fromValues(0,0,1);this.up=vec3.fromValues(0,1,0);this.enabled=!0;this.near=1;this.far=1E3;this.angle=45;this.angle_end=60;this.use_specular=this.use_diffuse=!0;this.target_in_world_coords=this.range_attenuation=this.linear_attenuation=!1;this.att_start=0;this.att_end=1E3;this.offset=0;this.spot_cone=!0;this.color=[1,1,1];this.intensity=1;this.cast_shadows=!1;this.shadow_bias=0.005;this.type=Light.OMNI;this.frustrum_size=
50;a&&this.configure(a)}Light.OMNI=1;Light.SPOT=2;Light.DIRECTIONAL=3;Light.DEFAULT_SHADOWMAP_RESOLUTION=1024;Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=50;Light.prototype.onAddedToNode=function(a){a.light||(a.light=this);LEvent.bind(a,"beforeRender",this.onBeforeRender,this)};Light.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light};Light.prototype.onBeforeRender=function(){this.projective_texture&&this.enabled&&this.computeLightMatrices()};Light._temp_matrix=mat4.create();
Light._temp2_matrix=mat4.create();Light._temp3_matrix=mat4.create();Light._temp_position=vec3.create();Light._temp_target=vec3.create();Light._temp_up=vec3.create();Light._temp_front=vec3.create();
Light.prototype.computeLightMatrices=function(a,b,c){var d=this.getPosition(Light._temp_position),e=this.getTarget(Light._temp_target),f=this.getUp(Light._temp_up),g=this.getFront(Light._temp_front);0.999<Math.abs(vec3.dot(g,f))&&vec3.set(f,0,0,1);b||(b=Light._temp_matrix);a||(a=Light._temp2_matrix);c||(c=Light._temp3_matrix);g=this.frustrum_size||Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;this.type==Light.DIRECTIONAL?mat4.ortho(b,-0.5*g,0.5*g,-0.5*g,0.5*g,this.near,this.far):mat4.perspective(b,(this.angle_end||
45)*DEG2RAD,1,this.near,this.far);mat4.lookAt(a,d,e,f);this.type==Light.DIRECTIONAL&&this.cast_shadows&&this.enabled&&(d=g/(this.shadowmap_resolution||Light.DEFAULT_SHADOWMAP_RESOLUTION),a[12]=Math.floor(a[12]/d)*d,a[13]=Math.floor(a[13]/d)*d);mat4.multiply(c,b,a);this._lightMatrix||(this._lightMatrix=mat4.create());mat4.copy(this._lightMatrix,c)};
Light.prototype.serialize=function(){this.position=vec3.toArray(this.position);this.target=vec3.toArray(this.target);this.color=vec3.toArray(this.color);return cloneObject(this)};Light.prototype.configure=function(a){LS.cloneObject(a,this)};Light.prototype.getPosition=function(a){return this._root&&this._root.transform?this._root.transform.transformPointGlobal(this.position,a||vec3.create()):vec3.clone(this.position)};
Light.prototype.getTarget=function(a){return this._root&&this._root.transform&&!this.target_in_world_coords?this._root.transform.transformPointGlobal(this.target,a||vec3.create()):vec3.clone(this.target)};Light.prototype.getUp=function(a){return this._root&&this._root.transform?this._root.transform.transformVector(this.up,a||vec3.create()):vec3.clone(this.up)};Light.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this.getPosition(),this.getTarget());vec3.normalize(a,a);return a};
Light.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=Texture);return a};LS.registerComponent(Light);LS.Light=Light;function MeshRenderer(a){this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.primitive=this.material=null;this.two_sided=!1;a&&this.configure(a);MeshRenderer._identity||(MeshRenderer._identity=mat4.create())}MeshRenderer["@mesh"]={widget:"mesh"};MeshRenderer["@lod_mesh"]={widget:"mesh"};
MeshRenderer["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4}};MeshRenderer.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this)};MeshRenderer.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer};
MeshRenderer.prototype.configure=function(a){this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material))};
MeshRenderer.prototype.serialize=function(){var a={mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());null!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};MeshRenderer.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};
MeshRenderer.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};MeshRenderer.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};
MeshRenderer.prototype.getRenderInstance=function(a){var b=this.getMesh();if(!b||"reflection"==a.step&&!node.flags.seen_by_reflections||"main"==a.step&&!node.flags.seen_by_camera||"shadow"==a.step&&!node.flags.cast_shadows)return null;a=this._root?this._root.transform.getGlobalMatrix():MeshRenderer._identity;var c=mat4.multiplyVec3(vec3.create(),a,vec3.create()),d=this._render_instance||new RenderInstance;d.mesh=b;d.submesh_id=this.submesh_id;d.primitive=null==this.primitive?gl.TRIANGLES:this.primitive;
d.material=this.material||this._root.getMaterial();d.two_sided=this.two_sided;d.matrix.set(a);d.center.set(c);d.scene=Scene;return d};LS.registerComponent(MeshRenderer);LS.MeshRenderer=MeshRenderer;function Rotator(a){this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45}Rotator.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Rotator.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};
Rotator.prototype.onUpdate=function(a,b){if(this._root){this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var c=quat.setAxisAngle(quat.create(),this.axis,Math.sin(2*this.speed*Scene._global_time*Math.PI)*this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,c,this._default);this._root.transform._dirty=!0}else this.local_space?this._root.transform.rotateLocal(this.speed*b,this.axis):this._root.transform.rotate(this.speed*
b,this.axis);LEvent.trigger(Scene,"change")}};LS.registerComponent(Rotator);function CameraController(a){this.speed=10;this.rot_speed=1;this.cam_type="orbit";this._moving=vec3.fromValues(0,0,0);this.orbit_center=null}CameraController.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"keydown",this.onKey,this);LEvent.bind(a,"keyup",this.onKey,this);LEvent.bind(a,"update",this.onUpdate,this)};
CameraController.prototype.onUpdate=function(a){if(this._root&&!this._root.transform&&this._root.camera&&(a=this._root.camera,"fps"==this.cam_type&&(0!=this._moving[0]||0!=this._moving[1]||0!=this._moving[2]))){var b=a.getLocalVector(this._moving);vec3.scale(b,b,this.speed*(this._move_fast?10:1));a.move(b);a.updateMatrices()}};
CameraController.prototype.onMouse=function(a){if(this._root&&a.dragging&&!this._root.transform&&this._root.camera)if("fps"==this.cam_type){var b=this._root.camera;b.rotate(-a.deltaX*this.rot_speed,[0,1,0]);b.updateMatrices();var c=b.getLocalVector([1,0,0]);b.rotate(-a.deltaY*this.rot_speed,c);b.updateMatrices()}else"orbit"==this.cam_type&&(b=this._root.camera,a.ctrlKey?(a=b.getLocalVector([0.1*this.speed*-a.deltaX,0.1*this.speed*a.deltaY,0]),b.move(a),b.updateMatrices()):(b.orbit(-a.deltaX*this.rot_speed,
[0,1,0],this.orbit_center),a.shiftKey?(b.updateMatrices(),c=b.getLocalVector([1,0,0]),b.orbit(-a.deltaY,c,this.orbit_center)):(b.orbitDistanceFactor(1+0.01*a.deltaY,this.orbit_center),b.updateMatrices())))};
CameraController.prototype.onKey=function(a){this._root&&(87==a.keyCode?this._moving[2]="keydown"==a.type?-1:0:83==a.keyCode?this._moving[2]="keydown"==a.type?1:0:65==a.keyCode?this._moving[0]="keydown"==a.type?-1:0:68==a.keyCode?this._moving[0]="keydown"==a.type?1:0:16==a.keyCode&&(this._move_fast="keydown"==a.type?!0:!1))};LS.registerComponent(CameraController);function FaceTo(a){this.scale=1;this.target=null;this.reverse=this.cylindrical=!1}FaceTo["@target"]={type:"node"};
FaceTo.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updateOrientation,this)};FaceTo.prototype.updateOrientation=function(a,b){if(this._root){var c=null;if(this.target){c=Scene.getNode(this.target);if(!c)return;c=c.transform.getPosition()}else c=b.camera.getEye();var d=this._root.transform.getPosition(),e=b.camera.getLocalVector([0,1,0]);this.cylindrical&&(c[1]=d[1],e.set([0,1,0]));this.reverse||vec3.subtract(c,d,c);this._root.transform.lookAt(d,c,e);this._root.transform.setScale(this.scale)}};
LS.registerComponent(FaceTo);function FogFX(a){this.enabled=!0;this.start=100;this.end=1E3;this.density=0.001;this.type=FogFX.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);a&&this.configure(a)}FogFX.LINEAR=1;FogFX.EXP=2;FogFX.EXP2=3;FogFX["@color"]={type:"color"};FogFX["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};FogFX["@type"]={type:"enum",values:{linear:FogFX.LINEAR,exponential:FogFX.EXP,"exponential 2":FogFX.EXP2}};
FogFX.prototype.onAddedToNode=function(a){LEvent.bind(Scene,"fillLightUniforms",this.fillUniforms,this);LEvent.bind(Scene,"fillMacros",this.fillMacros,this)};FogFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"fillLightUniforms",this.fillUniforms,this);LEvent.unbind(Scene,"fillMacros",this.fillMacros,this)};FogFX.prototype.fillUniforms=function(a,b){this.enabled&&(b.uniforms.u_fog_info=[this.start,this.end,this.density],b.uniforms.u_fog_color=b.light==b.lights[0]?this.color:[0,0,0])};
FogFX.prototype.fillMacros=function(a,b){if(this.enabled){var c=b.macros;c.USE_FOG="";switch(this.type){case FogFX.EXP:c.USE_FOG_EXP="";break;case FogFX.EXP2:c.USE_FOG_EXP2=""}}};LS.registerComponent(FogFX);function FollowNode(a){this.node_name="";this.follow_camera=this.fixed_y=!1;a&&this.configure(a)}FollowNode.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updatePosition,this)};
FollowNode.prototype.updatePosition=function(a,b){if(this._root){var c=null;if(this.follow_camera)c=b.camera.getEye();else{c=Scene.getNode(this.node_name);if(!c)return;c=c.transform.getPosition()}this.fixed_y&&(c[1]=this._root.transform._position[1]);this._root.transform.setPosition(c)}};LS.registerComponent(FollowNode);
function GeometricPrimitive(a){this.two_sided=!1;this.geometry=GeometricPrimitive.CUBE;this.align_z=!1;GeometricPrimitive.MESHES||(GeometricPrimitive.MESHES={});a&&this.configure(a)}GeometricPrimitive.CUBE=1;GeometricPrimitive.PLANE=2;GeometricPrimitive.CYLINDER=3;GeometricPrimitive.SPHERE=4;GeometricPrimitive.MESHES=null;GeometricPrimitive["@geometry"]={type:"enum",values:{Cube:GeometricPrimitive.CUBE,Plane:GeometricPrimitive.PLANE,Cylinder:GeometricPrimitive.CYLINDER,Sphere:GeometricPrimitive.SPHERE}};
GeometricPrimitive.prototype.configure=function(a){cloneObject(a,this)};GeometricPrimitive.prototype.serialize=function(){return cloneObject(this)};
GeometricPrimitive.prototype.getRenderInstance=function(){var a=null;if(this.geometry==GeometricPrimitive.CUBE)GeometricPrimitive.MESHES[GeometricPrimitive.CUBE]||(GeometricPrimitive.MESHES[GeometricPrimitive.CUBE]=GL.Mesh.cube({normals:!0,coords:!0})),a=GeometricPrimitive.MESHES[GeometricPrimitive.CUBE];else if(this.geometry==GeometricPrimitive.PLANE)GeometricPrimitive.MESHES[GeometricPrimitive.PLANE]||(GeometricPrimitive.MESHES[GeometricPrimitive.PLANE]=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),
a=GeometricPrimitive.MESHES[GeometricPrimitive.PLANE];else if(this.geometry==GeometricPrimitive.CYLINDER)GeometricPrimitive.MESHES[GeometricPrimitive.CYLINDER]||(GeometricPrimitive.MESHES[GeometricPrimitive.CYLINDER]=GL.Mesh.cylinder({normals:!0,coords:!0})),a=GeometricPrimitive.MESHES[GeometricPrimitive.CYLINDER];else if(this.geometry==GeometricPrimitive.SPHERE)GeometricPrimitive.MESHES[GeometricPrimitive.SPHERE]||(GeometricPrimitive.MESHES[GeometricPrimitive.SPHERE]=GL.Mesh.sphere({"long":32,lat:32,
normals:!0,coords:!0})),a=GeometricPrimitive.MESHES[GeometricPrimitive.SPHERE];else return null;var b=mat4.clone(this._root.transform.getGlobalMatrix());this.align_z&&mat4.rotateX(b,b,-0.5*Math.PI);var c=mat4.multiplyVec3(vec3.create(),b,vec3.create());this._root&&(this._root.mesh=a);var d=this._render_instance||new RenderInstance;d.mesh=a;d.material=this.material||this._root.getMaterial();d.two_sided=this.two_sided;d.matrix.set(b);d.center.set(c)};LS.registerComponent(GeometricPrimitive);
function GraphComponent(a){this._graph=new LGraph;this.force_redraw=!0;a?this.configure(a):(a=LiteGraph.createNode("scene/node"),this._graph.add(a))}GraphComponent.prototype.configure=function(a){a.graph_data&&this._graph.unserialize(a.graph_data)};GraphComponent.prototype.serialize=function(){return{force_redraw:this.force_redraw,graph_data:this._graph.serialize()}};
GraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;this._onStart_bind=this.onStart.bind(this);this._onUpdate_bind=this.onUpdate.bind(this);LEvent.bind(Scene,"start",this._onStart_bind);LEvent.bind(Scene,"update",this._onUpdate_bind)};GraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"start",this._onStart_bind);LEvent.unbind(Scene,"update",this._onUpdate_bind)};GraphComponent.prototype.onStart=function(){};
GraphComponent.prototype.onUpdate=function(a,b){this._root._on_scene&&(this._graph&&this._graph.runStep(1),this.force_redraw&&LEvent.trigger(Scene,"change"))};LS.registerComponent(GraphComponent);window.GraphComponent=GraphComponent;
if(void 0!=window.LiteGraph){var LGraphTransform=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id);this.addInput("Transform","Transform");this.addOutput("Position","vec3")};LGraphTransform.title="Transform";LGraphTransform.desc="Transform info of a node";LGraphTransform.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);for(var b in this.inputs){var c=
this.inputs[b],d=this.getInputData(b);if(void 0!=d)switch(c.name){case "Position":a.transform.setPosition(d);break;case "Rotation":a.transform.setRotation(d);break;case "Scale":a.transform.setScale(d)}}for(b in this.outputs)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Position":this.setOutputData(b,a.transform.getPosition());break;case "Rotation":this.setOutputData(b,a.transform.getRotation());break;case "Scale":this.setOutputData(b,a.transform.getScale(scale))}};LGraphTransform.prototype.onGetInputs=
function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LGraphTransform.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LiteGraph.registerNodeType("scene/transform",LGraphTransform);window.LGraphTransform=LGraphTransform;var LGraphSceneNode=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id)};LGraphSceneNode.title=
"SceneNode";LGraphSceneNode.desc="Node on the scene";LGraphSceneNode.prototype.getNode=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);return a};LGraphSceneNode.prototype.onExecute=function(){var a=this.getNode(),b;for(b in this.inputs){var c=this.inputs[b],d=this.getInputData(b);if(void 0!=d)switch(c.name){case "Transform":a.transform.copyFrom(d);break;case "Material":a.material=d;break;case "Visible":a.flags.visible=d}}for(b in this.outputs)if(c=
this.outputs[b],c.links&&c.links.length)switch(c.name){case "Transform":this.setOutputData(b,a.getTransform());break;case "Material":this.setOutputData(b,a.getMaterial());break;case "Light":this.setOutputData(b,a.getLight());break;case "Camera":this.setOutputData(b,a.getCamera());break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible)}};LGraphSceneNode.prototype.onGetInputs=function(){return[["Transform","Transform"],["Material","Material"],["Mesh",
"Mesh"],["Enabled","boolean"]]};LGraphSceneNode.prototype.onGetOutputs=function(){var a=[["Transform","Transform"],["Material","Material"],["Mesh","Mesh"],["Enabled","boolean"]],b=this.getNode();b.light&&a.push(["Light","Light"]);b.camera&&a.push(["Camera","Camera"]);return a};LiteGraph.registerNodeType("scene/node",LGraphSceneNode);window.LGraphSceneNode=LGraphSceneNode;var LGraphMaterial=function(){this.properties={mat_name:""};this.addInput("Material","Material");this.size=[100,20]};LGraphMaterial.title=
"Material";LGraphMaterial.desc="Material of a node";LGraphMaterial.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);var b=null;a&&(b=a.getMaterial());a=this.findInputSlot("Material");-1!=a&&(b=this.getInputData(a));b||(b=new Material);for(var c in this.inputs){var d=this.inputs[c],a=this.getInputData(c);if(void 0!=a)switch(d.name){case "Alpha":b.alpha=a;break;case "Specular f.":b.specular_factor=a;break;
case "Diffuse":vec3.copy(b.diffuse,a);break;case "Ambient":vec3.copy(b.ambient,a);break;case "Emissive":vec3.copy(b.emissive,a);break;case "UVs trans.":b.uvs_matrix.set(a);break;default:"Tex."==d.name.substr(0,4)&&(d=d.name.substr(4),b.setTexture(a,d))}}for(c in this.outputs)if(a=this.outputs[c],a.links&&a.links.length){switch(a.name){case "Material":a=b;break;case "Alpha":a=b.alpha;break;case "Specular f.":a=b.specular_factor;break;case "Diffuse":a=b.diffuse;break;case "Ambient":a=b.ambient;break;
case "Emissive":a=b.emissive;break;case "UVs trans.":a=b.uvs_matrix;break;default:continue}this.setOutputData(c,a)}};LGraphMaterial.prototype.onGetInputs=function(){var a=[["Material","Material"],["Alpha","number"],["Specular f.","number"],["Diffuse","color"],["Ambient","color"],["Emissive","color"],["UVs trans.","texmatrix"]],b;for(b in Material.TEXTURE_CHANNELS)a.push(["Tex."+Material.TEXTURE_CHANNELS[b],"Texture"]);return a};LGraphMaterial.prototype.onGetOutputs=function(){var a=[["Material","Material"],
["Alpha","number"],["Specular f.","number"],["Diffuse","color"],["Ambient","color"],["Emissive","color"],["UVs trans.","texmatrix"]],b;for(b in Material.TEXTURE_CHANNELS)a.push(["Tex."+Material.TEXTURE_CHANNELS[b],"Texture"]);return a};LiteGraph.registerNodeType("scene/material",LGraphMaterial);window.LGraphMaterial=LGraphMaterial;var LGraphLight=function(){this.properties={mat_name:""};this.addInput("Light","Light");this.addOutput("Intensity","number");this.addOutput("Color","color")};LGraphLight.title=
"Light";LGraphLight.desc="Light from a scene";LGraphLight.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);var b=null;a&&(b=a.getLight());a=this.findInputSlot("Light");-1!=a&&(b=this.getInputData(a));if(b){for(var c in this.inputs){var a=this.inputs[c],d=this.getInputData(c);if(void 0!=d)switch(a.name){case "Intensity":b.intensity=d;break;case "Color":vec3.copy(b.color,d);break;case "Eye":vec3.copy(b.eye,
d);break;case "Center":vec3.copy(b.center,d)}}for(c in this.outputs)if(a=this.outputs[c],a.links&&a.links.length)switch(a.name){case "Light":this.setOutputData(c,b);break;case "Intensity":this.setOutputData(c,b.intensity);break;case "Color":this.setOutputData(c,b.color);break;case "Eye":this.setOutputData(c,b.eye);break;case "Center":this.setOutputData(c,b.center)}}};LGraphLight.prototype.onGetInputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center",
"vec3"]]};LGraphLight.prototype.onGetOutputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};LiteGraph.registerNodeType("scene/light",LGraphLight);window.LGraphLight=LGraphLight;var LGraphScene=function(){this.addOutput("Time","number")};LGraphScene.title="Scene";LGraphScene.desc="Scene";LGraphScene.prototype.onExecute=function(){for(var a in this.inputs){var b=this.inputs[a],c=this.getInputData(a);if(void 0!=c)switch(b.name){case "Ambient color":vec3.copy(Scene.ambient_color,
c);break;case "Bg Color":vec3.copy(Scene.background_color,c)}}for(a in this.outputs)if(b=this.outputs[a],b.links&&b.links.length)switch(b.name){case "Light":this.setOutputData(a,Scene.light);break;case "Camera":this.setOutputData(a,Scene.camera);break;case "Ambient color":this.setOutputData(a,Scene.ambient_color);break;case "Bg Color":this.setOutputData(a,Scene.background_color);break;case "Time":this.setOutputData(a,Scene._time);break;case "Elapsed":this.setOutputData(a,null!=Scene._last_dt?Scene._last_dt:
0);break;case "Frame":this.setOutputData(a,null!=Scene._frame?Scene._frame:0)}};LGraphScene.prototype.onGetOutputs=function(){return[["Light","Light"],["Camera","Camera"],["Ambient color","color"],["Bg Color","color"],["Elapsed","number"],["Frame","number"]]};LiteGraph.registerNodeType("scene/scene",LGraphScene);window.LGraphScene=LGraphScene;var LGraphGlobal=function(){this.addOutput("Value","number");this.properties={name:"myvar",value:0,min:0,max:1}};LGraphGlobal.title="Global";LGraphGlobal.desc=
"Global var for the graph";LGraphGlobal.prototype.onExecute=function(){this.properties.name&&this.setOutputData(0,this.properties.value)};LiteGraph.registerNodeType("scene/global",LGraphGlobal);window.LGraphGlobal=LGraphGlobal;var LGraphTexture=function(){this.addOutput("Texture","Texture");this.properties={name:""}};LGraphTexture.title="Texture";LGraphTexture.desc="Texture";LGraphTexture.prototype.onExecute=function(){if(this.properties.name){var a=ResourcesManager.textures[this.properties.name];
a||ResourcesManager.loadImage(this.properties.name);this.setOutputData(0,a)}};LiteGraph.registerNodeType("texture/texture",LGraphTexture);window.LGraphTexture=LGraphTexture;var LGraphTextureOperation=function(){this.addInput("Texture","Texture");this.addInput("TextureB","Texture");this.addInput("value","number");this.addOutput("Texture","Texture");this.help="<p>pixelcode must be vec3</p>\t\t\t<p>uvcode must be vec2, is optional</p>\t\t\t<p><strong>uv:</strong> tex. coords, <strong>color:</strong> texture, <strong>colorB:</strong> textureB, <strong>time:</strong> scene time,<strong>value:</strong> input value</p>";
this.properties={value:1,uvcode:"",pixelcode:"color*2.0"};if(!LGraphTextureOperation._mesh){var a=new Float32Array(18);LGraphTextureOperation._mesh=new GL.Mesh.load({vertices:a,coords:[-1,-1,1,1,-1,1,-1,-1,1,-1,1,1]});Shaders.addGlobalShader(LGraphTextureOperation.vertex_shader,LGraphTextureOperation.pixel_shader,"LGraphTextureOperation",{UV_CODE:!0,PIXEL_CODE:!0})}};LGraphTextureOperation.title="Tex. Op";LGraphTextureOperation.desc="Texture shader operation";LGraphTextureOperation.prototype.onExecute=
function(){var a=this.getInputData(0),b=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var c=512,d=512;a?(c=a.width,d=a.height):b&&(c=b.width,d=b.height);this._tex&&this._tex.width==c&&this._tex.height==d||(this._tex=new GL.Texture(c,d,{format:gl.RGBA,filter:gl.LINEAR}));var e="";this.properties.uvcode&&(e="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(e=this.properties.uvcode));var f="";this.properties.pixelcode&&(f="result = "+this.properties.pixelcode,
-1!=this.properties.pixelcode.indexOf(";")&&(f=this.properties.pixelcode));var g=Shaders.get("LGraphTextureOperation",{UV_CODE:e,PIXEL_CODE:f});if(g){var h=this.getInputData(2);null!=h?this.properties.value=h:h=parseFloat(this.properties.value);this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a&&a.bind(0);b&&b.bind(1);g.uniforms({texture:0,textureB:1,value:h,texSize:[c,d],time:Scene._global_time-Scene._start_time}).draw(LGraphTextureOperation._mesh)});
this.setOutputData(0,this._tex)}}};LGraphTextureOperation.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tcoord = a_coord; gl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureOperation.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D texture;\n\t\t\tuniform sampler2D textureB;\n\t\t\tvarying vec2 coord;\n\t\t\tuniform vec2 texSize;\n\t\t\tuniform float time;\n\t\t\tuniform float value;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = coord;\n\t\t\t\tUV_CODE;\n\t\t\t\tvec3 color = texture2D(texture, uv).rgb;\n\t\t\t\tvec3 colorB = texture2D(textureB, uv).rgb;\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tPIXEL_CODE;\n\t\t\t\tgl_FragColor = vec4(result, 1.0);\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/textureop",LGraphTextureOperation);window.LGraphTextureOperation=LGraphTextureOperation;var LGraphTexturePreview=function(){this.addInput("Texture","Texture");this.size=[LGraphTexturePreview.img_size,LGraphTexturePreview.img_size]};LGraphTexturePreview.title="Texture preview";LGraphTexturePreview.desc="Show a texture in the graph canvas";LGraphTexturePreview.img_size=256;LGraphTexturePreview.prototype.onDrawBackground=function(a){var b=this.getInputData(0);if(b){var c=
LGraphTexturePreview.img_size;if(b.width>c||b.height>c){var d=this._temp_tex;this._temp_tex||(this._temp_tex=d=new GL.Texture(c,c,{minFilter:gl.NEAREST}));b.copyTo(d)}b=this._canvas;b||(this._canvas=b=createCanvas(c,c));d.toCanvas(b);a.drawImage(b,0,0,this.size[0],this.size[1])}};LiteGraph.registerNodeType("texture/texpreview",LGraphTexturePreview);window.LGraphTexturePreview=LGraphTexturePreview}
function KnobComponent(a){this.value=a.value||0;this.delta=a.delta||0.01;this.steps=a.steps||0;this.min_value=a.min_value||0;this.max_value=a.max_value||1;this.min_angle=a.min_angle||-120;this.max_angle=a.max_angle||120;this.axis=a.axis||[0,0,1];a&&this.configure(a)}KnobComponent.prototype.configure=function(a){cloneObject(a,this)};KnobComponent.prototype.serialize=function(){return cloneObject(this)};
KnobComponent.prototype.onAddedToNode=function(a){a.interactive=!0;LEvent.bind(a,"mousemove",this.onmousemove,this);this.updateKnob()};KnobComponent.prototype.updateKnob=function(){this._root&&(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+(this.max_angle-this.min_angle)*(this.value/(this.max_value-this.min_value)))*DEG2RAD),this._root.transform._dirty=!0)};
KnobComponent.prototype.onmousemove=function(a,b){this.value-=b.deltaY*this.delta;this.value>this.max_value?this.value=this.max_value:this.value<this.min_value&&(this.value=this.min_value);this.updateKnob();LEvent.trigger(this,"change",this.value);this._root&&LEvent.trigger(this._root,"knobChange",this.value)};LS.registerComponent(KnobComponent);
function ParticleEmissor(a){this.max_particles=1024;this.warm_up_time=0;this.emissor_type=ParticleEmissor.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=[10,10,10];this.emissor_mesh=null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this.particle_start_color=[1,1,1];this.particle_end_color=[1,1,1];this.particle_alpha_curve=[[0.5,1]];this.texture_grid_size=1;this.physics_gravity=[0,0,0];this.physics_friction=0;this.alpha=
1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.stop_update=!1;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=
this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;this.createMesh()}ParticleEmissor.BOX_EMISSOR=1;ParticleEmissor.SPHERE_EMISSOR=2;ParticleEmissor.MESH_EMISSOR=3;ParticleEmissor.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,"start",this.onStart,this)};ParticleEmissor.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this);LEvent.unbind(a,"start",this.onStart,this)};
ParticleEmissor.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};
ParticleEmissor.prototype.createParticle=function(a){a=a||{};switch(this.emissor_type){case ParticleEmissor.BOX_EMISSOR:a.pos=vec3.fromValues(this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5));break;case ParticleEmissor.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-1);a.pos=vec3.fromValues(Math.sin(c)*Math.cos(b),Math.sin(c)*Math.sin(b),Math.cos(c));vec3.multiply(a.pos,a.pos,this.emissor_size);break;
case ParticleEmissor.MESH_EMISSOR:(b=this.emissor_mesh)&&b.constructor==String&&(b=ResourcesManager.getMesh(this.emissor_mesh));b&&b.vertices?(c=3*Math.floor(Math.random()*b.vertices.length/3),a.pos=vec3.fromValues(b.vertices[c],b.vertices[c+1],b.vertices[c+2])):a.pos=vec3.create();break;default:a.pos=vec3.create()}vec3.add(a.pos,a.pos,this.follow_emitter?[0,0,0]:this._emissor_pos);a.vel=vec3.fromValues(Math.random()-0.5,Math.random()-0.5,Math.random()-0.5);a.life=this.particle_life;a.id=this._last_id;
a.angle=0;a.rot=this.particle_rotation+0.25*this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a.vel,a.vel,this.particle_speed);return a};ParticleEmissor.prototype.onStart=function(a){if(!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};
ParticleEmissor.prototype.onUpdate=function(a,b,c){this._root.transform.getPositionGlobal(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var d=vec3.clone(this.physics_gravity),e=this.physics_friction;a=[];for(var f=vec3.create(),g=0;g<this._particles.length;++g){var h=this._particles[g];vec3.copy(f,h.vel);vec3.add(f,d,f);vec3.scale(f,f,b);e&&(f[0]-=f[0]*e,f[1]-=f[1]*e,f[2]-=f[2]*e);vec3.add(h.pos,f,h.pos);h.angle+=h.rot*b;h.life-=b;0<h.life&&a.push(h)}if(0!=this.emissor_rate)for(b=
(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),g=0;g<b;g++)h=this.createParticle(),a.length<this.max_particles&&a.push(h);this._particles=a}this.align_always||c||this.updateMesh(Scene.current_camera);LEvent.trigger(Scene,"change")};
ParticleEmissor.prototype.createMesh=function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);for(var a=0;a<this.max_particles;a++)this._coords.set([1,1,0,1,1,0,0,1,0,0,1,0],12*a),this._colors.set([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],24*a);this._computed_grid_size=1;this._mesh=Mesh.load({vertices:this._vertices,coords:this._coords,
colors:this._colors,stream_type:gl.STREAM_DRAW});this._mesh_maxparticles=this.max_particles}};
ParticleEmissor.prototype.updateMesh=function(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,d=a.getLocalVector([0,0,1]),e=a.getLocalVector([1,0,0]),f=a.getLocalVector([0,1,0]);a=vec3.create();var g=vec3.fromValues(-1,0,-1),h=vec3.fromValues(1,0,-1),n=vec3.fromValues(-1,0,1),k=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(g,f,e),vec3.add(h,f,e),vec3.scale(n,h,-1),vec3.scale(k,g,-1));var e=vec3.create(),f=vec3.create(),l=
vec3.create(),m=vec3.create(),t=this._particles;if(this.sort_in_z){for(var t=this._particles.concat(),q=geo.createPlane(b,d),p=Math.sqrt(q[0]*q[0]+q[1]*q[1]+q[2]*q[2]),b=0;b<t.length;++b)t[b]._dist=Math.abs(vec3.dot(t[b].pos,q)+q[3])/p;t.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0});this._particles=t}0==this.particle_life&&(this.particle_life=1E-4);var q=new Float32Array([1,1,1,1]),p=new Float32Array(this.particle_start_color),w=new Float32Array(this.particle_end_color),r=!1;
(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size)&&!this.stop_update&&(r=!0,this._computed_grid_size=this.texture_grid_size);for(var u=1/this.texture_grid_size,s=0,v=0,A=this.texture_grid_size<<2,H=this.animated_texture,E=this.loop_animation,F=Scene._global_time*this.animation_fps,B=new Float32Array(60*this.particle_life<<0),D=new Float32Array(60*this.particle_life<<0),C=1/(60*this.particle_life),b=0;b<B.length;b+=1)B[b]=LS.getCurveValueAt(this.particle_alpha_curve,0,1,
0,b*C),D[b]=LS.getCurveValueAt(this.particle_size_curve,0,1,0,b*C);for(var C=quat.create(),x=s=b=0;x<t.length;++x)if(v=t[x],!(0>=v.life)){var s=1-v.life/this.particle_life,z=B[s*B.length<<0];this.independent_color&&v.c?vec3.clone(q,v.c):vec3.lerp(q,p,w,s);this.premultiplied_alpha?(vec3.scale(q,q,z),q[3]=1):q[3]=z;if(!(0.001>z)&&(z=this.particle_size*D[s*D.length<<0],!(Math.abs(z)<c)&&(vec3.scale(l,n,z),vec3.scale(f,h,z),vec3.scale(e,g,z),vec3.scale(m,k,z),0!=v.angle&&(quat.setAxisAngle(C,d,v.angle*
DEG2RAD),vec3.transformQuat(l,C,l),quat.multiplyVec3(f,C,f),quat.multiplyVec3(e,C,e),quat.multiplyVec3(m,C,m)),vec3.add(a,v.pos,f),this._vertices.set(a,18*b),vec3.add(a,v.pos,e),this._vertices.set(a,18*b+3),vec3.add(a,v.pos,m),this._vertices.set(a,18*b+6),vec3.add(a,v.pos,e),this._vertices.set(a,18*b+9),vec3.add(a,v.pos,l),this._vertices.set(a,18*b+12),vec3.add(a,v.pos,m),this._vertices.set(a,18*b+15),this._colors.set(q,24*b),this._colors.set(q,24*b+4),this._colors.set(q,24*b+8),this._colors.set(q,
24*b+12),this._colors.set(q,24*b+16),this._colors.set(q,24*b+20),r&&(s=(H?(E?F:s)*A<<0:v.id)%A*u,v=1-(s<<0)*u-u,s%=1,this._coords.set([s+u,v+u,s,v+u,s+u,v,s,v+u,s,v,s+u,v],12*b)),++b,18*b>=this._vertices.length)))break}this._visible_particles=b;this._mesh.vertexBuffers.a_vertex.data=this._vertices;this._mesh.vertexBuffers.a_color.data=this._colors;this._mesh.vertexBuffers.a_vertex.compile();this._mesh.vertexBuffers.a_color.compile();r&&(this._mesh.vertexBuffers.a_coord.data=this._coords,this._mesh.vertexBuffers.a_coord.compile())};
ParticleEmissor._identity=mat4.create();
ParticleEmissor.prototype.getRenderInstance=function(a,b){this.align_always&&this.updateMesh(b);this._material||(this._material=new Material({alpha:this.alpha-0.01,shader:"lowglobalshader"}));this._material.alpha=this.alpha-0.01;this._material.setTexture(this.texture);this._material.blending=this.additive_blending?Material.ADDITIVE_BLENDING:Material.NORMAL;this._material.soft_particles=this.soft_particles;this._material.constant_diffuse=!0;if(!this._mesh)return null;this._matrix=this._matrix||mat4.create();
var c=this._render_instance||new RenderInstance;c.mesh=this._mesh;c.material=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;c.matrix.set(this.follow_emitter?mat4.translate(this._matrix,ParticleEmissor._identity,this._root.transform._position):ParticleEmissor._identity);c.length=6*this._visible_particles};LS.registerComponent(ParticleEmissor);
function RealtimeReflector(a){this.texture_size=512;this.brightness_factor=1;this.colorclip_factor=0;this.clip_offset=0.5;this.rt_name="";this.use_mesh_info=this.use_cubemap=!1;this.refresh_rate=1;this._rt=null;a&&this.configure(a)}RealtimeReflector.prototype.onAddedToNode=function(a){this._bind_onRenderRT||(this._bind_onRenderRT=this.onRenderRT.bind(this));LEvent.bind(a,"afterRenderShadows",this._bind_onRenderRT,this)};
RealtimeReflector.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"afterRenderShadows",this._bind_onRenderRT,this)};
RealtimeReflector.prototype.onRenderRT=function(a,b){if(this._root&&(this.refresh_rate<<=0,0!=Scene._frame&&0==Scene._frame%this.refresh_rate||!this._rt)){isPowerOfTwo(this.texture_size)||(this.texture_size=256);var c=this.use_cubemap?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;this._rt&&this._rt.width==this.texture_size&&this._rt.texture_type==c||(this._rt=new Texture(this.texture_size,this.texture_size,{texture_type:c}));var c=this._root.transform.getPositionGlobal(),d=this._root.transform.getTop();if(this.use_mesh_info){var e=
this._root.getMesh();e&&(c=this._root.transform.transformPointGlobal([e.vertices[0],e.vertices[1],e.vertices[2]]),d=this._root.transform.transformVectorGlobal([e.normals[0],e.normals[1],e.normals[2]]))}var e=new Camera(b.serialize()),f=this._root.flags.visible;this._root.flags.visible=!1;this.use_cubemap?(e.eye=c,RenderPipeline.renderSceneMeshesToRT(e,this._rt,{is_rt:!0,is_reflection:!0,brightness_factor:this.brightness_factor,colorclip_factor:this.colorclip_factor})):(e.aspect=b.aspect,e.eye=geo.reflectPointInPlane(b.eye,
c,d),e.center=geo.reflectPointInPlane(b.center,c,d),e.up=geo.reflectPointInPlane(b.up,[0,0,0],d),vec3.add(c,c,vec3.scale(vec3.create(),d,-this.clip_offset)),c=[d[0],d[1],d[2],vec3.dot(c,d)],RenderPipeline.renderSceneMeshesToRT(e,this._rt,{clipping_plane:c,is_rt:!0,is_reflection:!0,brightness_factor:this.brightness_factor,colorclip_factor:this.colorclip_factor}));this._root.flags.visible=f;this.rt_name&&ResourcesManager.registerResource(this.rt_name,this._rt);this._root.material&&this._root.material.setTexture(this.rt_name?
this.rt_name:this._rt,Material.ENVIRONMENT_TEXTURE,Material.COORDS_SCREEN)}};LS.registerComponent(RealtimeReflector);function ScriptComponent(a){this.enabled=!0;this.code="function update(dt)\n{\n\tScene.refresh();\n}";this._component=null;this.configure(a);this.code&&this.processCode()}ScriptComponent["@code"]={type:"script"};ScriptComponent.valid_callbacks=["start","update"];
ScriptComponent.prototype.processCode=function(){var a=this.component_name||"__last_component",b=this.code,c="",d;for(d in ScriptComponent.valid_callbacks)c+="\tif(typeof("+ScriptComponent.valid_callbacks[d]+") != 'undefined') this."+ScriptComponent.valid_callbacks[d]+" = "+ScriptComponent.valid_callbacks[d]+";\n";b="function "+a+"(component, node) {\n"+b+"\n"+(c+("\n}\nwindow."+a+" = "+a+";\n"));try{this._last_executed_code=b,eval(b),this._component_class=window[a],this._component=new this._component_class(this,
this._root)}catch(e){this._component=this._component_class=null,trace("Error in script\n"+e),trace(this._last_executed_code)}};ScriptComponent.prototype.onAddedToNode=function(a){this._onStart_bind=this.onStart.bind(this);this._onUpdate_bind=this.onUpdate.bind(this);LEvent.bind(Scene,"start",this._onStart_bind);LEvent.bind(Scene,"update",this._onUpdate_bind)};ScriptComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"start",this._onStart_bind);LEvent.unbind(Scene,"update",this._onUpdate_bind)};
ScriptComponent.prototype.onStart=function(){this.processCode();this.enabled&&this._component&&this._component.start&&this._component.start()};ScriptComponent.prototype.onUpdate=function(a,b){this.enabled&&this._component&&this._component.update&&this._component.update(b)};LS.registerComponent(ScriptComponent);function TerrainRenderer(a){this.height=2;this.subdivisions=this.size=10;this.heightmap=null;this.auto_update=!0;this._mesh=null;this.action="Update";a&&this.configure(a)}
TerrainRenderer.prototype.configure=function(a){cloneObject(a,this)};TerrainRenderer.prototype.serialize=function(){return cloneObject(this)};TerrainRenderer.prototype.getResources=function(a){this.heightmap&&(a[this.heightmap]=Texture)};TerrainRenderer["@subdivisions"]={widget:"number",min:1,max:255,step:1};TerrainRenderer["@heightmap"]={widget:"texture"};TerrainRenderer["@action"]={widget:"button",callback:function(){this.options.component.updateMesh()}};
TerrainRenderer.prototype.updateMesh=function(){trace("updating terrain mesh...");if(this.heightmap){var a="string"==typeof this.heightmap?ResourcesManager.textures[this.heightmap]:this.heightmap;if(a){var b=a.img;if(b){this.subdivisions>b.width&&(this.subdivisions=b.width);this.subdivisions>b.height&&(this.subdivisions=b.height);255<this.subdivisions&&(this.subdivisions=255);var a=this.size,c=this.subdivisions<<0,d=this.height,e=createCanvas(c,c),f=e.getContext("2d");f.drawImage(b,0,0,b.width,b.height,
0,0,e.width,e.height);for(var b=f.getImageData(0,0,e.width,e.height).data,e=[],f=[],g=[],h=[],n=detailX=c-1,k,l=a/(c-1),m=0;m<=n;m++)for(var t=m/n,q=0;q<=detailX;q++){var p=q/detailX;k=b[4*m*c+4*q]/255;f.push(a*(2*p-1),k*d,a*(2*t-1));h.push(p,1-t);0==q||0==m||q==detailX-1||m==n-1?g.push(0,1,0):(k=[-(b[4*m*c+4*(q+1)]/255-b[4*m*c+4*(q-1)]/255)*d,2*l,-(b[4*(m+1)*c+4*q]/255-b[4*(m-1)*c+4*q]/255)*d],vec3.normalize(k,k),g.push(k[0],k[1],k[2]));q<detailX&&m<n&&(k=q+m*(detailX+1),e.push(k+1,k,k+detailX+1),
e.push(k+1,k+detailX+1,k+detailX+2))}this._mesh=Mesh.load({triangles:e,vertices:f,normals:g,coords:h});this._info=[this.heightmap,this.size,this.height,this.subdivisions,this.smooth]}}}};TerrainRenderer.PLANE=null;
TerrainRenderer.prototype.getRenderInstance=function(){!this._mesh&&this.heightmap&&this.updateMesh();this.auto_update&&this._info&&(this._info[0]==this.heightmap&&this._info[1]==this.size&&this._info[2]==this.height&&this._info[3]==this.subdivisions&&this._info[4]==this.smooth||this.updateMesh());return this._mesh?{mesh:this._mesh}:(TerrainRenderer.PLANE||(TerrainRenderer.PLANE=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),{mesh:TerrainRenderer.PLANE})};LS.registerComponent(TerrainRenderer);
RenderInstance.TWO_SIDED=1;function RenderInstance(){this._key="";this._uid=LS.generateUId();this.mesh=null;this.primitive=gl.TRIANGLES;this.material=null;this.flags=0;this.matrix=mat4.create();this.center=vec3.create()}RenderInstance.prototype.generateKey=function(a,b){return this._key=a+"|"+this.node._uid+"|"+this.material._uid+"|"};
RenderInstance.prototype.render=function(a){null!=this.submesh_id&&-1!=this.submesh_id&&this.mesh.info.groups&&this.mesh.info.groups.length>this.submesh_id?a.drawRange(this.mesh,this.primitive,this.mesh.info.groups[this.submesh_id].start,this.mesh.info.groups[this.submesh_id].length):this.start||this.length?a.drawRange(this.mesh,this.primitive,this.start||0,this.length):a.draw(this.mesh,this.primitive)};
var Renderer={apply_postfx:!0,generate_shadowmaps:!0,sort_nodes_in_z:!0,z_pass:!1,postfx_settings:{width:1024,height:512},postfx:[],_postfx_texture_a:null,_postfx_texture_b:null,_renderkeys:{},_current_scene:null,_default_material:new Material,_visible_lights:[],_visible_meshes:[],_opaque_meshes:[],_alpha_meshes:[],render:function(a,b,c){function d(){gl.clearColor(a.background_color[0],a.background_color[1],a.background_color[2],3<a.background_color.length?a.background_color[3]:1);!0!=c.ignore_clear&&
gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.enableCamera(a.current_camera);Renderer.renderSceneMeshes("main",c);LEvent.trigger(Scene,"afterRenderScene",a.current_camera)}c=c||{};this._current_scene=a=a||Scene;LEvent.trigger(Scene,"beforeRender",a.current_camera);a.sendEventToNodes("beforeRender",a.current_camera);if(a.light&&a.light.onBeforeRender)a.light.onBeforeRender();this.updateVisibleLights(a,c.nodes);!a.settings.enable_shadows||c.skip_shadowmaps||!this.generate_shadowmaps||c.shadows_disabled||
c.lights_disabled||this.renderShadowMaps();LEvent.trigger(Scene,"afterRenderShadows",a.current_camera);a.sendEventToNodes("afterRenderShadows",a.current_camera);a.settings.enable_rts&&!c.skip_rts&&0<a.rt_cameras.length&&this.renderRTCameras();a.active_viewport=a.viewport||[0,0,gl.canvas.width,gl.canvas.height];a.current_camera.aspect=a.active_viewport[2]/a.active_viewport[3];this.apply_postfx&&this.postfx.length?this.renderPostFX(d):c.texture&&c.depth_texture?Texture.drawToColorAndDepth(c.texture,
c.depth_texture,d):c.texture?c.texture.drawTo(d):(gl.viewport(a.active_viewport[0],a.active_viewport[1],a.active_viewport[2],a.active_viewport[3]),d(),gl.viewport(0,0,gl.canvas.width,gl.canvas.height));LEvent.trigger(Scene,"afterRender",a.current_camera);Scene.sendEventToNodes("afterRender",a.current_camera);if(a.light&&a.light.onAfterRender)a.light.onAfterRender();Scene._frame+=1;Scene._must_redraw=!1},_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),
_mvp_matrix:mat4.create(),_temp_matrix:mat4.create(),_world_model:mat4.create(),_object_model:mat4.create(),_normal_model:mat4.create(),enableCamera:function(a){a.setActive();a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);this.active_camera=a},renderSceneMeshesOld:function(a){var b=this.current_scene||Scene;a=a||{};var c=0,d=null!=a.brightness_factor?a.brightness_factor:
1,e=null!=a.colorclip_factor?a.colorclip_factor:0;a.camera=this.active_camera;LEvent.trigger(Scene,"beforeRenderPass",a);Scene.sendEventToNodes("beforeRenderPass",a);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);gl.lineWidth(1);var f=null;a.force_shader&&(f=Shaders.get(a.force_shader));vec3.create();var g={u_camera_eye:this.active_camera.eye,u_camera_planes:[this.active_camera.near,this.active_camera.far],u_viewprojection:this._viewprojection_matrix,u_brightness_factor:d,u_colorclip_factor:e,
u_time:Scene.current_time||0.001*(new Date).getTime()},h={camera:this.active_camera,instance:null,node:null,uniforms:g,macros:null,light:null,lights:this._visible_lights};LEvent.trigger(Scene,"fillGlobalUniforms",h);var n=a.clipping_plane;this.updateVisibleMeshes(b,a);a.pass="z";if(this.z_pass){gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);var k=Shaders.get("flat");gl.colorMask(!1,!1,!1,!1);for(var l in this._opaque_meshes){var m=this._opaque_meshes[l];m.two_sided?gl.disable(gl.CULL_FACE):
gl.enable(gl.CULL_FACE);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,m.matrix);k.uniforms({u_material_color:[1,0,0,1],u_mvp:this._mvp_matrix});m.renderFunc(k)}gl.colorMask(!0,!0,!0,!0)}a.pass="main";for(l in this._visible_meshes){var m=this._visible_meshes[l],t=m.node,q=m.mesh;h.instance=m;h.node=t;LEvent.trigger(t,"beforeRenderMeshes",a);var p=m.material;"string"===typeof p&&(p=b.materials[p]);p||(p=this._default_material);m.two_sided?gl.disable(gl.CULL_FACE):gl.enable(gl.CULL_FACE);
gl.depthFunc(gl.LEQUAL);t.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST);t.flags.depth_write?gl.depthMask(!0):gl.depthMask(!1);a.is_shadowmap||a.is_picking?gl.disable(gl.BLEND):p.blending==Material.ADDITIVE_BLENDING?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)):0.999>p.alpha?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)):gl.disable(gl.BLEND);t.flags.flip_normals?gl.frontFace(gl.CW):gl.frontFace(gl.CCW);k=m.matrix;mat4.copy(this._object_model,
k);mat4.copy(this._normal_model,k);mat4.setTranslation(this._normal_model,vec3.create());mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,this._object_model);if(a.is_shadowmap){if(!1!=t.flags.cast_shadows){if(!0==t.flags.alpha_shadows&&(p.getTexture("color")||p.getTexture("opacity"))){k={USE_ALPHA_TEST:"0.5"};if(q=p.getTexture("color"))k.USE_COLOR_TEXTURE="uvs_"+(p.textures.color_uvs||Material.DEFAULT_UVS.color||"0"),q.bind(0);if(q=p.getTexture("opacity"))k.USE_OPACITY_TEXTURE="uvs_"+(p.textures.opacity_uvs||
Material.DEFAULT_UVS.opacity||"0"),q.bind(1);k=Shaders.get("depth",k);k.uniforms({u_mvp:this._mvp_matrix,u_material_color:[0,0,0,p.alpha],texture:0,opacity_texture:1,u_texture_matrix:[p.uvs_matrix[0],0,p.uvs_matrix[2],0,p.uvs_matrix[1],p.uvs_matrix[3],0,0,1]})}else k=Shaders.get("depth"),k.uniforms({u_mvp:this._mvp_matrix});m.renderFunc(k)}}else if(a.is_picking)c+=10,p=new Uint32Array(1),p[0]=c,p=new Uint8Array(p.buffer),t._picking_color=c,k=Shaders.get("flat"),k.uniforms({u_mvp:this._mvp_matrix,
u_material_color:new Float32Array([p[0]/255,p[1]/255,p[2]/255,1])}),m.renderFunc(k);else{g.u_mvp=this._mvp_matrix;g.u_model=this._object_model;g.u_normal_model=this._normal_model;var w=p.getMaterialShaderData(m,t,b,a),r;for(r in w)g[r]=w[r];n&&(g.u_clipping_plane=n);LEvent.trigger(Scene,"fillMeshUniforms",h);for(var u=null,u=f?f:t.shader?t.shader:p.shader?p.shader:"globalshader",s=this._visible_lights.length,v=0;v<s;++v){k=this._visible_lights[v];h.light=k;0<v&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,
gl.ONE),gl.depthFunc(gl.LEQUAL),t.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST));LEvent.trigger(Scene,"fillLightUniforms",h);for(r in w)g[r]=w[r];var A=p.getLightShaderData(k,m,t,b,a);for(r in A)g[r]=A[r];if(u.constructor==String){k={};h.macros=k;if(w.MACROS)for(r in w.MACROS)k[r]=w.MACROS[r];if(A.MACROS)for(r in A.MACROS)k[r]=A.MACROS[r];this.active_camera.type==Camera.ORTHOGRAPHIC&&(k.USE_ORTHOGRAPHIC_CAMERA="");0==v&&(k.FIRST_PASS="");v==s-1&&(k.LAST_PASS="");!0==t.flags.alpha_test&&
(k.USE_ALPHA_TEST="0.5");n&&(k.USE_CLIPPING_PLANE="");1!=d&&(k.USE_BRIGHTNESS_FACTOR="");0<e&&(k.USE_COLORCLIP_FACTOR="");"a_normal"in q.vertexBuffers||(k.NO_NORMALS="");"a_coord"in q.vertexBuffers||(k.NO_COORDS="");"a_color"in q.vertexBuffers&&(k.USE_COLOR_STREAM="");"a_tangent"in q.vertexBuffers&&(k.USE_TANGENT_STREAM="");LEvent.trigger(Scene,"fillMacros",h);k=p.getShader(u,k)}else k=u,h.macros=null;k.uniforms(g);p.uniforms&&k.uniforms(p.uniforms);p.depth_func&&gl.depthFunc(gl[p.depth_func]);m.renderFunc(k);
if(a.lights_disabled)break;if(k.global&&!k.global.multipass)break}}LEvent.trigger(t,"afterRenderMeshes",a)}LEvent.trigger(Scene,"afterRenderPass",a);Scene.sendEventToNodes("afterRenderPass",a);gl.depthFunc(gl.LEQUAL);gl.depthMask(!0);gl.disable(gl.BLEND);gl.frontFace(gl.CCW)},renderSceneMeshes:function(a,b){var c=this.current_scene||Scene;b=b||{};b.camera=this.active_camera;b.step=a;LEvent.trigger(Scene,"beforeRenderPass",b);Scene.sendEventToNodes("beforeRenderPass",b);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);
gl.disable(gl.BLEND);gl.lineWidth(1);vec3.create();Scene.current_time||(new Date).getTime();this.updateVisibleMeshesNew(c,b);var c=this._visible_lights,d;for(d in this._visible_meshes)this.renderMultiPassInstance(a,this._visible_meshes[d],c,b);LEvent.trigger(Scene,"afterRenderPass",b);Scene.sendEventToNodes("afterRenderPass",b);gl.depthFunc(gl.LEQUAL);gl.depthMask(!0);gl.disable(gl.BLEND);gl.frontFace(gl.CCW)},renderMultiPassInstance:function(a,b,c,d){for(var e=0;e<c.length;e++){var f=c[e],g=b.generateKey(a,
d),g=this._renderkeys[g];if(!g){var g=b.material.shader||"globalshader",h={};b.material.getSurfaceShaderMacros(h,a,b,g,d);b.material.getLightShaderMacros(h,a,f,b,g,d);g=Shaders.get(g,h)}h={};b.material.fillSurfaceUniforms(g,h,b,node,scene,d);b.material.fillLightUniforms(g,h,f,b,node,scene,d);g.uniforms(h);b.render(g)}},updateVisibleMeshes:function(a,b){var c=a.nodes;b.nodes&&(c=b.nodes);var d=this.active_camera.getEye(),e=[],f=[],g;for(g in c){var h=c[g];LEvent.trigger(h,"computeVisibility",{camera:this.active_camera,
options:b});if(h._components)for(var n in h._components){var k=h._components[n];if(k.getRenderInstance){var l=k.getRenderInstance(b,this.active_camera);!l||!(!1!=h.flags.seen_by_camera||b.is_shadowmap||b.is_picking||b.is_reflection)||!1==h.flags.seen_by_picking&&b.is_picking||(l.matrix||(l.matrix=h.transform.getGlobalMatrix()),l.center||(l.center=mat4.multiplyVec3(vec3.create(),l.matrix,vec3.create())),null==l.primitive&&(l.primitive=gl.TRIANGLES),l.two_sided=l.two_sided||h.flags.two_sided,l.renderFunc||
(l.renderFunc=Renderer.renderMeshInstance),l.material=l.material||h.material||this._default_material,l.material.constructor===String&&(l.material=a.materials[l.material]),l.material&&(l.node=h,l.component=k,b.force_wireframe&&(l.primitive=gl.LINES),l.primitive!=gl.LINES||l.mesh.lines||l.mesh.computeWireframe(),k=l.material,1<=k.alpha&&k.blending!=Material.ADDITIVE_BLENDING?e.push(l):f.push(l),l._dist=vec3.dist(l.center,d)))}}}this.sort_nodes_in_z&&(e.sort(function(a,b){return a._dist<b._dist?-1:a._dist>
b._dist?1:0}),f.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0}));this._alpha_meshes=f;this._opaque_meshes=e;this._visible_meshes=e.concat(f)},updateVisibleMeshesNew:function(a,b){var c=a.nodes;b.nodes&&(c=b.nodes);var d=this.active_camera.getEye(),e=[],f=[],g;for(g in c){var h=c[g];LEvent.trigger(h,"computeVisibility",{camera:this.active_camera,options:b});if(!(!h.flags.visible||b.is_rt&&!1==h.flags.seen_by_reflections||!(!1!=h.flags.seen_by_camera||b.is_shadowmap||b.is_picking||
b.is_reflection)||!1==h.flags.seen_by_picking&&b.is_picking)&&h._components)for(var n in h._components){var k=h._components[n];if(k.getRenderInstance){var l=k.getRenderInstance(b,this.active_camera);l&&l.material&&(l.center||mat4.multiplyVec3(l.center,l.matrix,vec3.create()),l.node=h,l.component=k,b.force_wireframe&&(l.primitive=gl.LINES),l.primitive!=gl.LINES||l.mesh.lines||l.mesh.computeWireframe(),k=l.material,1<=k.alpha&&k.blending!=Material.ADDITIVE_BLENDING?e.push(l):f.push(l),l._dist=vec3.dist(l.center,
d))}}}this.sort_nodes_in_z&&(e.sort(function(a,b){return a._dist<b._dist?-1:a._dist>b._dist?1:0}),f.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0}));this._alpha_meshes=f;this._opaque_meshes=e;this._visible_meshes=e.concat(f)},null_light:null,updateVisibleLights:function(a,b){this._visible_lights=[];a.light&&!1!=a.light.enabled&&this._visible_lights.push(a.light);b=b||a.nodes;for(var c=0;c<b.length;++c){var d=b[c];if(d.flags.visible)for(var e in d._components)d._components[e].constructor===
Light&&d._components[e].enabled&&this._visible_lights.push(d._components[e])}0==this._visible_lights.length&&(this.null_light||(this.null_light=new Light,this.null_light.color=[0,0,0]),this._visible_lights.push(this.null_light))},renderSceneMeshesToRT:function(a,b,c){function d(){gl.clearColor(Scene.background_color[0],Scene.background_color[1],Scene.background_color[2],3<Scene.background_color.length?Scene.background_color[3]:1);!0!=c.ignore_clear&&gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);
Renderer.renderSceneMeshes(c)}b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a),b.drawTo(d)):b.texture_type==gl.TEXTURE_CUBE_MAP&&this.renderCubemap(a.getEye(),b.width,b,c,a.near,a.far)},renderShadowMaps:function(a){a=a||Scene;for(var b in this._visible_lights){var c=this._visible_lights[b];if(c.cast_shadows){var d=c.shadowmap_resolution;d||(d=Light.DEFAULT_SHADOWMAP_RESOLUTION);if(null==c._shadowMap||c._shadowMap.width!=d)c._shadowMap=new GL.Texture(d,d,{format:gl.RGBA,magFilter:gl.NEAREST,minFilter:gl.NEAREST}),
ResourcesManager.textures[":shadowmap_"+b.toString()]=c._shadowMap;c.computeLightMatrices(this._view_matrix,this._projection_matrix,this._viewprojection_matrix);this.active_camera=a.current_camera;c._shadowMap.unbind();c._shadowMap.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);c._lightMatrix||(c._lightMatrix=mat4.create());mat4.copy(Renderer._viewprojection_matrix,c._lightMatrix);Renderer.renderSceneMeshes({pass:"shadow",is_shadowmap:!0})})}}},renderRTCameras:function(){var a=
this.current_scene||Scene,b;for(b in a.rt_cameras){var c=a.rt_cameras[b];null==c.texture&&(c.texture=new GL.Texture(c.resolution||1024,c.resolution||1024,{format:gl.RGB,magFilter:gl.LINEAR}),ResourcesManager.textures[c.id]=c.texture);this.enableCamera(c);c.texture.drawTo(function(){gl.clearColor(a.background_color[0],a.background_color[1],a.background_color[2],0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.renderSceneMeshes({is_rt:!0,clipping_plane:c.clipping_plane})})}},renderPostFX:function(a){this._postfx_texture_a&&
this._postfx_texture_a.width==this.postfx_settings.width&&this._postfx_texture_a.height==this.postfx_settings.height||(this._postfx_texture_a=new GL.Texture(postfx_settings.width,postfx_settings.height,{magFilter:gl.LINEAR,minFilter:gl.NEAREST}),this._postfx_texture_b=new GL.Texture(postfx_settings.width,postfx_settings.height,{magFilter:gl.LINEAR,minFilter:gl.NEAREST}));this._postfx_texture_a.drawTo(a);for(var b in this.postfx){a=this.postfx[b];var c=null;"string"==typeof a?(c=Shaders.get(a),this._postfx_texture_b.drawTo(function(){Renderer._postfx_texture_a.bind();
c.uniforms({color:[1,1,1,1],texSize:[Renderer._postfx_texture_a.width,Renderer._postfx_texture_a.height],time:0.001*(new Date).getTime()}).draw(Renderer.viewport3d.screen_plane)})):a&&a.callback&&a.callback(this._postfx_texture_a,this._postfx_texture_b);a=this._postfx_texture_b;this._postfx_texture_b=this._postfx_texture_a;this._postfx_texture_a=a}options.texture?options.texture.drawTo(function(){Renderer._postfx_texture_a.bind();Shaders.get("screen").uniforms({color:[1,1,1,1]}).draw(Renderer.viewport3d.screen_plane)}):
(gl.viewport(scene.active_viewport[0],scene.active_viewport[1],scene.active_viewport[2],scene.active_viewport[3]),Renderer._postfx_texture_a.bind(),Shaders.get("screen").uniforms({color:[1,1,1,1]}).draw(Renderer.viewport3d.screen_plane))},renderCubemap:function(a,b,c,d,e,f){b=b||256;e=e||1;f=f||1E3;var g=[{dir:[1,0,0],up:[0,1,0]},{dir:[-1,0,0],up:[0,1,0]},{dir:[0,-1,0],up:[0,0,-1]},{dir:[0,1,0],up:[0,0,1]},{dir:[0,0,-1],up:[0,1,0]},{dir:[0,0,1],up:[0,1,0]}];c&&c.constructor==Texture||(c=null);c=c||
new Texture(b,b,{texture_type:gl.TEXTURE_CUBE_MAP,minFilter:gl.NEAREST});c.drawTo(function(b){gl.clearColor(Scene.background_color[0],Scene.background_color[1],Scene.background_color[2],3<Scene.background_color.length?Scene.background_color[3]:1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);b=new Camera({eye:a,center:[a[0]+g[b].dir[0],a[1]+g[b].dir[1],a[2]+g[b].dir[2]],up:g[b].up,fov:90,aspect:1,near:e,far:f});Renderer.enableCamera(b);Renderer.renderSceneMeshes(d)});return c},pickingMap:null,
_picking_color:null,picking_depth:0,renderPickingBuffer:function(a,b){var c=this.current_scene||Scene;if(null==this.pickingMap||this.pickingMap.width!=gl.canvas.width||this.pickingMap.height!=gl.canvas.height)this.pickingMap=new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,magFilter:gl.NEAREST});b=gl.canvas.height-b;small_area=!0;this.pickingMap.drawTo(function(){var d=c.viewport||[0,0,gl.canvas.width,gl.canvas.height];c.current_camera.aspect=d[2]/d[3];gl.viewport(d[0],d[1],d[2],d[3]);
small_area&&(gl.scissor(a-1,b-1,2,2),gl.enable(gl.SCISSOR_TEST));gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.enableCamera(c.current_camera);Renderer.renderSceneMeshes({is_picking:!0});Renderer._picking_color=new Uint8Array(4);gl.readPixels(a,b,1,1,gl.RGBA,gl.UNSIGNED_BYTE,Renderer._picking_color);small_area&&gl.disable(gl.SCISSOR_TEST)});this._picking_color||(this._picking_color=new Uint8Array(4));return this._picking_color},projectToCanvas:function(a,b,c){},
getNodeAtCanvasPosition:function(a,b,c){a=a||Scene;this.renderPickingBuffer(b,c);this._picking_color[3]=0;b=(new Uint32Array(this._picking_color.buffer))[0];c=null;for(var d in a.nodes){var e=a.nodes[d];if(e._picking_color&&b==e._picking_color){c=e;closer_dist=0;break}}return c}};LS.Renderer=Renderer;
var Parser={flipAxis:0,merge_smoothgroups:!1,image_extensions:["png","jpg"],nonative_image_extensions:["tga","dds"],mesh_extensions:"obj bin dae ase gr2 json jsmesh".split(" "),generic_extensions:["xml","js","json"],xml_extensions:["xml","dae"],json_extensions:["js","json"],binary_extensions:["bin","tga","dds"],parsers:{},registerParser:function(a){this.parsers[a.extension]=a},parse:function(a,b,c){c=c||{};var d=this.getResourceInfo(a);c.extension&&(d.extension=c.extension);var e=this.parsers[d.extension];
if(!e)return trace("Perser Error: No parser found for "+d.extension+" format"),null;d=null;try{d=e.parse(b,c)}catch(f){return trace("Error parsing content: "+f),null}d.name=a;return d},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var e=0;e<b.width;++e)for(var f=0;f<b.height;++f){var g=4*f*b.width+4*e,h=3*(b.height-f-1)*b.width+3*e;d.data[g+2]=a.pixels[h];
d.data[g+1]=a.pixels[h+1];d.data[g+0]=a.pixels[h+2];d.data[g+3]=255}else for(e=0;e<b.width;++e)for(f=0;f<b.height;++f)g=4*f*b.width+4*e,h=4*(b.height-f-1)*b.width+4*e,d.data[g+0]=a.pixels[h+2],d.data[g+1]=a.pixels[h+1],d.data[g+2]=a.pixels[h+0],d.data[g+3]=a.pixels[h+3];c.putImageData(d,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],a[1],a[2]],d=0;d<a.length;d+=3){var e=[a[d],a[d+1],a[d+2]];e[0]<b[0]?b[0]=e[0]:e[0]>c[0]&&
(c[0]=e[0]);e[1]<b[1]?b[1]=e[1]:e[1]>c[1]&&(c[1]=e[1]);e[2]<b[2]?b[2]=e[2]:e[2]>c[2]&&(c[2]=e[2])}a={};a.aabb_min=b;a.aabb_max=c;a.aabb_center=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];a.aabb_half=[b[0]-a.aabb_center[0],b[1]-a.aabb_center[1],b[2]-a.aabb_center[2]];a.radius=Math.sqrt(a.aabb_half[0]*a.aabb_half[0]+a.aabb_half[1]*a.aabb_half[1]+a.aabb_half[2]*a.aabb_half[2]);return a},stringToTypedArray:function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);
return c},typedArrayToString:function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c},JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",TEXT_FORMAT:"text",MESH_DATA:"MESH",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",GENERIC_DATA:"GENERIC",getResourceInfo:function(a){var b=a.substr(a.lastIndexOf(".")+1).toLowerCase();a={filename:a,extension:b};a.format=Parser.TEXT_FORMAT;-1!=this.xml_extensions.indexOf(b)?a.format=Parser.XML_FORMAT:
-1!=this.json_extensions.indexOf(b)?a.format=Parser.JSON_FORMAT:-1!=this.binary_extensions.indexOf(b)&&(a.format=Parser.BINARY_FORMAT);-1!=this.image_extensions.indexOf(b)?a.type=Parser.IMAGE_DATA:-1!=this.mesh_extensions.indexOf(b)?a.type=Parser.MESH_DATA:-1!=this.nonative_image_extensions.indexOf(b)?a.type=Parser.NONATIVE_IMAGE_DATA:-1!=this.generic_extensions.indexOf(b)&&(a.type=Parser.GENERIC_DATA);return a}};
Mesh.prototype.toBinary=function(){if(!window.BinaryPack)throw"BinaryPack not imported, no binary formats supported";if(this.info){var a={info:this.info};this.info.num_vertices=this.vertices.length;for(var b in this.vertexBuffers){var c=this.vertexBuffers[b];a[c.name]=c.data}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=c.data;b=new BinaryPack;b.save(a);return b.getData()}trace("Error: Mesh info not found")};
var parserASE={extension:"ase",data_type:"mesh",format:"text",parse:function(a,b){b=b||{};var c=[],d=[],e=[],f=[],g=[],h=null,h=null,n=0,k=-1,l=null,m=[],t=Parser.flipAxis;null!=b.flipAxis&&(t=b.flipAxis);for(var q=t||b.flipNormals,p=a.split("\n"),w=0;w<p.length;++w)if(h=p[w].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==h[0]&&(h=h.substr(1,h.length)),""!=h)if(h=h.split(" "),"*MESH"==h[0]){if(n+=1,f=[],g=[],1<n)break}else if("*NODE_NAME"==h[0])h[1].substr(1,h[1].length-2);else if("*MESH_VERTEX"==
h[0])t?f.push([-1*parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[3])]):f.push([parseFloat(h[2]),parseFloat(h[3]),parseFloat(h[4])]);else if("*MESH_FACE"==h[0]){var r=parseInt(h[17]);k!=r&&(k=r,null!=l&&(l.length=c.length/3-l.start,0<l.length&&m.push(l)),l={name:"mat_"+r,start:c.length/3,length:-1,material:""});r=f[parseInt(h[3])];c.push(r[0],r[1],r[2]);r=f[parseInt(h[5])];c.push(r[0],r[1],r[2]);r=f[parseInt(h[7])];c.push(r[0],r[1],r[2])}else"*MESH_TVERT"==h[0]?g.push([parseFloat(h[2]),parseFloat(h[3])]):
"*MESH_TFACE"==h[0]?(r=g[parseInt(h[2])],d.push(r[0],r[1]),r=g[parseInt(h[3])],d.push(r[0],r[1]),r=g[parseInt(h[4])],d.push(r[0],r[1])):"*MESH_VERTEXNORMAL"==h[0]&&(q?e.push(-1*parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[3])):e.push(parseFloat(h[2]),parseFloat(h[3]),parseFloat(h[4])));f=c.length/3-l.start;l&&1<f&&(l.length=f,m.push(l));l={};l.vertices=new Float32Array(c);0<e.length&&(l.normals=new Float32Array(e));0<d.length&&(l.coords=new Float32Array(d));Parser.computeMeshBounding(l.vertices);
1<m.length&&(info.groups=m);l.info=info;return l}};Parser.registerParser(parserASE);var parserBIN={extension:"bin",data_type:"mesh",format:"binary",parse:function(a,b){if(!window.BinaryPack)throw"BinaryPack not imported, no binary formats supported";a="string"==typeof a?BinaryPack.stringToTypedArray(a):new Uint8Array(a);return(new BinaryPack).load(a)}};Parser.registerParser(parserBIN);
var parserDAE={extension:"dae",data_type:"mesh",format:"text",parse:function(a,b){trace("Parsing collada");var c=(new DOMParser).parseFromString(a,"text/xml").querySelectorAll("library_geometries geometry");if(!c||0==c.length)return null;for(var d in c){var e={},f=c[d];f.getAttribute("id");if(f.querySelector){c=f.querySelector("mesh");d=c.querySelectorAll("source");for(var g in d)if(f=d[g],f.querySelector){var h=f.querySelector("float_array");if(h){for(var n=h.textContent,n=n.replace(/\n/gi," "),
n=n.trim(),n=n.split(" "),h=new Float32Array(parseInt(h.getAttribute("count"))),k=0;k<n.length;k++)h[k]=parseFloat(n[k]);e[f.getAttribute("id")]=h}}d=c.querySelector("vertices input");vertices_source=e[d.getAttribute("source").substr(1)];e[c.querySelector("vertices").getAttribute("id")]=vertices_source;var k=c.querySelector("polygons"),l=k.querySelectorAll("input"),f=d=c=-1,m=h=n=null;for(g in l){var t=l[g];if(t.getAttribute){var q=t.getAttribute("semantic").toUpperCase(),p=e[t.getAttribute("source").substr(1)];
"VERTEX"==q?(n=p,c=parseInt(t.getAttribute("offset"))):"NORMAL"==q?(h=p,d=parseInt(t.getAttribute("offset"))):"TEXCOORD"==q&&(m=p,f=parseInt(t.getAttribute("offset")))}}var q=k.querySelectorAll("p"),p=[],e=[],l=[],t=[],w=0;for(g in q){k=q[g];if(!k||!k.textContent)break;a=k.textContent.split(" ");for(var r=-1,u=-1,s=-1,k=0;k<a.length;k+=3)6<k&&(p.push(p[3*r],p[3*r+1],p[3*r+2]),e.push(e[3*r],e[3*r+1],e[3*r+2]),l.push(l[2*r],l[2*r+1]),p.push(p[3*(s+1)],p[3*(s+1)+1],p[3*(s+1)+2]),e.push(e[3*(s+1)],e[3*
(s+1)+1],e[3*(s+1)+2]),l.push(l[2*(s+1)],l[2*(s+1)+1]),w+=2,u=w-1),s=u,u=3*parseInt(a[k+c]),p.push(n[u],n[u+1],n[u+2]),-1!=d&&(u=3*parseInt(a[k+d]),e.push(h[u],h[u+1],h[u+2])),-1!=f&&(u=2*parseInt(a[k+f]),l.push(m[u],m[u+1])),u=w,w+=1,0==k&&(r=u)}g={vertices:new Float32Array(p)};e.length&&(g.normals=new Float32Array(e));l.length&&(g.coords=new Float32Array(l));t.length&&(g.triangles=new Uint16Array(t));e=Parser.computeMeshBounding(g.vertices);g.bounding=e;return isNaN(e.radius)?null:g}}}};Parser.registerParser(parserDAE);
var parserDDS={extension:"dds",data_type:"image",format:"binary",parse:function(a,b){var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),d=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,d.handler,!0);d.texture_type=d.handler.texture_type;d.width=d.handler.width;d.height=d.handler.height;return d}};Parser.registerParser(parserDDS);
var parserJSMesh={extension:"jsmesh",data_type:"mesh",format:"text",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles="number"==typeof c.triangles[0]?
c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=Parser.computeMeshBounding(c.vertices));return c}};Parser.registerParser(parserJSMesh);
var parserOBJ={extension:"obj",data_type:"mesh",format:"text",parse:function(a,b){b=b||{};for(var c=[],d=[],e=[],f=[],g=[],h=[],n=[],k={},l=0,m=null,t=null,q=0,p=0,w=t=0,r=0,u=0,s=null,v=!1,A=!1,H=!1,E=!1,F=0,B=b.noindex?b.noindex:1E7<a.length?!0:!1,D=Parser.flipAxis||b.flipAxis,C=D||b.flipNormals,x=null,z=[],J=a.split("\n"),K=J.length,I=0;I<K;++I)if(m=J[I].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=m[0]&&""!=m)if(s=m.split(" "),E&&"v"==s[0]&&(E=!1),"v"==s[0])D?g.push(-1*parseFloat(s[1]),parseFloat(s[3]),
parseFloat(s[2])):g.push(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));else if("vt"==s[0])h.push(parseFloat(s[1]),parseFloat(s[2]));else if("vn"==s[0])C?n.push(-parseFloat(s[2]),-parseFloat(s[3]),parseFloat(s[1])):n.push(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));else if("f"==s[0]){if(E=!0,!(4>s.length)){for(var G=[],m=1;m<s.length;++m){if(!(s[m]in k)||B){t=s[m].split("/");if(1==t.length)t=p=q=parseInt(t[0])-1;else if(2==t.length)q=parseInt(t[0])-1,p=parseInt(t[1])-1,t=-1;else if(3==
t.length)q=parseInt(t[0])-1,p=parseInt(t[1])-1,t=parseInt(t[2])-1;else return trace("Problem parsing: unknown number of values per face"),!1;u=r=w=0;3*q+2<g.length&&(v=!0,w=g[3*q+0],r=g[3*q+1],u=g[3*q+2]);c.push(w,r,u);r=w=0;2*p+1<h.length&&(A=!0,w=h[2*p+0],r=h[2*p+1]);d.push(w,r);r=w=0;u=1;-1!=t&&(3*t+2<n.length&&(H=!0,w=n[3*t+0],r=n[3*t+1],u=n[3*t+2]),e.push(w,r,u));B||(k[s[m]]=l++)}B||(q=k[s[m]],G.push(q),F<q&&(F=q))}if(!B)for(m=2;m<G.length;m++)f.push(G[0],G[m-1],G[m])}}else"g"==s[0]||"usemtl"==
s[0]?1<s.length&&(null!=x&&(x.length=f.length-x.start,0<x.length&&z.push(x)),x={name:s[1],start:f.length,length:-1,material:""}):"usemtl"==s[0]?x&&(x.material=s[1]):"o"!=s[0]&&"s"!=s[0]&&trace("unknown code: "+m);x&&1<f.length-x.start&&(x.length=f.length-x.start,z.push(x));if((65536<F||B)&&0<f.length){console.log("Deindexing mesh...");g=new Float32Array(3*f.length);h=e&&e.length?new Float32Array(3*f.length):null;n=d&&d.length?new Float32Array(2*f.length):null;for(m=0;m<f.length;m+=1)g.set(c.slice(3*
f[m],3*f[m]+3),3*m),h&&h.set(e.slice(3*f[m],3*f[m]+3),3*m),n&&n.set(d.slice(2*f[m],2*f[m]+2),2*m);c=g;h&&(e=h);n&&(d=n);f=null}m={};v&&(m.vertices=new Float32Array(c));H&&0<e.length&&(m.normals=new Float32Array(e));A&&0<d.length&&(m.coords=new Float32Array(d));f&&0<f.length&&(m.triangles=new Uint16Array(f));m.bounding=Parser.computeMeshBounding(m.vertices);c={};1<z.length&&(c.groups=z);m.info=c;(0==m.bounding.radius||isNaN(m.bounding.radius))&&console.log("no radius found in mesh");return m}};Parser.registerParser(parserOBJ);
var parserTGA={extension:"tga",data_type:"image",format:"binary",parse:function(a,b){a="string"==typeof a?Parser.stringToTypedArray(a):new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),d=a.subarray(0,12),e=0;e<d.length;e++)if(c[e]!=d[e])return null;e=a.subarray(12,18);c={};c.width=256*e[1]+e[0];c.height=256*e[3]+e[2];c.bpp=e[4];c.bytesPerPixel=c.bpp/8;c.imageSize=c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);for(e=0;e<c.imageSize;e+=c.bytesPerPixel)d=
c.pixels[e],c.pixels[e]=c.pixels[e+2],c.pixels[e+2]=d;c.flipY=!0;c.format=32==c.bpp?"BGRA":"BGR";return c}};Parser.registerParser(parserTGA);function SceneTree(){this.init()}SceneTree.DEFAULT_BACKGROUND_COLOR=new Float32Array([0,0,0,1]);SceneTree.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);
SceneTree.prototype.init=function(){this.id="";this.materials={};this.local_repository=null;this.nodes=[];this.nodes_by_id={};this.rt_cameras=[];this._components=[];this.camera&&(this.camera=null);this.addComponent(new Camera);this.current_camera=this.camera;this.light&&(this.light=null);this.addComponent(new Light({position:vec3.fromValues(100,100,100),target:vec3.fromValues(0,0,0)}));this.ambient_color=new Float32Array(SceneTree.DEFAULT_AMBIENT_COLOR);this.background_color=new Float32Array(SceneTree.DEFAULT_BACKGROUND_COLOR);
this.textures={};this.viewport=this.active_viewport=null;this.settings={enable_shadows:!0,enable_rts:!0};this._start_time=this._global_time=this._time=this._frame=0;this._last_dt=1/60;this._must_redraw=!0;this.selected_node&&delete this.selected_node;this.extra={}};SceneTree.prototype.clear=function(){for(;this.nodes.length;)Scene.removeNode(this.nodes[0]);this.init();LEvent.trigger(this,"clear");LEvent.trigger(this,"change")};
SceneTree.prototype.configure=function(a){this._components=[];this.camera=this.light=null;"Scene"!=a.object_type&&trace("Warning: object set to scene doesnt look like a propper one.");a.local_repository&&(this.local_repository=a.local_repository);a.background_color&&this.background_color.set(a.background_color);a.ambient_color&&this.ambient_color.set(a.ambient_color);a.textures&&(this.textures=a.textures);a.extra&&(this.extra=a.extra);if(a.nodes){var b=[],c;for(c in a.nodes){var d=a.nodes[c],e=new SceneNode(d.id);
e.configure(d);this.addNode(e);e._parent&&b.push(e)}for(c in b)e=b[c],(d=Scene.getNode(e._parent))&&d.addChild(e),LEvent.trigger(this,"nodeChangeParent",[d,e])}if(a.materials)for(c in a.materials)this.materials[c]=new Material(a.materials[c]);a.components&&this.configureComponents(a);a.camera&&(this.camera?this.camera.configure(a.camera):this.addComponent(new Camera(a.camera)));a.light&&(this.light?this.light.configure(a.light):this.addComponent(new Light(a.light)));LEvent.trigger(this,"configure",
a);LEvent.trigger(this,"change");this.current_camera=this.camera};
SceneTree.prototype.serialize=function(){var a={object_type:"Scene"};a.ambient_color=toArray(this.ambient_color);a.background_color=toArray(this.background_color);a.textures=cloneObject(this.textures);a.local_repository=this.local_repository;a.nodes=[];a.extra=this.extra||{};for(var b in this.nodes)a.nodes.push(this.nodes[b].serialize());if(this.materials)for(b in a.materials={},this.materials)a.materials[b]=this.materials[b].serialize();this.serializeComponents(a);LEvent.trigger(this,"serializing",
a);return a};SceneTree.prototype.loadScene=function(a,b,c){var d=this,e=ResourcesManager.getNoCache(!0);LS.request({url:a+e,dataType:"json",success:function(a){d.configure(a);d.loadResources();b&&b()},error:function(b){trace("Error loading scene: "+a+" -> "+b);c&&c(a)}})};SceneTree.prototype.appendScene=function(a){"SceneTree"==getObjectClassName(a)&&(a=a.serialize());a={nodes:a.nodes};this.configure(a)};
SceneTree.prototype.addNode=function(a,b){void 0==b?this.nodes.push(a):this.nodes.splice(b,0,a);a.id&&-1!=a.id&&(null!=this.nodes_by_id[a.id]&&(a.id=a.id+"_"+(1E3*Math.random()).toFixed(0)),this.nodes_by_id[a.id]=a);a._on_scene=!0;a.processActionInComponents("onAddedToScene",this);LEvent.trigger(this,"nodeAdded",a);LEvent.trigger(this,"change")};
SceneTree.prototype.removeNode=function(a){var b=this.nodes.indexOf(a);return-1!=b?(delete a.scene,this.nodes.splice(b,1),a.id&&delete this.nodes_by_id[a.id],a._on_scene=!1,a.processActionInComponents("onRemovedFromScene",this),LEvent.trigger(this,"nodeRemoved",a),LEvent.trigger(this,"change"),!0):!1};SceneTree.prototype.getNode=function(a){return this.nodes_by_id[a]};SceneTree.prototype.getNodeByIndex=function(a){return this.nodes[a]};SceneTree.prototype.getNodeIndex=function(a){return this.nodes.indexOf(a)};
SceneTree.prototype.getNodesByClass=function(a){var b=[],c;for(c in this.nodes)this.nodes[c].className&&-1!=this.nodes[c].className.split(" ").indexOf(a)&&b.push(this.nodes[c]);return b};SceneTree.prototype.loadResources=function(){var a={},b;for(b in this.textures)this.textures[b]&&(a[this.textures[b]]=Texture);this.light&&this.light.getResources(a);for(b in this.nodes)this.nodes[b].getResources(a);ResourcesManager.loadResources(a)};
SceneTree.prototype.start=function(a){LEvent.trigger(this,"start",this);this.sendEventToNodes("start")};SceneTree.prototype.update=function(a){LEvent.trigger(this,"beforeUpdate",this);this._global_time=0.001*(new Date).getTime();this._time=this._start_time-this._global_time;this._last_dt=a;LEvent.trigger(this,"update",a);this.sendEventToNodes("update",a,!0);LEvent.trigger(this,"afterUpdate",this)};
SceneTree.prototype.sendEventToNodes=function(a,b){for(var c in this.nodes)LEvent.trigger(this.nodes[c],a,b)};SceneTree.prototype.generateUniqueNodeName=function(a){a=a||"node";for(var b=1,c=a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};SceneTree.prototype.refresh=function(){this._must_redraw=!0};SceneTree.prototype.getTime=function(){return this._global_time};
function SceneNode(a){this.id=a||"node_"+(1E4*Math.random()).toFixed(0);this._uid=LS.generateUId();this.flags={visible:!0,selectable:!0,two_sided:!1,flip_normals:!1,cast_shadows:!0,receive_shadows:!0,ignore_lights:!1,alpha_test:!1,alpha_shadows:!1,depth_test:!0,depth_write:!0};this._components=[];this.addComponent(new Transform);this.extra={}}LS.extendClass(ComponentContainer,SceneTree);LS.extendClass(ComponentContainer,SceneNode);
SceneNode.prototype.setId=function(a){if(null!=Scene.getNode(a))return trace("ID already in use"),!1;if(this.id!=a)return this.id&&delete Scene.nodes_by_id[this.id],(this.id=a)&&(Scene.nodes_by_id[this.id]=this),LEvent.trigger(this,"id_changed",a),!0};SceneNode.prototype.getResources=function(a){for(var b in this._components)this._components[b].getResources&&this._components[b].getResources(a);this.material&&this.getMaterial().getResources(a);return a};SceneNode.prototype.getTransform=function(){return this.transform};
SceneNode.prototype.getMesh=function(){var a=this.mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};SceneNode.prototype.getLight=function(){return this.light};SceneNode.prototype.getCamera=function(){return this.camera};SceneNode.prototype.getLODMesh=function(){var a=this.lod_mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.lod_mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};
SceneNode.prototype.setMesh=function(a,b){this.meshrenderer?"string"==typeof a?this.meshrenderer.configure({mesh:a,submesh_id:b}):this.meshrenderer.mesh=a:this.addComponent(new MeshRenderer({mesh:a,submesh_id:b}))};
SceneNode.prototype.loadAndSetMesh=function(a,b){b=b||{};if(ResourcesManager.meshes[a]||!a){if(this.setMesh(a),b.on_complete)b.on_complete(ResourcesManager.meshes[a],this)}else{var c=this;ResourcesManager.loadMesh(a,b,function(a){c.setMesh(a.filename);c.loading-=1;0==c.loading&&(LEvent.trigger(c,"resource_loaded",c),delete c.loading);if(b.on_complete)b.on_complete(a,c)})||(this.loading?this.loading+=1:(this.loading=1,LEvent.trigger(this,"resource_loading")))}};
SceneNode.prototype.getMaterial=function(){return this.material?this.material.constructor===String?Scene.materials[this.material]:this.material:null};SceneNode.prototype.clone=function(){Scene.generateUniqueNodeName(this.id);var a=new SceneNode(c);a.configure(this.serialize());for(var b in this._children){var c=Scene.generateUniqueNodeName(this._children[b].id),c=new SceneNode(c);c.configure(this._children[b].serialize());a.addChild(c)}return a};
SceneNode.prototype.configure=function(a){a.className&&(this.className=a.className);a.mesh&&this.addComponent(new MeshRenderer({mesh:a.mesh,submesh_id:a.submesh_id}));a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material));if(a.flags)for(var b in a.flags)this.flags[b]=a.flags[b];a.transform&&this.transform.configure(a.transform);a.light&&this.addComponent(new Light(a.light));a.camera&&this.addComponent(new Camera(a.camera));a.model&&this.transform.fromMatrix(a.model);
a.children&&(this.children=a.children);a.extra&&(this.extra=a.extra);a.comments&&(this.comments=a.comments);a.parent&&(this._parent=a.parent);a.components&&this.configureComponents(a);LEvent.trigger(this,"configure",a)};
SceneNode.prototype.serialize=function(){var a={};this.id&&(a.id=this.id);this.className&&(a.className=this.className);this.mesh&&"string"==typeof this.mesh&&(a.mesh=this.mesh);null!=this.submesh_id&&(a.submesh_id=this.submesh_id);this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());this.flags&&(a.flags=cloneObject(this.flags));this.extra&&(a.extra=this.extra);this.comments&&(a.comments=this.comments);this._parent&&(a.parent=this._parent.id);this.serializeComponents(a);
LEvent.trigger(this,"serialize",a);return a};SceneNode.prototype.addChild=function(a,b){a._parent=this;this._children?this._children.push(a):this._children=[a];if(b){var c=a.transform.getGlobalMatrix(),d=this.transform.getGlobalMatrix();mat4.invert(d,d);a.transform.fromMatrix(mat4.multiply(d,d,c))}a.transform._parent=this.transform;LEvent.trigger(this,"nodeAdded",a)};
SceneNode.prototype.removeChild=function(a,b){if(this._children&&a._parent==this&&a._parent==this){var c=this._children.indexOf(a);-1!=c&&(this._children.splice(c,1),b&&(c=a.transform.getGlobalMatrix(),a.transform._parent=null,a.transform.fromMatrix(c)),a.transform._parent=null,LEvent.trigger(this,"nodeRemoved",a))}};SceneNode.prototype.getAllChildNodes=function(a){a=a||[];if(!this._children)return a;for(var b in this._children)a.push(this._children[b]),this._children[b].getAllChildNodes(a);return a};
var Scene=new SceneTree;LS.SceneTree=SceneTree;LS.SceneNode=SceneNode;LS.ResourcesManager=ResourcesManager;LS.Generators=Generators;LS.newMeshNode=function(a,b){var c=new SceneNode(a);c.addComponent(new MeshRenderer);c.setMesh(b);return c};LS.newLightNode=function(a){a=new SceneNode(a);a.addComponent(new Light);return a};LS.newCameraNode=function(a){a=new SceneNode(a);a.addComponent(new Camera);return a};
function Context(a){a=a||{};this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_options={};this.force_redraw=!1;this.interactive=!0;this.gl.ondraw=Context.prototype._ondraw.bind(this);this.gl.onupdate=Context.prototype._onupdate.bind(this);this.gl.onmousedown=Context.prototype._onmouse.bind(this);this.gl.onmousemove=Context.prototype._onmouse.bind(this);this.gl.onmouseup=Context.prototype._onmouse.bind(this);this.gl.onkey=Context.prototype._onkey.bind(this);gl.captureMouse();gl.captureKeys(!0)}
Context.prototype._ondraw=function(){if(this.onPreDraw)this.onPreDraw();if(Scene._must_redraw||this.force_redraw)LEvent.trigger(Scene,"pre_scene_render"),Renderer.render(Scene,Scene.current_camera,this.render_options),LEvent.trigger(Scene,"post_scene_render");if(this.onDraw)this.onDraw()};Context.prototype._onupdate=function(a){if(this.onPreUpdate)this.onPreUpdate(a);Scene.update(a);if(this.onUpdate)this.onUpdate(a)};
Context.prototype._onmouse=function(a){"mousedown"==a.type&&this.interactive&&(this._clicked_node=Renderer.getNodeAtCanvasPosition(Scene,a.mousex,a.mousey));this._clicked_node&&this._clicked_node.interactive&&(a.scene_node=this._clicked_node,LEvent.trigger(Scene,a.type,a),LEvent.trigger(this._clicked_node,a.type,a));"mouseup"==a.type&&(this._clicked_node=null);this.onMouse&&(a.scene_node=this._clicked_node,this.onMouse(a))};
Context.prototype._onkey=function(a){this.onKey&&this.onKey(a)||LEvent.trigger(Scene,a.type,a)};LS.Context=Context;
