function WBin(){}WBin.HEADER_SIZE=64;WBin.FOUR_CC="WBIN";WBin.VERSION=0.2;WBin.CLASSNAME_SIZE=32;WBin.LUMPNAME_SIZE=54;WBin.LUMPHEADER_SIZE=10+WBin.LUMPNAME_SIZE;WBin.CODES={ArrayBuffer:"AB",Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",Int32Array:"I4",Uint32Array:"i4",Float32Array:"F4",Float64Array:"F8",Object:"OB",String:"ST",Number:"NU","null":"00"};WBin.REVERSE_CODES={};for(var i in WBin.CODES)WBin.REVERSE_CODES[WBin.CODES[i]]=i;WBin.FULL_BINARY=1;
WBin.isWBin=function(a){a=a.subarray(0,4);for(var b=0;b<a.length;b++)if(0!=a[b]&&a[b]!=WBin.FOUR_CC.charCodeAt(b))return!1;return!0};
WBin.create=function(a,b){if(!a)throw"WBin null origin passed";var c=new Uint8Array([0,0]),d=new Uint8Array((new Float32Array([WBin.VERSION])).buffer);b=b||"";if(a.toBinary){var e=a.toBinary();if(!e)return null;if(e.constructor==ArrayBuffer){c[0]|=WBin.FULL_BINARY;var f=WBin.getObjectClassName(a),g=new Uint8Array(WBin.HEADER_SIZE+e.length);g.set(WBin.stringToUint8Array(WBin.FOUR_CC));g.set(d,4);g.set(c,8);g.set(WBin.stringToUint8Array(f,WBin.CLASSNAME_SIZE),14);g.set(e,WBin.HEADER_SIZE);return g}a=
e}var h=WBin.HEADER_SIZE,e=[],k=0,n;for(n in a)if(g=a[n],null!=g){f=WBin.getObjectClassName(g);(f=WBin.CODES[f])||(f="OB");"NU"==f?g=g.toString():"OB"==f&&(g=JSON.stringify(g));var p=0;"string"==typeof g&&(g=WBin.stringToUint8Array(g));if(g.buffer&&g.buffer.constructor==ArrayBuffer)g=new Uint8Array(new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength)),p=g.byteLength;else if(g.constructor==ArrayBuffer)p=g.byteLength;else throw"WBin: cannot be anything different to ArrayBuffer";var m=n.substring(0,
WBin.LUMPNAME_SIZE);m.length<n.length&&console.error("Lump name is too long (max is "+WBin.LUMPNAME_SIZE+"), it has been cut down, this could lead to an error in the future");e.push({code:f,name:m,data:g,start:k,size:p});k+=p;h+=WBin.LUMPHEADER_SIZE+p}g=new Uint8Array(h);g.set(WBin.stringToUint8Array(WBin.FOUR_CC));g.set(d,4);g.set(c,8);g.set(new Uint8Array((new Uint16Array([e.length])).buffer),10);b&&g.set(WBin.stringToUint8Array(b,WBin.CLASSNAME_SIZE),12);var c=WBin.HEADER_SIZE+e.length*WBin.LUMPHEADER_SIZE,
d=WBin.HEADER_SIZE,r;for(r in e)n=e[r],h=new Uint8Array(WBin.LUMPHEADER_SIZE),h.set(new Uint8Array((new Uint32Array([n.start])).buffer),0),h.set(new Uint8Array((new Uint32Array([n.size])).buffer),4),h.set(WBin.stringToUint8Array(n.code,2),8),h.set(WBin.stringToUint8Array(n.name,WBin.LUMPNAME_SIZE),10),g.set(h,d),d+=WBin.LUMPHEADER_SIZE,h=new Uint8Array(n.data),g.set(h,c+n.start);return g};
WBin.load=function(a,b){a=new Uint8Array(a);var c=WBin.getHeaderInfo(a);if(!c)return console.error("Wrong WBin"),null;c.version>(new Float32Array([WBin.VERSION]))[0]&&console.log("ALERT: WBin version is higher that code version");var d={},e;for(e in c.lumps){var f=c.lumps[e],g=c.lump_data.subarray(f.start,f.start+f.size);if(f.size!=g.length)throw"WBin: incorrect wbin lump size";var h=null,k=WBin.REVERSE_CODES[f.code];if(!k)throw"WBin: Incorrect data code";switch(k){case "null":break;case "String":h=
WBin.Uint8ArrayToString(g);break;case "Number":h=parseFloat(WBin.Uint8ArrayToString(g));break;case "Object":h=JSON.parse(WBin.Uint8ArrayToString(g));break;case "ArrayBuffer":h=(new Uint8Array(g)).buffer;break;default:g=new Uint8Array(g);h=window[k];if(!h)throw"ctor not found in WBin: "+k;if(0!=g.length/h.BYTES_PER_ELEMENT%1)throw"WBin: size do not match type";h=new h(g.buffer)}d[f.name]=h}if(!b&&c.classname){if((h=window[c.classname])&&h.fromBinary)return h.fromBinary(d);if(h&&h.prototype.fromBinary)return c=
new h,c.fromBinary(d),c;d["@classname"]=c.classname}return d};
WBin.getHeaderInfo=function(a){for(var b=a.subarray(0,4),c=0;c<b.length;c++)if(0!=b[c]&&b[c]!=WBin.FOUR_CC.charCodeAt(c))return null;for(var b=WBin.readFloat32(a,4),d=new Uint8Array(a.subarray(8,10)),e=WBin.readUint16(a,10),f=WBin.Uint8ArrayToString(a.subarray(12,12+WBin.CLASSNAME_SIZE)),g=[],c=0;c<e;++c){var h=WBin.HEADER_SIZE+c*WBin.LUMPHEADER_SIZE,h=a.subarray(h,h+WBin.LUMPHEADER_SIZE),k={};k.start=WBin.readUint32(h,0);k.size=WBin.readUint32(h,4);k.code=WBin.Uint8ArrayToString(h.subarray(8,10));
k.name=WBin.Uint8ArrayToString(h.subarray(10));g.push(k)}a=a.subarray(WBin.HEADER_SIZE+e*WBin.LUMPHEADER_SIZE);return{version:b,flags:d,classname:f,numlumps:e,lumps:g,lump_data:a}};WBin.getObjectClassName=function(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]};WBin.stringToUint8Array=function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c};
WBin.Uint8ArrayToString=function(a,b){for(var c="",d=0;d<a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c};WBin.readUint16=function(a,b){var c=new Uint16Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+2));return c[0]};WBin.readUint32=function(a,b){var c=new Uint32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4));return c[0]};WBin.readFloat32=function(a,b){var c=new Float32Array(1);(new Uint8Array(c.buffer)).set(a.subarray(b,b+4));return c[0]};
var Draw={ready:!1,images:{},onRequestFrame:null,init:function(){!this.ready&&gl&&(this.color=new Float32Array(4),this.color[3]=1,this.mvp_matrix=mat4.create(),this.temp_matrix=mat4.create(),this.point_size=2,this.stack=new Float32Array(512),this.model_matrix=new Float32Array(this.stack.buffer,0,64),mat4.identity(this.model_matrix),this.camera=null,this.camera_position=vec3.create(),this.view_matrix=mat4.create(),this.projection_matrix=mat4.create(),this.viewprojection_matrix=mat4.create(),this.camera_stack=
[],this.shader=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\t\t\t  gl_FragColor = u_color;\n\t\t\t}\t\t"),this.shader_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\t\t\t  gl_FragColor = u_color * v_color;\n\t\t\t}\t\t"),this.shader_texture=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, v_coord);\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t"),this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]}),this.ready=!0)},setColor:function(a){for(var b=0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=
a},setLineWidth:function(a){gl.lineWidth(a)},setPointSize:function(a){this.point_size=a},setCamera:function(a){this.camera=a;vec3.copy(this.camera_position,a.getEye());mat4.copy(this.view_matrix,a._view_matrix);mat4.copy(this.projection_matrix,a._projection_matrix);mat4.copy(this.viewprojection_matrix,a._viewprojection_matrix)},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},setViewProjectionMatrix:function(a,b,c){mat4.copy(this.view_matrix,a);mat4.copy(this.projection_matrix,b);
c?mat4.copy(this.viewprojection_matrix,c):mat4.multiply(this.viewprojection_matrix,a,c)},setMatrix:function(a){mat4.copy(this.model_matrix,a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b){if(a&&a.length){var c=null,c=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=c.length/3&&(b=null);c=GL.Mesh.load({vertices:c,colors:b});return this.renderMesh(c,gl.LINES,b?this.shader_color:
this.shader)}},renderPoints:function(a,b){if(a&&a.length){var c=null,c=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));c=GL.Mesh.load({vertices:c,colors:b});return this.renderMesh(c,gl.POINTS,b?this.shader_color:this.shader)}},renderRectangle:function(a,b,c){var d=new Float32Array(12);c?d.set([0.5*-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):d.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);a=GL.Mesh.load({vertices:d});
return this.renderMesh(a,gl.LINE_LOOP)},renderCircle:function(a,b,c){var d=[0,1,0];b=b||100;for(var e=quat.create(),f=vec3.create(),g=new Float32Array(3*b),h=0;h<b;h++)quat.setAxisAngle(e,d,h/b*Math.PI*2),vec3.transformQuat(f,[0,0,a],e),c||vec3.set(f,f[0],f[2],f[1]),g.set(f,3*h);a=GL.Mesh.load({vertices:g});return this.renderMesh(a,gl.LINE_LOOP)},renderWireSphere:function(a,b){b=b||100;quat.create();for(var c=vec3.create(),d=new Float32Array(18*b),e=1/b*Math.PI*2,f=0;f<b;f++)c.set([Math.sin(f*e)*
a,Math.cos(f*e)*a,0]),d.set(c,18*f),c.set([Math.sin((f+1)*e)*a,Math.cos((f+1)*e)*a,0]),d.set(c,18*f+3),c.set([Math.sin(f*e)*a,0,Math.cos(f*e)*a]),d.set(c,18*f+6),c.set([Math.sin((f+1)*e)*a,0,Math.cos((f+1)*e)*a]),d.set(c,18*f+9),c.set([0,Math.sin(f*e)*a,Math.cos(f*e)*a]),d.set(c,18*f+12),c.set([0,Math.sin((f+1)*e)*a,Math.cos((f+1)*e)*a]),d.set(c,18*f+15);c=GL.Mesh.load({vertices:d});return this.renderMesh(c,gl.LINES)},renderWireBox:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=new Float32Array([-a,b,c,-a,
b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);a=GL.Mesh.load({vertices:a,lines:b});return this.renderMesh(a,gl.LINES)},renderSolidBox:function(a,b,c){a*=0.5;b*=0.5;c*=0.5;a=GL.Mesh.load({vertices:[[-a,b,-c],[-a,-b,+c],[-a,b,c],[-a,b,-c],[-a,-b,-c],[-a,-b,+c],[a,b,-c],[a,b,c],[a,-b,+c],[a,b,-c],[a,-b,+c],[a,-b,-c],[-a,b,c],[a,-b,c],[a,b,c],[-a,b,c],[-a,-b,c],[a,-b,c],[-a,b,-c],[a,b,-c],[a,-b,-c],[-a,b,-c],[a,-b,-c],[-a,-b,-c],
[-a,b,-c],[a,b,c],[a,b,-c],[-a,b,-c],[-a,b,c],[a,b,c],[-a,-b,-c],[a,-b,-c],[a,-b,c],[-a,-b,-c],[a,-b,c],[-a,-b,c]]});return this.renderMesh(a,gl.TRIANGLES)},renderPlane:function(a,b,c){this.push();this.translate(a);this.scale(b[0],b[1],1);c?(c.bind(0),this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture)):this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN);this.pop()},renderGrid:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),d=0,e=-b;e<=b;e++)c.set([e*a,0,a*b],d),c.set([e*
a,0,-a*b],d+3),c.set([a*b,0,e*a],d+6),c.set([-a*b,0,e*a],d+9),d+=12;c=GL.Mesh.load({vertices:c});return this.renderMesh(c,gl.LINES)},renderCone:function(a,b,c,d){var e=[0,1,0];c=c||100;var f=quat.create(),g=vec3.create(),h=new Float32Array(3*(c+2));h.set(d?[0,0,b]:[0,b,0],0);for(b=0;b<=c;b++)quat.setAxisAngle(f,e,b/c*Math.PI*2),vec3.transformQuat(g,[0,0,a],f),d&&vec3.set(g,g[0],g[2],g[1]),h.set(g,3*b+3);a=GL.Mesh.load({vertices:h});return this.renderMesh(a,gl.TRIANGLE_FAN)},renderCylinder:function(a,
b,c,d){d=[0,1,0];c=c||100;for(var e=quat.create(),f=vec3.create(),g=new Float32Array(6*(c+1)),h=0;h<=c;h++)quat.setAxisAngle(e,d,h/c*Math.PI*2),vec3.transformQuat(f,[0,0,a],e),g.set(f,6*h+3),f[1]=b,g.set(f,6*h);a=GL.Mesh.load({vertices:g});return this.renderMesh(a,gl.TRIANGLE_STRIP)},renderImage:function(a,b,c){c=c||10;var d=null;if("string"==typeof b){d=this.images[b];if(null==d){Draw.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);Draw.images[b]=a;if(Draw.onRequestFrame)Draw.onRequestFrame()};
return}if(1==d)return}else b.constructor==Texture&&(d=b);d&&(this.push(),this.billboard(a),this.scale(c,c,c),d.bind(0),this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture),this.pop())},renderMesh:function(a,b,c){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";c=c||this.shader;mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,this.model_matrix);c.uniforms({u_mvp:this.mvp_matrix,u_color:this.color,u_point_size:this.point_size,u_texture:0}).draw(a,void 0==b?gl.LINES:
b);return this.last_mesh=a},renderText:function(a){Draw.font_atlas||this.createFontAtlas();for(var b=this.font_atlas,c=a.length,d=b.atlas.char_size,e=b.atlas.spacing,f=0,g=0;g<c;++g)null!=b.atlas[a.charCodeAt(g)]&&f++;for(var h=new Float32Array(18*f),f=new Float32Array(12*f),k=0,n=0,g=y=0;g<c;++g){var p=b.atlas[a.charCodeAt(g)];p?(h.set([n,y,0],18*k),h.set([n,y+d,0],18*k+3),h.set([n+d,y+d,0],18*k+6),h.set([n+d,y,0],18*k+9),h.set([n,y,0],18*k+12),h.set([n+d,y+d,0],18*k+15),f.set([p[0],p[1]],12*k),
f.set([p[0],p[3]],12*k+2),f.set([p[2],p[3]],12*k+4),f.set([p[2],p[1]],12*k+6),f.set([p[0],p[1]],12*k+8),f.set([p[2],p[3]],12*k+10),n+=e,++k):10==a.charCodeAt(g)?(n=0,y-=d):n+=d}a=GL.Mesh.load({vertices:h,coords:f});b.bind(0);return this.renderMesh(a,gl.TRIANGLES,this.shader_texture)},createFontAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,d=a.getContext("2d");d.fillStyle="white";d.font=b+"px Courier New";d.textAlign="center";for(var e=0,f=0,b=-0.3*b,g={char_size:c,
spacing:0.6*c},h=6;100>h;h++){var k=String.fromCharCode(h+27);g[h+27]=[e/a.width,1-(f+c)/a.height,(e+c)/a.width,1-f/a.height];d.fillText(k,Math.floor(e+0.5*c),Math.floor(f+c+b),c);e+=c;e+c>a.width&&(e=0,f+=c)}this.font_atlas=GL.Texture.fromImage(a,{magFilter:gl.NEAREST,minFilter:gl.LINEAR});this.font_atlas.atlas=g},linearize:function(a){for(var b=a[0].length,c=new Float32Array(a.length*b),d=a.length,e=0;e<d;++e)c.set(a[e],e*b);return c},push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-
64)throw"matrices stack overflow";var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset+64,64);mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-64,64)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},popCamera:function(){if(0==this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},
identity:function(){mat4.identity(this.model_matrix)},scale:function(a,b,c){3==arguments.length?mat4.scale(this.model_matrix,this.model_matrix,[a,b,c]):mat4.scale(this.model_matrix,this.model_matrix,a)},translate:function(a,b,c){3==arguments.length?mat4.translate(this.model_matrix,this.model_matrix,[a,b,c]):mat4.translate(this.model_matrix,this.model_matrix,a)},rotate:function(a,b,c,d){4==arguments.length?mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,d]):mat4.rotate(this.model_matrix,
this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},billboard:function(a){mat4.invert(this.model_matrix,this.view_matrix);mat4.setTranslation(this.model_matrix,a)},fromTranslationFrontTop:function(a,b,c){mat4.fromTranslationFrontTop(this.model_matrix,a,b,c)},project:function(a,b){b=b||vec3.create();return mat4.multiplyVec3(b,this.mvp_matrix,a)}},Shaders={compiled_shaders:{},global_shaders:{},default_shader:null,
on_compile_error:null,init:function(a,b){this.default_shader=null;this.compiled_shaders={};this.global_shaders={};this.global_extra_code=String.fromCharCode(10)+"#define WEBGL"+String.fromCharCode(10);this.createDefaultShaders();this.default_shader=this.get("flat");this.last_shaders_url=a=a||"data/shaders.xml";this.loadFromXML(a,!1,b)},reloadShaders:function(a){this.loadFromXML(this.last_shaders_url,!0,!0,a)},get:function(a,b){if(!a)return null;if(!b){var c=this.compiled_shaders[a];if(null!=c)return c}var d=
this.global_shaders[a];if(null==d)return this.default_shader;var c=a,e="";if(0!=d.num_macros)for(var f in b)d.macros[f]&&(c+=f+"="+b[f]+":",e+=String.fromCharCode(10)+"#define "+f+" "+b[f]+String.fromCharCode(10));f=c.hashCode();if(null!=this.compiled_shaders[f])return this.compiled_shaders[f];if(c=this.compileShader(e+d.vs_code,e+d.ps_code,c))c.global=d;return this.registerCompiledShader(c,f,a)},getGlobalShaderInfo:function(a){return this.global_shaders[a]},compileShader:function(a,b,c){if(!gl)return null;
var d=null;try{d=new GL.Shader(this.global_extra_code+a,this.global_extra_code+b),d.name=c}catch(e){console.log("Error compiling shader: "+c);console.log(e);console.log("VS CODE\n************");a=(this.global_extra_code+a).split("\n");for(var f in a)console.log(f+": "+a[f]);console.log("PS CODE\n************");a=(this.global_extra_code+b).split("\n");for(f in a)console.log(f+": "+a[f]);if(this.on_compile_error)this.on_compile_error(e);return null}return d},registerCompiledShader:function(a,b,c){if(null==
a)return this.compiled_shaders[b]=this.default_shader;a.id=c;a.key=b;return this.compiled_shaders[b]=a},loadFromXML:function(a,b,c,d){c=c?"?nocache="+window.performance.now()+Math.floor(1E3*Math.random()):"";LS.request({url:a+c,dataType:"xml",success:function(c){console.log("Shaders XML loaded: "+a);b&&(Shaders.global_shaders={},Shaders.compiled_shaders={});Shaders.processShadersXML(c);d&&d()},error:function(a){console.log("Error parsing Shaders XML: "+a);throw"Error parsing Shaders XML: "+a;}})},
processShadersXML:function(a){a=a.querySelectorAll("shader");for(var b in a){var c=a[b];if(c&&c.attributes){var d=c.attributes.id;if(d){var d=d.value,e="",f="";(e=c.attributes.macros)&&(e=e.value.split(","));var g={};for(b in e)g[e[b]]=!0;e=c.querySelector("code[type='vertex_shader']").textContent;f=c.querySelector("code[type='pixel_shader']").textContent;e&&f?(c=(c=c.attributes.multipass)?"1"==c.value||"true"==c.value:!1,Shaders.registerGlobalShader(e,f,d,g,c)):console.log("no code in shader: "+
d)}}}},registerGlobalShader:function(a,b,c,d,e){var f=0,g;for(g in d)f+=1;a={vs_code:a,ps_code:b,macros:d,num_macros:f,macros_found:{},multipass:e};this.global_shaders[c]=a;LEvent.trigger(Shaders,"newShader");return a},common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_mvp;\n\t",common_pscode:"\n\t\tprecision mediump float;\n\t",createDefaultShaders:function(){this.registerGlobalShader(this.common_vscode+
"\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t  gl_FragColor = vec4(u_material_color);\t\t\t}\t\t","flat");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 v_uvs;\t\t\tvoid main() {\n\t\t\t\tv_uvs = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",this.common_pscode+"\t\t\tuniform vec4 u_material_color;\t\t\tvarying vec2 v_uvs;\t\t\tuniform sampler2D texture;\t\t\tvoid main() {\t\t\t\tgl_FragColor = u_material_color * texture2D(texture,v_uvs);\t\t\t}\t\t",
"texture_flat");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tcoord = a_coord;\t\t\tgl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\t\t}\t\t",this.common_pscode+"\t\t\tuniform sampler2D texture;\t\t\tuniform vec4 color;\t\t\tvarying vec2 coord;\t\t\tvoid main() {\t\t\tgl_FragColor = texture2D(texture, coord) * color;\t\t\t}\t\t","screen");this.registerGlobalShader(this.common_vscode+"\t\t\tvarying vec4 v_pos;\t\t\tvoid main() {\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\tv_pos = gl_Position;\t\t\t}\t\t\t",
this.common_pscode+"\t\t\tprecision highp float;\t\t\tvarying vec4 v_pos;\t\t\tvec3 PackDepth24(float depth)\t\t\t{\t\t\t\tfloat depthInteger = floor(depth);\t\t\t\tfloat depthFraction = fract(depth);\t\t\t\tfloat depthUpper = floor(depthInteger / 256.0);\t\t\t\tfloat depthLower = depthInteger - (depthUpper * 256.0);\t\t\t\treturn vec3(depthUpper / 256.0, depthLower / 256.0, depthFraction);\t\t\t}\t\t\t\t\t\tuniform vec4 u_material_color;\t\t\tvoid main() {\t\t\t\tvec4 color = vec4(0.0);\t\t\t\tcolor.x = u_material_color.x; \t\t\t\tfloat depth = v_pos.z / v_pos.w;\t\t\t    color.yzw = PackDepth24(depth*256.0);\t\t\t  gl_FragColor = color;\t\t\t}\t\t",
"picking_depth")}};String.prototype.hashCode=function(){var a=0,b,c;if(0==this.length)return a;b=0;for(l=this.length;b<l;++b)c=this.charCodeAt(b),a=(a<<5)-a+c,a|=0;return a};function LScript(){this.code="function update(dt) {\n\n}";this.valid_callbacks=["start","update"];this.extracode="";this.catch_exceptions=!0}
LScript.prototype.compile=function(a){var b=[],c=[];if(a)for(var d in a)b.push(d),c.push(a[d]);b=b.join(",");a=this.code;a="var _myclass = function _LScript("+b+") {\n"+this.extracode+"\n"+a+"\n";b="";for(d in this.valid_callbacks)b+="\tif(typeof("+this.valid_callbacks[d]+") != 'undefined') this."+this.valid_callbacks[d]+" = "+this.valid_callbacks[d]+";\n";this._last_executed_code=a+=b+"\n}\n; _myclass;";try{this._class=eval(a),this._context=LScript.applyToConstructor(this._class,c)}catch(e){this._context=
this._class=null;console.error("Error in script\n"+e);console.error(this._last_executed_code);if(this.onerror)this.onerror(e);return!1}return!0};LScript.prototype.hasMethod=function(a){return this._context&&this._context[a]&&"function"==typeof this._context[a]?!0:!1};
LScript.prototype.callMethod=function(a,b){if(this._context&&this._context[a]){if(!this.catch_exceptions)return this._context[a].apply(this._context,b);try{return this._context[a].apply(this._context,b)}catch(c){if(console.error("Error in function\n"+c),this.onerror)this.onerror(c)}}};LScript.applyToConstructor=function(a,b){var c=[null].concat(b);return new (a.bind.apply(a,c))};var trace=window.console?console.log.bind(console):function(){};function toArray(a){return Array.apply([],a)}
Object.defineProperty(Object.prototype,"merge",{value:function(a){for(var b in a)this[b]=a[b]},configurable:!0,writable:!1,enumerable:!1});
var LS={_last_uid:0,generateUId:function(){return this._last_uid++},Components:{},registerComponent:function(a){for(var b in arguments)this.Components[getClassName(arguments[b])]=arguments[b],a.prototype.serialize||(a.prototype.serialize=LS._serialize),a.prototype.configure||(a.prototype.configure=LS._configure),LEvent.trigger(LS,"component_registered",arguments[b])},MaterialClasses:{},registerMaterialClass:function(a){this.MaterialClasses[getClassName(a)]=a;LEvent.trigger(LS,"materialclass_registered",
a);a.resource_type="Material"},_configure:function(a){LS.cloneObject(a,this)},_serialize:function(){return LS.cloneObject(this)},request:function(a){if("string"===typeof a)throw"LS.request expects object, not string. Use LS.get or LS.getJSON";var b=a.dataType||"text";if("json"==b)b="text";else if("xml"==b)b="text";else if("binary"==b)b="arraybuffer",a.mimeType="application/octet-stream";else if("image"==b)return b=new Image,b.onload=function(){a.success&&a.success.call(this)},b.onerror=a.error,b.src=
a.url,b;var c=new XMLHttpRequest;c.open(a.data?"POST":"GET",a.url,!0);b&&(c.responseType=b);a.mimeType&&c.overrideMimeType(a.mimeType);c.onload=function(b){b=this.response;if(200!=this.status)b="Error "+this.status,a.error&&a.error(b);else{if("json"==a.dataType)try{b=JSON.parse(b)}catch(e){a.error&&a.error(e)}else if("xml"==a.dataType)try{b=(new DOMParser).parseFromString(b,"text/xml")}catch(f){a.error&&a.error(f)}a.success&&a.success.call(this,b);LEvent.trigger(c,"done",b)}};c.onerror=function(b){a.error&&
a.error(b);LEvent.trigger(this,"fail",b)};c.send(a.data);return c},get:function(a,b){return LS.request({url:a,data:b})},getJSON:function(a,b){return LS.request({url:a,data:b,dataType:"json"})}};XMLHttpRequest.prototype.done=function(a){LEvent.bind(this,"done",function(b,c){a(c)});return this};XMLHttpRequest.prototype.fail=function(a){LEvent.bind(this,"fail",function(b,c){a(c)});return this};
function extendClass(a,b){for(var c in a)b[c]=a[c];if(a.prototype)for(c in a.prototype)a.prototype.hasOwnProperty(c)&&!b.prototype.hasOwnProperty(c)&&(a.prototype.__lookupGetter__(c)?b.prototype.__defineGetter__(c,a.prototype.__lookupGetter__(c)):b.prototype[c]=a.prototype[c],a.prototype.__lookupSetter__(c)&&b.prototype.__defineSetter__(c,a.prototype.__lookupSetter__(c)))}LS.extendClass=extendClass;
function cloneObject(a,b){var c=b||{},d;for(d in a)if("_"!=d[0]&&"jQuery"!=d.substr(0,6)){var e=a[d];null==e?c[d]=null:isFunction(e)||("number"==typeof e||"string"==typeof e?c[d]=e:e.constructor==Float32Array?c[d]=Array.apply([],e):isArray(e)?c[d]&&c[d].constructor==Float32Array?c[d].set(e):c[d]=JSON.parse(JSON.stringify(e)):c[d]=JSON.parse(JSON.stringify(e)))}return c}LS.cloneObject=cloneObject;
function getObjectClassName(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}LS.getObjectClassName=getObjectClassName;function getClassName(a){if(a&&a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}LS.getClassName=getClassName;
function getObjectAttributes(a){if(a.getAttributes)return a.getAttributes();var b=a.constructor;if(b.attributes)return b.attributes;var c={},d;for(d in a)if("_"!=d[0]&&"jQuery"!=d.substr(0,6)){if(b!=Object){var e=b["@"+d];if(e&&e.type){c[d]=e.type;continue}}e=a[d];null==e?c[d]=null:isFunction(e)||(c[d]=e.constructor===Number?"number":e.constructor===String?"string":e.buffer&&e.buffer.constructor===ArrayBuffer?2==e.length?"vec2":3==e.length?"vec3":4==e.length?"vec4":9==e.length?"mat3":16==e.length?
"mat4":"*":"*")}return c}LS.getObjectAttributes=getObjectAttributes;var Generators={generators:{},addGenerator:function(a,b){this.generators[a]=b},executeGenerator:function(a){var b=this.generators[a.action];if(!b||"function"!=typeof b)return null;try{var c=b(a);c.generator=b;return c}catch(d){trace("Error in generator: "+d)}return null}};LS.Generators=Generators;
LS.getCurveValueAt=function(a,b,c,d,e){if(e<b||e>c)return d;b=[b,d];for(var f=0,f=0;f<a.length;f+=1){var g=a[f];if(e==g[0])return g[1];if(e<g[0])return f=(e-b[0])/(g[0]-b[0]),b[1]*(1-f)+g[1]*f;b=g}g=[c,d];f=(e-b[0])/(g[0]-b[0]);return b[1]*(1-f)+g[1]*f};LS.resampleCurve=function(a,b,c,d,e){var f=[];f.length=e;for(var g=(c-b)/e,h=0;h<e;h++)f[h]=LS.getCurveValueAt(a,b,c,d,b+g*h);return f};
var ResourcesManager={path:"",ignore_cache:!1,free_data:!1,keep_files:!1,resources:{},meshes:{},textures:{},materials:{},resources_being_loaded:{},resources_being_processes:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,formats:{js:"text",json:"json",xml:"xml"},formats_resource:{},resource_pre_callbacks:{},resource_post_callbacks:{},getNoCache:function(a){return this.ignore_cache||a?"?nocache="+window.performance.now()+Math.floor(1E3*Math.random()):""},reset:function(){this.resources={};this.meshes=
{};this.textures={}},registerFileFormat:function(a,b){this.formats[a.toLowerCase()]=b},registerResourcePreProcessor:function(a,b,c,d){a=a.split(",");for(var e in a){var f=a[e].toLowerCase();this.resource_pre_callbacks[f]=b;c&&(this.formats[f]=c);d&&(this.formats_resource[f]=d)}},registerResourcePostProcessor:function(a,b){this.resource_post_callbacks[a]=b},getExtension:function(a){var b=a.indexOf("?");-1!=b&&(a=a.substr(0,b));b=a.lastIndexOf(".");return-1==b?"":a.substr(b+1).toLowerCase()},getFilename:function(a){var b=
a.lastIndexOf("/"),c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c)},getBasename:function(a){a=this.getFilename(a);var b=a.indexOf(".");return-1==b?a:a.substr(0,b)},loadResources:function(a,b){for(var c in a)"string"==typeof c&&":"!=c[0]&&this.load(c,b)},load:function(a,b,c){b=b||{};if(null!=this.resources[a])return c&&c(this.resources[a]),!0;var d=this.getExtension(a);if(!d)return!1;if(null!=this.resources_being_loaded[a])this.resources_being_loaded[a].push({options:b,callback:c});
else if(!this.resources_being_processes[a]){this.resources_being_loaded[a]=[{options:b,callback:c}];0==this.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"start_loading_resources",a);this.num_resources_being_loaded++;c="";c="http://"==a.substr(0,7)?a:b.local_repository?b.local_repository+"/"+a:this.path+a;b.force_local_url&&(c=a);var e=this.getNoCache();c={url:c+e,success:function(c){ResourcesManager.processResource(a,c,b,ResourcesManager._resourceLoadedSuccess)},error:function(b){ResourcesManager._resourceLoadedError(a,
b)}};if(d=this.formats[d])c.dataType=d;LS.request(c);return!1}},processResource:function(a,b,c,d){function e(e,f){f.filename=e;c.filename&&(f.filename=c.filename);f.fullpath||(f.fullpath=a);LS.ResourcesManager.resources_being_processes[e]&&delete LS.ResourcesManager.resources_being_processes[e];!LS.ResourcesManager.keep_files||b.constructor!=ArrayBuffer&&b.constructor!=String||(f._original_data=b);f.getResources&&ResourcesManager.loadResources(f.getResources({}));LS.ResourcesManager.registerResource(a,
f);d&&d(a,f,c)}c=c||{};if(!b)throw"No data found when processing resource: "+a;var f=null,f=this.getExtension(a);this.resources_being_processes[a]=!0;if(!f){"string"==typeof b&&(b=JSON.parse(b));if(b.constructor==ArrayBuffer){f=WBin.load(b);e(a,f);return}var g=b.object_type;if(g&&window[g]){var h=window[g],f=null;h.prototype.configure?(f=new window[g],f.configure(b)):f=new window[g](b);e(a,f);return}return!1}g=this.resource_pre_callbacks[f.toLowerCase()];if(!g)return console.log("Resource format unknown: "+
f),!1;(f=g(a,b,c,e))&&e(a,f)},registerResource:function(a,b){b.object_type||(b.object_type=LS.getObjectClassName(b));var c=b.object_type;b.constructor.resource_type&&(c=b.constructor.resource_type);(c=this.resource_post_callbacks[c])&&c(a,b);this.resources[a]=b;LEvent.trigger(this,"resource_registered",b);Scene.refresh()},computeResourceInternalData:function(a){if(!a)throw"Resource is null";var b=null,c="text",d="";a._original_file?(b=a._original_file,c="file"):a._original_data?b=a._original_data:
a.toBinary?(b=a.toBinary(),c="binary",d="wbin"):a.toBlob?(b=a.toBlob(),c="file"):a.toBase64?(b=a.toBase64(),c="base64"):b=a.serialize?JSON.stringify(a.serialize()):a.data?a.data:JSON.stringify(a);b.buffer&&b.buffer.constructor==ArrayBuffer&&(b=b.buffer);return{data:b,encoding:c,extension:d}},renameResource:function(a,b){var c=this.resources[a];c&&(c.filename=b,c.fullpath=b,this.resources[b]=c,delete this.resources[a],this.meshes[a]&&(delete this.meshes[a],this.meshes[b]=c),this.textures[a]&&(delete this.textures[a],
this.textures[b]=c))},isLoading:function(){return 0<this.num_resources_being_loaded},processScene:function(a,b,c){a=Parser.parse(a,b,c);if(a.meshes)for(var d in a.meshes)b=GL.Mesh.load(a.meshes[d]),ResourcesManager.registerResource(d,b);d=new LS.SceneTree;d.configure(a);d.loadResources();return d},computeImageMetadata:function(a){return{width:a.width,height:a.height}},getMesh:function(a){return null!=a?this.meshes[a]:null},getTexture:function(a){return null!=a?this.textures[a]:null},_resourceLoadedSuccess:function(a,
b){LS.ResourcesManager.debug&&console.log("RES: "+a+" ---\x3e "+ResourcesManager.num_resources_being_loaded);for(var c in ResourcesManager.resources_being_loaded[a])null!=ResourcesManager.resources_being_loaded[a][c].callback&&ResourcesManager.resources_being_loaded[a][c].callback(b);ResourcesManager.resources_being_loaded[a]&&(delete ResourcesManager.resources_being_loaded[a],ResourcesManager.num_resources_being_loaded--,0==ResourcesManager.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,
"end_loading_resources"))},_resourceLoadedError:function(a,b){console.log("Error loading "+a);delete ResourcesManager.resources_being_loaded[a];LEvent.trigger(ResourcesManager,"resource_not_found",a);ResourcesManager.num_resources_being_loaded--;0==ResourcesManager.num_resources_being_loaded&&LEvent.trigger(ResourcesManager,"end_loading_resources")},require:function(a,b){function c(a){for(var b=a.shift(1);ResourcesManager._required_files[b]&&b;)b=a.shift(1);ResourcesManager._required_files[b]=!0;
LS.request({url:b,success:function(d){eval(d);if(ResourcesManager._waiting_callbacks[b])for(var h in ResourcesManager._waiting_callbacks[b])ResourcesManager._waiting_callbacks[b][h]();c(a)}})}"string"==typeof a&&(a=[a]);var d=a[a.length-1];b&&(ResourcesManager._waiting_callbacks[d]?ResourcesManager._waiting_callbacks[d].push(b):ResourcesManager._waiting_callbacks[d]=[b]);c(a)},_required_files:{},_waiting_callbacks:{}};LS.ResourcesManager=ResourcesManager;LS.RM=ResourcesManager;LS.getTexture=function(a){return LS.ResourcesManager.getTexture(a)};
LS.ResourcesManager.registerResourcePostProcessor("Mesh",function(a,b){b.object_type="Mesh";b.metadata&&(b.metadata={},b.generateMetadata());b.bounding&&b.bounding.length==BBox.data_length||(b.bounding=null,b.updateBounding());b.getBuffer("normals")||b.computeNormals();LS.ResourcesManager.free_data&&b.freeData();LS.ResourcesManager.meshes[a]=b});LS.ResourcesManager.registerResourcePostProcessor("Texture",function(a,b){LS.ResourcesManager.textures[a]=b});
LS.ResourcesManager.registerResourcePostProcessor("Material",function(a,b){LS.ResourcesManager.materials[a]=b});LS.ResourcesManager.registerResourcePreProcessor("wbin",function(a,b,c){return b=new WBin.load(b)},"binary");LS.ResourcesManager.registerResourcePreProcessor("json",function(a,b,c){a=b;"object"==typeof b&&b.object_type&&window[b.object_type]&&(a=window[b.object_type],a.prototype.configure?(a=new a,a.configure(b)):a=new a(b));return a});
LS.ResourcesManager.processImage=function(a,b,c){if(b.width==b.height/6)c=Texture.cubemapFromImage(b,{wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR}),c.img=b,console.log("Cubemap created");else{c=gl.LINEAR;var d=gl.REPEAT,e=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||(e=gl.LINEAR,d=gl.CLAMP_TO_EDGE);c=b.pixels?GL.Texture.fromMemory(b.width,b.height,b.pixels,{format:24==b.bpp?gl.RGB:gl.RGBA,flipY:b.flipY,wrapS:gl.REPEAT,wrapT:gl.REPEAT,
magFilter:c,minFilter:e}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:d,wrapT:d,magFilter:c,minFilter:e,flipY:b.flipY});c.img=b}c.filename=a;c.generateMetadata();return c};
LS.ResourcesManager.registerResourcePreProcessor("jpg,jpeg,png,webp",function(a,b,c,d){var e=LS.ResourcesManager.getExtension(a),f="image/png";if("jpg"==e||"jpeg"==e)f="image/jpg";"webp"==e&&(f="image/webp");var e=new Blob([b],{type:f}),g=URL.createObjectURL(e),e=new Image;e.src=g;e.real_filename=a;e.onload=function(){var a=this.real_filename,e=LS.ResourcesManager.processImage(a,this,c);e&&(LS.ResourcesManager.registerResource(a,e),LS.ResourcesManager.keep_files&&(e._original_data=b));URL.revokeObjectURL(g);
e&&d&&d(a,e,c)}},"binary","Texture");LS.ResourcesManager.registerResourcePreProcessor("dds,tga",function(a,b,c){b=(new Uint8Array(b)).buffer;c=Parser.parse(a,b,c);return c.constructor==Texture?(c.filename=a,c):c=LS.ResourcesManager.processImage(a,c)},"binary","Texture");LS.ResourcesManager.processASCIIMesh=function(a,b,c){b=Parser.parse(a,b,c);return null==b?(console.error("Error parsing mesh: "+a),null):GL.Mesh.load(b)};
LS.ResourcesManager.registerResourcePreProcessor("obj",LS.ResourcesManager.processASCIIMesh,"text","Mesh");LS.ResourcesManager.processASCIIScene=function(a,b,c){b=Parser.parse(a,b,c);if(null==b)return console.error("Error parsing mesh: "+a),null;for(var d in b.resources)LS.ResourcesManager.processResource(d,b.resources[d]);a=new LS.SceneNode;a.configure(b.root);Scene.root.addChild(a);return a};LS.ResourcesManager.registerResourcePreProcessor("dae",LS.ResourcesManager.processASCIIScene,"text","Scene");
Mesh.fromBinary=function(a){var b=null,b=a.constructor==ArrayBuffer?WBin.load(a):a;a={};for(var c in b.vertex_buffers)a[b.vertex_buffers[c]]=b[b.vertex_buffers[c]];var d={};for(c in b.index_buffers)d[b.index_buffers[c]]=b[b.index_buffers[c]];c=new GL.Mesh(a,d);c.info=b.info;c.bounding=b.bounding;return c};
Mesh.prototype.toBinary=function(){this.info||(this.info={});var a={object_type:"Mesh",info:this.info,groups:this.groups};this.bounding||this.updateBounding();a.bounding=this.bounding;var b=[],c=[],d;for(d in this.vertexBuffers){var e=this.vertexBuffers[d];a[e.name]=e.data;b.push(e.name);"vertices"==e.name&&(a.info.num_vertices=e.data.length/3)}for(d in this.indexBuffers)e=this.indexBuffers[d],a[d]=e.data,c.push(d);a.vertex_buffers=b;a.index_buffers=c;return WBin.create(a,"Mesh")};
function Material(a){this._uid=LS.generateUId();this._dirty=!0;this.color=new Float32Array([1,1,1]);this.opacity=1;this.ambient=new Float32Array([1,1,1]);this.diffuse=new Float32Array([1,1,1]);this.emissive=new Float32Array([0,0,0]);this.backlight_factor=0;this.specular_factor=0.1;this.specular_gloss=10;this.specular_ontop=!1;this.reflection_factor=0;this.reflection_fresnel=1;this.reflection_specular=this.reflection_additive=!1;this.velvet=new Float32Array([0.5,0.5,0.5]);this.velvet_exp=0;this.velvet_additive=
!1;this.detail=[0,10,10];this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.extra_factor=0;this.extra_color=new Float32Array([0,0,0]);this.blending=Material.NORMAL;this.normalmap_factor=1;this.displacementmap_factor=0.1;this.bumpmap_factor=1;this.use_scene_ambient=!0;this.textures={};this.extra_uniforms={};a&&this.configure(a)}Material.icon="mini-icon-material.png";Material.NORMAL="normal";Material.ADDITIVE_BLENDING="additive";Material.COLOR="color";Material.OPACITY="opacity";
Material.BLENDING="blending";Material.AMBIENT="ambient";Material.DIFFUSE="diffuse";Material.BACKLIGHT_FACTOR="backlight_factor";Material.EMISSIVE="emissive";Material.SPECULAR_FACTOR="specular_factor";Material.SPECULAR_GLOSS="specular_gloss";Material.SPECULAR_ON_TOP="specular_ontop";Material.REFLECTION_FACTOR="reflection_factor";Material.REFLECTION_FRESNEL="reflection_fresnel";Material.REFLECTION_ADDITIVE="reflection_additive";Material.REFLECTION_SPECULAR="reflection_specular";Material.VELVET="velvet";
Material.VELVET_EXP="velvet_exp";Material.VELVET_ADDITIVE="velvet_additive";Material.NORMALMAP_FACTOR="normalmap_factor";Material.DISPLACEMENTMAP_FACTOR="displacementmap_factor";Material.OPACITY_TEXTURE="opacity";Material.AMBIENT_TEXTURE="ambient";Material.COLOR_TEXTURE="color";Material.SPECULAR_TEXTURE="specular";Material.EMISSIVE_TEXTURE="emissive";Material.DETAIL_TEXTURE="detail";Material.REFLECTIVITY_TEXTURE="reflectivity";Material.ENVIRONMENT_TEXTURE="environment";Material.NORMAL_TEXTURE="normal";
Material.BUMP_TEXTURE="bump";Material.DISPLACEMENT_TEXTURE="displacement";Material.IRRADIANCE_TEXTURE="irradiance";Material.EXTRA_TEXTURE="extra";Material.TEXTURE_CHANNELS=[Material.COLOR_TEXTURE,Material.OPACITY_TEXTURE,Material.AMBIENT_TEXTURE,Material.SPECULAR_TEXTURE,Material.EMISSIVE_TEXTURE,Material.DETAIL_TEXTURE,Material.NORMAL_TEXTURE,Material.DISPLACEMENT_TEXTURE,Material.BUMP_TEXTURE,Material.REFLECTIVITY_TEXTURE,Material.ENVIRONMENT_TEXTURE,Material.IRRADIANCE_TEXTURE,Material.EXTRA_TEXTURE];
Material.COORDS_UV0="0";Material.COORDS_UV1="1";Material.COORDS_UV_TRANSFORMED="transformed";Material.COORDS_SCREEN="screen";Material.COORDS_POLAR="polar";Material.COORDS_POLAR_REFLECTED="polar_reflected";Material.COORDS_WORLDXZ="worldxz";Material.COORDS_WORLDXY="worldxy";Material.COORDS_WORLDYZ="worldyz";
Material.TEXTURE_COORDINATES=[Material.COORDS_UV0,Material.COORDS_UV1,Material.COORDS_UV_TRANSFORMED,Material.COORDS_SCREEN,Material.COORDS_POLAR,Material.COORDS_POLAR_REFLECTED,Material.COORDS_WORLDXY,Material.COORDS_WORLDXZ,Material.COORDS_WORLDYZ];Material.DEFAULT_UVS={normal:Material.COORDS_UV0,displacement:Material.COORDS_UV0,environment:Material.COORDS_POLAR_REFLECTED,irradiance:Material.COORDS_POLAR};Material.available_shaders="default lowglobal phong_texture flat normal phong flat_texture cell_outline".split(" ");
Material.REFLECTIVE_FLAG=1;Material.prototype.setDirty=function(){this._dirty_macros=this._dirty_uniforms=!0};
Material.prototype.fillSurfaceShaderMacros=function(a){a={};for(var b in this.textures){var c=this.getTexture(b);if(c){var d=this.textures[b+"_uvs"]||Material.DEFAULT_UVS[b]||"0";"normal"==b?0!=this.normalmap_factor&&(!this.normalmap_tangent||this.normalmap_tangent&&gl.derivatives_supported)&&(a.USE_NORMAL_TEXTURE="uvs_"+d,0!=this.normalmap_factor&&(a.USE_NORMALMAP_FACTOR=""),this.normalmap_tangent&&gl.derivatives_supported&&(a.USE_TANGENT_NORMALMAP="")):"displacement"==b?0!=this.displacementmap_factor&&
gl.derivatives_supported&&(a.USE_DISPLACEMENT_TEXTURE="uvs_"+d,1!=this.displacementmap_factor&&(a.USE_DISPLACEMENTMAP_FACTOR="")):"bump"==b?0!=this.bump_factor&&gl.derivatives_supported&&(a.USE_BUMP_TEXTURE="uvs_"+d,1!=this.bumpmap_factor&&(a.USE_BUMP_FACTOR="")):a["USE_"+b.toUpperCase()+(c.texture_type==gl.TEXTURE_2D?"_TEXTURE":"_CUBEMAP")]="uvs_"+d}}this.velvet&&this.velvet_exp&&(a.USE_VELVET="");this.emissive_material&&(a.USE_EMISSIVE_MATERIAL="");this.specular_ontop&&(a.USE_SPECULAR_ONTOP="");
this.specular_on_alpha&&(a.USE_SPECULAR_ON_ALPHA="");this.reflection_specular&&(a.USE_SPECULAR_IN_REFLECTION="");0.001<this.backlight_factor&&(a.USE_BACKLIGHT="");0<this.reflection_factor&&(a.USE_REFLECTION="");if(this.extra_macros)for(var e in this.extra_macros)a[e]=this.extra_macros[e];this._macros=a};
Material.prototype.getLightShaderMacros=function(a,b,c,d){var e={};c=c.settings.enable_shadows&&a.cast_shadows&&a._shadowMap&&null!=a._lightMatrix&&!d.shadows_disabled;a.use_diffuse&&!this.constant_diffuse&&(e.USE_DIFFUSE_LIGHT="");a.use_specular&&0<this.specular_factor&&(e.USE_SPECULAR_LIGHT="");a.type==Light.DIRECTIONAL?e.USE_DIRECTIONAL_LIGHT="":a.type==Light.SPOT&&(e.USE_SPOT_LIGHT="");a.spot_cone&&(e.USE_SPOT_CONE="");a.linear_attenuation&&(e.USE_LINEAR_ATTENUATION="");a.range_attenuation&&(e.USE_RANGE_ATTENUATION=
"");(d=a.projective_texture)&&d.constructor==String&&(d=ResourcesManager.textures[d]);d&&(e.USE_PROJECTIVE_LIGHT="");0.001<a.offset&&(e.USE_LIGHT_OFFSET="");c&&!1!=b.flags.receive_shadows&&(e.USE_SHADOW_MAP="",a.hard_shadows&&(e.USE_HARD_SHADOWS=""),a._shadowMap&&a._shadowMap.texture_type==gl.TEXTURE_CUBE_MAP&&(e.USE_SHADOW_CUBEMAP=""),e.SHADOWMAP_OFFSET="");return e};
Material.prototype.fillSurfaceUniforms=function(a,b){var c={},d=[];c.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.opacity]);c.u_ambient_color=this.use_scene_ambient?vec3.fromValues(a.ambient_color[0]*this.ambient[0],a.ambient_color[1]*this.ambient[1],a.ambient_color[2]*this.ambient[2]):this.ambient;c.u_diffuse_color=this.diffuse;c.u_emissive_color=this.emissive||vec3.create();c.u_specular=[this.specular_factor,this.specular_gloss];c.u_reflection_info=[this.reflection_additive?
-this.reflection_factor:this.reflection_factor,this.reflection_fresnel];c.u_backlight_factor=this.backlight_factor;c.u_normalmap_factor=this.normalmap_factor;c.u_displacementmap_factor=this.displacementmap_factor;c.u_bumpmap_factor=this.bumpmap_factor;c.u_velvet_info=new Float32Array([this.velvet[0],this.velvet[1],this.velvet[2],this.velvet_additive?this.velvet_exp:-this.velvet_exp]);c.u_detail_info=this.detail;c.u_texture_matrix=this.uvs_matrix;for(var e in this.textures){var f=this.getTexture(e);
if(f){d.push([e+(f.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap"),f]);var g=this.textures[e+"_uvs"]||Material.DEFAULT_UVS[e]||"0";"normal"!=e&&"displacement"!=e&&"bump"!=e&&("irradiance"==e&&f.type==gl.TEXTURE_2D&&(f.bind(0),f.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),f.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),f.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)),f.texture_type!=gl.TEXTURE_2D||g!=Material.COORDS_POLAR_REFLECTED&&g!=Material.COORDS_POLAR||(f.bind(0),f.setParameter(gl.TEXTURE_WRAP_T,
gl.CLAMP_TO_EDGE),f.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR)))}}for(e in this.extra_uniforms)c[e]=this.extra_uniforms[e];this._uniforms=c;this._samplers=d};
Material.prototype.fillLightUniforms=function(a,b,c,d){a={};d=b.cast_shadows&&b._shadowMap&&null!=b._lightMatrix&&!d.shadows_disabled;var e=b.projective_texture;e&&e.constructor==String&&(e=ResourcesManager.textures[e]);if(b.type==Light.DIRECTIONAL||b.type==Light.SPOT)a.u_light_front=b.getFront();b.type==Light.SPOT&&(a.u_light_angle=[b.angle*DEG2RAD,b.angle_end*DEG2RAD,Math.cos(b.angle*DEG2RAD*0.5),Math.cos(b.angle_end*DEG2RAD*0.5)]);a.u_light_pos=b.getPosition();a.u_light_color=vec3.scale(a.u_light_color||
vec3.create(),b.color,b.intensity);a.u_light_att=[b.att_start,b.att_end];a.u_light_offset=b.offset;b._lightMatrix&&(a.u_lightMatrix=mat4.multiply(a.u_lightMatrix||mat4.create(),b._lightMatrix,c.matrix));e&&(a.light_texture=e.bind(11));d&&(a.u_shadow_params=[1/b._shadowMap.width,b.shadow_bias],a.shadowMap=b._shadowMap.bind(10));return a};
Material.prototype.configure=function(a){for(var b in a){var c=a[b],d=null;switch(b){case "opacity":case "backlight_factor":case "specular_factor":case "specular_gloss":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "blending":case "normalmap_factor":case "displacementmap_factor":case "extra_factor":case "shader_name":case "specular_ontop":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":d=c;break;case "color":case "ambient":case "diffuse":case "emissive":case "velvet":case "detail":case "extra_color":d=
new Float32Array(c);break;case "textures":this.textures=a.textures;continue;case "transparency":this.opacity=1-c;case "extra_uniforms":this.extra_uniforms=LS.cloneObject(c);default:continue}this[b]=d}a.uvs_matrix&&9==a.uvs_matrix.length&&(this.uvs_matrix=new Float32Array(a.uvs_matrix))};Material.prototype.serialize=function(){var a=cloneObject(this);a.material_class=getObjectClassName(this);return a};Material.prototype.clone=function(){return new this.constructor(JSON.stringify(JSON.parse(this.serialize())))};
Material.prototype.loadAndSetTexture=function(a,b,c){c=c||{};b=b||Material.COLOR_TEXTURE;var d=this;if("string"===typeof a)":"!=a[0]?ResourcesManager.load(a,c,function(a){d.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};
Material.prototype.setTexture=function(a,b,c){b=b||Material.COLOR_TEXTURE;a?(this.textures[b]=a,c&&(this.textures[b+"_uvs"]=c)):(delete this.textures[b],delete this.textures[b+"_uvs"]);a&&a.constructor==String&&":"!=a[0]&&ResourcesManager.load(a)};Material.prototype.getTexture=function(a){return(a=this.textures[a])?a.constructor==String?ResourcesManager.textures[a]:a.constructor==Texture?a:null:null};
Material.prototype.getResources=function(a){for(var b in this.textures)"string"==typeof this.textures[b]&&"_uvs"!=b.substr(-4)&&(a[this.textures[b]]=Texture);return a};Material.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)LS.ResourcesManager.load(a[b])};Material.prototype.getRenderer=function(){return this.renderer||Renderer._default_renderer};Material.prototype.registerMaterial=function(a){this.name=a;LS.ResourcesManager.registerResource(a,this);this.material=a};LS.registerMaterialClass(Material);
LS.Material=Material;function CustomMaterial(a){this._uid=LS.generateUId();this._dirty=!0;this.shader_name="base";this.color=new Float32Array([1,1,1]);this.opacity=1;this.vs_code="";this.code="vec4 surf() {\n\treturn u_material_color * vec4(1.0,0.0,0.0,1.0);\n}\n";this._uniforms={};this._macros={};this.textures={};a&&this.configure(a);this.computeCode()}CustomMaterial.ps_shader_definitions="\n";CustomMaterial.icon="mini-icon-material.png";CustomMaterial.prototype.onCodeChange=function(){this.computeCode()};
CustomMaterial.prototype.computeCode=function(){this._ps_uniforms_code="";var a=this.code.split("\n"),b;for(b in a)a[b]=a[b].split("//")[0];this._ps_functions_code=a.join("");this._ps_code="vec4 result = surf(); color = result.xyz; alpha = result.a;"};
CustomMaterial.prototype.onModifyMacros=function(a){a.USE_PIXEL_SHADER_UNIFORMS=a.USE_PIXEL_SHADER_UNIFORMS?a.USE_PIXEL_SHADER_UNIFORMS+this._ps_uniforms_code:this._ps_uniforms_code;a.USE_PIXEL_SHADER_FUNCTIONS=a.USE_PIXEL_SHADER_FUNCTIONS?a.USE_PIXEL_SHADER_FUNCTIONS+this._ps_functions_code:this._ps_functions_code;a.USE_PIXEL_SHADER_CODE=a.USE_PIXEL_SHADER_CODE?a.USE_PIXEL_SHADER_CODE+this._ps_code:this._ps_code};CustomMaterial.prototype.fillSurfaceShaderMacros=function(a){this._macros={}};
CustomMaterial.prototype.fillSurfaceUniforms=function(a,b){var c=[],d;for(d in this.textures){var e=this.getTexture(d);e&&c.push([d+(e.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap"),e])}this._uniforms.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.opacity]);this._samplers=c};CustomMaterial.prototype.configure=function(a){LS.cloneObject(a,this)};CustomMaterial.prototype.serialize=function(){return LS.cloneObject(this)};LS.extendClass(Material,CustomMaterial);
LS.registerMaterialClass(CustomMaterial);LS.CustomMaterial=CustomMaterial;
function SurfaceMaterial(a){this._uid=LS.generateUId();this._dirty=!0;this.shader_name="surface";this.color=new Float32Array([1,1,1]);this.opacity=1;this.blending=Material.NORMAL;this.vs_code="";this.code="void surf(in Input IN, inout SurfaceOutput o) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = 0.0;\n\to.Alpha = IN.color.a;\n}\n";this._uniforms={};this._macros={};this.properties=[];this.textures=
{};a&&this.configure(a);this.flags=0;this.computeCode()}SurfaceMaterial.icon="mini-icon-material.png";SurfaceMaterial.prototype.onCodeChange=function(){this.computeCode()};
SurfaceMaterial.prototype.computeCode=function(){var a="",b;for(b in this.properties){var c="uniform ",d=this.properties[b];switch(d.type){case "number":c+="float ";break;case "vec2":c+="vec2 ";break;case "vec3":c+="vec3 ";break;case "vec4":case "color":c+="vec4 ";break;case "texture":c+="sampler2D ";break;case "cubemap":c+="samplerCube ";break;default:continue}c+=d.name+";";a+=c}c=this.code.split("\n");for(b in c)c[b]=c[b].split("//")[0];this.surf_code=a+c.join("")};
SurfaceMaterial.prototype.onModifyMacros=function(a){this._ps_uniforms_code&&(a.USE_PIXEL_SHADER_UNIFORMS=a.USE_PIXEL_SHADER_UNIFORMS?a.USE_PIXEL_SHADER_UNIFORMS+this._ps_uniforms_code:this._ps_uniforms_code);this._ps_functions_code&&(a.USE_PIXEL_SHADER_FUNCTIONS=a.USE_PIXEL_SHADER_FUNCTIONS?a.USE_PIXEL_SHADER_FUNCTIONS+this._ps_functions_code:this._ps_functions_code);this._ps_code&&(a.USE_PIXEL_SHADER_CODE=a.USE_PIXEL_SHADER_CODE?a.USE_PIXEL_SHADER_CODE+this._ps_code:this._ps_code);a.USE_SURF=this.surf_code};
SurfaceMaterial.prototype.fillSurfaceShaderMacros=function(a){this._macros={}};SurfaceMaterial.prototype.fillSurfaceUniforms=function(a,b){var c=[],d;for(d in this.properties){var e=this.properties[d];if("texture"==e.type||"cubemap"==e.type){var f=LS.getTexture(e.value);f&&c.push([e.name,f])}else this._uniforms[e.name]=e.value}this._uniforms.u_material_color=new Float32Array([this.color[0],this.color[1],this.color[2],this.opacity]);this._samplers=c};
SurfaceMaterial.prototype.configure=function(a){LS.cloneObject(a,this)};LS.extendClass(Material,SurfaceMaterial);LS.registerMaterialClass(SurfaceMaterial);LS.SurfaceMaterial=SurfaceMaterial;function ComponentContainer(){}ComponentContainer.prototype.configureComponents=function(a){if(a.components)for(var b in a.components){var c=a.components[b],d=c[0];"Transform"==d&&0==b?this.transform.configure(c[1]):window[d]?(c=new window[d](c[1]),this.addComponent(c)):trace("Unknown component found: "+d)}};
ComponentContainer.prototype.serializeComponents=function(a){if(this._components){a.components=[];for(var b in this._components){var c=this._components[b];c.serialize&&a.components.push([getObjectClassName(c),c.serialize()])}}};
ComponentContainer.prototype.addComponent=function(a){a._root=this;if(a.onAddedToNode)a.onAddedToNode(this);this._components||(this._components=[]);if(-1!=this._components.indexOf(a))throw"inserting the same component twice";this._components.push(a);a._uid||(a._uid=LS.generateUId());return a};
ComponentContainer.prototype.removeComponent=function(a){a._root=null;if(a.onRemovedFromNode)a.onRemovedFromNode(this);LEvent.unbindAll(this,a);a=this._components.indexOf(a);-1!=a&&this._components.splice(a,1)};ComponentContainer.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0])};ComponentContainer.prototype.hasComponent=function(a){if(this._components){for(var b in this._components)if(this._components[b].constructor==a)return!0;return!1}};
ComponentContainer.prototype.getComponent=function(a){if(this._components){for(var b in this._components)if(this._components[b].constructor==a)return this._components[b];return null}};ComponentContainer.prototype.getIndexOfComponent=function(a){return this._components?this._components.indexOf(a):-1};ComponentContainer.prototype.getComponentByIndex=function(a){return this._components?this._components[a]:null};
ComponentContainer.prototype.processActionInComponents=function(a,b){if(this._components)for(var c=0;c<this._components.length;++c)if(this._components[c][a]&&"function"==typeof this._components[c][a])this._components[c][a](b)};function CompositePattern(){}CompositePattern.prototype.compositeCtor=function(){};
CompositePattern.prototype.addChild=function(a,b,c){function d(a){if(a._children)for(var b in a._children){var c=a._children[b];!c._in_tree&&a._in_tree&&(LEvent.trigger(a._in_tree,"treeItemAdded",c),c._in_tree=a._in_tree);d(c)}}for(var e=this;e._parentNode;){if(e==a)throw"addChild: Cannot insert a node as his own child";e=e._parentNode}a._parentNode&&a._parentNode.removeChild(a,c);a._parentNode=this;this._children?void 0==b?this._children.push(a):this._children.splice(b,0,a):this._children=[a];a._in_tree=
this._in_tree;this._onChildAdded&&this._onChildAdded(a,c);LEvent.trigger(this,"childAdded",a);this._in_tree&&(LEvent.trigger(this._in_tree,"treeItemAdded",a),d(a))};
CompositePattern.prototype.removeChild=function(a,b){function c(a){if(a._children)for(var b in a._children){var d=a._children[b];d._in_tree&&(LEvent.trigger(d._in_tree,"treeItemRemoved",d),d._in_tree=null);c(d)}}if(!this._children||a._parentNode!=this||a._parentNode!=this)return!1;var d=this._children.indexOf(a);if(-1==d)return!1;this._children.splice(d,1);this._onChildRemoved&&this._onChildRemoved(a,b);LEvent.trigger(this,"childRemoved",a);a._in_tree&&(LEvent.trigger(a._in_tree,"treeItemRemoved",
a),c(a));a._in_tree=null;return!0};CompositePattern.prototype.serializeChildren=function(){var a=[];if(this._children)for(var b in this._children)a.push(this._children[b].serialize());return a};CompositePattern.prototype.configureChildren=function(a){if(a.children)for(var b in a.children){var c=new this.constructor(a.children[b].id);this.addChild(c);c.configure(a.children[b])}};CompositePattern.prototype.getParent=function(){return this._parentNode};
CompositePattern.prototype.getChildren=function(){return this._children||[]};Object.defineProperty(CompositePattern.prototype,"childNodes",{enumerable:!0,get:function(){return this._children||[]},set:function(a){}});Object.defineProperty(CompositePattern.prototype,"parentNode",{enumerable:!0,get:function(){return this._parentNode},set:function(a){}});
CompositePattern.prototype.getDescendants=function(){if(!this._children||0==this._children.length)return[];for(var a=this._children.concat(),b=0;b<this._children.length;++b)a=a.concat(this._children[b].getDescendants());return a};function Transform(a){this._position=vec3.create();this._rotation=quat.create();this._scale=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._dirty=!1;a&&this.configure(a)}Transform.temp_matrix=mat4.create();Transform.icon="mini-icon-gizmo.png";
Transform.attributes={position:"vec3",scale:"vec3",rotation:"quat"};Transform.prototype.onAddedToNode=function(a){a.transform||(a.transform=this)};Transform.prototype.onRemovedFromNode=function(a){a.transform==this&&delete a.transform};Transform.prototype.copyFrom=function(a){this.configure(a.serialize())};
Transform.prototype.configure=function(a){a.position&&vec3.copy(this._position,a.position);a.scale&&vec3.copy(this._scale,a.scale);a.rotation&&4==a.rotation.length&&quat.copy(this._rotation,a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);var b=quat.setAngleAxis(quat.create(),[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,
[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._dirty=!0;this._on_change()};Transform.prototype.serialize=function(){return{position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],matrix:toArray(this._local_matrix)}};
Transform.prototype.identity=function(){vec3.copy(this._position,[0,0,0]);quat.copy(this._rotation,[0,0,0,1]);vec3.copy(this._scale,[1,1,1]);mat4.identity(this._local_matrix);mat4.identity(this._global_matrix);this._dirty=!1};Transform.prototype.reset=Transform.prototype.identity;Transform.prototype.getPosition=function(a){return a?vec3.copy(a,this._position):vec3.clone(this._position)};
Transform.prototype.getGlobalPosition=function(a){if(this._parent){var b=vec3.create();return mat4.multiplyVec3(a||b,this.getGlobalMatrix(),b)}return a?vec3.copy(a,this._position):vec3.clone(this._position)};Transform.prototype.getRotation=function(){return quat.clone(this._rotation)};Transform.prototype.getGlobalRotation=function(){if(this._parent){for(var a=this._parent,b=quat.clone(this._rotation);a;)quat.multiply(b,a._rotation,b),a=a._parent;return b}return quat.clone(this._rotation)};
Transform.prototype.getScale=function(){return vec3.clone(this._scale)};Transform.prototype.getGlobalScale=function(){if(this._parent){for(var a=this,b=vec3.clone(this._scale);a._parent;)vec3.multiply(b,b,a._scale),a=a._parent;return b}return vec3.clone(this._scale)};Transform.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,this._rotation,this._position);mat4.scale(this._local_matrix,this._local_matrix,this._scale);this._dirty=!1};
Transform.prototype.updateGlobalMatrix=function(a){this._dirty&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this._local_matrix):this._global_matrix.set(this._local_matrix)};Transform.prototype.getLocalMatrix=function(){this._dirty&&this.updateMatrix();return mat4.clone(this._local_matrix)};Transform.prototype.getLocalMatrixRef=function(){this._dirty&&this.updateMatrix();return this._local_matrix};
Transform.prototype.getGlobalMatrix=function(a,b){this._dirty&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,b?this._parent._global_matrix:this._parent.getGlobalMatrix(),this._local_matrix):this._global_matrix.set(this._local_matrix);a.set(this._global_matrix);return a};Transform.prototype.getGlobalRotation=function(a){a=a||quat.create();a.set(this._rotation);for(var b=this._parent;b;)quat.multiply(a,a,b._rotation),b=b._parent;return a};
Transform.prototype.getGlobalRotationMatrix=function(a){for(var b=quat.clone(this._rotation),c=this._parent;c;)quat.multiply(b,b,c._rotation),c=c._parent;a=a||mat4.create();return mat4.fromQuat(a,b)};Transform.prototype.getGlobalMatrixRef=function(){return this._global_matrix};Transform.prototype.getMatrixWithoutScale=function(){var a=this.getGlobalPosition();return mat4.fromRotationTranslation(mat4.create(),this.getGlobalRotation(),a)};
Transform.prototype.getMatrixWithoutRotation=function(){var a=this.getGlobalPosition();return mat4.clone([1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1])};Transform.prototype.getNormalMatrix=function(a){this._dirty&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,this._parent.getGlobalMatrix(),this._local_matrix):a.set(this._local_matrix);return mat4.transpose(a,mat4.invert(a,a))};
Transform.prototype.fromMatrix=function(a){var b=mat4.clone(a);mat4.multiplyVec3(this._position,b,[0,0,0]);var c=vec3.create();this._scale[0]=vec3.length(mat4.rotateVec3(c,b,[1,0,0]));this._scale[1]=vec3.length(mat4.rotateVec3(c,b,[0,1,0]));this._scale[2]=vec3.length(mat4.rotateVec3(c,b,[0,0,1]));mat4.scale(mat4.create(),b,[1/this._scale[0],1/this._scale[1],1/this._scale[2]]);vec3.normalize(b.subarray(0,3),b.subarray(0,3));vec3.normalize(b.subarray(4,7),b.subarray(4,7));vec3.normalize(b.subarray(8,
11),b.subarray(8,11));b=mat3.fromMat4(mat3.create(),b);mat3.transpose(b,b);quat.fromMat3(this._rotation,b);quat.normalize(this._rotation,this._rotation);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._dirty=!1;this._on_change()};Transform.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._dirty=!0;this._on_change()};
Transform.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._dirty=!0;this._on_change()};Transform.prototype.setRotation=function(a){quat.copy(this._rotation,a);this._dirty=!0;this._on_change()};Transform.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scale,a,b,c):vec3.set(this._scale,a,a,a);this._dirty=!0;this._on_change()};
Transform.prototype.translate=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._dirty=!0;this._on_change()};Transform.prototype.translateLocal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,this.transformVector([a,b,c])):vec3.add(this._position,this._position,this.transformVector(a));this._dirty=!0;this._on_change()};
Transform.prototype.rotate=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._dirty=!0;this._on_change()};Transform.prototype.rotateLocal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,this._rotation,c);this._dirty=!0;this._on_change()};Transform.prototype.rotateQuat=function(a){quat.multiply(this._rotation,a,this._rotation);this._dirty=!0;this._on_change()};
Transform.prototype.rotateQuatLocal=function(a){quat.multiply(this._rotation,this._rotation,a);this._dirty=!0;this._on_change()};Transform.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scale,this._scale,[a,b,c]):vec3.multiply(this._scale,this._scale,a);this._dirty=!0;this._on_change()};
Transform.interpolate=function(a,b,c,d){vec3.lerp(d._scale,a._scale,b._scale,c);vec3.lerp(d._position,a._position,b._position,c);quat.slerp(d._rotation,a._rotation,b._rotation,c);this._dirty=!0;this._on_change()};Transform.prototype.lookAt=function(a,b,c){var d=mat4.create();if(this._parent){var e=this._parent.getGlobalMatrix();a=mat4.multiplyVec3(vec3.create(),e,a);b=mat4.multiplyVec3(vec3.create(),e,b);c=mat4.multiplyVec3(vec3.create(),e,c)}mat4.lookAt(d,a,b,c);mat4.invert(d,d);this.fromMatrix(d)};
Transform.prototype._on_change=function(){this._dirty=!0;LEvent.trigger(this,"changed",this);this._root&&LEvent.trigger(this._root,"transformChanged",this)};Transform.prototype.getFront=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(0,0,1),this.getGlobalRotation())};Transform.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(0,1,0),this.getGlobalRotation())};
Transform.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),vec3.fromValues(1,0,0),this.getGlobalRotation())};Transform.prototype.transformPoint=function(a,b){b=b||vec3.create();this._dirty&&this.updateMatrix();return mat4.multiplyVec3(b,this._local_matrix,a)};Transform.prototype.transformPointGlobal=function(a,b){b=b||vec3.create();this._dirty&&this.updateMatrix();return mat4.multiplyVec3(b,this.getGlobalMatrix(),a)};
Transform.prototype.transformVector=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this._rotation)};Transform.prototype.transformVectorGlobal=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this.getGlobalRotation())};
Transform.prototype.applyTransformMatrix=function(a,b){if(this._parent){var c=this.getGlobalMatrix(),d=this._parent._global_matrix,e=mat4.create();mat4.multiply(this._global_matrix,a,c);mat4.invert(e,d);mat4.multiply(this._local_matrix,e,this._global_matrix);this.fromMatrix(this._local_matrix)}else b?mat4.multiply(this._local_matrix,a,this._local_matrix):mat4.multiply(this._local_matrix,this._local_matrix,a),this.fromMatrix(this._local_matrix),mat4.copy(this._global_matrix,this._local_matrix)};LS.registerComponent(Transform);
LS.Transform=Transform;
function Camera(a){this.enabled=!0;this._type=Camera.PERSPECTIVE;this._eye=vec3.fromValues(0,100,100);this._center=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this._near=1;this._far=1E3;this._ortho=new Float32Array([-1,1,-1,1]);this._aspect=1;this._fov=45;this._frustrum_size=50;this._viewport=new Float32Array([0,0,1,1]);this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._to_texture="";this._texture_size=
512;a&&this.configure(a)}Camera.icon="mini-icon-camera.png";Camera.PERSPECTIVE=1;Camera.ORTHOGRAPHIC=2;Camera.ORTHO2D=3;Object.defineProperty(Camera.prototype,"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._dirty_matrices=!0);this._type=a}});Object.defineProperty(Camera.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._dirty_matrices=!0}});
Object.defineProperty(Camera.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._dirty_matrices=!0}});Object.defineProperty(Camera.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._dirty_matrices=!0}});Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._dirty_matrices=!0);this._near=a}});
Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._dirty_matrices=!0);this._far=a}});Object.defineProperty(Camera.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._dirty_matrices=!0);this._aspect=a}});Object.defineProperty(Camera.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._dirty_matrices=!0);this._fov=a}});
Object.defineProperty(Camera.prototype,"frustrum_size",{get:function(){return this._frustrum_size},set:function(a){this._frustrum_size!=a&&(this._dirty_matrices=!0);this._frustrum_size=a}});Camera.prototype.onAddedToNode=function(a){a.camera||(a.camera=this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};Camera.prototype.onRemovedFromNode=function(a){a.camera==this&&delete a.camera};Camera.prototype.onCollectCameras=function(a,b){this.enabled&&b.push(this)};
Camera.prototype.lookAt=function(a,b,c){vec3.copy(this._eye,a);vec3.copy(this._center,b);vec3.copy(this._up,c);this._dirty_matrices=!0};
Camera.prototype.updateMatrices=function(){this.type==Camera.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this._frustrum_size*this._aspect*0.5,this._frustrum_size*this._aspect*0.5,0.5*-this._frustrum_size,0.5*this._frustrum_size,this._near,this._far):this.type==Camera.ORTHO2D?mat4.ortho(this._projection_matrix,this._ortho[0],this._ortho[1],this._ortho[2],this._ortho[3],this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._aspect,this._near,this._far);mat4.lookAt(this._view_matrix,
this._eye,this._center,this._up);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._dirty_matrices=!1};Camera.prototype.getModelMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._model_matrix)};Camera.prototype.getViewMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._view_matrix)};
Camera.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};Camera.prototype.getViewProjectionMatrix=function(a){a=a||mat4.create();this._dirty_matrices&&this.updateMatrices();return mat4.copy(a,this._viewprojection_matrix)};
Camera.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};
Camera.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._dirty_matrices&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.multiplyVec3(b,c,a)};
Camera.prototype.getLocalVector=function(a,b){b=b||vec3.create();this._dirty_matrices&&this.updateMatrices();var c=this._model_matrix;this._root&&this._root.transform&&mat4.multiply(c,c,this._root.transform.getGlobalMatrixRef());return mat4.rotateVec3(b,c,a)};Camera.prototype.getEye=function(){var a=vec3.clone(this._eye);return this._root&&this._root.transform&&this._root._parent?mat4.multiplyVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};
Camera.prototype.getFront=function(){var a=vec3.sub(vec3.create(),this._center,this._eye);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):vec3.normalize(a,a)};Camera.prototype.getUp=function(){var a=vec3.clone(this._up);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};
Camera.prototype.getTop=function(){var a=vec3.sub(vec3.create(),this._center,this._eye),b=vec3.cross(vec3.create(),this._up,a),a=vec3.cross(vec3.create(),a,b);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};Camera.prototype.getCenter=function(){var a=vec3.clone(this._center);return this._root&&this._root.transform&&this._root._parent?mat4.multiplyVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};
Camera.prototype.setEye=function(a){return vec3.copy(this._eye,a)};Camera.prototype.setCenter=function(a){return vec3.copy(this._center,a)};Camera.prototype.setOrthographic=function(a,b,c,d,e,f){this._near=e;this._far=f;this._ortho.set([a,b,c,d]);this._type=Camera.ORTHO2D;this._dirty_matrices=!0};Camera.prototype.move=function(a){vec3.add(this._center,this._center,a);vec3.add(this._eye,this._eye,a);this._dirty_matrices=!0};
Camera.prototype.rotate=function(a,b,c){c&&this.getLocalVector(b,b);a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._center,this._eye);vec3.transformQuat(b,b,a);vec3.add(this._center,this._eye,b);this._dirty_matrices=!0};Camera.prototype.orbit=function(a,b,c){c=c||this._center;a=quat.setAxisAngle(quat.create(),b,0.0174532925*a);b=vec3.subtract(vec3.create(),this._eye,c);vec3.transformQuat(b,b,a);vec3.add(this._eye,c,b);this._dirty_matrices=!0};
Camera.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._dirty_matrices=!0};
Camera.prototype.setOrientation=function(a,b){var c=this.getCenter(),d=this.getEye(),e=[0,1,0],c=vec3.sub(vec3.create(),c,d),c=vec3.length(c),f=null,f=vec3.fromValues(0,0,-c);b&&(vec3.rotateY(f,f,-0.5*Math.PI),vec3.rotateY(e,e,-0.5*Math.PI));vec3.transformQuat(f,f,a);vec3.transformQuat(e,e,a);b&&(vec3.rotateY(f,f,0.5*Math.PI),vec3.rotateY(e,e,0.5*Math.PI));this.center=vec3.add(vec3.create(),d,f);this.up=e;this._dirty_matrices=!0};
Camera.prototype.setEulerAngles=function(a,b,c){var d=quat.create();quat.fromEuler(d,[a,b,c]);this.setOrientation(d)};Camera.prototype.fromViewmatrix=function(a){a=mat4.invert(mat4.create(),a);this.eye=vec3.transformMat4(vec3.create(),vec3.create(),a);this.center=vec3.transformMat4(vec3.create(),[0,0,-1],a);this.up=mat4.rotateVec3(vec3.create(),a,[0,1,0]);this._dirty_matrices=!0};
Camera.prototype.project=function(a,b,c){b=b||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();c=mat4.multiplyVec3(c||vec3.create(),this._viewprojection_matrix,a);c[0]/=c[2];c[1]/=c[2];vec3.set(c,0.5*(c[0]+1)*b[2]+b[0],0.5*(c[1]+1)*b[3]+b[1],c[2]);return c};Camera.prototype.unproject=function(a,b,c){b=b||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();return gl.unproject(c||vec3.create(),a,this._view_matrix,this._projection_matrix,b)};
Camera.prototype.getRayInPixel=function(a,b,c){c=c||gl.getParameter(gl.VIEWPORT);this._dirty_matrices&&this.updateMatrices();var d=this.getEye(),e=vec3.unproject(vec3.create(),[a,b,1],this._view_matrix,this._projection_matrix,c);this.type==Camera.ORTHOGRAPHIC&&(d=vec3.unproject(vec3.create(),[a,b,0],this._view_matrix,this._projection_matrix,c));a=vec3.subtract(vec3.create(),e,d);vec3.normalize(a,a);return{start:d,direction:a}};
Camera.prototype.configure=function(a){null!=a.enabled&&(this.enabled=a.enabled);null!=a.type&&(this._type=a.type);null!=a.eye&&this._eye.set(a.eye);null!=a.center&&this._center.set(a.center);null!=a.up&&this._up.set(a.up);null!=a.near&&(this._near=a.near);null!=a.far&&(this._far=a.far);null!=a.fov&&(this._fov=a.fov);null!=a.aspect&&(this._aspect=a.aspect);null!=a.frustrum_size&&(this._frustrum_size=a.frustrum_size);null!=a.viewport&&this._viewport.set(a.viewport);this.updateMatrices()};
Camera.prototype.serialize=function(){return{enabled:this.enabled,type:this._type,eye:vec3.toArray(this._eye),center:vec3.toArray(this._center),up:vec3.toArray(this._up),near:this._near,far:this._far,fov:this._fov,aspect:this._aspect,frustrum_size:this._frustrum_size,viewport:toArray(this._viewport),to_texture:this._to_texture,texture_size:this._texture_size}};LS.registerComponent(Camera);LS.Camera=Camera;
function Light(a){this.position=vec3.create();this.target=vec3.fromValues(0,0,1);this.up=vec3.fromValues(0,1,0);this.enabled=!0;this.near=1;this.far=1E3;this.angle=45;this.angle_end=60;this.use_specular=this.use_diffuse=!0;this.range_attenuation=this.linear_attenuation=!1;this.att_start=0;this.att_end=1E3;this.offset=0;this.spot_cone=!0;this.target_in_world_coords=!1;this.color=vec3.fromValues(1,1,1);this.intensity=1;this.cast_shadows=!1;this.shadow_bias=0.005;this.shadowmap_resolution=1024;this.type=
Light.OMNI;this.frustrum_size=50;this._macros={};this._uniforms={};a&&(this.configure(a),a.shadowmap_resolution&&(this.shadowmap_resolution=parseInt(a.shadowmap_resolution)))}Light.FRONT_VECTOR=new Float32Array(0,0,-1);Light.UP_VECTOR=new Float32Array(0,1,0);Light.OMNI=1;Light.SPOT=2;Light.DIRECTIONAL=3;Light.DEFAULT_SHADOWMAP_RESOLUTION=1024;Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=50;
Light.prototype.onAddedToNode=function(a){a.light||(a.light=this);LEvent.bind(a,"collectLights",this.onCollectLights,this)};Light.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light};Light.prototype.onCollectLights=function(a,b){this.enabled&&(this.projective_texture&&this.computeLightMatrices(),b.push(this))};Light._temp_matrix=mat4.create();Light._temp2_matrix=mat4.create();Light._temp3_matrix=mat4.create();Light._temp_position=vec3.create();Light._temp_target=vec3.create();
Light._temp_up=vec3.create();Light._temp_front=vec3.create();
Light.prototype.computeLightMatrices=function(a,b,c){var d=this.getPosition(Light._temp_position),e=this.getTarget(Light._temp_target),f=this.getUp(Light._temp_up),g=this.getFront(Light._temp_front);0.999<Math.abs(vec3.dot(g,f))&&vec3.set(f,0,0,1);b||(b=Light._temp_matrix);a||(a=Light._temp2_matrix);c||(c=Light._temp3_matrix);g=this.frustrum_size||Light.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;this.type==Light.DIRECTIONAL?mat4.ortho(b,-0.5*g,0.5*g,-0.5*g,0.5*g,this.near,this.far):mat4.perspective(b,(this.angle_end||
45)*DEG2RAD,1,this.near,this.far);mat4.lookAt(a,d,e,f);this.type==Light.DIRECTIONAL&&this.cast_shadows&&this.enabled&&(d=g/(this.shadowmap_resolution||Light.DEFAULT_SHADOWMAP_RESOLUTION),a[12]=Math.floor(a[12]/d)*d,a[13]=Math.floor(a[13]/d)*d);mat4.multiply(c,b,a);this._lightMatrix||(this._lightMatrix=mat4.create());mat4.copy(this._lightMatrix,c)};
Light.prototype.serialize=function(){this.position=vec3.toArray(this.position);this.target=vec3.toArray(this.target);this.color=vec3.toArray(this.color);return cloneObject(this)};Light.prototype.configure=function(a){LS.cloneObject(a,this)};Light.prototype.getPosition=function(a){return this._root&&this._root.transform?this._root.transform.getGlobalPosition():vec3.clone(this.position)};
Light.prototype.getTarget=function(a){return this._root&&this._root.transform&&!this.target_in_world_coords?this._root.transform.transformPointGlobal(Light.FRONT_VECTOR,a||vec3.create()):vec3.clone(this.target)};Light.prototype.getUp=function(a){return this._root&&this._root.transform?this._root.transform.transformVector(Light.UP_VECTOR,a||vec3.create()):vec3.clone(this.up)};
Light.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this.getPosition(),this.getTarget());vec3.normalize(a,a);return a};Light.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=Texture);return a};LS.registerComponent(Light);LS.Light=Light;
function LightFX(a){this.enabled=!0;this.volume_visibility=0;this.glare_visibility=this.volume_density=this.volume_radius=1;this.glare_size=vec2.fromValues(0.2,0.2);this.glare_texture=null;this._macros={};this._uniforms={};a&&this.configure(a)}LightFX["@glare_texture"]={type:"texture"};LightFX["@glare_size"]={type:"vec2",step:0.001};LightFX["@glare_visibility"]={type:"number",step:0.001};LightFX.icon="mini-icon-lightfx.png";
LightFX.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};LightFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};LightFX.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this._root.light;if(!c||c.enabled)this.volume_visibility&&c&&b.push(this.getVolumetricRenderInstance(c)),this.glare_visibility&&(c=this.getGlareRenderInstance(c))&&b.push(c)}};
LightFX.prototype.getVolumetricRenderInstance=function(){this._volumetric_mesh||(this._volumetric_mesh=GL.Mesh.sphere());var a=this._volumetric_render_instance;a||(this._volumetric_render_instance=a=new RenderInstance(this._root,this));a.flags=RenderInstance.ALPHA;var b=this._volumetric_material;b||(b=this._volumetric_material=new Material({shader_name:"volumetric_light",blending:Material.ADDITIVE_BLENDING}));vec3.copy(b.color,light.color);b.opacity=this.volume_visibility;a.material=b;a.matrix.set(this._root.transform._global_matrix);
mat4.multiplyVec3(a.center,a.matrix,light.position);mat4.scale(a.matrix,a.matrix,[this.volume_radius,this.volume_radius,this.volume_radius]);b=vec4.create();b.set(a.center);b[3]=0.5*this.volume_radius;a.uniforms.u_volume_info=b;a.uniforms.u_volume_density=this.volume_density;a.setMesh(this._mesh,gl.TRIANGLES);a.flags=RI_CULL_FACE|RI_BLEND|RI_DEPTH_TEST;return a};
LightFX.prototype.getGlareRenderInstance=function(a){if(!this.glare_texture)return null;var b=this._glare_render_instance;b||(this._glare_render_instance=b=new RenderInstance(this._root,this),b.setMesh(GL.Mesh.plane({size:1}),gl.TRIANGLES),b.priority=1);b.flags=RI_2D_FLAGS;a?vec3.copy(b.center,a.getPosition()):vec3.copy(b.center,this._root.transform.getGlobalPosition());b.scale_2D=this.glare_size;var c=this._glare_material;c||(c=this._glare_material=new Material({blending:Material.ADDITIVE_BLENDING}));
a&&(vec3.scale(c.color,a.color,this.glare_visibility*a.intensity),c.textures.color=this.glare_texture);b.material=c;return b};LightFX.onGlarePreRender=function(a){mat4.projectVec3(this.pos2D,Renderer._viewprojection_matrix,this.center);this.pos2D[2]=0;this.material.opacity=1/(2*vec3.distance(this.pos2D,[0,0,0]))};LightFX.prototype.getResources=function(a){this.glare_texture&&(a[this.glare_texture]=Texture);return a};LS.registerComponent(LightFX);LS.LightFX=LightFX;
function MeshRenderer(a){this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.primitive=this.material=null;this.two_sided=!1;a&&this.configure(a);MeshRenderer._identity||(MeshRenderer._identity=mat4.create())}MeshRenderer.icon="mini-icon-teapot.png";MeshRenderer["@mesh"]={widget:"mesh"};MeshRenderer["@lod_mesh"]={widget:"mesh"};MeshRenderer["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4}};
MeshRenderer["@submesh_id"]={widget:"combo",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};MeshRenderer.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
MeshRenderer.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};MeshRenderer.prototype.configure=function(a){this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material));a.morph_targets&&(this.morph_targets=a.morph_targets)};
MeshRenderer.prototype.serialize=function(){var a={mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());null!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};MeshRenderer.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};
MeshRenderer.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};MeshRenderer.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};
MeshRenderer.prototype.onCollectInstances=function(a,b){var c=this.getMesh();if(!c)return null;if(this._root){var d=this._RI;d||(this._RI=d=new RenderInstance(this._root,this));d.matrix.set(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,vec3.create());d.material=this.material||this._root.getMaterial();d.flags=RI_DEFAULT_FLAGS;d.applyNodeFlags();this.two_sided&&(d.flags&=~RI_CULL_FACE);d.setMesh(c,this.primitive);-1!=this.submesh_id&&null!=this.submesh_id&&(d.submesh_id=this.submesh_id);
b.push(d)}};LS.registerComponent(MeshRenderer);LS.MeshRenderer=MeshRenderer;function SkinnedMeshRenderer(a){this.cpu_skinning=!0;this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.primitive=this.material=null;this.two_sided=!1;a&&this.configure(a);MeshRenderer._identity||(MeshRenderer._identity=mat4.create())}SkinnedMeshRenderer.icon="mini-icon-teapot.png";SkinnedMeshRenderer["@mesh"]={widget:"mesh"};SkinnedMeshRenderer["@lod_mesh"]={widget:"mesh"};
SkinnedMeshRenderer["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4}};SkinnedMeshRenderer["@submesh_id"]={widget:"combo",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};
SkinnedMeshRenderer.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};SkinnedMeshRenderer.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
SkinnedMeshRenderer.prototype.configure=function(a){this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;a.material&&(this.material="string"==typeof a.material?a.material:new Material(a.material))};
SkinnedMeshRenderer.prototype.serialize=function(){var a={mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());null!=this.primitive&&(a.primitive=this.primitive);this.submesh_id&&(a.submesh_id=this.submesh_id);this.two_sided&&(a.two_sided=this.two_sided);return a};SkinnedMeshRenderer.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};
SkinnedMeshRenderer.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};SkinnedMeshRenderer.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};SkinnedMeshRenderer.prototype.getBoneMatrix=function(a){var b=Scene.getNode(a);if(b)return b.transform.getGlobalMatrix();console.log("bone not found :"+a);return mat4.create()};
SkinnedMeshRenderer.prototype.applySkin=function(a,b){var c=a.getBuffer("vertices").data,d=a.getBuffer("weights").data,e=a.getBuffer("bone_indices").data,f=b.getBuffer("vertices"),g=f.data,h=[],k;for(k in a.bones){var n=this.getBoneMatrix(a.bones[k][0]);h.push(mat4.multiply(mat4.create(),n,a.bones[k][1]))}vec3.create();k=0;for(n=g.length/3;k<n;++k){var p=c.subarray(3*k,3*k+3),m=e.subarray(4*k,4*k+4);d.subarray(4*k,4*k+4);var r=g.subarray(3*k,3*k+3);mat4.multiplyVec3(r,h[m[0]],p)}f.compile(gl.STREAM_DRAW)};
SkinnedMeshRenderer.prototype.onCollectInstances=function(a,b,c){a=this.getMesh();if(!a)return null;if(this._root&&(c=this._render_instance,c||(this._render_instance=c=new RenderInstance(this._root,this)),a.getBuffer("vertices")&&a.getBuffer("bone_indices"))){if(this.cpu_skinning){if(!this._skinned_mesh||this._skinned_mesh._reference!=a){this._skinned_mesh=new GL.Mesh;this._skinned_mesh._reference=a;var d=a.getBuffer("vertices"),e;for(e in a.vertexBuffers)this._skinned_mesh.vertexBuffers[e]=a.vertexBuffers[e];
for(e in a.indexBuffers)this._skinned_mesh.indexBuffers[e]=a.indexBuffers[e];this._skinned_mesh.addVertexBuffer("vertices","a_vertex",3,new Float32Array(d.data),gl.STREAM_DRAW)}this.applySkin(a,this._skinned_mesh);c.setMesh(this._skinned_mesh,this.primitive)}else c.setMesh(a,this.primitive);this._root.transform.getGlobalMatrix(c.matrix);mat4.multiplyVec3(c.center,c.matrix,vec3.create());-1!=this.submesh_id&&null!=this.submesh_id&&(c.submesh_id=this.submesh_id);c.material=this.material||this._root.getMaterial();
c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();this.two_sided&&(c.flags&=~RI_CULL_FACE);c.flags|=RI_IGNORE_FRUSTUM;b.push(c)}};LS.registerComponent(SkinnedMeshRenderer);LS.SkinnedMeshRenderer=SkinnedMeshRenderer;function SpriteRenderer(a){a&&this.configure(a)}SpriteRenderer.icon="mini-icon-teapot.png";SpriteRenderer.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
SpriteRenderer.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
SpriteRenderer.prototype.onCollectInstances=function(a,b){if(this._root){var c=this._mesh;this._mesh||(c=this._mesh=GL.Mesh.plane());var d=this._render_instance;d||(this._render_instance=d=new RenderInstance(this._root,this));d.matrix.set(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,vec3.create());d.setMesh(c,gl.TRIANGLES);d.material=this._root.getMaterial();d.flags=RI_DEFAULT_FLAGS;d.applyNodeFlags();b.push(d)}};LS.registerComponent(SpriteRenderer);
function Skybox(a){this.texture=null;this.intensity=1;this.use_environment=!0;a&&this.configure(a)}Skybox.icon="mini-icon-teapot.png";Skybox["@texture"]={widget:"texture"};Skybox.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Skybox.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
Skybox.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=Texture);return a};
Skybox.prototype.onCollectInstances=function(a,b){if(this._root){var c=null;if(c=this.use_environment?Renderer._current_scene.textures.environment:this.texture){c.constructor===String&&(c=LS.ResourcesManager.textures[c]);var d=this._mesh;d||(d=this._mesh=GL.Mesh.cube({size:10}));var e=this._render_instance;e||(this._render_instance=e=new RenderInstance(this._root,this),e.priority=100,e.onPreRender=function(a){a=a.camera.getEye();mat4.identity(this.matrix);mat4.setTranslation(this.matrix,a);if(this.node.transform){var b=
this.node.transform.getGlobalRotationMatrix();mat4.multiply(this.matrix,this.matrix,b)}vec3.copy(this.center,a)});var f=this._material;f||(f=this._material=new LS.Material({use_scene_ambient:!1}));vec3.copy(f.color,[this.intensity,this.intensity,this.intensity]);f.textures.color=c;e.setMesh(d);e.material=f;e.flags=RI_DEFAULT_FLAGS;e.applyNodeFlags();e.enableFlag(RI_CW|RI_IGNORE_LIGHTS|RI_IGNORE_FRUSTUM|RI_IGNORE_CLIPPING_PLANE);e.disableFlag(RI_CAST_SHADOWS|RI_DEPTH_WRITE|RI_DEPTH_TEST);b.push(e)}}};
LS.registerComponent(Skybox);LS.Skybox=Skybox;function BackgroundRenderer(a){this.texture=null;a&&this.configure(a)}BackgroundRenderer.icon="mini-icon-teapot.png";BackgroundRenderer["@texture"]={widget:"texture"};BackgroundRenderer.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};BackgroundRenderer.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
BackgroundRenderer.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=Texture);return a};
BackgroundRenderer.prototype.onCollectInstances=function(a,b){var c=this.texture;if(c){c.constructor===String&&(c=LS.ResourcesManager.textures[c]);var d=this._mesh;d||(d=this._mesh=GL.Mesh.getScreenQuad());var e=this._material;e||(e=this._material=new LS.Material({use_scene_ambient:!1}));e.textures.color=c;c=this._render_instance;c||(this._render_instance=c=new RenderInstance(this._root,this),c.priority=100);c.setMesh(d);c.material=e;c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();c.disableFlag(RI_CAST_SHADOWS);
c.enableFlag(RI_IGNORE_LIGHTS);c.enableFlag(RI_CW);c.disableFlag(RI_DEPTH_WRITE);c.disableFlag(RI_DEPTH_TEST);c.enableFlag(RI_IGNORE_FRUSTRUM);c.enableFlag(RI_IGNORE_VIEWPROJECTION);b.push(c)}};function Collider(a){this.shape=1;this.mesh=null;this.size=vec3.fromValues(0.5,0.5,0.5);this.center=vec3.create();a&&this.configure(a)}Collider.icon="mini-icon-teapot.png";Collider["@size"]={type:"vec3",step:0.01};Collider["@center"]={type:"vec3",step:0.01};Collider["@mesh"]={type:"mesh"};
Collider["@shape"]={widget:"combo",values:{Box:1,Sphere:2,Mesh:5}};Collider.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectPhysicInstances",this.onGetColliders,this)};Collider.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectPhysicInstances",this.onGetColliders,this)};Collider.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};
Collider.prototype.getResources=function(a){if(this.mesh)return"string"==typeof this.mesh&&(a[this.mesh]=Mesh),a};
Collider.prototype.onGetColliders=function(a,b){var c=this._PI;c||(this._PI=c=new PhysicsInstance(this._root,this));c.matrix.set(this._root.transform._global_matrix);c.type=this.shape;c.type==PhysicsInstance.SPHERE?BBox.setCenterHalfsize(c.oobb,this.center,[this.size[0],this.size[0],this.size[0]]):BBox.setCenterHalfsize(c.oobb,this.center,this.size);vec3.copy(c.center,this.center);if(c.type==PhysicsInstance.MESH){var d=this.getMesh();if(!d)return;c.setMesh(d)}b.push(c)};LS.registerComponent(Collider);
LS.Collider=Collider;function AnnotationComponent(a){this.text="";this.notes=[];this._screen_pos=vec3.create();this._selected=null;this.configure(a)}AnnotationComponent.editor_color=[0.33,0.874,0.56,0.9];AnnotationComponent.onShowMainAnnotation=function(a){"undefined"!=typeof AnnotationModule&&AnnotationModule.editAnnotation(a)};
AnnotationComponent.onShowPointAnnotation=function(a,b){function c(a){this.text=a}var d=a.getComponent(AnnotationComponent);d&&"undefined"!=typeof AnnotationModule&&AnnotationModule.showDialog(b.text,{item:b,on_close:c.bind(b),on_delete:function(a){d.removeAnnotation(a.item);Scene.refresh()},on_focus:function(a){AnnotationModule.focusInAnnotation(a.item);d._selected=a.item}})};AnnotationComponent.prototype.addAnnotation=function(a){this._selected=null;this.notes.push(a)};
AnnotationComponent.prototype.removeAnnotation=function(a){this._selected=null;a=this.notes.indexOf(a);-1!=a&&this.notes.splice(a,1)};AnnotationComponent.prototype.setStartTransform=function(){this.start_position=this.getObjectCenter()};AnnotationComponent.prototype.getObjectCenter=function(){var a=vec3.create(),b=this._root.getMesh();b&&b.bounding&&vec3.copy(a,b.bounding.aabb_center);return this._root.transform.transformPointGlobal(a,vec3.create())};
AnnotationComponent.prototype.serialize=function(){var a={text:this.text,notes:[],start_position:this.start_position},b;for(b in this.notes){var c=this.notes[b],d;for(d in c)c[d].constructor==Float32Array&&Array.prototype.slice.call(c[d]);a.notes.push(c)}return a};AnnotationComponent.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousedown",this.onMouse.bind(this),this)};AnnotationComponent.prototype.onRemovedFromNode=function(a){};
AnnotationComponent.prototype.onMouse=function(a,b){if("mousedown"==b.eventType){this._screen_pos[2]=0;var c=vec3.dist(this._screen_pos,[b.canvasx,gl.canvas.height-b.canvasy,0]);if(30>c)AnnotationComponent.onShowMainAnnotation(this._root);for(var d in this.notes){var e=this.notes[d],c=vec2.dist(e._end_screen,[b.mousex,gl.canvas.height-b.mousey]);if(30>c)return this._selected=e,AnnotationComponent.onShowPointAnnotation(this._root,e),!0}}};LS.registerComponent(AnnotationComponent);
function Rotator(a){this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45}Rotator.icon="mini-icon-rotator.png";Rotator.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};Rotator.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};
Rotator.prototype.onUpdate=function(a,b){if(this._root){var c=this._root._on_scene;this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var d=quat.setAxisAngle(quat.create(),this.axis,Math.sin(this.speed*Scene._global_time*2*Math.PI)*this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,d,this._default);this._root.transform._dirty=!0}else this.local_space?this._root.transform.rotateLocal(this.speed*b,this.axis):this._root.transform.rotate(this.speed*
b,this.axis);c&&LEvent.trigger(c,"change")}};LS.registerComponent(Rotator);function CameraController(a){this.speed=10;this.wheel_speed=this.rot_speed=1;this.smooth=!1;this.allow_panning=!0;this.cam_type="orbit";this._moving=vec3.fromValues(0,0,0);this.orbit_center=null;this._collision=vec3.create();this.configure(a)}CameraController.icon="mini-icon-cameracontroller.png";
CameraController.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousedown",this.onMouse,this);LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"mousewheel",this.onMouse,this);LEvent.bind(a,"keydown",this.onKey,this);LEvent.bind(a,"keyup",this.onKey,this);LEvent.bind(a,"update",this.onUpdate,this)};
CameraController.prototype.onUpdate=function(a){if(this._root){if(!this._root.transform&&this._root.camera&&(a=this._root.camera,"fps"==this.cam_type&&(0!=this._moving[0]||0!=this._moving[1]||0!=this._moving[2]))){var b=a.getLocalVector(this._moving);vec3.scale(b,b,this.speed*(this._move_fast?10:1));a.move(b);a.updateMatrices()}this.smooth&&Scene.refresh()}};
CameraController.prototype.onMouse=function(a,b){if(this._root){var c=this._root.camera;if(c)if(b||(b=a),"mousewheel"==b.eventType)c.orbitDistanceFactor(1+-0.001*b.wheel*this.wheel_speed,this.orbit_center),c.updateMatrices();else if("mousedown"==b.eventType&&this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,c.getCenter(),this._collision),b.dragging&&!this._root.transform)if("fps"==this.cam_type){c.rotate(-b.deltax*this.rot_speed,[0,1,0]);c.updateMatrices();var d=c.getLocalVector([1,
0,0]);c.rotate(-b.deltay*this.rot_speed,d);c.updateMatrices()}else"orbit"==this.cam_type&&(this.allow_panning&&(b.ctrlKey||1==b.button)?(d=vec3.create(),this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,c.getCenter(),d),d=vec3.sub(vec3.create(),this._collision,d),c.move(d),c.updateMatrices()):(c.orbit(-b.deltax*this.rot_speed,[0,1,0],this.orbit_center),c.updateMatrices(),d=c.getLocalVector([1,0,0]),c.orbit(-b.deltay*this.rot_speed,d,this.orbit_center)))}};
CameraController.prototype.testPerpendicularPlane=function(a,b,c,d){var e=this._root.camera;a=e.getRayInPixel(a,gl.canvas.height-b);b=e.getFront();c=c||e.getCenter();d=d||vec3.create();return geo.testRayPlane(a.start,a.direction,c,b,d)?!0:!1};
CameraController.prototype.onKey=function(a,b){this._root&&(87==b.keyCode?this._moving[2]="keydown"==b.type?-1:0:83==b.keyCode?this._moving[2]="keydown"==b.type?1:0:65==b.keyCode?this._moving[0]="keydown"==b.type?-1:0:68==b.keyCode?this._moving[0]="keydown"==b.type?1:0:16==b.keyCode&&(this._move_fast="keydown"==b.type?!0:!1))};LS.registerComponent(CameraController);function NodeManipulator(a){this.rot_speed=[1,1];this.smooth=!1;this.configure(a)}NodeManipulator.icon="mini-icon-rotator.png";
NodeManipulator.prototype.onAddedToNode=function(a){a.interactive=!0;LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"update",this.onUpdate,this)};NodeManipulator.prototype.onUpdate=function(a){this._root&&this._root.transform&&this.smooth&&Scene.refresh()};NodeManipulator.prototype.onMouse=function(a,b){this._root&&this._root.transform&&b.dragging&&(this._root.transform.rotate(b.deltax*this.rot_speed[0],[0,1,0]),this._root.transform.rotateLocal(-b.deltay*this.rot_speed[1],[1,0,0]))};LS.registerComponent(NodeManipulator);
function FaceTo(a){this.scale=1;this.target=null;this.reverse=this.cylindrical=!1}FaceTo.icon="mini-icon-billboard.png";FaceTo["@target"]={type:"node"};FaceTo.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updateOrientation,this)};
FaceTo.prototype.updateOrientation=function(a,b){if(this._root){var c=this._root._on_scene,d=null;if(this.target){d=c.getNode(this.target);if(!d)return;d=d.transform.getPosition()}else d=b.camera.getEye();var c=this._root.transform.getPosition(),e=b.camera.getLocalVector([0,1,0]);this.cylindrical&&(d[1]=c[1],e.set([0,1,0]));this.reverse||vec3.subtract(d,c,d);this._root.transform.lookAt(c,d,e);this._root.transform.setScale(this.scale)}};LS.registerComponent(FaceTo);
function FogFX(a){this.enabled=!0;this.start=100;this.end=1E3;this.density=0.001;this.type=FogFX.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);a&&this.configure(a)}FogFX.icon="mini-icon-fog.png";FogFX.LINEAR=1;FogFX.EXP=2;FogFX.EXP2=3;FogFX["@color"]={type:"color"};FogFX["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};FogFX["@type"]={type:"enum",values:{linear:FogFX.LINEAR,exponential:FogFX.EXP,"exponential 2":FogFX.EXP2}};
FogFX.prototype.onAddedToNode=function(a){LEvent.bind(Scene,"fillLightUniforms",this.fillUniforms,this);LEvent.bind(Scene,"fillMacros",this.fillMacros,this)};FogFX.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"fillLightUniforms",this.fillUniforms,this);LEvent.unbind(Scene,"fillMacros",this.fillMacros,this)};FogFX.prototype.fillUniforms=function(a,b){this.enabled&&(b.uniforms.u_fog_info=[this.start,this.end,this.density],b.uniforms.u_fog_color=b.light==b.lights[0]?this.color:[0,0,0])};
FogFX.prototype.fillMacros=function(a,b){if(this.enabled){var c=b.macros;c.USE_FOG="";switch(this.type){case FogFX.EXP:c.USE_FOG_EXP="";break;case FogFX.EXP2:c.USE_FOG_EXP2=""}}};LS.registerComponent(FogFX);function FollowNode(a){this.node_name="";this.follow_camera=this.fixed_y=!1;a&&this.configure(a)}FollowNode.icon="mini-icon-follow.png";FollowNode.prototype.onAddedToNode=function(a){LEvent.bind(a,"computeVisibility",this.updatePosition,this)};
FollowNode.prototype.updatePosition=function(a,b){if(this._root){var c=null,c=Scene.getCamera();if(this.follow_camera)c=c.getEye();else{c=Scene.getNode(this.node_name);if(!c)return;c=c.transform.getPosition()}this.fixed_y&&(c[1]=this._root.transform._position[1]);this._root.transform.setPosition(c)}};LS.registerComponent(FollowNode);function GeometricPrimitive(a){this.subdivisions=this.size=10;this.geometry=GeometricPrimitive.CUBE;this.primitive=null;this.align_z=!1;a&&this.configure(a)}
GeometricPrimitive.CUBE=1;GeometricPrimitive.PLANE=2;GeometricPrimitive.CYLINDER=3;GeometricPrimitive.SPHERE=4;GeometricPrimitive.icon="mini-icon-cube.png";GeometricPrimitive["@geometry"]={type:"enum",values:{Cube:GeometricPrimitive.CUBE,Plane:GeometricPrimitive.PLANE,Cylinder:GeometricPrimitive.CYLINDER,Sphere:GeometricPrimitive.SPHERE}};GeometricPrimitive["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4}};
GeometricPrimitive.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};GeometricPrimitive.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};
GeometricPrimitive.prototype.updateMesh=function(){var a=Math.max(1,this.subdivisions|0),b=""+this.geometry+"|"+this.size+"|"+a+"|"+this.align_z;switch(this.geometry){case GeometricPrimitive.CUBE:this._mesh=GL.Mesh.cube({size:this.size,normals:!0,coords:!0});break;case GeometricPrimitive.PLANE:this._mesh=GL.Mesh.plane({size:this.size,detail:a,xz:this.align_z,normals:!0,coords:!0});break;case GeometricPrimitive.CYLINDER:this._mesh=GL.Mesh.cylinder({size:this.size,subdivisions:a,normals:!0,coords:!0});
break;case GeometricPrimitive.SPHERE:this._mesh=GL.Mesh.sphere({size:this.size,"long":a,lat:a,normals:!0,coords:!0})}this._key=b};
GeometricPrimitive.prototype.onCollectInstances=function(a,b){if(this._root){var c=Math.max(1,this.subdivisions|0),c=""+this.geometry+"|"+this.size+"|"+c+"|"+this.align_z;this._mesh&&this._key==c||this.updateMesh();c=this._render_instance;c||(this._render_instance=c=new RenderInstance(this._root,this));this._root.transform.getGlobalMatrix(c.matrix);mat4.multiplyVec3(c.center,c.matrix,vec3.create());c.setMesh(this._mesh,this.primitive);this._root.mesh=this._mesh;c.material=this.material||this._root.getMaterial();
c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();b.push(c)}};LS.registerComponent(GeometricPrimitive);function GraphComponent(a){this.force_redraw=this.enabled=!0;this.on_event="update";this._graph=new LGraph;a?this.configure(a):(a=LiteGraph.createNode("scene/node"),this._graph.add(a));LEvent.bind(this,"trigger",this.trigger,this)}GraphComponent["@on_event"]={type:"enum",values:["start","render","update","trigger"]};GraphComponent.icon="mini-icon-graph.png";
GraphComponent.prototype.configure=function(a){this.enabled=!!a.enabled;if(a.graph_data)try{var b=JSON.parse(a.graph_data);this._graph.configure(b)}catch(c){console.err("Error parsing Graph data")}};GraphComponent.prototype.serialize=function(){return{enabled:this.enabled,force_redraw:this.force_redraw,graph_data:JSON.stringify(this._graph.serialize())}};
GraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;LEvent.bind(a,"start",this.onEvent,this);LEvent.bind(a,"beforeRenderMainPass",this.onEvent,this);LEvent.bind(a,"update",this.onEvent,this)};GraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"start",this.onEvent,this);LEvent.unbind(a,"beforeRenderMainPass",this.onEvent,this);LEvent.unbind(a,"update",this.onEvent,this)};
GraphComponent.prototype.onEvent=function(a){a=a.type;"beforeRenderMainPass"==a&&(a="render");this.on_event==a&&this.runGraph()};GraphComponent.prototype.trigger=function(a){"trigger"==this.on_event&&this.runGraph()};GraphComponent.prototype.runGraph=function(){this._root._in_tree&&this.enabled&&(this._graph&&this._graph.runStep(1),this.force_redraw&&LEvent.trigger(this._root._in_tree,"change"))};LS.registerComponent(GraphComponent);window.GraphComponent=GraphComponent;
function FXGraphComponent(a){this.enabled=!0;this.use_antialiasing=this.use_high_precision=this.use_viewport_size=!1;this._graph=new LGraph;a?this.configure(a):(this._graph_color_texture_node=LiteGraph.createNode("texture/texture","Color Buffer"),this._graph_color_texture_node.ignore_remove=!0,this._graph_depth_texture_node=LiteGraph.createNode("texture/texture","Depth Buffer"),this._graph_depth_texture_node.ignore_remove=!0,this._graph_depth_texture_node.pos[1]=400,this._graph.add(this._graph_color_texture_node),
this._graph.add(this._graph_depth_texture_node),this._graph_viewport_node=LiteGraph.createNode("texture/toviewport","Viewport"),this._graph_viewport_node.pos[0]=500,this._graph.add(this._graph_viewport_node),this._graph_color_texture_node.connect(0,this._graph_viewport_node));null==FXGraphComponent.high_precision_format&&(FXGraphComponent.high_precision_format=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.float_ext?gl.FLOAT:gl.UNSIGNED_BYTE)}FXGraphComponent.icon="mini-icon-graph.png";
FXGraphComponent.buffer_size=[1024,512];FXGraphComponent.prototype.configure=function(a){a.graph_data&&(this.enabled=!!a.enabled,this.use_viewport_size=!!a.use_viewport_size,this.use_high_precision=!!a.use_high_precision,this.use_antialiasing=!!a.use_antialiasing,this._graph.configure(JSON.parse(a.graph_data)),this._graph_color_texture_node=this._graph.findNodesByName("Color Buffer")[0],this._graph_depth_texture_node=this._graph.findNodesByName("Depth Buffer")[0],this._graph_viewport_node=this._graph.findNodesByName("Viewport")[0])};
FXGraphComponent.prototype.serialize=function(){return{enabled:this.enabled,use_antialiasing:this.use_antialiasing,use_high_precision:this.use_high_precision,use_viewport_size:this.use_viewport_size,graph_data:JSON.stringify(this._graph.serialize())}};FXGraphComponent.prototype.getResources=function(a){var b=this._graph.findNodesByType("texture/texture"),c;for(c in b)b[c].properties.name&&(a[b[c].properties.name]=Texture);return a};
FXGraphComponent.prototype.onAddedToNode=function(a){this._graph._scenenode=a;LEvent.bind(Scene,"beforeRenderPass",this.onBeforeRender,this);LEvent.bind(Scene,"afterRenderPass",this.onAfterRender,this)};FXGraphComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"beforeRenderPass",this.onBeforeRender,this);LEvent.unbind(Scene,"afterRenderPass",this.onAfterRender,this);Renderer.color_rendertarget=null;Renderer.depth_rendertarget=null};
FXGraphComponent.prototype.onBeforeRender=function(a,b){if(this._graph&&Renderer.render_fx){var c=!1;this._graph_depth_texture_node&&this._graph_depth_texture_node.isOutputConnected(0)&&(c=!0);var d=FXGraphComponent.buffer_size[0],e=FXGraphComponent.buffer_size[1];this.use_viewport_size&&(d=gl.canvas.width,e=gl.canvas.height);var f=this.use_high_precision?FXGraphComponent.high_precision_format:gl.UNSIGNED_BYTE;this.color_texture&&this.color_texture.width==d&&this.color_texture.height==e&&this.color_texture.type==
f||(this.color_texture=new GL.Texture(d,e,{format:gl.RGB,filter:gl.LINEAR,type:f}),ResourcesManager.textures[":color_buffer"]=this.color_texture);this.depth_texture&&this.depth_texture.width==d&&this.depth_texture.height==e||!c||(this.depth_texture=new GL.Texture(d,e,{filter:gl.NEAREST,format:gl.DEPTH_COMPONENT,type:gl.UNSIGNED_INT}),ResourcesManager.textures[":depth_buffer"]=this.depth_texture);this.enabled?(Renderer.color_rendertarget=this.color_texture,Renderer.depth_rendertarget=c?this.depth_texture:
null):(Renderer.color_rendertarget=null,Renderer.depth_rendertarget=null)}};
FXGraphComponent.prototype.onAfterRender=function(a,b){this._graph&&this.enabled&&Renderer.render_fx&&(this._graph_color_texture_node||(this._graph_color_texture_node=this._graph.findNodesByName("Color Buffer")[0]),this._depth_depth_texture_node||(this._depth_depth_texture_node=this._graph.findNodesByName("Depth Buffer")[0]),this._graph_color_texture_node&&(this._graph_color_texture_node.properties.name=":color_buffer",this._graph_depth_texture_node&&(this._graph_depth_texture_node.properties.name=
":depth_buffer"),this._graph_viewport_node&&(this._graph_viewport_node.properties.antialiasing=this.use_antialiasing),this._graph.runStep(1)))};LS.registerComponent(FXGraphComponent);window.FXGraphComponent=FXGraphComponent;function KnobComponent(a){this.value=0;this.delta=0.01;this.min_value=this.steps=0;this.max_value=1;this.min_angle=-120;this.max_angle=120;this.axis=vec3.fromValues(0,0,1);a&&this.configure(a)}KnobComponent.icon="mini-icon-knob.png";
KnobComponent.prototype.configure=function(a){cloneObject(a,this)};KnobComponent.prototype.serialize=function(){return cloneObject(this)};KnobComponent.prototype.onAddedToNode=function(a){a.interactive=!0;LEvent.bind(a,"mousemove",this.onmousemove,this);this.updateKnob()};
KnobComponent.prototype.updateKnob=function(){this._root&&(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+this.value/(this.max_value-this.min_value)*(this.max_angle-this.min_angle))*DEG2RAD),this._root.transform._dirty=!0)};
KnobComponent.prototype.onmousemove=function(a,b){this.value-=b.deltay*this.delta;this.value>this.max_value?this.value=this.max_value:this.value<this.min_value&&(this.value=this.min_value);this.updateKnob();LEvent.trigger(this,"change",this.value);this._root&&LEvent.trigger(this._root,"knobChange",this.value);a.stopPropagation()};LS.registerComponent(KnobComponent);
function ParticleEmissor(a){this.max_particles=1024;this.warm_up_time=0;this.emissor_type=ParticleEmissor.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=[10,10,10];this.emissor_mesh=null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this.particle_start_color=[1,1,1];this.particle_end_color=[1,1,1];this.particle_opacity_curve=[[0.5,1]];this.texture_grid_size=1;this.physics_gravity=[0,0,0];this.physics_friction=0;this.opacity=
1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.stop_update=!1;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=
this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;this.createMesh()}ParticleEmissor.icon="mini-icon-particles.png";ParticleEmissor.BOX_EMISSOR=1;ParticleEmissor.SPHERE_EMISSOR=2;ParticleEmissor.MESH_EMISSOR=3;ParticleEmissor.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};
ParticleEmissor.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this);LEvent.unbind(a,"start",this.onStart,this);LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ParticleEmissor.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};
ParticleEmissor.prototype.createParticle=function(a){a=a||{};switch(this.emissor_type){case ParticleEmissor.BOX_EMISSOR:a.pos=vec3.fromValues(this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5));break;case ParticleEmissor.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-1);a.pos=vec3.fromValues(Math.sin(c)*Math.cos(b),Math.sin(c)*Math.sin(b),Math.cos(c));vec3.multiply(a.pos,a.pos,this.emissor_size);break;
case ParticleEmissor.MESH_EMISSOR:(b=this.emissor_mesh)&&b.constructor==String&&(b=ResourcesManager.getMesh(this.emissor_mesh));b&&b.vertices?(c=3*Math.floor(Math.random()*b.vertices.length/3),a.pos=vec3.fromValues(b.vertices[c],b.vertices[c+1],b.vertices[c+2])):a.pos=vec3.create();break;default:a.pos=vec3.create()}vec3.add(a.pos,a.pos,this.follow_emitter?[0,0,0]:this._emissor_pos);a.vel=vec3.fromValues(Math.random()-0.5,Math.random()-0.5,Math.random()-0.5);a.life=this.particle_life;a.id=this._last_id;
a.angle=0;a.rot=this.particle_rotation+0.25*this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a.vel,a.vel,this.particle_speed);return a};ParticleEmissor.prototype.onStart=function(a){if(!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};
ParticleEmissor.prototype.onUpdate=function(a,b,c){this._root.transform&&this._root.transform.getGlobalPosition(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var d=vec3.clone(this.physics_gravity),e=this.physics_friction;a=[];for(var f=vec3.create(),g=0;g<this._particles.length;++g){var h=this._particles[g];vec3.copy(f,h.vel);vec3.add(f,d,f);vec3.scale(f,f,b);e&&(f[0]-=f[0]*e,f[1]-=f[1]*e,f[2]-=f[2]*e);vec3.add(h.pos,f,h.pos);h.angle+=h.rot*b;h.life-=b;0<h.life&&
a.push(h)}if(0!=this.emissor_rate)for(b=(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),g=0;g<b;g++)h=this.createParticle(),a.length<this.max_particles&&a.push(h);this._particles=a}this.align_always||c||this.updateMesh(Renderer.main_camera);LEvent.trigger(Scene,"change")};
ParticleEmissor.prototype.createMesh=function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);for(var a=0;a<this.max_particles;a++)this._coords.set([1,1,0,1,1,0,0,1,0,0,1,0],12*a),this._colors.set([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],24*a);this._computed_grid_size=1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,
coords:this._coords,colors:this._colors},null,gl.STREAM_DRAW);this._mesh_maxparticles=this.max_particles}};
ParticleEmissor.prototype.updateMesh=function(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,d=a.getLocalVector([0,0,1]),e=a.getLocalVector([1,0,0]),f=a.getLocalVector([0,1,0]);a=vec3.create();var g=vec3.fromValues(-1,0,-1),h=vec3.fromValues(1,0,-1),k=vec3.fromValues(-1,0,1),n=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(g,f,e),vec3.add(h,f,e),vec3.scale(k,h,-1),vec3.scale(n,g,-1));var e=vec3.create(),f=vec3.create(),p=
vec3.create(),m=vec3.create(),r=this._particles;if(this.sort_in_z){for(var r=this._particles.concat(),q=geo.createPlane(b,d),v=Math.sqrt(q[0]*q[0]+q[1]*q[1]+q[2]*q[2]),b=0;b<r.length;++b)r[b]._dist=Math.abs(vec3.dot(r[b].pos,q)+q[3])/v;r.sort(function(a,b){return a._dist<b._dist?1:a._dist>b._dist?-1:0});this._particles=r}0==this.particle_life&&(this.particle_life=1E-4);var q=new Float32Array([1,1,1,1]),v=new Float32Array(this.particle_start_color),w=new Float32Array(this.particle_end_color),s=!1;
(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size)&&!this.stop_update&&(s=!0,this._computed_grid_size=this.texture_grid_size);for(var x=1/this.texture_grid_size,t=0,u=0,B=this.texture_grid_size<<2,D=this.animated_texture,E=this.loop_animation,F=Scene._global_time*this.animation_fps,C=new Float32Array(60*this.particle_life<<0),G=new Float32Array(60*this.particle_life<<0),H=1/(60*this.particle_life),b=0;b<C.length;b+=1)C[b]=LS.getCurveValueAt(this.particle_opacity_curve,0,
1,0,b*H),G[b]=LS.getCurveValueAt(this.particle_size_curve,0,1,0,b*H);for(var H=quat.create(),z=t=b=0;z<r.length;++z)if(u=r[z],!(0>=u.life)){var t=1-u.life/this.particle_life,A=C[t*C.length<<0];this.independent_color&&u.c?vec3.clone(q,u.c):vec3.lerp(q,v,w,t);this.premultiplied_alpha?(vec3.scale(q,q,A),q[3]=1):q[3]=A;if(!(0.001>A)&&(A=this.particle_size*G[t*G.length<<0],!(Math.abs(A)<c)&&(vec3.scale(p,k,A),vec3.scale(f,h,A),vec3.scale(e,g,A),vec3.scale(m,n,A),0!=u.angle&&(quat.setAxisAngle(H,d,u.angle*
DEG2RAD),vec3.transformQuat(p,p,H),vec3.transformQuat(f,f,H),vec3.transformQuat(e,e,H),vec3.transformQuat(m,m,H)),vec3.add(a,u.pos,f),this._vertices.set(a,18*b),vec3.add(a,u.pos,e),this._vertices.set(a,18*b+3),vec3.add(a,u.pos,m),this._vertices.set(a,18*b+6),vec3.add(a,u.pos,e),this._vertices.set(a,18*b+9),vec3.add(a,u.pos,p),this._vertices.set(a,18*b+12),vec3.add(a,u.pos,m),this._vertices.set(a,18*b+15),this._colors.set(q,24*b),this._colors.set(q,24*b+4),this._colors.set(q,24*b+8),this._colors.set(q,
24*b+12),this._colors.set(q,24*b+16),this._colors.set(q,24*b+20),s&&(t=(D?(E?F:t)*B<<0:u.id)%B*x,u=1-(t<<0)*x-x,t%=1,this._coords.set([t+x,u+x,t,u+x,t+x,u,t,u+x,t,u,t+x,u],12*b)),++b,18*b>=this._vertices.length)))break}this._visible_particles=b;this._mesh.vertexBuffers.vertices.data=this._vertices;this._mesh.vertexBuffers.vertices.compile();this._mesh.vertexBuffers.colors.data=this._colors;this._mesh.vertexBuffers.colors.compile();s&&(this._mesh.vertexBuffers.coords.data=this._coords,this._mesh.vertexBuffers.coords.compile())};
ParticleEmissor._identity=mat4.create();
ParticleEmissor.prototype.onCollectInstances=function(a,b,c){if(this._root){a=Renderer.main_camera;this.align_always&&this.updateMesh(a);this._material||(this._material=new Material({opacity:this.opacity-0.01,shader:"lowglobalshader"}));this._material.opacity=this.opacity-0.01;this._material.setTexture(this.texture);this._material.blending=this.additive_blending?Material.ADDITIVE_BLENDING:Material.NORMAL;this._material.soft_particles=this.soft_particles;this._material.constant_diffuse=!0;if(!this._mesh)return null;
a=this._render_instance;a||(this._render_instance=a=new RenderInstance(this._root,this));this.follow_emitter?mat4.translate(a.matrix,ParticleEmissor._identity,this._root.transform._position):mat4.copy(a.matrix,ParticleEmissor._identity);a.material=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.flags=RI_DEFAULT_FLAGS|RI_IGNORE_FRUSTUM;a.applyNodeFlags();a.setMesh(this._mesh,gl.TRIANGLES);a.setRange(0,6*this._visible_particles);
b.push(a)}};LS.registerComponent(ParticleEmissor);function PlayAnimation(a){this.animation="";this.take="default";this.playback_speed=1;this.mode="loop";this.play=!0;this.current_time=0;a&&this.configure(a)}PlayAnimation["@animation"]={widget:"resource"};PlayAnimation["@mode"]={type:"enum",values:["loop","pingpong","once"]};PlayAnimation.prototype.configure=function(a){a.animation&&(this.animation=a.animation);a.take&&(this.take=a.take);null!=a.playback_speed&&(this.playback_speed=parseFloat(a.playback_speed))};
PlayAnimation.icon="mini-icon-reflector.png";PlayAnimation.prototype.onAddedToNode=function(a){LEvent.bind(a,"update",this.onUpdate,this)};PlayAnimation.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};PlayAnimation.prototype.onUpdate=function(a,b){if(this.animation){var c=LS.ResourcesManager.resources[this.animation];c&&(this.play&&(this.current_time+=b*this.playback_speed),c=c.takes[this.take])&&(c.actionPerSample(this.current_time,this._processSample),Scene.refresh())}};
PlayAnimation.prototype._processSample=function(a,b,c,d){if(a=Scene.getNode(a))switch(b){case "matrix":a.transform&&a.transform.fromMatrix(c)}};PlayAnimation.prototype.getResources=function(a){this.animation&&(a[this.animation]=LS.Animation)};LS.registerComponent(PlayAnimation);
function RealtimeReflector(a){this.texture_size=512;this.brightness_factor=1;this.colorclip_factor=0;this.clip_offset=0.5;this.rt_name="";this.use_mesh_info=this.generate_mipmaps=this.use_cubemap=!1;this.offset=vec3.create();this.ignore_this_mesh=!0;this.high_precision=!1;this.refresh_rate=1;this._rt=null;a&&this.configure(a)}RealtimeReflector.icon="mini-icon-reflector.png";RealtimeReflector["@texture_size"]={type:"enum",values:[64,128,256,512,1024,2048]};
RealtimeReflector.prototype.onAddedToNode=function(a){this._bind_onRenderRT||(this._bind_onRenderRT=this.onRenderRT.bind(this));LEvent.bind(a,"renderReflections",this._bind_onRenderRT,this)};RealtimeReflector.prototype.onRemoveFromNode=function(a){LEvent.unbind(a,"renderReflections",this._bind_onRenderRT,this)};
RealtimeReflector.prototype.onRenderRT=function(a){if(this._root&&(a=Renderer.main_camera,this.refresh_rate<<=0,0!=Scene._frame&&0==Scene._frame%this.refresh_rate||!this._rt)){isPowerOfTwo(this.texture_size)||(this.texture_size=256);var b=this.use_cubemap?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D,c=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._rt&&this._rt.width==this.texture_size&&this._rt.type==c&&this._rt.texture_type==b&&this._rt.mipmaps==this.generate_mipmaps||(this._rt=new Texture(this.texture_size,
this.texture_size,{type:c,texture_type:b,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR}),this._rt.mipmaps=this.generate_mipmaps);var b=this._root.transform.getGlobalPosition(),c=this._root.transform.getTop(),d=a.getEye(),e=a.getCenter(),f=a.getUp();if(this.use_mesh_info){var g=this._root.getMesh();g&&(b=this._root.transform.transformPointGlobal(g.vertices.subarray(0,3)),c=this._root.transform.transformVectorGlobal(g.normals.subarray(0,3)))}vec3.add(b,b,this.offset);var g=new Camera(a.serialize()),
h=this._root.flags.visible;this.ignore_this_mesh&&(this._root.flags.visible=!1);this.use_cubemap?(g.eye=b,Renderer.renderInstancesToRT(g,this._rt,{is_rt:!0,is_reflection:!0,brightness_factor:this.brightness_factor,colorclip_factor:this.colorclip_factor})):(g.fov=a.fov,g.aspect=a.aspect,g.eye=geo.reflectPointInPlane(d,b,c),g.center=geo.reflectPointInPlane(e,b,c),g.up=geo.reflectPointInPlane(f,[0,0,0],c),vec3.add(b,b,vec3.scale(vec3.create(),c,-this.clip_offset)),a=[c[0],c[1],c[2],vec3.dot(b,c)],Renderer.renderInstancesToRT(g,
this._rt,{clipping_plane:a,is_rt:!0,is_reflection:!0,brightness_factor:this.brightness_factor,colorclip_factor:this.colorclip_factor}));this.generate_mipmaps&&(this._rt.bind(),gl.generateMipmap(this._rt.texture_type));this._root.flags.visible=h;this.rt_name&&ResourcesManager.registerResource(this.rt_name,this._rt);this._root.material&&(a=this._root.getMaterial())&&a.setTexture(this.rt_name?this.rt_name:this._rt,Material.ENVIRONMENT_TEXTURE,Material.COORDS_SCREEN)}};LS.registerComponent(RealtimeReflector);
function ScriptComponent(a){this.enabled=!0;this.code="function update(dt)\n{\n\tScene.refresh();\n}";this._component=null;this._script=new LScript;this._script.valid_callbacks=ScriptComponent.valid_callbacks;this._last_error=null;this._script.onerror=function(a){this.onError(a)}.bind(this);this.configure(a);this.code&&this.processCode()}ScriptComponent.icon="mini-icon-script.png";ScriptComponent["@code"]={type:"script"};ScriptComponent.valid_callbacks=["start","update","trigger"];
ScriptComponent.prototype.getContext=function(){return this._script?this._script._context:null};ScriptComponent.prototype.processCode=function(){this._script.code=this.code;this._script.compile({component:this,node:this._root})};ScriptComponent.prototype.onAddedToNode=function(a){this._onStart_bind=this.onStart.bind(this);this._onUpdate_bind=this.onUpdate.bind(this);LEvent.bind(Scene,"start",this._onStart_bind);LEvent.bind(Scene,"update",this._onUpdate_bind)};
ScriptComponent.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"start",this._onStart_bind);LEvent.unbind(Scene,"update",this._onUpdate_bind)};ScriptComponent.prototype.onStart=function(){this.processCode();this._script.callMethod("start")};ScriptComponent.prototype.onUpdate=function(a,b){this._script.callMethod("update",[b])};ScriptComponent.prototype.onError=function(a){console.log("app stopping due to error in script");Scene.stop()};LS.registerComponent(ScriptComponent);
function TerrainRenderer(a){this.height=2;this.subdivisions=this.size=10;this.heightmap=null;this.auto_update=!0;this._mesh=null;this.action="Update";a&&this.configure(a)}TerrainRenderer.icon="mini-icon-terrain.png";TerrainRenderer.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};TerrainRenderer.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);this._root.mesh==this._mesh&&delete this._root.mesh};
TerrainRenderer.prototype.configure=function(a){cloneObject(a,this)};TerrainRenderer.prototype.serialize=function(){return cloneObject(this)};TerrainRenderer.prototype.getResources=function(a){this.heightmap&&(a[this.heightmap]=Texture)};TerrainRenderer["@subdivisions"]={widget:"number",min:1,max:255,step:1};TerrainRenderer["@heightmap"]={widget:"texture"};TerrainRenderer["@action"]={widget:"button",callback:function(){this.options.component.updateMesh()}};
TerrainRenderer.prototype.updateMesh=function(){trace("updating terrain mesh...");if(this.heightmap){var a="string"==typeof this.heightmap?ResourcesManager.textures[this.heightmap]:this.heightmap;if(a){var b=a.img;if(b){this.subdivisions>b.width&&(this.subdivisions=b.width);this.subdivisions>b.height&&(this.subdivisions=b.height);255<this.subdivisions&&(this.subdivisions=255);var a=0.5*this.size,c=this.subdivisions<<0,d=this.height,e=createCanvas(c,c),f=e.getContext("2d");f.drawImage(b,0,0,b.width,
b.height,0,0,e.width,e.height);for(var b=f.getImageData(0,0,e.width,e.height).data,e=[],f=[],g=[],h=[],k=detailX=c-1,n,p=a/(c-1),m=0;m<=k;m++)for(var r=m/k,q=0;q<=detailX;q++){var v=q/detailX;n=b[m*c*4+4*q]/255;f.push(a*(2*v-1),n*d,a*(2*r-1));h.push(v,1-r);0==q||0==m||q==detailX-1||m==k-1?g.push(0,1,0):(n=[-(b[m*c*4+4*(q+1)]/255-b[m*c*4+4*(q-1)]/255)*d,2*p,-(b[(m+1)*c*4+4*q]/255-b[(m-1)*c*4+4*q]/255)*d],vec3.normalize(n,n),g.push(n[0],n[1],n[2]));q<detailX&&m<k&&(n=q+m*(detailX+1),e.push(n+1,n,n+
detailX+1),e.push(n+1,n+detailX+1,n+detailX+2))}c=new GL.Mesh({vertices:f,normals:g,coords:h},{triangles:e});c.setBounding([0,0.5*this.height,0],[a,0.5*this.height,a]);this._mesh=c;this._info=[this.heightmap,this.size,this.height,this.subdivisions,this.smooth]}}}};TerrainRenderer.PLANE=null;
TerrainRenderer.prototype.onCollectInstances=function(a,b){!this._mesh&&this.heightmap&&this.updateMesh();this.auto_update&&this._info&&(this._info[0]==this.heightmap&&this._info[1]==this.size&&this._info[2]==this.height&&this._info[3]==this.subdivisions&&this._info[4]==this.smooth||this.updateMesh());var c=this._render_instance;c||(this._render_instance=c=new RenderInstance(this._root,this));if(!this._mesh)return TerrainRenderer.PLANE||(TerrainRenderer.PLANE=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),
c.mesh=TerrainRenderer.PLANE,c;c.material=this._root.getMaterial();c.setMesh(this._mesh,gl.TRIANGLES);this._root.mesh=this._mesh;this._root.transform.getGlobalMatrix(c.matrix);mat4.multiplyVec3(c.center,c.matrix,vec3.create());c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();b.push(c)};LS.registerComponent(TerrainRenderer);
function Cloner(a){this.count=[10,1,1];this.size=[100,100,100];this.material=this.lod_mesh=this.mesh=null;this.mode=Cloner.GRID_MODE;a&&this.configure(a);Cloner._identity||(Cloner._identity=mat4.create())}Cloner.GRID_MODE=1;Cloner.RADIAL_MODE=2;Cloner.icon="mini-icon-teapot.png";Cloner["@mesh"]={widget:"mesh"};Cloner["@lod_mesh"]={widget:"mesh"};Cloner["@mode"]={widget:"combo",values:{Grid:1,Radial:2}};Cloner["@count"]={widget:"vector3",min:1,step:1};
Cloner.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Cloner.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Cloner.prototype.getMesh=function(){return"string"===typeof this.mesh?ResourcesManager.meshes[this.mesh]:this.mesh};Cloner.prototype.getLODMesh=function(){return"string"===typeof this.lod_mesh?ResourcesManager.meshes[this.lod_mesh]:this.low_mesh};
Cloner.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};Cloner.generateTransformKey=function(a,b,c){var d=new Float32Array(9);d.set(a);d.set(b,3);d.set(c,6);return d};Cloner.compareKeys=function(a,b){for(var c=0;c<a.length;++c)if(a[c]!=b[c])return!1;return!0};
Cloner.prototype.onCollectInstances=function(a,b){var c=this.getMesh();if(!c)return null;if(this._root){var d=this.count[0]*this.count[1]*this.count[2];if(d){if(!this._RIs||this._RIs.length!=d){this._RIs?this._RIs.length=d:this._RIs=Array(d);for(var e=0;e<d;++e)this._RIs[e]||(this._RIs[e]=new RenderInstance(this._root,this))}var f=this._RIs,g=this._root.transform.getGlobalMatrix(mat4.create()),h=this.material||this._root.getMaterial(),k=vec3.scale(vec3.create(),this.size,0.5),n=[0,0,0];1<this.count[0]?
n[0]=this.size[0]/(this.count[0]-1):k[0]=0;1<this.count[1]?n[1]=this.size[1]/(this.count[1]-1):k[1]=0;1<this.count[2]?n[2]=this.size[2]/(this.count[2]-1):k[2]=0;var p=0,m=b.length;b.length=m+d;for(var e=0,d=vec3.create(),r=vec3.create(),q=0;q<this.count[0];++q)for(var v=0;v<this.count[1];++v)for(var w=0;w<this.count[2];++w){var s=f[e];0==e?(s.flags=RI_DEFAULT_FLAGS,s.applyNodeFlags(),p=s.flags):s.flags=p;s.setMesh(c);s.material=h;d.set([q*n[0]-k[0],v*n[1]-k[1],w*n[2]-k[2]]);mat4.translate(s.matrix,
g,d);mat4.multiplyVec3(s.center,s.matrix,r);b[m+e]=s;++e}}}};LS.registerComponent(Cloner);LS.Cloner=Cloner;function Spherize(a){this._uid||(this._uid=LS.generateUId());this.radius=10;this.center=vec3.create();this.factor=0.5;this._uniforms_code=Spherize._uniforms_code.replaceAll({"@":this._uid});this._code=Spherize._code.replaceAll({"@":this._uid})}Spherize["@factor"]={type:"number",step:0.001};Spherize.icon="mini-icon-rotator.png";
Spherize.prototype.onAddedToNode=function(a){LEvent.bind(a,"computingShaderMacros",this.onMacros,this);LEvent.bind(a,"computingShaderUniforms",this.onUniforms,this)};Spherize.prototype.onRemoveFromNode=function(a){LEvent.unbindAll(a,this)};Spherize._uniforms_code="uniform vec3 u_spherize_center@; uniform float u_spherize_radius@; uniform float u_spherize_factor@;";Spherize._code="vec3 vn@ = normalize(vertex-u_spherize_center@); vertex = mix(vertex, vn@ * u_spherize_radius@, u_spherize_factor@); v_normal = (mix(v_normal, vn@, clamp(0.0,1.0,u_spherize_factor@)));";
Spherize.prototype.onMacros=function(a,b){b.USE_VERTEX_SHADER_UNIFORMS=b.USE_VERTEX_SHADER_UNIFORMS?b.USE_VERTEX_SHADER_UNIFORMS+this._uniforms_code:this._uniforms_code;b.USE_VERTEX_SHADER_CODE=b.USE_VERTEX_SHADER_CODE?b.USE_VERTEX_SHADER_CODE+this._code:this._code};Spherize.prototype.onUniforms=function(a,b){b["u_spherize_center"+this._uid]=this.center;b["u_spherize_radius"+this._uid]=this.radius;b["u_spherize_factor"+this._uid]=this.factor};LS.registerComponent(Spherize);
function OculusController(a){this.enabled=!0;this.eye_distance=1;a&&this.configure(a)}OculusController.rift_server_url="http://tamats.com/uploads/RiftServer_0_3.zip";OculusController.icon="mini-icon-graph.png";
OculusController.prototype.onAddedToNode=function(a){LEvent.bind(Scene,"start",this.onStart,this);LEvent.bind(Scene,"stop",this.onStop,this);LEvent.bind(Scene,"beforeRender",this.onBeforeRender,this);LEvent.bind(Scene,"afterRender",this.onAfterRender,this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};
OculusController.prototype.onRemovedFromNode=function(a){LEvent.unbind(Scene,"start",this.onStart,this);LEvent.unbind(Scene,"stoo",this.onStop,this);LEvent.unbind(Scene,"beforeRender",this.onBeforeRender,this);LEvent.unbind(Scene,"afterRender",this.onAfterRender,this);LEvent.unbind(a,"collectCameras",this.onCollectCameras,this);Renderer.color_rendertarget=null};
OculusController.prototype.onCollectCameras=function(a,b){var c=Renderer.main_camera;this._orientation&&c.setOrientation(this._orientation,!0);var d=c.getLocalVector([0.5*this.eye_distance,0,0]),e=vec3.scale(vec3.create(),d,-1);this._left_camera||(this._left_camera=new LS.Camera,this._right_camera=new LS.Camera);var f=c.serialize();this._left_camera.configure(f);this._right_camera.configure(f);this._left_camera.eye=vec3.add(vec3.create(),c.eye,e);this._right_camera.eye=vec3.add(vec3.create(),c.eye,
d);this._left_camera._viewport.set([0,0,0.5,1]);this._right_camera._viewport.set([0.5,0,0.5,1]);this._right_camera._ignore_clear=!0;b.push(this._left_camera,this._right_camera)};
OculusController.prototype.onStart=function(a){a=new WebSocket("ws://localhost:1981");a.onopen=function(){console.log("OVR connection stablished")};a.onmessage=this.onMessage.bind(this);a.onclose=function(){console.log("OVR connection lost")};a.onerror=function(){console.error("Oculus Server not found in your machine. To run an app using Oculus Rift you need to use a client side app, you can download it from: "+OculusController.rift_server_url)};this._ws=a};
OculusController.prototype.onMessage=function(a){var b=a.data,b=JSON.parse("["+b+"]");a=quat.create();a.set(b);b=quat.fromValues(-1,0,0,0);quat.multiply(a,b,a);this._orientation=a;Scene.refresh()};OculusController.prototype.onStop=function(a){this._ws&&(this._ws.close(),this._ws=null)};
OculusController.prototype.onBeforeRender=function(a,b){var c=1024,d=512,d=gl.getParameter(gl.VIEWPORT),c=d[2],d=d[3];this._color_texture&&this._color_texture.width==c&&this._color_texture.height==d||(this._color_texture=new GL.Texture(c,d,{format:gl.RGB,filter:gl.LINEAR}),ResourcesManager.textures[":ovr_color_buffer"]=this._color_texture);Renderer.color_rendertarget=this.enabled?this._color_texture:null};OculusController.prototype.onAfterRender=function(a,b){this._color_texture&&this._color_texture.toViewport()};
LS.registerComponent(OculusController);window.OculusController=OculusController;
if("undefined"!=typeof LiteGraph){var LGraphTransform=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id);this.addInput("Transform","Transform");this.addOutput("Position","vec3")};LGraphTransform.title="Transform";LGraphTransform.desc="Transform info of a node";LGraphTransform.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);
for(var b in this.inputs){var c=this.inputs[b],d=this.getInputData(b);if(void 0!=d)switch(c.name){case "Position":a.transform.setPosition(d);break;case "Rotation":a.transform.setRotation(d);break;case "Scale":a.transform.setScale(d)}}for(b in this.outputs)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Position":this.setOutputData(b,a.transform.getPosition());break;case "Rotation":this.setOutputData(b,a.transform.getRotation());break;case "Scale":this.setOutputData(b,a.transform.getScale(scale))}};
LGraphTransform.prototype.onGetInputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LGraphTransform.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["Enabled","boolean"]]};LiteGraph.registerNodeType("scene/transform",LGraphTransform);window.LGraphTransform=LGraphTransform;var LGraphSceneNode=function(){this.properties={node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id)};
LGraphSceneNode.title="SceneNode";LGraphSceneNode.desc="Node on the scene";LGraphSceneNode.prototype.getNode=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);return a};LGraphSceneNode.prototype.onExecute=function(){var a=this.getNode(),b;for(b in this.inputs){var c=this.inputs[b],d=this.getInputData(b);if(void 0!=d)switch(c.name){case "Transform":a.transform.copyFrom(d);break;case "Material":a.material=d;break;case "Visible":a.flags.visible=
d}}for(b in this.outputs)if(c=this.outputs[b],c.links&&c.links.length)switch(c.name){case "Transform":this.setOutputData(b,a.getTransform());break;case "Material":this.setOutputData(b,a.getMaterial());break;case "Light":this.setOutputData(b,a.getLight());break;case "Camera":this.setOutputData(b,a.getCamera());break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible)}};LGraphSceneNode.prototype.onGetInputs=function(){return[["Transform","Transform"],
["Material","Material"],["Mesh","Mesh"],["Enabled","boolean"]]};LGraphSceneNode.prototype.onGetOutputs=function(){var a=this.getNode(),b=[["Transform","Transform"],["Material","Material"],["Mesh","Mesh"],["Enabled","boolean"]];a.light&&b.push(["Light","Light"]);a.camera&&b.push(["Camera","Camera"]);return b};LiteGraph.registerNodeType("scene/node",LGraphSceneNode);window.LGraphSceneNode=LGraphSceneNode;var LGraphMaterial=function(){this.properties={mat_name:""};this.addInput("Material","Material");
this.size=[100,20]};LGraphMaterial.title="Material";LGraphMaterial.desc="Material of a node";LGraphMaterial.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);var b=null;a&&(b=a.getMaterial());a=this.findInputSlot("Material");-1!=a&&(b=this.getInputData(a));b||(b=new Material);for(var c in this.inputs){var d=this.inputs[c],a=this.getInputData(c);if(void 0!=a)switch(d.name){case "Alpha":b.alpha=a;break;case "Specular f.":b.specular_factor=
a;break;case "Diffuse":vec3.copy(b.diffuse,a);break;case "Ambient":vec3.copy(b.ambient,a);break;case "Emissive":vec3.copy(b.emissive,a);break;case "UVs trans.":b.uvs_matrix.set(a);break;default:"Tex."==d.name.substr(0,4)&&(d=d.name.substr(4),b.setTexture(a,d))}}for(c in this.outputs)if(a=this.outputs[c],a.links&&a.links.length){switch(a.name){case "Material":a=b;break;case "Alpha":a=b.alpha;break;case "Specular f.":a=b.specular_factor;break;case "Diffuse":a=b.diffuse;break;case "Ambient":a=b.ambient;
break;case "Emissive":a=b.emissive;break;case "UVs trans.":a=b.uvs_matrix;break;default:continue}this.setOutputData(c,a)}};LGraphMaterial.prototype.onGetInputs=function(){var a=[["Material","Material"],["Alpha","number"],["Specular f.","number"],["Diffuse","color"],["Ambient","color"],["Emissive","color"],["UVs trans.","texmatrix"]],b;for(b in Material.TEXTURE_CHANNELS)a.push(["Tex."+Material.TEXTURE_CHANNELS[b],"Texture"]);return a};LGraphMaterial.prototype.onGetOutputs=function(){var a=[["Material",
"Material"],["Alpha","number"],["Specular f.","number"],["Diffuse","color"],["Ambient","color"],["Emissive","color"],["UVs trans.","texmatrix"]],b;for(b in Material.TEXTURE_CHANNELS)a.push(["Tex."+Material.TEXTURE_CHANNELS[b],"Texture"]);return a};LiteGraph.registerNodeType("scene/material",LGraphMaterial);window.LGraphMaterial=LGraphMaterial;var LGraphLight=function(){this.properties={mat_name:""};this.addInput("Light","Light");this.addOutput("Intensity","number");this.addOutput("Color","color")};
LGraphLight.title="Light";LGraphLight.desc="Light from a scene";LGraphLight.prototype.onExecute=function(){var a=this._node;this.properties.node_id&&(a=Scene.getNode(this.properties.node_id));a||(a=this.graph._scenenode);var b=null;a&&(b=a.getLight());a=this.findInputSlot("Light");-1!=a&&(b=this.getInputData(a));if(b){for(var c in this.inputs){var a=this.inputs[c],d=this.getInputData(c);if(void 0!=d)switch(a.name){case "Intensity":b.intensity=d;break;case "Color":vec3.copy(b.color,d);break;case "Eye":vec3.copy(b.eye,
d);break;case "Center":vec3.copy(b.center,d)}}for(c in this.outputs)if(a=this.outputs[c],a.links&&a.links.length)switch(a.name){case "Light":this.setOutputData(c,b);break;case "Intensity":this.setOutputData(c,b.intensity);break;case "Color":this.setOutputData(c,b.color);break;case "Eye":this.setOutputData(c,b.eye);break;case "Center":this.setOutputData(c,b.center)}}};LGraphLight.prototype.onGetInputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center",
"vec3"]]};LGraphLight.prototype.onGetOutputs=function(){return[["Light","Light"],["Intensity","number"],["Color","color"],["Eye","vec3"],["Center","vec3"]]};LiteGraph.registerNodeType("scene/light",LGraphLight);window.LGraphLight=LGraphLight;var LGraphScene=function(){this.addOutput("Time","number")};LGraphScene.title="Scene";LGraphScene.desc="Scene";LGraphScene.prototype.onExecute=function(){for(var a in this.inputs){var b=this.inputs[a],c=this.getInputData(a);if(void 0!=c)switch(b.name){case "Ambient color":vec3.copy(Scene.ambient_color,
c);break;case "Bg Color":vec3.copy(Scene.background_color,c)}}for(a in this.outputs)if(b=this.outputs[a],b.links&&b.links.length)switch(b.name){case "Light":this.setOutputData(a,Scene.light);break;case "Camera":this.setOutputData(a,Scene.camera);break;case "Ambient color":this.setOutputData(a,Scene.ambient_color);break;case "Bg Color":this.setOutputData(a,Scene.background_color);break;case "Time":this.setOutputData(a,Scene._time);break;case "Elapsed":this.setOutputData(a,null!=Scene._last_dt?Scene._last_dt:
0);break;case "Frame":this.setOutputData(a,null!=Scene._frame?Scene._frame:0)}};LGraphScene.prototype.onGetOutputs=function(){return[["Light","Light"],["Camera","Camera"],["Ambient color","color"],["Bg Color","color"],["Elapsed","number"],["Frame","number"]]};LiteGraph.registerNodeType("scene/scene",LGraphScene);window.LGraphScene=LGraphScene;var LGraphGlobal=function(){this.addOutput("Value","number");this.properties={name:"myvar",value:0,min:0,max:1}};LGraphGlobal.title="Global";LGraphGlobal.desc=
"Global var for the graph";LGraphGlobal.prototype.onExecute=function(){this.properties.name&&this.setOutputData(0,this.properties.value)};LiteGraph.registerNodeType("scene/global",LGraphGlobal);window.LGraphGlobal=LGraphGlobal}
if("undefined"!=typeof LiteGraph){var LGraphTexture=function(){this.addOutput("Texture","Texture");this.properties={name:""};this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]};LGraphTexture.title="Texture";LGraphTexture.desc="Texture";LGraphTexture.widgets_info={name:{widget:"texture"}};LGraphTexture.textures_container=null;LGraphTexture.loadTextureCallback=null;LGraphTexture.prototype.onExecute=function(){if(this.properties.name&&ResourcesManager){var a=LGraphTexture.textures_container;
a||"undefined"==typeof ResourcesManager||(a=ResourcesManager.textures);if(!a)throw"Cannot load texture, container of textures not found";(a=a[this.properties.name])||":"==this.properties.name[0]?(this._last_tex=a,this.setOutputData(0,a)):(LGraphTexture.loadTextureCallback||"undefined"==typeof ResourcesManager||(LGraphTexture.loadTextureCallback=ResourcesManager.load.bind(ResourcesManager)),(a=LGraphTexture.loadTextureCallback)&&a(this.properties.name))}};LGraphTexture.prototype.onDrawBackground=function(a){if(this.properties.name&&
!(this.flags.collapsed||20>=this.size[1])){if(this._last_preview_tex!=this._last_tex){var b=LGraphTexture.generateLowResTexturePreview(this._last_tex);if(!b)return;this._last_preview_tex=this._last_tex;this._canvas=cloneCanvas(b)}this._canvas&&(a.save(),a.translate(0,this.size[1]),a.scale(1,-1),a.drawImage(this._canvas,0,0,this.size[0],this.size[1]),a.restore())}};LGraphTexture.image_preview_size=256;LGraphTexture.generateLowResTexturePreview=function(a){if(!a)return null;var b=LGraphTexture.image_preview_size,
c=a;if(a.width>b||a.height>b)c=this._preview_temp_tex,this._preview_temp_tex||(this._preview_temp_tex=c=new GL.Texture(b,b,{minFilter:gl.NEAREST})),a.copyTo(c);a=this._preview_canvas;a||(this._preview_canvas=a=createCanvas(b,b));c&&c.toCanvas(a);return a};LiteGraph.registerNodeType("texture/texture",LGraphTexture);window.LGraphTexture=LGraphTexture;var LGraphTextureSave=function(){this.addInput("Texture","Texture");this.properties={name:""}};LGraphTextureSave.title="Save";LGraphTextureSave.desc="Save a texture in the repository";
LGraphTextureSave.prototype.onExecute=function(){if(this.properties.name){var a=this.getInputData(0);a&&(ResourcesManager.textures[this.properties.name]=a)}};LiteGraph.registerNodeType("texture/save",LGraphTextureSave);window.LGraphTextureSave=LGraphTextureSave;var LGraphTextureOperation=function(){this.addInput("Texture","Texture");this.addInput("TextureB","Texture");this.addInput("value","number");this.addOutput("Texture","Texture");this.help="<p>pixelcode must be vec3</p>\t\t\t<p>uvcode must be vec2, is optional</p>\t\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture</p><p><strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time</p><p><strong>value:</strong> input value</p>";
this.properties={value:1,uvcode:"",pixelcode:"color + colorB * value",low_precision:!1}};LGraphTextureOperation.widgets_info={uvcode:{widget:"textarea",height:100},pixelcode:{widget:"textarea",height:100}};LGraphTextureOperation.title="Operation";LGraphTextureOperation.desc="Texture shader operation";LGraphTextureOperation.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var c=512,d=512,e=gl.UNSIGNED_BYTE;a?(c=a.width,
d=a.height,e=a.type):b&&(c=b.width,d=b.height,e=b.type);this.properties.low_precision&&(e=gl.UNSIGNED_BYTE);this._tex&&this._tex.width==c&&this._tex.height==d&&this._tex.type==e||(this._tex=new GL.Texture(c,d,{type:e,format:gl.RGBA,filter:gl.LINEAR}));e="";this.properties.uvcode&&(e="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(e=this.properties.uvcode));var f="";this.properties.pixelcode&&(f="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";")&&
(f=this.properties.pixelcode));var g=this._shader;g&&this._shader_code==e+"|"+f||(this._shader=new GL.Shader(LGraphTextureOperation.vertex_shader,LGraphTextureOperation.pixel_shader,{UV_CODE:e,PIXEL_CODE:f}),this._shader_code=e+"|"+f,g=this._shader);if(g){this.boxcolor="green";var h=this.getInputData(2);null!=h?this.properties.value=h:h=parseFloat(this.properties.value);this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);a&&a.bind(0);b&&b.bind(1);var e=
Mesh.getScreenQuad();g.uniforms({texture:0,textureB:1,value:h,texSize:[c,d],time:Scene._global_time-Scene._start_time}).draw(e)});this.setOutputData(0,this._tex)}else this.boxcolor="red"}};LGraphTextureOperation.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tcoord = a_coord; gl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureOperation.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D texture;\n\t\t\tuniform sampler2D textureB;\n\t\t\tvarying vec2 coord;\n\t\t\tuniform vec2 texSize;\n\t\t\tuniform float time;\n\t\t\tuniform float value;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = coord;\n\t\t\t\tUV_CODE;\n\t\t\t\tvec3 color = texture2D(texture, uv).rgb;\n\t\t\t\tvec3 colorB = texture2D(textureB, uv).rgb;\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tPIXEL_CODE;\n\t\t\t\tgl_FragColor = vec4(result, 1.0);\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/operation",LGraphTextureOperation);window.LGraphTextureOperation=LGraphTextureOperation;var LGraphTextureShader=function(){this.addOutput("Texture","Texture");this.properties={code:"",width:512,height:512};this.properties.code="\nvoid main() {\n  vec2 uv = coord;\n  vec3 color = vec3(0.0);\n//your code here\n\ngl_FragColor = vec4(color, 1.0);\n}\n";this.widgets_info={code:{widget:"textarea",height:100}}};LGraphTextureShader.title="Shader";LGraphTextureShader.desc=
"Texture shader";LGraphTextureShader.prototype.onExecute=function(){if(this._shader_code!=this.properties.code)if(this._shader_code=this.properties.code,this._shader=new GL.Shader(LGraphTextureShader.vertex_shader,LGraphTextureShader.pixel_shader+this.properties.code))this.boxcolor="green";else{this.boxcolor="red";return}this._tex&&this._tex.width==this.properties.width&&this._tex.height==this.properties.height||(this._tex=new GL.Texture(this.properties.width,this.properties.height,{format:gl.RGBA,
filter:gl.LINEAR}));var a=this._tex,b=this._shader;a.drawTo(function(){b.uniforms({texSize:[a.width,a.height],time:Scene._global_time-Scene._start_time}).draw(Mesh.getScreenQuad())});this.setOutputData(0,this._tex)};LGraphTextureShader.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tcoord = a_coord; gl_Position = vec4(coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureShader.pixel_shader=
"precision highp float;\n\t\t\t\n\t\t\tvarying vec2 coord;\n\t\t\tuniform float time;\n\t\t\t";LiteGraph.registerNodeType("texture/shader",LGraphTextureShader);window.LGraphTextureShader=LGraphTextureShader;var LGraphTexturePreview=function(){this.addInput("Texture","Texture");this.properties={flipY:!1};this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]};LGraphTexturePreview.title="Preview";LGraphTexturePreview.desc="Show a texture in the graph canvas";LGraphTexturePreview.prototype.onDrawBackground=
function(a){if(!this.flags.collapsed){var b=this.getInputData(0);b&&(b=LGraphTexture.generateLowResTexturePreview(b),a.save(),this.properties.flipY&&(a.translate(0,this.size[1]),a.scale(1,-1)),a.drawImage(b,0,0,this.size[0],this.size[1]),a.restore())}};LiteGraph.registerNodeType("texture/preview",LGraphTexturePreview);window.LGraphTexturePreview=LGraphTexturePreview;var LGraphTextureToViewport=function(){this.addInput("Texture","Texture");this.properties={additive:!1,antialiasing:!1};LGraphTextureToViewport._shader||
(LGraphTextureToViewport._shader=new GL.Shader(LGraphTextureToViewport.vertex_shader,LGraphTextureToViewport.pixel_shader))};LGraphTextureToViewport.title="to Viewport";LGraphTextureToViewport.desc="Texture to viewport";LGraphTextureToViewport.prototype.onExecute=function(){var a=this.getInputData(0);if(a)if(this.properties.additive?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)):gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this.properties.antialiasing){gl.getViewport();a&&a.bind(0);var b=
Mesh.getScreenQuad();LGraphTextureToViewport._shader.uniforms({texture:0,uViewportSize:[a.width,a.height],inverseVP:[1/a.width,1/a.height]}).draw(b)}else a.toViewport()};LGraphTextureToViewport.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureToViewport.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 uViewportSize;\n\t\t\tuniform vec2 inverseVP;\n\t\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\t\n\t\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t\t{\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\t\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\t\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\t\n\t\t\t\tvec2 dir;\n\t\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\t\n\t\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\t\n\t\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\t\t\t\t\n\t\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\t\t\t\t\n\t\t\t\treturn vec4(rgbA,1.0);\n\t\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\t\telse\n\t\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\t\treturn color;\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/toviewport",LGraphTextureToViewport);window.LGraphTextureToViewport=LGraphTextureToViewport;var LGraphTextureCopy=function(){this.addInput("Texture","Texture");this.addOutput("","Texture");this.properties={size:0,low_precision:!1}};LGraphTextureCopy.title="Copy";LGraphTextureCopy.desc="Copy Texture";LGraphTextureCopy.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]}};LGraphTextureCopy.prototype.onExecute=function(){var a=this.getInputData(0);
if(a){var b=a.width,c=a.height;0!=this.properties.size&&(c=b=this.properties.size);var d=this._temp_texture,e=this.properties.low_precision?gl.UNSIGNED_BYTE:a.type;d&&d.width==b&&d.height==c&&d.type==e||(this._temp_texture=new GL.Texture(b,c,{type:e,format:gl.RGBA,filter:gl.LINEAR}));a.copyTo(this._temp_texture);this.setOutputData(0,this._temp_texture)}};LiteGraph.registerNodeType("texture/copy",LGraphTextureCopy);window.LGraphTextureCopy=LGraphTextureCopy;var LGraphTextureLUT=function(){this.addInput("Texture",
"Texture");this.addInput("LUT","Texture");this.addInput("Intensity","number");this.addOutput("","Texture");this.properties={intensity:1};LGraphTextureLUT._shader||(LGraphTextureLUT._shader=new GL.Shader(LGraphTextureLUT.vertex_shader,LGraphTextureLUT.pixel_shader))};LGraphTextureLUT.title="LUT";LGraphTextureLUT.desc="Apply LUT to Texture";LGraphTextureLUT.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=this.getInputData(1);if(b){b.bind(0);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,
gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);var c=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=c=this.getInputData(2));var d=a.width,e=a.height,f=this._temp_texture;f&&f.width==d&&f.height==e||(this._temp_texture=new GL.Texture(d,e,{format:gl.RGBA,filter:gl.LINEAR}));var g=Mesh.getScreenQuad();this._temp_texture.drawTo(function(){a.bind(0);
b.bind(1);LGraphTextureLUT._shader.uniforms({texture:0,textureB:1,u_amount:c,uViewportSize:[a.width,a.height]}).draw(g)});this.setOutputData(0,this._temp_texture)}else this.setOutputData(0,a)}};LGraphTextureLUT.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 coord;\n\t\t\tvoid main() {\n\t\t\t\tcoord = a_coord; gl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";LGraphTextureLUT.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 coord;\n\t\t\tuniform sampler2D texture;\n\t\t\tuniform sampler2D textureB;\n\t\t\tuniform float u_amount;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\t lowp vec4 textureColor = clamp( texture2D(texture, coord), vec4(0.0), vec4(1.0) );\n\t\t\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t\t\t mediump vec2 quad1;\n\t\t\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t\t\t mediump vec2 quad2;\n\t\t\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t\t\t highp vec2 texPos1;\n\t\t\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t\t highp vec2 texPos2;\n\t\t\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t\t lowp vec4 newColor1 = texture2D(textureB, texPos1);\n\t\t\t\t lowp vec4 newColor2 = texture2D(textureB, texPos2);\n\t\t\t\t lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t\t\t gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/LUT",LGraphTextureLUT);window.LGraphTextureLUT=LGraphTextureLUT;var LGraphTextureChannels=function(){this.addInput("Texture","Texture");this.addOutput("R","Texture");this.addOutput("G","Texture");this.addOutput("B","Texture");this.addOutput("A","Texture");this.properties={};LGraphTextureChannels._shader||(LGraphTextureChannels._shader=new GL.Shader(LGraphTextureChannels.vertex_shader,LGraphTextureChannels.pixel_shader))};LGraphTextureChannels.title="Channels";LGraphTextureChannels.desc=
"Split texture channels";LGraphTextureChannels.prototype.onExecute=function(){var a=this.getInputData(0);if(a){this._channels||(this._channels=Array(4));for(var b=0,c=0;4>c;c++)this.isOutputConnected(c)?(this._channels[c]&&this._channels[c].width==a.width&&this._channels[c].height==a.height&&this._channels[c].type==a.type||(this._channels[c]=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR})),b++):this._channels[c]=null;if(b){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);
for(var d=Mesh.getScreenQuad(),e=LGraphTextureChannels._shader,f=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],c=0;4>c;c++)this._channels[c]&&(this._channels[c].drawTo(function(){a.bind(0);e.uniforms({u_texture:0,u_mask:f[c]}).draw(d)}),this.setOutputData(c,this._channels[c]))}}};LGraphTextureChannels.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureChannels.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\t\t\t}\n\t\t\t";LiteGraph.registerNodeType("texture/channels",LGraphTextureChannels);window.LGraphTextureChannels=LGraphTextureChannels;var LGraphTextureMix=function(){this.addInput("A","Texture");
this.addInput("B","Texture");this.addInput("Mixer","Texture");this.addOutput("Texture","Texture");this.properties={};LGraphTextureMix._shader||(LGraphTextureMix._shader=new GL.Shader(LGraphTextureMix.vertex_shader,LGraphTextureMix.pixel_shader))};LGraphTextureMix.title="Mix";LGraphTextureMix.desc="Generates a texture mixing two textures";LGraphTextureMix.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2);if(a&&b&&c){this._temp_texture&&this._temp_texture.width==
a.width&&this._temp_texture.height==a.height&&this._temp_texture.type==a.type||(this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var d=Mesh.getScreenQuad(),e=LGraphTextureMix._shader;this._temp_texture.drawTo(function(){a.bind(0);b.bind(1);c.bind(2);e.uniforms({u_textureA:0,u_textureB:1,u_textureMix:2}).draw(d)});this.setOutputData(0,this._temp_texture)}};LGraphTextureMix.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureMix.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_textureA;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform sampler2D u_textureMix;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), texture2D(u_textureMix, v_coord) );\n\t\t\t}\n\t\t\t";LiteGraph.registerNodeType("texture/mix",LGraphTextureMix);window.LGraphTextureMix=LGraphTextureMix;
var LGraphTextureDepthRange=function(){this.addInput("Texture","Texture");this.addInput("Distance","number");this.addInput("Range","number");this.addOutput("Texture","Texture");this.properties={distance:100,range:50,high_precision:!1};LGraphTextureDepthRange._shader||(LGraphTextureDepthRange._shader=new GL.Shader(LGraphTextureDepthRange.vertex_shader,LGraphTextureDepthRange.pixel_shader))};LGraphTextureDepthRange.title="Depth Range";LGraphTextureDepthRange.desc="Generates a texture with a depth range";
LGraphTextureDepthRange.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=gl.UNSIGNED_BYTE;this.properties.high_precision&&(b=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT);this._temp_texture&&this._temp_texture.type==b&&this._temp_texture.width==a.width&&this._temp_texture.height==a.height||(this._temp_texture=new GL.Texture(a.width,a.height,{type:b,format:gl.RGBA,filter:gl.LINEAR}));var c=this.properties.distance;this.isInputConnected(1)&&(c=this.getInputData(1),this.properties.distance=
c);var d=this.properties.range;this.isInputConnected(2)&&(d=this.getInputData(2),this.properties.range=d);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);var e=Mesh.getScreenQuad(),f=LGraphTextureDepthRange._shader;this._temp_texture.drawTo(function(){a.bind(0);f.uniforms({texture:0,u_distance:c,u_range:d,u_camera_planes:[Renderer.active_camera.near,Renderer.active_camera.far]}).draw(e)});this.setOutputData(0,this._temp_texture)}};LGraphTextureDepthRange.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureDepthRange.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_distance;\n\t\t\tuniform float u_range;\n\t\t\t\n\t\t\tfloat LinearDepth()\n\t\t\t{\n\t\t\t\tfloat n = u_camera_planes.x;\n\t\t\t\tfloat f = u_camera_planes.y;\n\t\t\t\treturn (2.0 * n) / (f + n - texture2D(u_texture, v_coord).x * (f - n));\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat diff = abs(LinearDepth() * u_camera_planes.y - u_distance);\n\t\t\t\tfloat dof = 1.0;\n\t\t\t\tif(diff <= u_range)\n\t\t\t\t\tdof = diff / u_range;\n\t\t\t   gl_FragColor = vec4(dof);\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/depth_range",LGraphTextureDepthRange);window.LGraphTextureDepthRange=LGraphTextureDepthRange;var LGraphTextureBlur=function(){this.addInput("Texture","Texture");this.addInput("Iterations","number");this.addInput("Intensity","number");this.addOutput("Blurred","Texture");this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1]};LGraphTextureBlur._shader||(LGraphTextureBlur._shader=new GL.Shader(LGraphTextureBlur.vertex_shader,LGraphTextureBlur.pixel_shader))};
LGraphTextureBlur.title="Blur";LGraphTextureBlur.desc="Blur a texture";LGraphTextureBlur.prototype.onExecute=function(){var a=this.getInputData(0);if(a){var b=this._temp_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(this._temp_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}),this._final_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));b=this.properties.iterations;this.isInputConnected(1)&&(b=this.getInputData(1),
this.properties.iterations=b);b=Math.floor(b);if(0==b)this.setOutputData(0,a);else{var c=this.properties.intensity;this.isInputConnected(2)&&(c=this.getInputData(2),this.properties.intensity=c);gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);for(var d=Mesh.getScreenQuad(),e=LGraphTextureBlur._shader,f=this.properties.scale||[1,1],g=a,h=this.properties.preserve_aspect?Renderer.active_camera.aspect:1,a=0;a<b;++a)this._temp_texture.drawTo(function(){g.bind(0);e.uniforms({texture:0,u_intensity:1,u_offset:[0,
h/g.height*f[1]]}).draw(d)}),this._temp_texture.bind(0),this._final_texture.drawTo(function(){e.uniforms({texture:0,u_intensity:c,u_offset:[1/g.width*f[0],0]}).draw(d)}),g=this._final_texture;this.setOutputData(0,this._final_texture)}}};LGraphTextureBlur.vertex_shader="precision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord; gl_Position = vec4(v_coord * 2.0 - 1.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t";
LGraphTextureBlur.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t";
LiteGraph.registerNodeType("texture/blur",LGraphTextureBlur);window.LGraphTextureBlur=LGraphTextureBlur;var LGraphTextureWebcam=function(){this.addOutput("Webcam","Texture");this.properties={}};LGraphTextureWebcam.title="Webcam";LGraphTextureWebcam.desc="Webcam texture";LGraphTextureWebcam.prototype.openStream=function(){function a(a){trace("Webcam rejected",a);b._webcam_stream=!1;b.box_color="red"}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||
navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;if(navigator.getUserMedia){this._waiting_confirmation=!0;navigator.getUserMedia({video:!0},this.streamReady.bind(this),a);var b=this}};LGraphTextureWebcam.prototype.streamReady=function(a){this._webcam_stream=a;var b=this._video;b||(b=document.createElement("video"),b.autoplay=!0,b.src=window.URL.createObjectURL(a),this._video=b,b.onloadedmetadata=function(a){console.log(a)})};LGraphTextureWebcam.prototype.onExecute=function(){null!=
this._webcam_stream||this._waiting_confirmation||this.openStream();if(this._video&&this._video.videoWidth){var a=this._video.videoWidth,b=this._video.videoHeight,c=this._temp_texture;c&&c.width==a&&c.height==b||(this._temp_texture=new GL.Texture(a,b,{format:gl.RGB,filter:gl.LINEAR}));this._temp_texture.uploadImage(this._video);this.setOutputData(0,this._temp_texture)}};LiteGraph.registerNodeType("texture/webcam",LGraphTextureWebcam);window.LGraphTextureWebcam=LGraphTextureWebcam}
var RI_CULL_FACE=1,RI_CW=2,RI_DEPTH_TEST=4,RI_DEPTH_WRITE=8,RI_ALPHA_TEST=16,RI_BLEND=32,RI_CAST_SHADOWS=256,RI_IGNORE_LIGHTS=512,RI_RENDER_2D=1024,RI_IGNORE_FRUSTUM=2048,RI_IGNORE_VIEWPROJECTION=4096,RI_IGNORE_CLIPPING_PLANE=8192,RI_DEFAULT_FLAGS=RI_CULL_FACE|RI_DEPTH_TEST|RI_DEPTH_WRITE|RI_CAST_SHADOWS,RI_2D_FLAGS=RI_RENDER_2D|RI_CULL_FACE|RI_BLEND|RI_IGNORE_LIGHTS;
function RenderInstance(a,b){this._key="";this._uid=LS.generateUId();this.wireframe_index_buffer=this.index_buffer=this.vertex_buffers=null;this.range=new Int32Array([0,-1]);this.mesh=null;this.primitive=gl.TRIANGLES;this.node=a;this.component=b;this.priority=10;this.flags=RI_DEFAULT_FLAGS;this.matrix=mat4.create();this.normal_matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create();this.material=null;this.macros={};this.uniforms={}}
RenderInstance.prototype.generateKey=function(a,b){return this._key=a+"|"+this.node._uid+"|"+this.material._uid+"|"};
RenderInstance.prototype.setMesh=function(a,b){b||0==b||(b=gl.TRIANGLES);this.mesh=a;this.primitive=b;this.vertex_buffers=a.vertexBuffers;switch(b){case gl.TRIANGLES:this.index_buffer=a.indexBuffers.triangles;break;case gl.LINES:a.indexBuffers.lines||a.computeWireframe();this.index_buffer=a.indexBuffers.lines;break;default:this.index_buffer=null}a.bounding?(this.oobb.set(a.bounding),this.flags&=~RI_IGNORE_FRUSTUM):this.flags|=RI_IGNORE_FRUSTUM};
RenderInstance.prototype.setRange=function(a,b){this.range[0]=a;this.range[1]=b};RenderInstance.prototype.applyNodeFlags=function(){var a=this.node.flags;!0==a.two_sided&&(this.flags&=~RI_CULL_FACE);!1==a.cast_shadows&&(this.flags&=~RI_CAST_SHADOWS);!0==a.flip_normals&&(this.flags|=RI_CW);!1==a.depth_test&&(this.flags&=~RI_DEPTH_TEST);!1==a.depth_write&&(this.flags&=~RI_DEPTH_WRITE);!0==a.alpha_test&&(this.flags|=RI_ALPHA_TEST)};RenderInstance.prototype.enableFlag=function(a){this.flags|=a};
RenderInstance.prototype.disableFlag=function(a){this.flags&=~a};RenderInstance.prototype.isFlag=function(a){return this.flags&a};RenderInstance.prototype.computeNormalMatrix=function(){var a=mat4.invert(this.normal_matrix,this.matrix);a&&mat4.transpose(this.normal_matrix,a)};RenderInstance.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};
RenderInstance.prototype.render=function(a){a.drawBuffers(this.vertex_buffers,this.index_buffer,this.primitive,this.range[0],this.range[1])};
var Renderer={default_shader:"global",default_low_shader:"lowglobal",color_rendertarget:null,depth_rendertarget:null,generate_shadowmaps:!0,update_materials:!0,sort_instances_by_distance:!0,sort_instances_by_priority:!0,render_fx:!0,z_pass:!1,_renderkeys:{},_full_viewport:vec4.create(),_current_scene:null,_default_material:new Material,_rendercalls:0,_rendered_instances:0,reset:function(){this.depth_rendertarget=this.color_rendertarget=null},render:function(a,b,c){function d(b){var d=f;b&&Renderer._full_viewport.set([0,
0,b.width,b.height]);Renderer.enableCamera(d,c);gl.clearColor(a.background_color[0],a.background_color[1],a.background_color[2],3<a.background_color.length?a.background_color[3]:0);!0==c.ignore_clear||d._ignore_clear||gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);LEvent.trigger(a,"beforeRenderScene",d);a.sendEventToNodes("beforeRenderScene",d);Renderer.renderInstances(c);LEvent.trigger(a,"afterRenderScene",d);a.sendEventToNodes("afterRenderScene",d)}c=c||{};this._current_scene=a=a||Scene;c.main_camera=
b;this._rendered_instances=this._rendercalls=0;LEvent.trigger(Scene,"beforeRender");a.sendEventToNodes("beforeRender");this.processVisibleData(a,c);var e=this._visible_cameras;b&&!c.render_all_cameras&&(e=[b]);Renderer.main_camera=e[0];!a.settings.enable_shadows||c.skip_shadowmaps||!this.generate_shadowmaps||c.shadows_disabled||c.lights_disabled||c.low_quality||this.renderShadowMaps();LEvent.trigger(Scene,"afterRenderShadows");a.sendEventToNodes("afterRenderShadows");LEvent.trigger(Scene,"renderReflections");
a.sendEventToNodes("renderReflections");LEvent.trigger(Scene,"beforeRenderMainPass");a.sendEventToNodes("beforeRenderMainPass");var f=null,g;for(g in e)f=e[g],LEvent.trigger(f,"beforeRenderPass"),LEvent.trigger(Scene,"beforeRenderPass"),Renderer._full_viewport.set([0,0,gl.canvas.width,gl.canvas.height]),gl.viewport(0,0,gl.canvas.width,gl.canvas.height),this.render_fx&&this.color_rendertarget&&this.depth_rendertarget?Texture.drawToColorAndDepth(this.color_rendertarget,this.depth_rendertarget,d):this.render_fx&&
this.color_rendertarget?this.color_rendertarget.drawTo(d):(gl.viewport(0,0,gl.canvas.width,gl.canvas.height),d()),LEvent.trigger(f,"afterRenderPass"),LEvent.trigger(Scene,"afterRenderPass");LEvent.trigger(Scene,"afterRender");Scene.sendEventToNodes("afterRender");Scene._frame+=1;Scene._must_redraw=!1},_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),_2Dviewprojection_matrix:mat4.create(),_mvp_matrix:mat4.create(),_temp_matrix:mat4.create(),_identity_matrix:mat4.create(),
enableCamera:function(a,b,c){LEvent.trigger(a,"cameraEnabled",b);var d=Renderer._full_viewport[2],e=Renderer._full_viewport[3],f=d*a._viewport[2],g=e*a._viewport[3];c||(b&&b.ignore_viewports?(a._aspect=d/e,gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3])):(a._aspect=f/g,gl.viewport(a._viewport[0]*d,a._viewport[1]*e,a._viewport[2]*d,a._viewport[3]*e)));a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,
a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);mat4.ortho(this._2Dviewprojection_matrix,-1,1,-1,1,1,-1);this.active_camera=a},renderInstances:function(a){var b=this.current_scene||Scene;a=a||{};a.camera=this.active_camera;var c=geo.extractPlanes(this._viewprojection_matrix);LEvent.trigger(b,"beforeRenderInstances",a);b.sendEventToNodes("beforeRenderInstances",a);this.fillSceneShaderMacros(b,a);this.fillSceneShaderUniforms(b,a);if(!a.is_shadowmap&&!a.is_picking&&
b.textures.background){var d=null;"string"==typeof b.textures.background&&(d=LS.ResourcesManager.textures[b.textures.background]);d&&(gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),d.toViewport())}gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.disable(gl.BLEND);gl.lineWidth(1);var d=this._visible_lights,e=this._visible_instances,f;for(f in e){var g=e[f],h=g.node.flags;g._in_camera=!1;if(!(a.is_rt&&!1==h.seen_by_reflections||a.is_shadowmap&&!(g.flags&RI_CAST_SHADOWS)||!(!1!=h.seen_by_camera||a.is_shadowmap||
a.is_picking||a.is_reflection)||!1==h.seen_by_picking&&a.is_picking||0>=g.material.opacity)){if(g.onPreRender)g.onPreRender(a);if(g.flags&RI_IGNORE_FRUSTUM||geo.frustumTestBox(c,g.aabb)!=CLIP_OUTSIDE)g._in_camera=!0}}for(f in e)if(g=e[f],g._in_camera&&(g.flags&RI_RENDER_2D?this.render2DInstance(g,b,a):(this._rendered_instances+=1,a.is_shadowmap?this.renderShadowPassInstance(g,a):a.is_picking?this.renderPickingInstance(g,a):this.renderMultiPassInstance(g,d,b,a)),g.onPostRender))g.onPostRender(a);LEvent.trigger(b,
"renderScreenSpace",a);a.is_shadowmap||a.is_picking||!b.textures.foreground||(d=null,"string"==typeof b.textures.foreground&&(d=LS.ResourcesManager.textures[b.textures.foreground]),d&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.disable(gl.DEPTH_TEST),d.toViewport(),gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST)));gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.depthMask(!0);gl.disable(gl.BLEND);gl.frontFace(gl.CCW);LEvent.trigger(b,"afterRenderInstances",a);b.sendEventToNodes("afterRenderInstances",
a);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.depthMask(!0);gl.disable(gl.BLEND);gl.frontFace(gl.CCW)},renderMultiPassInstance:function(a,b,c,d){var e=a.node,f=a.material,g=a.matrix;a.flags&RI_IGNORE_VIEWPROJECTION?this._mvp_matrix.set(g):mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,g);var h=e._macros,k=e._uniforms;k.u_mvp=this._mvp_matrix;k.u_model=g;k.u_normal_model=a.normal_matrix;this.enableInstanceFlags(a,d);f.blending==Material.ADDITIVE_BLENDING?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,
gl.ONE)):0.999>f.opacity||a.flags&RI_BLEND?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)):gl.disable(gl.BLEND);for(var g=c._samplers.concat(f._samplers),n=0;n<g.length;n++){var p=g[n];f._uniforms[p[0]]=n;p[1].bind(n)}g=Renderer.default_shader;d.low_quality&&(g=Renderer.default_low_shader);a.material.shader_name&&(g=a.material.shader_name);n=b.length;p=e.flags.ignore_lights||a.flags&RI_IGNORE_LIGHTS||d.ignore_lights;if(!n||p){var m={FIRST_PASS:"",USE_AMBIENT_ONLY:""};m.merge(c._macros);
m.merge(h);m.merge(f._macros);m.merge(a.macros);p&&(m.USE_IGNORE_LIGHT="");!d.clipping_plane||a.flags&RI_IGNORE_CLIPPING_PLANE||(m.USE_CLIPPING_PLANE="");if(f.onModifyMacros)f.onModifyMacros(m);m=Shaders.get(g,m);m.uniforms(c._uniforms);m.uniforms(k);m.uniforms(f._uniforms);m.uniforms(a.uniforms);a.render(m);this._rendercalls+=1}else for(p=0;p<n;p++){var r=b[p],m=null;if(!m){var q=a.material.getLightShaderMacros(r,e,c,d);0==p&&(q.FIRST_PASS="");p==n-1&&(q.LAST_PASS="");m={};m.merge(c._macros);m.merge(h);
m.merge(f._macros);m.merge(a.macros);m.merge(q);!d.clipping_plane||a.flags&RI_IGNORE_CLIPPING_PLANE||(m.USE_CLIPPING_PLANE="");if(f.onModifyMacros)f.onModifyMacros(m);m=Shaders.get(g,m)}r=a.material.fillLightUniforms(p,r,a,d);0<p&&(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthFunc(gl.LEQUAL),e.flags.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST));f.depth_func&&gl.depthFunc(gl[f.depth_func]);m.uniforms(c._uniforms);m.uniforms(k);m.uniforms(f._uniforms);m.uniforms(r);
m.uniforms(a.uniforms);a.render(m);this._rendercalls+=1;if(m.global&&!m.global.multipass)break}},render2DInstance:function(a,b,c){var d=a.node;b=a.material;var e=this._temp_matrix;mat4.identity(e);var f=vec3.create();if(a.pos2D)f.set(a.pos2D);else{mat4.projectVec3(f,this._viewprojection_matrix,a.center);if(0>f[2])return;f[2]=0}mat4.translate(e,e,f);f=vec3.fromValues(1,gl.canvas.width/gl.canvas.height,1);a.scale_2D&&(f[0]*=a.scale_2D[0],f[1]*=a.scale_2D[1]);mat4.scale(e,e,f);mat4.multiply(this._mvp_matrix,
this._2Dviewprojection_matrix,e);d=d._uniforms;d.u_mvp=this._mvp_matrix;d.u_model=e;d.u_normal_model=this._identity_matrix;this.enableInstanceFlags(a,c);b.blending==Material.ADDITIVE_BLENDING?(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)):(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA));for(c=0;c<b._samplers.length;c++)e=b._samplers[c],b._uniforms[e[0]]=c,e[1].bind(c);c=Shaders.get("flat_texture");c.uniforms(d);c.uniforms(b._uniforms);c.uniforms(a.uniforms);a.render(c);
this._rendercalls+=1},renderShadowPassInstance:function(a,b){var c=a.node,d=a.material,e=a.matrix;mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,e);var f=c._macros,g=c._uniforms;g.u_mvp=this._mvp_matrix;g.u_model=e;g.u_normal_model=a.normal_matrix;this.enableInstanceFlags(a,b);if(!0==c.flags.alpha_shadows&&(d.getTexture("color")||d.getTexture("opacity"))){c={USE_ALPHA_TEST:"0.5"};if(e=d.getTexture("color"))c.USE_COLOR_TEXTURE="uvs_"+(d.textures.color_uvs||Material.DEFAULT_UVS.color||"0"),
e.bind(0);if(e=d.getTexture("opacity"))c.USE_OPACITY_TEXTURE="uvs_"+(d.textures.opacity_uvs||Material.DEFAULT_UVS.opacity||"0"),e.bind(1);c.merge(f);shader=Shaders.get("depth",c);shader.uniforms({texture:0,opacity_texture:1})}else c={},c.merge(f),c.merge(d._macros),c.merge(a.macros),shader=Shaders.get("depth",c);shader.uniforms(d._uniforms);shader.uniforms(g);a.render(shader);this._rendercalls+=1},fillSceneShaderMacros:function(a,b){var c={};b.camera.type==Camera.ORTHOGRAPHIC&&(c.USE_ORTHOGRAPHIC_CAMERA=
"");b.brightness_factor&&1!=b.brightness_factor&&(c.USE_BRIGHTNESS_FACTOR="");b.colorclip_factor&&(c.USE_COLORCLIP_FACTOR="");a._macros=c},fillSceneShaderUniforms:function(a,b){var c={u_camera_eye:this.active_camera.getEye(),u_camera_planes:[this.active_camera.near,this.active_camera.far],u_time:a._time||0.001*window.performance.now(),u_brightness_factor:null!=b.brightness_factor?b.brightness_factor:1,u_colorclip_factor:null!=b.colorclip_factor?b.colorclip_factor:0,u_ambient_light:a.ambient_color,
u_background_color:a.background_color.subarray(0,3)};b.clipping_plane&&(c.u_clipping_plane=b.clipping_plane);a._uniforms=c;a._samplers=[];for(var d in a.textures)if((c=LS.getTexture(a.textures[d]))&&("environment"==d||"irradiance"==d)){var e=c.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap";a._samplers.push([d+e,c]);a._macros["USE_"+(d+e).toUpperCase()]=""}},renderPickingInstance:function(a,b){mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,a.matrix);var c=this.getNextPickingColor(a),
d=Shaders.get("flat");d.uniforms({u_mvp:this._mvp_matrix,u_material_color:c});a.render(d)},getNextPickingColor:function(a,b){this._picking_next_color_id+=10;var c=new Uint32Array(1);c[0]=this._picking_next_color_id;c=new Uint8Array(c.buffer);this._picking_nodes[this._picking_next_color_id]=[a,b];return new Float32Array([c[0]/255,c[1]/255,c[2]/255,1])},enableInstanceFlags:function(a,b){var c=a.flags;c&RI_CULL_FACE?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);c&RI_DEPTH_TEST?
gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST);c&RI_DEPTH_WRITE?gl.depthMask(!0):gl.depthMask(!1);var d=gl.CCW;c&RI_CW&&(d=gl.CW);b.reverse_backfacing&&(d=d==gl.CW?gl.CCW:gl.CW);gl.frontFace(d)},processVisibleData:function(a,b){b=b||{};b.scene=a;a.collectData();var c=[],d=[],e={},f=a._instances,g=b.main_camera||a.getCamera();b.current_camera=g;var g=g.getEye(),h;for(h in f){var k=f[h];if(k){k.material||(k.material=this._default_material);e[k.material._uid]=k.material;k._dist=vec3.dist(k.center,
g);b.force_wireframe&&(k.primitive=gl.LINES,k.mesh&&(k.mesh.indexBuffers.lines||k.mesh.computeWireframe(),k.index_buffer=k.mesh.indexBuffers.lines));var n=k.material;1>n.opacity||n.blending==Material.ADDITIVE_BLENDING||k.flags&RI_BLEND?d.push(k):c.push(k);n=k.macros;k.flags&RI_ALPHA_TEST?n.USE_ALPHA_TEST="0.5":n.USE_ALPHA_TEST&&delete n.USE_ALPHA_TEST;k=k.vertex_buffers;"normals"in k||(n.NO_NORMALS="");"coords"in k||(n.NO_COORDS="");"coords1"in k&&(n.USE_COORDS1_STREAM="");"colors"in k&&(n.USE_COLOR_STREAM=
"");"tangents"in k&&(n.USE_TANGENT_STREAM="")}}this.sort_instances_by_distance&&(c.sort(this._sort_near_to_far_func),d.sort(this._sort_far_to_near_func));f=c.concat(d);this.sort_instances_by_priority&&f.sort(this._sort_by_priority_func);if(this.update_materials)for(h in e)g=e[h],g._macros||(g._macros={},g._uniforms={},g._samplers=[]),g.fillSurfaceShaderMacros(a),g.fillSurfaceUniforms(a);this._alpha_instances=d;this._opaque_instances=c;this._visible_instances=f;this._visible_lights=a._lights;this._visible_cameras=
a._cameras;this._visible_materials=e},_sort_far_to_near_func:function(a,b){return b._dist-a._dist},_sort_near_to_far_func:function(a,b){return a._dist-b._dist},_sort_by_priority_func:function(a,b){return b.priority-a.priority},renderInstancesToRT:function(a,b,c){function d(){gl.clearColor(Scene.background_color[0],Scene.background_color[1],Scene.background_color[2],3<Scene.background_color.length?Scene.background_color[3]:0);!0!=c.ignore_clear&&gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.renderInstances(c)}
b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a),b.drawTo(d)):b.texture_type==gl.TEXTURE_CUBE_MAP&&this.renderToCubemap(a.getEye(),b.width,b,c,a.near,a.far)},renderShadowMaps:function(a){a=a||Scene;for(var b in this._visible_lights){var c=this._visible_lights[b];if(c.cast_shadows){var d=c.shadowmap_resolution;d||(d=Light.DEFAULT_SHADOWMAP_RESOLUTION);var e=c.type==Light.OMNI?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;if(null==c._shadowMap||c._shadowMap.width!=d||c._shadowMap.texture_type!=e)c._shadowMap=
new GL.Texture(d,d,{texture_type:e,format:gl.RGBA,magFilter:gl.NEAREST,minFilter:gl.NEAREST}),ResourcesManager.textures[":shadowmap_"+c._uid]=c._shadowMap;c.type==Light.OMNI?this.renderToCubemap(c.getPosition(),d,c._shadowMap,{step:"shadow",is_shadowmap:!0},c.near,c.far):(c.computeLightMatrices(this._view_matrix,this._projection_matrix,this._viewprojection_matrix),this.active_camera=a.current_camera,c._shadowMap.unbind(),c._shadowMap.drawTo(function(){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|
gl.DEPTH_BUFFER_BIT);c._lightMatrix||(c._lightMatrix=mat4.create());mat4.copy(Renderer._viewprojection_matrix,c._lightMatrix);Renderer.renderInstances({step:"shadow",is_shadowmap:!0})}))}}},cubemap_camera_parameters:[{dir:[1,0,0],up:[0,-1,0]},{dir:[-1,0,0],up:[0,-1,0]},{dir:[0,1,0],up:[0,0,1]},{dir:[0,-1,0],up:[0,0,-1]},{dir:[0,0,1],up:[0,-1,0]},{dir:[0,0,-1],up:[0,-1,0]}],renderToCubemap:function(a,b,c,d,e,f){b=b||256;e=e||1;f=f||1E3;c&&c.constructor==Texture||(c=null);c=c||new Texture(b,b,{texture_type:gl.TEXTURE_CUBE_MAP,
minFilter:gl.NEAREST});c.drawTo(function(b,c){var k=Renderer.cubemap_camera_parameters;"shadow"==d.is_shadowmap?gl.clearColor(0,0,0,0):gl.clearColor(Scene.background_color[0],Scene.background_color[1],Scene.background_color[2],3<Scene.background_color.length?Scene.background_color[3]:1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);k=new Camera({eye:a,center:[a[0]+k[c].dir[0],a[1]+k[c].dir[1],a[2]+k[c].dir[2]],up:k[c].up,fov:90,aspect:1,near:e,far:f});Renderer.enableCamera(k,d,!0);Renderer.renderInstances(d)});
return c},_pickingMap:null,_picking_color:new Uint8Array(4),_picking_depth:0,_picking_next_color_id:0,_picking_nodes:{},renderPickingBuffer:function(a,b,c){var d=this.current_scene||Scene;if(null==this._pickingMap||this._pickingMap.width!=gl.canvas.width||this._pickingMap.height!=gl.canvas.height)this._pickingMap=new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,filter:gl.NEAREST}),ResourcesManager.textures[":picking"]=this._pickingMap;c=gl.canvas.height-c;this._picking_next_color_id=
0;this._pickingMap.drawTo(function(){var e=d.viewport||[0,0,gl.canvas.width,gl.canvas.height];a.aspect=e[2]/e[3];gl.viewport(e[0],e[1],e[2],e[3]);gl.scissor(b-1,c-1,2,2);gl.enable(gl.SCISSOR_TEST);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);Renderer.enableCamera(a);Renderer.renderInstances({is_picking:!0});LEvent.trigger(Scene,"renderPicking",[b,c]);gl.readPixels(b,c,1,1,gl.RGBA,gl.UNSIGNED_BYTE,Renderer._picking_color);gl.disable(gl.SCISSOR_TEST)});return this._picking_color},
getNodeAtCanvasPosition:function(a,b,c,d){b=b||Scene.getCamera();this._picking_nodes={};this.renderPickingBuffer(b,c,d);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes={};return a?a[0].node:null},getInstanceAtCanvasPosition:function(a,b,c,d){b=b||Scene.getCamera();this._picking_nodes={};this.renderPickingBuffer(b,c,d);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes=
{};return a},projectToCanvas:function(a,b,c){}};LS.Renderer=Renderer;function PhysicsInstance(a,b){this._uid=LS.generateUId();this.type=PhysicsInstance.BOX;this.mesh=null;this.node=a;this.component=b;this.matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create()}PhysicsInstance.BOX=1;PhysicsInstance.SPHERE=2;PhysicsInstance.PLANE=3;PhysicsInstance.CAPSULE=4;PhysicsInstance.MESH=5;PhysicsInstance.FUNCTION=6;
PhysicsInstance.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};PhysicsInstance.prototype.setMesh=function(a){this.mesh=a;this.type=PhysicsInstance.MESH;BBox.setCenterHalfsize(this.oobb,a.bounding.aabb_center,a.bounding.aabb_halfsize)};
var Physics={raycast:function(a,b,c){a=a._colliders;for(var d=[],e=0;e<a.length;++e){var f=a[e],g=vec3.create();if(geo.testRayBBox(b,c,f.aabb,null,g)){var h=f.matrix,k=mat4.invert(mat4.create(),h),n=mat4.multiplyVec3(vec3.create(),k,b),k=mat4.rotateVec3(vec3.create(),k,c);if(f.type==PhysicsInstance.SPHERE){if(!geo.testRaySphere(n,k,f.center,f.oobb[3],g))continue;vec3.transformMat4(g,g,h)}else{if(!geo.testRayBBox(n,k,f.oobb,null,g))continue;if(f.type==PhysicsInstance.MESH){var p=f.mesh.octree;p||(p=
f.mesh.octree=new Octree(f.mesh));n=p.testRay(n,k,0,1E4);if(!n)continue;mat4.multiplyVec3(g,h,n.pos)}else vec3.transformMat4(g,g,h)}h=vec3.distance(b,g);d.push([f,g,h])}}d.sort(function(a,b){return a[2]-b[2]});return d}};LS.Physics=Physics;
var Parser={flipAxis:0,merge_smoothgroups:!1,safe_parsing:!1,image_extensions:["png","jpg"],nonative_image_extensions:["tga","dds"],mesh_extensions:"obj bin ase gr2 json jsmesh".split(" "),scene_extensions:["dae"],generic_extensions:["xml","js","json"],xml_extensions:["xml","dae"],json_extensions:["js","json"],binary_extensions:["bin","tga","dds"],parsers:{},registerParser:function(a){this.parsers[a.extension]=a},parse:function(a,b,c){c=c||{};var d=this.getFileFormatInfo(a);c.extension&&(d.extension=
c.extension);var e=this.parsers[d.extension];if(!e)return console.error("Parser Error: No parser found for "+d.extension+" format"),null;d=null;if(this.safe_parsing)try{d=e.parse(b,c,a)}catch(f){return console.error("Error parsing content",f),null}else d=e.parse(b,c,a);d&&(d.name=a);return d},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var e=0;e<b.width;++e)for(var f=
0;f<b.height;++f){var g=f*b.width*4+4*e,h=(b.height-f-1)*b.width*3+3*e;d.data[g+2]=a.pixels[h];d.data[g+1]=a.pixels[h+1];d.data[g+0]=a.pixels[h+2];d.data[g+3]=255}else for(e=0;e<b.width;++e)for(f=0;f<b.height;++f)g=f*b.width*4+4*e,h=(b.height-f-1)*b.width*4+4*e,d.data[g+0]=a.pixels[h+2],d.data[g+1]=a.pixels[h+1],d.data[g+2]=a.pixels[h+0],d.data[g+3]=a.pixels[h+3];c.putImageData(d,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=
[a[0],a[1],a[2]],d=0;d<a.length;d+=3){var e=[a[d],a[d+1],a[d+2]];e[0]<b[0]?b[0]=e[0]:e[0]>c[0]&&(c[0]=e[0]);e[1]<b[1]?b[1]=e[1]:e[1]>c[1]&&(c[1]=e[1]);e[2]<b[2]?b[2]=e[2]:e[2]>c[2]&&(c[2]=e[2])}a=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];return BBox.setCenterHalfsize(BBox.create(),a,b)},stringToTypedArray:function(a,b){for(var c=new Uint8Array(b?b:a.length),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return c},typedArrayToString:function(a,b){for(var c="",d=0;d<
a.length;d++)if(0!=a[d]||b)c+=String.fromCharCode(a[d]);else break;return c},JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",TEXT_FORMAT:"text",MESH_DATA:"MESH",SCENE_DATA:"SCENE",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",GENERIC_DATA:"GENERIC",getFileFormatInfo:function(a){var b=a.substr(a.lastIndexOf(".")+1).toLowerCase();a={filename:a,extension:b};a.format=Parser.TEXT_FORMAT;-1!=this.xml_extensions.indexOf(b)?a.format=Parser.XML_FORMAT:-1!=this.json_extensions.indexOf(b)?
a.format=Parser.JSON_FORMAT:-1!=this.binary_extensions.indexOf(b)&&(a.format=Parser.BINARY_FORMAT);-1!=this.image_extensions.indexOf(b)?a.type=Parser.IMAGE_DATA:-1!=this.mesh_extensions.indexOf(b)?a.type=Parser.MESH_DATA:-1!=this.scene_extensions.indexOf(b)?a.type=Parser.SCENE_DATA:-1!=this.nonative_image_extensions.indexOf(b)?a.type=Parser.NONATIVE_IMAGE_DATA:-1!=this.generic_extensions.indexOf(b)&&(a.type=Parser.GENERIC_DATA);return a}},parserASE={extension:"ase",data_type:"mesh",format:"text",
parse:function(a,b){b=b||{};var c=[],d=[],e=[],f=[],g=[],h=null,h=null,k=0,n=-1,p=null,m=[],r=Parser.flipAxis;null!=b.flipAxis&&(r=b.flipAxis);for(var q=r||b.flipNormals,v=a.split("\n"),w=0;w<v.length;++w)if(h=v[w].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==h[0]&&(h=h.substr(1,h.length)),""!=h)if(h=h.split(" "),"*MESH"==h[0]){if(k+=1,f=[],g=[],1<k)break}else if("*NODE_NAME"==h[0])h[1].substr(1,h[1].length-2);else if("*MESH_VERTEX"==h[0])r?f.push([-1*parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[3])]):
f.push([parseFloat(h[2]),parseFloat(h[3]),parseFloat(h[4])]);else if("*MESH_FACE"==h[0]){var s=parseInt(h[17]);n!=s&&(n=s,null!=p&&(p.length=c.length/3-p.start,0<p.length&&m.push(p)),p={name:"mat_"+s,start:c.length/3,length:-1,material:""});s=f[parseInt(h[3])];c.push(s[0],s[1],s[2]);s=f[parseInt(h[5])];c.push(s[0],s[1],s[2]);s=f[parseInt(h[7])];c.push(s[0],s[1],s[2])}else"*MESH_TVERT"==h[0]?g.push([parseFloat(h[2]),parseFloat(h[3])]):"*MESH_TFACE"==h[0]?(s=g[parseInt(h[2])],d.push(s[0],s[1]),s=g[parseInt(h[3])],
d.push(s[0],s[1]),s=g[parseInt(h[4])],d.push(s[0],s[1])):"*MESH_VERTEXNORMAL"==h[0]&&(q?e.push(-1*parseFloat(h[2]),parseFloat(h[4]),parseFloat(h[3])):e.push(parseFloat(h[2]),parseFloat(h[3]),parseFloat(h[4])));f=c.length/3-p.start;p&&1<f&&(p.length=f,m.push(p));p={info:{}};p.vertices=new Float32Array(c);0<e.length&&(p.normals=new Float32Array(e));0<d.length&&(p.coords=new Float32Array(d));p.bounding=Parser.computeMeshBounding(p.vertices);1<m.length&&(p.info.groups=m);return p}};Parser.registerParser(parserASE);
var temp_v3=vec3.create(),parserDAE={extension:"dae",data_type:"scene",format:"text",_xmlroot:null,no_flip:!0,_nodes_by_id:null,safeString:function(a){return a.replace(/ /g,"_")},parse:function(a,b,c){this._xmlroot=b=(new DOMParser).parseFromString(a,"text/xml");var d=b.querySelector("visual_scene");this._nodes_by_id={};this.readAllNodeNames(d);a={object_type:"SceneTree",light:null,resources:{},root:{children:[]}};for(var d=d.childNodes,e=0;e<d.length;e++)if("node"==d[e].localName){var f=this.readNode(d[e],
a,0,!0);a.root.children.push(f)}if(b=this.readAnimations(b,a))c="#animations_"+c.substr(0,c.indexOf(".")),a.resources[c]=b,a.root.animations=c;console.log(a);return a},readAllNodeNames:function(a){var b=this.safeString(a.getAttribute("id"));b&&(this._nodes_by_id[b]=!0);for(b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];"node"==c.localName&&this.readAllNodeNames(c)}},readNode:function(a,b,c,d){var e=this.safeString(a.getAttribute("id"));a.getAttribute("type");var f={id:e,children:[],_depth:c};
this._nodes_by_id[e]=f;f.model=this.readTransform(a,c,d);for(e=0;e<a.childNodes.length;e++){var g=a.childNodes[e];if("node"==g.localName)f.children.push(this.readNode(g,b,c+1,d));else{if("instance_geometry"==g.localName){var h=g.getAttribute("url");if(!b.resources[h]){var k=this.readGeometry(h,d);k&&(k.name=h,b.resources[h]=k)}f.mesh=h;try{var n=g.querySelector("instance_material");if(n){var p=n.getAttribute("symbol");if(!b.resources[p]){var m=this.readMaterial(p);m&&(m.id=p,b.resources[p]=m)}f.material=
p}}catch(r){console.error("Error parsing material, check that materials doesnt have space in their names")}}if("instance_controller"==g.localName&&(h=g.getAttribute("url"),k=this.readController(h,d,b))){var q=k;"morph"==k.type&&(q=k.mesh,f.morph_targets=k.morph_targets);q.name=h;f.mesh=h;b.resources[h]=q}"instance_light"==g.localName&&(h=g.getAttribute("url"),this.readLight(f,h,d))}}return f},translate_table:{transparency:"opacity",reflectivity:"reflection_factor",specular:"specular_factor",shininess:"specular_gloss",
emission:"emissive",diffuse:"color"},readMaterial:function(a){a=this._xmlroot.querySelector("library_materials material#"+a);if(!a)return null;a=a.querySelector("instance_effect");if(!a)return null;a=a.getAttribute("url");a=this._xmlroot.querySelector("library_effects effect"+a);if(!a)return null;var b=a.querySelector("technique");if(!b)return null;a={};var c=b.querySelector("phong");if(!c)return null;for(var d=c.querySelectorAll("color"),b=0;b<d.length;++b){var e=d[b],f=e.getAttribute("sid");this.translate_table[f]&&
(f=this.translate_table[f]);a[f]=this.readContentAsFloats(e).subarray(0,3);"specular_factor"==f&&(a[f]=(a[f][0]+a[f][1]+a[f][2])/3)}c=c.querySelectorAll("float");for(b=0;b<c.length;++b)d=c[b],f=d.getAttribute("sid"),this.translate_table[f]&&(f=this.translate_table[f]),a[f]=this.readContentAsFloats(d)[0],"opacity"==f&&(a[f]=1-a[f]);a.object_Type="Material";return a},readLight:function(a,b){function c(a,b){for(var c in b.childNodes){var d=b.childNodes[c];if(d&&1==d.nodeType)switch(d.localName){case "color":a.color=
parserDAE.readContentAsFloats(d);break;case "falloff_angle":a.angle_end=parserDAE.readContentAsFloats(d)[0],a.angle=a.angle_end-10}}}var d={},e=this._xmlroot.querySelector("library_lights "+b);if(!e)return null;var f=[],g=e.querySelector("technique_common");if(g)for(var h in g.childNodes)1==g.childNodes[h].nodeType&&f.push(g.childNodes[h]);e=e.querySelectorAll("technique");for(h=0;h<e.length;h++)for(var k in e[h].childNodes)1==e[h].childNodes[k].nodeType&&f.push(e[h].childNodes[k]);for(h in f)switch(g=
f[h],g.localName){case "point":d.type=LS.Light.OMNI;c(d,g);break;case "spot":d.type=LS.Light.SPOT;c(d,g);break;case "intensity":d.intensity=this.readContentAsFloats(g)[0]}d.position=[0,0,0];d.target=[0,-1,0];a.light=d},max3d_matrix_0:new Float32Array([0,-1,0,0,0,0,-1,0,1,0,0,-0,0,0,0,1]),transformMatrix:function(a,b,c){mat4.transpose(a,a);if(this.no_flip)return a;b?(b=new Float32Array(a.subarray(4,8)),a.set(a.subarray(8,12),4),a.set(b,8),b=a.subarray(8,12),vec4.scale(b,b,-1)):(b=mat4.create(),b.set([a[0],
a[2],-a[1]],0),b.set([a[8],a[10],-a[9]],4),b.set([-a[4],-a[6],a[5]],8),b.set([a[12],a[14],-a[13]],12),a.set(b));return a},readTransform:function(a,b,c){for(var d=mat4.create(),e=quat.create(),f=mat4.create(),g=quat.create(),h=vec3.create(),k=vec3.fromValues(1,1,1),n=0;n<a.childNodes.length;n++){var p=a.childNodes[n];if("matrix"==p.localName)return d=this.readContentAsFloats(p),console.log("Nodename: "+a.getAttribute("id")),console.log(d),this.transformMatrix(d,0==b),console.log(d),d;if("translate"==
p.localName){var m=this.readContentAsFloats(p);h.set(m)}else"rotate"==p.localName?(m=this.readContentAsFloats(p),4==m.length&&("jointOrientX"==p.getAttribute("sid")&&(m[3]+=90),c&&(p=m[1],m[1]=m[2],m[2]=-p),quat.setAxisAngle(g,m.subarray(0,3),m[3]*DEG2RAD),quat.multiply(e,e,g))):"scale"==p.localName&&(m=this.readContentAsFloats(p),c&&(p=m[1],m[1]=m[2],m[2]=-p),k.set(m))}c&&0<b&&(p=h[1],h[1]=h[2],h[2]=-p);mat4.translate(d,d,h);mat4.fromQuat(f,e);mat4.multiply(d,d,f);mat4.scale(d,d,k);return d},readGeometry:function(a,
b){var c=this._xmlroot.querySelector("geometry"+a);if(!c)return null;for(var d=c.querySelector("mesh"),e={},f=d.querySelectorAll("source"),c=0;c<f.length;c++){var g=f[c];if(g.querySelector&&g.querySelector("float_array")){var h=this.readContentAsFloats(g),k=g.querySelector("accessor"),k=parseInt(k.getAttribute("stride"));e[g.getAttribute("id")]={stride:k,data:h}}}c=d.querySelector("vertices input");vertices_source=e[c.getAttribute("source").substr(1)];e[d.querySelector("vertices").getAttribute("id")]=
vertices_source;g=!1;c=d.querySelector("polygons");if(!c&&(c=d.querySelector("polylist")))return console.error("Polylist not supported, please be sure to enable TRIANGULATE option in your exporter."),null;c||(c=d.querySelector("triangles"));if(!c)return console.log("no polygons or triangles in mesh: "+a),null;h=d.querySelectorAll("triangles");if(h.length)g=!0;else return console.error("no triangles in mesh: "+a),null;for(var d=[],k=0,n={},p=[],f=[],m=0;m<h.length;m++){var r=h[m],q=r.querySelectorAll("input");
if(0==m)for(c=0;c<q.length;c++){var v=q[c];if(v.getAttribute){var w=v.getAttribute("semantic").toUpperCase(),s=e[v.getAttribute("source").substr(1)],x=parseInt(v.getAttribute("offset")),t=0;v.getAttribute("set")&&(t=parseInt(v.getAttribute("set")));d.push([w,[],s.stride,s.data,x,t])}}v=r.querySelectorAll("p");w=d.length;for(c=0;c<v.length;c++){r=v[c];if(!r||!r.textContent)break;for(var r=r.textContent.trim().split(" "),t=s=x=-1,u=0,q=r.length;u<q;u+=w){var B=r.slice(u,u+w).join(" "),t=s;if(n.hasOwnProperty(B))s=
n[B];else{for(var D=0;D<d.length;++D){var E=d[D],F=parseInt(r[u+D]),s=E[1],C=E[3];0==D&&(p[s.length/w]=F);for(var F=F*E[2],G=0;G<E[2];++G)s.push(C[F+G])}s=k;k+=1;n[B]=s}g||(0==u&&(x=s),u>2*w&&(f.push(x),f.push(t)));f.push(s)}}}e={vertices:new Float32Array(d[0][1]),_remap:new Uint16Array(p)};g={normal:"normals",texcoord:"coords"};for(c=1;c<d.length;++c)h=d[c][0].toLowerCase(),r=d[c][1],r.length&&(g[h]&&(h=g[h]),e[h]&&(h+=d[c][5]),e[h]=new Float32Array(r));f.length&&(e.triangles=new Uint16Array(f));
if(b&&!this.no_flip){d=0;s=e.vertices;c=0;for(q=s.length;c<q;c+=3)d=s[c+1],s[c+1]=s[c+2],s[c+2]=-d;s=e.normals;c=0;for(q=s.length;c<q;c+=3)d=s[c+1],s[c+1]=s[c+2],s[c+2]=-d}e.filename=a;e.object_type="Mesh";return e},findXMLNodeById:function(a,b,c){a=a.childNodes;for(var d=0;d<a.length;++d){var e=a[d];if(1==e.nodeType&&e.localName==b&&e.getAttribute("id")==c)return e}return null},readAnimations:function(a,b){var c=a.querySelector("library_animations");if(!c)return null;for(var c=c.childNodes,d={object_type:"Animation",
takes:{}},e={tracks:[]},f=e.tracks,g=0;g<c.length;++g){var h=c[g];if(1==h.nodeType){var k=h.getAttribute("id");if(h=h.querySelector("animation")){var n=h.querySelector("channel");if(n){var p=n.getAttribute("source"),m=n.getAttribute("target");if(xmlsampler=this.findXMLNodeById(h,"sampler",p.substr(1))){for(var r={},q={},v={},w=xmlsampler.querySelectorAll("input"),p=null,n=0;n<w.length;n++){var s=w[n],x=s.getAttribute("source"),t=s.getAttribute("semantic"),u=this.findXMLNodeById(h,"source",x.substr(1));
if(u){var B=u.querySelector("param");B&&(s=B.getAttribute("type"),r[t]={source:x,type:s},t=null,"float"==s||"float4x4"==s)&&(u=u.querySelector("float_array"),u=this.readContentAsFloats(u),t=q[x]=u,x=B.getAttribute("name"),"TIME"==x&&(p=t),v[x||"OUTPUT"]=s)}}if(p){n=m.split("/");h={};h.nodename=this.safeString(n[0]);h.property=n[1];k=this._nodes_by_id[h.nodename];m=1;v=v.OUTPUT;switch(v){case "float":m=1;break;case "float3x3":m=9;break;case "float4x4":m=16}h.value_size=m;h.duration=p[p.length-1];if(r=
q[r.OUTPUT.source]){q=m+1;w=new Float32Array(p.length*q);for(n=0;n<p.length;++n)w[n*q]=p[n],x=r.subarray(n*m,(n+1)*m),"float4x4"==v&&this.transformMatrix(x,0==k._depth),w.set(x,n*q+1);h.data=w;f.push(h)}}else console.error("Error DAE: no TIME info found in animation: "+k)}else console.error("Error DAE: Sampler not found in "+p)}}}}if(!f.length)return null;d.takes["default"]=e;return d},findNode:function(a,b){if(a.id==b)return a;if(a.children)for(var c in a.children){var d=this.findNode(a.children[c],
b);if(d)return d}return null},readController:function(a,b,c){a=this._xmlroot.querySelector("controller"+a);if(!a)return null;var d=a.querySelector("skin");return d?this.readSkinController(d,b,c):(a=a.querySelector("morph"))?this.readMorphController(a,b,c):null},readSkinController:function(a,b,c){c=a.getAttribute("source");c=this.readGeometry(c,b);if(!c)return null;var d=this.readSources(a,b);if(!d)return null;(b=a.querySelector("bind_shape_matrix"))?this.readContentAsFloats(b):mat4.create();b=[];
var e=a.querySelector("joints");if(e){for(var f=null,g=null,h=e.querySelectorAll("input"),e=0;e<h.length;e++){var k=h[e],n=k.getAttribute("semantic").toUpperCase(),k=k.getAttribute("source"),k=d[k.substr(1)];"JOINT"==n?f=k:"INV_BIND_MATRIX"==n&&(g=k)}if(!g||!f)return console.error("Error DAE: no joints or inv_bind sources found"),null;for(e in f)h=g.subarray(16*e,16*e+16),n=f[e],this.transformMatrix(h,0==this._nodes_by_id[n]._depth,!0),b.push([n,h])}if(a=a.querySelector("vertex_weights")){n=null;
h=a.querySelectorAll("input");for(e=0;e<h.length;e++)"WEIGHT"==h[e].getAttribute("semantic").toUpperCase()&&(n=d[h[e].getAttribute("source").substr(1)]);if(!n)throw"no weights found";var e=a.querySelector("vcount"),k=this.readContentAsUInt32(e),e=a.querySelector("v"),p=this.readContentAsUInt32(e);a=c.vertices.length/3;for(var d=new Float32Array(4*a),f=new Uint8Array(4*a),m=0,g=c._remap,e=0;e<k.length;++e){var r=k[e];4<r&&(r=4);for(h=0;h<r;++h)f[4*e+h]=p[m],d[4*e+h]=n[p[m+1]],m+=2}n=new Float32Array(4*
a);k=new Uint8Array(4*a);for(e=0;e<a;++e){h=4*g[e];p=d.subarray(h,h+4);m=f.subarray(h,h+4);for(r=0;3>r;++r){for(var q=r,v=p[r],h=r+1;4>h;++h)p[h]<=v||(q=h,v=p[h]);q!=r&&(h=p[r],p[r]=p[q],p[q]=h,h=m[r],m[r]=m[q],m[q]=h)}n.set(p,4*e);k.set(m,4*e)}c.weights=n;c.bone_indices=k;c.bones=b;delete c._remap}return c},readMorphController:function(a,b,c){var d=a.getAttribute("source"),d=this.readGeometry(d,b);if(!d)return null;var e=this.readSources(a,b),f=[];a=a.querySelector("targets");if(!a)return null;for(var g=
a.querySelectorAll("input"),h=a=null,k=0;k<g.length;k++){var n=g[k].getAttribute("semantic").toUpperCase(),p=e[g[k].getAttribute("source").substr(1)];"MORPH_TARGET"==n?a=p:"MORPH_WEIGHT"==n&&(h=p)}if(!a||!h)return null;for(k in a)e="#"+a[k],g=this.readGeometry(e,b),c.resources[e]=g,f.push([e,h[k]]);return{type:"morph",mesh:d,morph_targets:f}},readSources:function(a,b){for(var c={},d=a.querySelectorAll("source"),e=0;e<d.length;e++){var f=d[e];if(f.querySelector)if(f.querySelector("float_array")){var g=
this.readContentAsFloats(f);c[f.getAttribute("id")]=g}else(g=f.querySelector("Name_array"))&&(g=this.readContentAsStringsArray(g))&&(c[f.getAttribute("id")]=g)}return c},readContentAsUInt32:function(a){if(!a)return null;a=a.textContent;a=a.replace(/\n/gi," ");a=a.trim();if(0==a.length)return null;a=a.split(" ");for(var b=new Uint32Array(a.length),c=0;c<a.length;c++)b[c]=parseInt(a[c]);return b},readContentAsFloats:function(a){if(!a)return null;var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi,
" "),b=b.trim(),b=b.split(" ");a=a.getAttribute("count")||b.length;a=new Float32Array(a);for(var c=0;c<b.length;c++)a[c]=parseFloat(b[c]);return a},readContentAsStringsArray:function(a){if(!a)return null;for(var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" "),c=0;c<b.length;c++)b[c]=b[c].trim();if(a.getAttribute("count")&&parseInt(a.getAttribute("count"))!=b.length){var c=[],d="",e;for(e in b)d=d?d+(" "+b[e]):b[e],this._nodes_by_id[this.safeString(d)]&&
(c.push(this.safeString(d)),d="");a=parseInt(a.getAttribute("count"));if(c.length==a)return c;console.error("Error: bone names have spaces, avoid using spaces in names");return null}return b},debugMatrix:function(a,b){var c=new Float32Array(JSON.parse("["+a.split(" ").join(",")+"]"));return this.transformMatrix(c,b)}};Parser.registerParser(parserDAE);mat4.fromDAE=function(a){a=new Float32Array(JSON.parse("["+a.split(" ").join(",")+"]"));mat4.transpose(a,a);return a};
var parserDDS={extension:"dds",data_type:"image",format:"binary",parse:function(a,b){var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),d=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,d.handler,!0);d.texture_type=d.handler.texture_type;d.width=d.handler.width;d.height=d.handler.height;return d}};Parser.registerParser(parserDDS);
var parserJSMesh={extension:"jsmesh",data_type:"mesh",format:"text",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles="number"==typeof c.triangles[0]?
c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=Parser.computeMeshBounding(c.vertices));return c}};Parser.registerParser(parserJSMesh);
var parserOBJ={extension:"obj",data_type:"mesh",format:"text",parse:function(a,b){b=b||{};for(var c=[],d=[],e=[],f=[],g=[],h=[],k=[],n={},p=0,m=null,r=null,q=0,v=0,w=r=0,s=0,x=0,t=null,u=!1,B=!1,D=!1,E=!1,F=0,C=b.noindex?b.noindex:1E7<a.length?!0:!1,G=Parser.flipAxis||b.flipAxis,H=G||b.flipNormals,z=null,A=[],K=a.split("\n"),L=K.length,J=0;J<L;++J)if(m=K[J].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=m[0]&&""!=m)if(t=m.split(" "),E&&"v"==t[0]&&(E=!1),"v"==t[0])G?g.push(-1*parseFloat(t[1]),parseFloat(t[3]),
parseFloat(t[2])):g.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));else if("vt"==t[0])h.push(parseFloat(t[1]),parseFloat(t[2]));else if("vn"==t[0])H?k.push(-parseFloat(t[2]),-parseFloat(t[3]),parseFloat(t[1])):k.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]));else if("f"==t[0]){if(E=!0,!(4>t.length)){for(var I=[],m=1;m<t.length;++m){if(!(t[m]in n)||C){r=t[m].split("/");if(1==r.length)r=v=q=parseInt(r[0])-1;else if(2==r.length)q=parseInt(r[0])-1,v=parseInt(r[1])-1,r=-1;else if(3==
r.length)q=parseInt(r[0])-1,v=parseInt(r[1])-1,r=parseInt(r[2])-1;else return trace("Problem parsing: unknown number of values per face"),!1;x=s=w=0;3*q+2<g.length&&(u=!0,w=g[3*q+0],s=g[3*q+1],x=g[3*q+2]);c.push(w,s,x);s=w=0;2*v+1<h.length&&(B=!0,w=h[2*v+0],s=h[2*v+1]);d.push(w,s);s=w=0;x=1;-1!=r&&(3*r+2<k.length&&(D=!0,w=k[3*r+0],s=k[3*r+1],x=k[3*r+2]),e.push(w,s,x));C||(n[t[m]]=p++)}C||(q=n[t[m]],I.push(q),F<q&&(F=q))}if(!C)for(m=2;m<I.length;m++)f.push(I[0],I[m-1],I[m])}}else"g"==t[0]||"usemtl"==
t[0]?1<t.length&&(null!=z&&(z.length=f.length-z.start,0<z.length&&A.push(z)),z={name:t[1],start:f.length,length:-1,material:""}):"usemtl"==t[0]?z&&(z.material=t[1]):"o"!=t[0]&&"s"!=t[0]&&trace("unknown code: "+m);z&&1<f.length-z.start&&(z.length=f.length-z.start,A.push(z));if((65536<F||C)&&0<f.length){console.log("Deindexing mesh...");g=new Float32Array(3*f.length);h=e&&e.length?new Float32Array(3*f.length):null;k=d&&d.length?new Float32Array(2*f.length):null;for(m=0;m<f.length;m+=1)g.set(c.slice(3*
f[m],3*f[m]+3),3*m),h&&h.set(e.slice(3*f[m],3*f[m]+3),3*m),k&&k.set(d.slice(2*f[m],2*f[m]+2),2*m);c=g;h&&(e=h);k&&(d=k);f=null}m={};u&&(m.vertices=new Float32Array(c));D&&0<e.length&&(m.normals=new Float32Array(e));B&&0<d.length&&(m.coords=new Float32Array(d));f&&0<f.length&&(m.triangles=new Uint16Array(f));m.bounding=Mesh.computeBounding(m.vertices);c={};1<A.length&&(c.groups=A);m.info=c;(0==m.bounding.radius||isNaN(m.bounding.radius))&&console.log("no radius found in mesh");return m}};Parser.registerParser(parserOBJ);
var parserTGA={extension:"tga",data_type:"image",format:"binary",parse:function(a,b){a="string"==typeof a?Parser.stringToTypedArray(a):new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),d=a.subarray(0,12),e=0;e<d.length;e++)if(c[e]!=d[e])return null;e=a.subarray(12,18);c={};c.width=256*e[1]+e[0];c.height=256*e[3]+e[2];c.bpp=e[4];c.bytesPerPixel=c.bpp/8;c.imageSize=c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);for(e=0;e<c.imageSize;e+=c.bytesPerPixel)d=
c.pixels[e],c.pixels[e]=c.pixels[e+2],c.pixels[e+2]=d;c.flipY=!0;c.format=32==c.bpp?"BGRA":"BGR";return c}};Parser.registerParser(parserTGA);
function SceneTree(){this._uid=LS.generateUId();this._root=new LS.SceneNode("root");this._root.removeAllComponents();this._root._is_root=!0;this._root._in_tree=this;this._nodes=[this._root];this._nodes_by_id={root:this._root};LEvent.bind(this,"treeItemAdded",this.onNodeAdded.bind(this));LEvent.bind(this,"treeItemRemoved",this.onNodeRemoved.bind(this));this.init()}SceneTree.DEFAULT_BACKGROUND_COLOR=new Float32Array([0,0,0,1]);SceneTree.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);
Object.defineProperty(SceneTree.prototype,"root",{enumerable:!0,get:function(){return this._root},set:function(a){throw"Root node cannot be replaced";}});
SceneTree.prototype.init=function(){this.id="";this.local_repository=null;this._root.removeAllComponents();this._nodes=[this._root];this._nodes_by_id={root:this._root};this.rt_cameras=[];this._root.addComponent(new Camera);this.current_camera=this._root.camera;this._root.addComponent(new Light({position:vec3.fromValues(100,100,100),target:vec3.fromValues(0,0,0)}));this.ambient_color=new Float32Array(SceneTree.DEFAULT_AMBIENT_COLOR);this.background_color=new Float32Array(SceneTree.DEFAULT_BACKGROUND_COLOR);
this.textures={};this.settings={enable_shadows:!0,enable_rts:!0};this._frame=0;this._last_collect_frame=-1;this._start_time=this._global_time=this._time=0;this._last_dt=1/60;this._must_redraw=!0;this.selected_node&&delete this.selected_node;this.extra={};this._renderer=LS.Renderer};
SceneTree.prototype.clear=function(){for(;this._root._children&&this._root._children.length;)this._root.removeChild(this._root._children[0]);this._root.processActionInComponents("onRemovedFromNode",this);this._root.processActionInComponents("onRemovedFromScene",this);this.init();LEvent.trigger(this,"clear");LEvent.trigger(this,"change")};
SceneTree.prototype.configure=function(a){this._root.removeAllComponents();"SceneTree"!=a.object_type&&trace("Warning: object set to scene doesnt look like a propper one.");a.local_repository&&(this.local_repository=a.local_repository);a.background_color&&this.background_color.set(a.background_color);a.ambient_color&&this.ambient_color.set(a.ambient_color);a.textures&&(this.textures=a.textures);a.extra&&(this.extra=a.extra);a.root&&this.root.configure(a.root);a.nodes&&this.root.configure({children:a.nodes});
a.components&&this._root.configureComponents(a);a.camera&&(this._root.camera?this._root.camera.configure(a.camera):this._root.addComponent(new Camera(a.camera)));a.light?this._root.light?this._root.light.configure(a.light):this._root.addComponent(new Light(a.light)):a.hasOwnProperty("light")&&this._root.light&&(this._root.removeComponent(this._root.light),this._root.light=null);LEvent.trigger(this,"configure",a);LEvent.trigger(this,"change")};
SceneTree.prototype.serialize=function(){var a={};a.object_type=getObjectClassName(this);a.local_repository=this.local_repository;a.ambient_color=toArray(this.ambient_color);a.background_color=toArray(this.background_color);a.textures=cloneObject(this.textures);a.extra=this.extra||{};a.root=this.root.serialize();LEvent.trigger(this,"serializing",a);return a};
SceneTree.prototype.loadScene=function(a,b,c){function d(){b&&b()}var e=this,f=ResourcesManager.getNoCache(!0);LS.request({url:a+f,dataType:"json",success:function(a){e.init();e.configure(a);e.loadResources(d)},error:function(b){trace("Error loading scene: "+a+" -> "+b);c&&c(a)}})};SceneTree.prototype.appendScene=function(a){a=a.root.childNodes;for(var b in a){var c=a[b],d=new LS.SceneNode(c.id);this.root.addChild(d);d.configure(c.constructor==LS.SceneNode?c.serialize():c)}};
SceneTree.prototype.getCamera=function(){return this._root.camera};SceneTree.prototype.getLight=function(){return this._root.light};
SceneTree.prototype.onNodeAdded=function(a,b){if(b._in_tree&&b._in_tree!=this)throw"Cannot add a node from other scene, clone it";b.id&&-1!=b.id&&(null!=this._nodes_by_id[b.id]&&(b.id=b.id+"_"+(1E3*Math.random()).toFixed(0)),this._nodes_by_id[b.id]=b);this._nodes.push(b);b.processActionInComponents("onAddedToScene",this);LEvent.trigger(this,"nodeAdded",b);LEvent.trigger(this,"change")};
SceneTree.prototype.onNodeRemoved=function(a,b){var c=this._nodes.indexOf(b);if(-1!=c)return this._nodes.splice(c,1),b.id&&delete this._nodes_by_id[b.id],b.processActionInComponents("onRemovedFromNode",this),b.processActionInComponents("onRemovedFromScene",this),LEvent.trigger(this,"nodeRemoved",b),LEvent.trigger(this,"change"),!0};SceneTree.prototype.getNodes=function(){return this._nodes};SceneTree.prototype.getNode=function(a){return this._nodes_by_id[a]};SceneTree.prototype.getElementById=SceneTree.prototype.getNode;
SceneTree.prototype.filterNodes=function(a){var b=[],c;for(c in this._nodes)a(this._nodes[c])&&b.push(this._nodes[c]);return b};
SceneTree.prototype.loadResources=function(a){function b(){LEvent.unbind(LS.ResourcesManager,"end_loading_resources",b);a&&a()}var c={},d;for(d in this.textures)this.textures[d]&&(c[this.textures[d]]=Texture);this.light&&this.light.getResources(c);for(d in this._nodes)this._nodes[d].getResources(c);var e=0;for(d in c)++e;0==e?a&&a():(LEvent.bind(LS.ResourcesManager,"end_loading_resources",b),LS.ResourcesManager.loadResources(c))};
SceneTree.prototype.start=function(){"running"!=this._state&&(this._state="running",this._start_time=0.001*window.performance.now(),LEvent.trigger(this,"start",this),this.sendEventToNodes("start"))};SceneTree.prototype.stop=function(){"stopped"!=this._state&&(this._state="stopped",LEvent.trigger(this,"stop",this),this.sendEventToNodes("stop"))};SceneTree.prototype.render=function(a,b){this._renderer.render(this,a,b)};
SceneTree.prototype.collectData=function(){var a=this.getNodes(),b=[],c=[],d=[],e=[],f;for(f in a){var g=a[f];if(!1!=g.flags.visible){LEvent.trigger(g,"computeVisibility");g.transform&&g.transform.updateGlobalMatrix();var h={};LEvent.trigger(g,"computingShaderMacros",h);var k={};LEvent.trigger(g,"computingShaderUniforms",k);g._macros=h;g._uniforms=k;g._instances=[];LEvent.trigger(g,"collectRenderInstances",g._instances);LEvent.trigger(g,"collectPhysicInstances",e);LEvent.trigger(g,"collectLights",
c);LEvent.trigger(g,"collectCameras",d);b=b.concat(g._instances)}}for(var n in b)a=b[n],a.computeNormalMatrix(),a.flags&RI_IGNORE_FRUSTUM||a.updateAABB();for(n in e)e[n].updateAABB();this._instances=b;this._lights=c;this._cameras=d;this._colliders=e;this._last_collect_frame=this._frame};
SceneTree.prototype.update=function(a){LEvent.trigger(this,"beforeUpdate",this);this._global_time=0.001*window.performance.now();this._time=this._global_time-this._start_time;this._last_dt=a;LEvent.trigger(this,"update",a);this.sendEventToNodes("update",a,!0);LEvent.trigger(this,"afterUpdate",this)};SceneTree.prototype.sendEventToNodes=function(a,b){for(var c in this._nodes)LEvent.trigger(this._nodes[c],a,b)};
SceneTree.prototype.generateUniqueNodeName=function(a){a=a||"node";var b=1,c=a.lastIndexOf("_");if(c){var d=a.substr(c+1);parseInt(d)&&(b=parseInt(d),a=a.substr(0,c))}for(c=a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};SceneTree.prototype.refresh=function(){this._must_redraw=!0};SceneTree.prototype.getTime=function(){return this._time};
function SceneNode(a){this.id=a||"node_"+(1E4*Math.random()).toFixed(0);this._uid=LS.generateUId();this.flags={visible:!0,selectable:!0,two_sided:!1,flip_normals:!1,cast_shadows:!0,receive_shadows:!0,ignore_lights:!1,alpha_test:!1,alpha_shadows:!1,depth_test:!0,depth_write:!0};this._components=[];this.addComponent(new Transform);this.extra={}}LS.extendClass(ComponentContainer,SceneNode);LS.extendClass(CompositePattern,SceneNode);
SceneNode.prototype.setId=function(a){if(this.id==a)return!0;var b=this._in_tree;if(b){if(null!=b.getNode(a))return console.error("ID already in use"),!1;this.id&&delete b._nodes_by_id[this.id];(this.id=a)&&(b._nodes_by_id[this.id]=this);LEvent.trigger(this,"idChanged",a);LEvent.trigger(Scene,"nodeIdChanged",this);return!0}this.id=a};
SceneNode.prototype.getResources=function(a,b){for(var c in this._components)this._components[c].getResources&&this._components[c].getResources(a);if(this.material)if("string"==typeof this.material)":"!=this.material[0]&&(a[this.material]=LS.Material);else{var d=this.getMaterial();d&&d.getResources(a)}this.prefab&&(a[this.prefab]=LS.Prefab);if(b)for(c in this._children)this._children[c].getResources(a,!0);return a};SceneNode.prototype.getTransform=function(){return this.transform};
SceneNode.prototype.getMesh=function(){var a=this.mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};SceneNode.prototype.getLight=function(){return this.light};SceneNode.prototype.getCamera=function(){return this.camera};SceneNode.prototype.getLODMesh=function(){var a=this.lod_mesh;!a&&this.meshrenderer&&(a=this.meshrenderer.lod_mesh);return a?a.constructor===String?ResourcesManager.meshes[a]:a:null};
SceneNode.prototype.setMesh=function(a,b){this.meshrenderer?"string"==typeof a?this.meshrenderer.configure({mesh:a,submesh_id:b}):this.meshrenderer.mesh=a:this.addComponent(new MeshRenderer({mesh:a,submesh_id:b}))};
SceneNode.prototype.loadAndSetMesh=function(a,b){b=b||{};if(ResourcesManager.meshes[a]||!a){if(this.setMesh(a),b.on_complete)b.on_complete(ResourcesManager.meshes[a],this)}else{var c=this;ResourcesManager.loadMesh(a,b,function(a){c.setMesh(a.filename);c.loading-=1;0==c.loading&&(LEvent.trigger(c,"resource_loaded",c),delete c.loading);if(b.on_complete)b.on_complete(a,c)})||(this.loading?this.loading+=1:(this.loading=1,LEvent.trigger(this,"resource_loading")))}};
SceneNode.prototype.getMaterial=function(){return this.material?this.material.constructor===String?this._in_tree?LS.ResourcesManager.materials[this.material]:null:this.material:null};SceneNode.prototype.setPrefab=function(a){this._prefab_name=a};SceneNode.prototype.clone=function(){var a=this._in_tree,a=a?a.generateUniqueNodeName(this.id):this.id,a=new SceneNode(a),b=this.serialize();b.id=null;a.configure(b);return a};
SceneNode.prototype.configure=function(a){a.id&&this.setId(a.id);a.className&&(this.className=a.className);if(a.mesh){var b=a.mesh;"string"==typeof b&&(b=ResourcesManager.meshes[b]);b&&(b.bones?this.addComponent(new SkinnedMeshRenderer({mesh:a.mesh,submesh_id:a.submesh_id})):this.addComponent(new MeshRenderer({mesh:a.mesh,submesh_id:a.submesh_id,morph_targets:a.morph_targets})))}a.material&&((b=a.material.material_class)||(b="Material"),this.material="string"==typeof a.material?a.material:new LS.MaterialClasses[b](a.material));
if(a.flags)for(var c in a.flags)this.flags[c]=a.flags[c];a.transform&&this.transform.configure(a.transform);a.light&&this.addComponent(new Light(a.light));a.camera&&this.addComponent(new Camera(a.camera));a.model&&this.transform.fromMatrix(a.model);a.prefab&&(this.prefab=a.prefab);a.animations&&(this.animations=a.animations,this.addComponent(new PlayAnimation({animation:this.animations})));a.extra&&(this.extra=a.extra);a.comments&&(this.comments=a.comments);a.components&&this.configureComponents(a);
this.configureChildren(a);LEvent.trigger(this,"configure",a)};
SceneNode.prototype.serialize=function(){var a={};this.id&&(a.id=this.id);this.className&&(a.className=this.className);this.mesh&&"string"==typeof this.mesh&&(a.mesh=this.mesh);null!=this.submesh_id&&(a.submesh_id=this.submesh_id);this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());this.prefab&&(a.prefab=this.prefab);this.flags&&(a.flags=cloneObject(this.flags));this.extra&&(a.extra=this.extra);this.comments&&(a.comments=this.comments);this._children&&
(a.children=this.serializeChildren());this.serializeComponents(a);LEvent.trigger(this,"serialize",a);return a};SceneNode.prototype._onChildAdded=function(a,b){if(b&&this.transform){var c=a.transform.getGlobalMatrix(),d=this.transform.getGlobalMatrix();mat4.invert(d,d);a.transform.fromMatrix(mat4.multiply(d,d,c))}this.transform&&(a.transform._parent=this.transform)};
SceneNode.prototype._onChangeParent=function(a,b){if(b&&a.transform){var c=this.transform.getGlobalMatrix(),d=a.transform.getGlobalMatrix();mat4.invert(d,d);this.transform.fromMatrix(mat4.multiply(d,d,c))}a.transform&&(this.transform._parent=a.transform)};SceneNode.prototype._onChildRemoved=function(a,b){if(this.transform)if(b){var c=a.transform.getGlobalMatrix();a.transform._parent=null;a.transform.fromMatrix(c)}else a.transform._parent=null};LS.SceneTree=SceneTree;LS.SceneNode=SceneNode;
var Scene=new SceneTree;LS.ResourcesManager=ResourcesManager;LS.Generators=Generators;LS.newMeshNode=function(a,b){var c=new SceneNode(a);c.addComponent(new MeshRenderer);c.setMesh(b);return c};LS.newLightNode=function(a){a=new SceneNode(a);a.addComponent(new Light);return a};LS.newCameraNode=function(a){a=new SceneNode(a);a.addComponent(new Camera);return a};function Prefab(a){a&&this.configure(a)}
Prefab.prototype.configure=function(a){var b=a["@resources_name"];this.prefab_json=a["@json"];if(b){var c={},d;for(d in b)c[b[d]]=a[b[d]];this.resources=c}this.processResources()};Prefab.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));return new Prefab(a)};
Prefab.prototype.processResources=function(){if(this.resources){var a=this.resources,b;for(b in a)LS.ResourcesManager.resources[b]||(LS.ResourcesManager.resources_being_processes[b]=!0);for(b in a)LS.ResourcesManager.resources[b]||LS.ResourcesManager.processResource(b,a[b])}};
Prefab.prototype.createObject=function(){if(!this.prefab_json)return null;var a=JSON.parse(this.prefab_json),b=new LS.SceneNode;b.configure(a);ResourcesManager.loadResources(b.getResources({},!0));this.fullpath&&(b.prefab=this.fullpath);return b};
Prefab.createPrefab=function(a,b,c){if(a){a=a.replace(/ /gi,"_");c=c||{};b.id=null;b.object_type="SceneNode";var d=new Prefab;d.filename=a+".wbin";d.resources=c;d.prefab_json=JSON.stringify(b);a=Prefab.packResources(c,{"@json":d.prefab_json});d._original_file=a;return d}};
Prefab.packResources=function(a,b){var c=b||{},d=[],e;for(e in a){var f=a[e],g=LS.ResourcesManager.resources[f];if(g){var h=null;(h=g._original_data?g._original_data:LS.ResourcesManager.computeResourceInternalData(g).data)?(d.push(f),c[f]=h):console.warning("Wrong data in resource")}}c["@resources_name"]=d;return WBin.create(c,"Prefab")};LS.Prefab=Prefab;function Animation(a){this.takes={};a&&this.configure(a)}
Animation.prototype.configure=function(a){if(a.takes)for(var b in a.takes){var c=a.takes[b],d;for(d in c.tracks)this.addTrackToTake(b,new LS.Animation.Track(c.tracks[d]))}};Animation.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));var b=a["@json"],c;for(c in b.takes){var d=b.takes[c],e;for(e in d.tracks){var f=d.tracks[e];f.data=a["@track_"+f.data]}}return new Animation(b)};
Animation.prototype.toBinary=function(){var a={},b=[],c;for(c in this.takes){var d=this.takes[c],e;for(e in d.tracks){var f=d.tracks[e],g=f.data,h=b.length;a["@track_"+h]=g;f.data=h;b.push(g)}}a["@json"]={takes:this.takes};a=WBin.create(a,"Animation");for(c in this.takes)for(e in d=this.takes[c],d.tracks)f=d.tracks[e],f.data=b[f.data];return a};Animation.prototype.addTrackToTake=function(a,b){var c=this.takes[a];c||(c=this.takes[a]=new Take);c.tracks.push(b)};LS.Animation=Animation;
function Take(a){this.tracks=[];this.duration=0}Take.prototype.getPropertiesSample=function(a,b){b=b||[];for(var c in this.tracks){var d=this.tracks[c],e=d.getSample(a);b.push([d.nodename,d.property,e])}return b};Take.prototype.actionPerSample=function(a,b,c){for(var d in this.tracks){var e=this.tracks[d],f=e.getSample(a,!0);b(e.nodename,e.property,f,c)}};Animation.Take=Take;function Track(a){this.property=this.nodename="";this.value_size=this.duration=0;this.data=null;a&&this.configure(a)}
Track.prototype.configure=function(a){this.property=a.property;this.duration=a.duration;this.nodename=a.nodename;this.value_size=a.value_size;this.data=a.data};
Track.prototype.getSample=function(a,b){var c=a%this.duration;0>c&&(c=this.duration+c);for(var d=this.data,e=0,f=d.subarray(1,k),g=f,h=this.value_size,k=this.value_size+1,n=a,p=0,m=d.length;p<m&&(e=n,n=d[p],g=f,f=d.subarray(p+1,p+k),n<c);p+=k);if(!b||g==f)return 1==h?g[0]:g;c=(c-e)/(n-e);if(null!=g&&null!=f){if(1==h)return g[0]*(1-c)+f[0]*c;this._last_sample||(this._last_sample=new Float32Array(h));d=this._last_sample;for(e=0;e<h;e++)d[e]=g[e]*(1-c)+f[e]*c;return d}return null!=g?g:f};
Animation.Track=Track;
function Context(a){a=a||{};if(a.container_id){var b=document.getElementById(a.container_id);if(b){var c=document.createElement("canvas");c.width=b.offsetWidth;c.height=b.offsetHeight;b.appendChild(c);a.canvas=c}}this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_options={};a.resources&&(LS.ResourcesManager.path=a.resources);a.shaders&&Shaders.init(a.shaders);this.force_redraw=a.redraw||!1;this.interactive=!0;this.gl.ondraw=Context.prototype._ondraw.bind(this);this.gl.onupdate=Context.prototype._onupdate.bind(this);
this.gl.onmousedown=Context.prototype._onmouse.bind(this);this.gl.onmousemove=Context.prototype._onmouse.bind(this);this.gl.onmouseup=Context.prototype._onmouse.bind(this);this.gl.onmousewheel=Context.prototype._onmouse.bind(this);this.gl.onkeydown=Context.prototype._onkey.bind(this);this.gl.onkeyup=Context.prototype._onkey.bind(this);gl.captureMouse(!0);gl.captureKeys(!0);gl.animate()}Context.prototype.loadScene=function(a,b){Scene.loadScene(a,function(){Scene.start();b&&b()})};
Context.prototype._ondraw=function(){if(this.onPreDraw)this.onPreDraw();(Scene._must_redraw||this.force_redraw)&&Scene.render(Scene.getCamera(),this.render_options);if(this.onDraw)this.onDraw()};Context.prototype._onupdate=function(a){if(this.onPreUpdate)this.onPreUpdate(a);Scene.update(a);if(this.onUpdate)this.onUpdate(a)};
Context.prototype._onmouse=function(a){!this.interactive||"mousedown"!=a.eventType&&"mousewheel"!=a.eventType||(this._clicked_node=Renderer.getNodeAtCanvasPosition(Scene,null,a.mousex,a.mousey));var b=null;this._clicked_node&&this._clicked_node.interactive&&(a.scene_node=this._clicked_node,b=LEvent.trigger(this._clicked_node,a.eventType,a));b&&b.stop||LEvent.trigger(Scene.root,a.eventType,a);"mouseup"==a.eventType&&(this._clicked_node=null);this.onMouse&&(a.scene_node=this._clicked_node,this.onMouse(a))};
Context.prototype._onkey=function(a){this.onKey&&this.onKey(a)||LEvent.trigger(Scene,a.eventType,a)};LS.Context=Context;
