<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../src/components/cameraFX.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/LS.Animation.html">LS.Animation</a></li>
            
                <li><a href="../classes/LS.Animation.Track.html">LS.Animation.Track</a></li>
            
                <li><a href="../classes/LS.Collision.html">LS.Collision</a></li>
            
                <li><a href="../classes/LS.ComponentContainer.html">LS.ComponentContainer</a></li>
            
                <li><a href="../classes/LS.Components.Camera.html">LS.Components.Camera</a></li>
            
                <li><a href="../classes/LS.Components.CameraController.html">LS.Components.CameraController</a></li>
            
                <li><a href="../classes/LS.Components.CameraFX.html">LS.Components.CameraFX</a></li>
            
                <li><a href="../classes/LS.Components.FollowNode.html">LS.Components.FollowNode</a></li>
            
                <li><a href="../classes/LS.Components.FXGraphComponent.html">LS.Components.FXGraphComponent</a></li>
            
                <li><a href="../classes/LS.Components.GeometricPrimitive.html">LS.Components.GeometricPrimitive</a></li>
            
                <li><a href="../classes/LS.Components.GraphComponent.html">LS.Components.GraphComponent</a></li>
            
                <li><a href="../classes/LS.Components.Knob.html">LS.Components.Knob</a></li>
            
                <li><a href="../classes/LS.Components.Light.html">LS.Components.Light</a></li>
            
                <li><a href="../classes/LS.Components.LightFX.html">LS.Components.LightFX</a></li>
            
                <li><a href="../classes/LS.Components.NodeManipulator.html">LS.Components.NodeManipulator</a></li>
            
                <li><a href="../classes/LS.Components.PlayAnimation.html">LS.Components.PlayAnimation</a></li>
            
                <li><a href="../classes/LS.Components.Poser.html">LS.Components.Poser</a></li>
            
                <li><a href="../classes/LS.Components.RealtimeReflector.html">LS.Components.RealtimeReflector</a></li>
            
                <li><a href="../classes/LS.Components.Spherize.html">LS.Components.Spherize</a></li>
            
                <li><a href="../classes/LS.Components.Target.html">LS.Components.Target</a></li>
            
                <li><a href="../classes/LS.Components.Transform.html">LS.Components.Transform</a></li>
            
                <li><a href="../classes/LS.CompositePattern.html">LS.CompositePattern</a></li>
            
                <li><a href="../classes/LS.LS.html">LS.LS</a></li>
            
                <li><a href="../classes/LS.LScript.html">LS.LScript</a></li>
            
                <li><a href="../classes/LS.Material.html">LS.Material</a></li>
            
                <li><a href="../classes/LS.Physics.html">LS.Physics</a></li>
            
                <li><a href="../classes/LS.PhysicsInstance.html">LS.PhysicsInstance</a></li>
            
                <li><a href="../classes/LS.Picking.html">LS.Picking</a></li>
            
                <li><a href="../classes/LS.Player.html">LS.Player</a></li>
            
                <li><a href="../classes/LS.Prefab.html">LS.Prefab</a></li>
            
                <li><a href="../classes/LS.Renderer.html">LS.Renderer</a></li>
            
                <li><a href="../classes/LS.RenderInstance.html">LS.RenderInstance</a></li>
            
                <li><a href="../classes/LS.RenderOptions.html">LS.RenderOptions</a></li>
            
                <li><a href="../classes/LS.ResourcesManager.html">LS.ResourcesManager</a></li>
            
                <li><a href="../classes/LS.SceneNode.html">LS.SceneNode</a></li>
            
                <li><a href="../classes/LS.SceneTree.html">LS.SceneTree</a></li>
            
                <li><a href="../classes/LS.ShaderQuery.html">LS.ShaderQuery</a></li>
            
                <li><a href="../classes/LS.ShadersManager.html">LS.ShadersManager</a></li>
            
                <li><a href="../classes/LS.StandardMaterial.html">LS.StandardMaterial</a></li>
            
                <li><a href="../classes/LS.WBin.html">LS.WBin</a></li>
            
                <li><a href="../classes/Rotator.html">Rotator</a></li>
            
                <li><a href="../classes/VRCameraController.html">VRCameraController</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ../src/components/cameraFX.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
* This component allow to create basic FX
* @class CameraFX
* @param {Object} o object with the serialized info
*/
function CameraFX(o)
{
	this.enabled = true;
	this.use_viewport_size = true;
	this.use_high_precision = false;
	this.use_node_camera = false;

	this.fx = [];

	this._uniforms = { u_aspect: 1, u_viewport: vec2.create(), u_iviewport: vec2.create(), u_texture: 0, u_texture_depth: 1 };

	if(o)
		this.configure(o);

	//debug
	//this.addFX(&quot;threshold&quot;);
}

//CameraFX[&quot;@camera_id&quot;] = { type:&quot;string&quot; };

CameraFX.icon = &quot;mini-icon-fx.png&quot;;

CameraFX.available_fx = {
	&quot;brightness/contrast&quot;: {
		name: &quot;Brightness &amp; Contrast&quot;,
		uniforms: {
			brightness: { name: &quot;u_brightness&quot;, type: &quot;float&quot;, value: 1, min: 0, max: 2, step: 0.01 },
			contrast: { name: &quot;u_contrast&quot;, type: &quot;float&quot;, value: 1, min: 0, max: 2, step: 0.01 }
		},
		code:&quot;color.xyz = (color.xyz * u_brightness@ - vec3(0.5)) * u_contrast@ + vec3(0.5);&quot;
	},
	&quot;invert&quot;: {
		name: &quot;Invert color&quot;,
		code:&quot;color.xyz = vec3(1.0) - color.xyz;&quot;
	},
	&quot;threshold&quot;: {
		name: &quot;Threshold&quot;,
		uniforms: {
			threshold: { name: &quot;u_threshold&quot;, type: &quot;float&quot;, value: 0.5, min: 0, max: 2, step: 0.01 },
			threshold_width: { name: &quot;u_threshold_width&quot;, type: &quot;float&quot;, value: 0.01, min: 0, max: 1, step: 0.001 }
		},
		code:&quot;color.xyz = vec3( smoothstep( u_threshold@ - u_threshold_width@ * 0.5, u_threshold@ + u_threshold_width@ * 0.5,  length(color.xyz) ));&quot;
	},
	&quot;colorize&quot;: {
		name: &quot;Colorize&quot;,
		uniforms: {
			colorize: { name: &quot;u_colorize&quot;, type: &quot;color3&quot;, value: [1,1,1] },
			vibrance: { name: &quot;u_vibrance&quot;, type: &quot;float&quot;, value: 0.0, min: 0, max: 2, step: 0.01 }
		},
		code:&quot;color.xyz = color.xyz * (u_colorize@ + vec3(u_vibrance@ * 0.1)) * (1.0 + u_vibrance@);&quot;
	},
	&quot;halftone&quot;: {
		name: &quot;Halftone&quot;,
		uniforms: {
			&quot;Halftone angle&quot;: { name: &quot;u_halftone_angle&quot;, type: &quot;float&quot;, value: 0, step: 0.01 },
			&quot;Halftone size&quot;: { name: &quot;u_halftone_size&quot;, type: &quot;float&quot;, value: 1, step: 0.01 }
		},
		functions: [&quot;pattern&quot;],
		code:&quot;color.x = ( (color.x * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );&quot; + 
			&quot;color.y = ( (color.y * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.167, u_halftone_size@ ) );&quot; + 
			&quot;color.z = ( (color.z * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.333, u_halftone_size@ ) );&quot;
	},
	&quot;halftone B/N&quot;: {
		name: &quot;HalftoneBN&quot;,
		uniforms: {
			&quot;Halftone angle&quot;: { name: &quot;u_halftone_angle&quot;, type: &quot;float&quot;, value: 0, step: 0.01 },
			&quot;Halftone size&quot;: { name: &quot;u_halftone_size&quot;, type: &quot;float&quot;, value: 1, step: 0.01 }
		},
		functions: [&quot;pattern&quot;],
		code:&quot;color.xyz = vec3( (length(color.xyz) * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );&quot;
	},
	&quot;lens&quot;: {
		name: &quot;Lens Distortion&quot;,
		uniforms: {
			lens_k: { name: &quot;u_lens_k&quot;, type: &quot;float&quot;, value: -0.15 },
			lens_kcube: { name: &quot;u_lens_kcube&quot;, type: &quot;float&quot;, value: 0.8 },
			lens_scale: { name: &quot;u_lens_scale&quot;, type: &quot;float&quot;, value: 1 }
		},
		uv_code:&quot;float r2 = u_aspect * u_aspect * (uv.x-0.5) * (uv.x-0.5) + (uv.y-0.5) * (uv.y-0.5); float distort@ = 1. + r2 * (u_lens_k@ + u_lens_kcube@ * sqrt(r2)); uv = vec2( u_lens_scale@ * distort@ * (uv.x-0.5) + 0.5, u_lens_scale@  * distort@ * (uv.y-0.5) + 0.5 );&quot;
	},
	&quot;pixelate&quot;: {
		name: &quot;Pixelate&quot;,
		uniforms: {
			width: { name: &quot;u_width&quot;, type: &quot;float&quot;, value: 256, step: 1, min: 1 },
			height: { name: &quot;u_height&quot;, type: &quot;float&quot;, value: 256, step: 1, min: 1 }
		},
		uv_code:&quot;uv = vec2( floor(uv.x * u_width@) / u_width@, floor(uv.y * u_height@) / u_height@ );&quot;
	},
	&quot;quantize&quot;: {
		name: &quot;Quantize&quot;,
		uniforms: {
			levels: { name: &quot;u_levels&quot;, type: &quot;float&quot;, value: 8, step: 1, min: 1 }
		},
		code:&quot;color.xyz = floor(color.xyz * u_levels@) / u_levels@;&quot;
	},
	&quot;edges&quot;: {
		name: &quot;Edges&quot;,
		uniforms: {
			&quot;Edges factor&quot;: { name: &quot;u_edges_factor&quot;, type: &quot;float&quot;, value: 1 }
		},
		code:&quot;vec4 color@ = texture2D(u_texture, uv );\n\
				vec4 color_up@ = texture2D(u_texture, uv + vec2(0., u_iviewport.y));\n\
				vec4 color_right@ = texture2D(u_texture, uv + vec2(u_iviewport.x,0.));\n\
				vec4 color_down@ = texture2D(u_texture, uv + vec2(0., -u_iviewport.y));\n\
				vec4 color_left@ = texture2D(u_texture, uv + vec2(-u_iviewport.x,0.));\n\
				color = u_edges_factor@ * (abs(color@ - color_up@) + abs(color@ - color_down@) + abs(color@ - color_left@) + abs(color@ - color_right@));&quot;
	},
	&quot;depth&quot;: {
		name: &quot;Depth&quot;,
		uniforms: {
			&quot;near&quot;: { name: &quot;u_near&quot;, type: &quot;float&quot;, value: 0.01, step: 0.1 },
			&quot;far&quot;: { name: &quot;u_far&quot;, type: &quot;float&quot;, value: 1000, step: 1 }
		},
		code:&quot;color.xyz = vec3( (2.0 * u_near@) / (u_far@ + u_near@ - texture2D(u_texture_depth, uv ).x * (u_far@ - u_near@)) );&quot;
	},
	&quot;logarithmic&quot;: {
		name: &quot;Logarithmic&quot;,
		uniforms: {
			&quot;Log. A Factor&quot;: { name: &quot;u_logfactor_a&quot;, type: &quot;float&quot;, value: 2, step: 0.01 },
			&quot;Log. B Factor&quot;: { name: &quot;u_logfactor_b&quot;, type: &quot;float&quot;, value: 2, step: 0.01 }
		},
		code:&quot;color.xyz = log( color.xyz * u_logfactor_a@ ) * u_logfactor_b@;&quot;
	}
	/*
	,
	&quot;fast_edges&quot;: {
		name: &quot;Edges (fast)&quot;,
		code:&quot;color.xyz = abs( dFdx(color.xyz) ) + abs( dFdy(color.xyz) );&quot;
	}
	*/
};

CameraFX.available_functions = {
	pattern: &quot;float pattern(float angle, float size) {\n\
				float s = sin(angle * 3.1415), c = cos(angle * 3.1415);\n\
				vec2 tex = v_coord * u_viewport.xy;\n\
				vec2 point = vec2( c * tex.x - s * tex.y , s * tex.x + c * tex.y ) * size;\n\
				return (sin(point.x) * sin(point.y)) * 4.0;\n\
			}\n\
		&quot;
}

/**
* Returns the first component of this container that is of the same class
* @method configure
* @param {Object} o object with the configuration info from a previous serialization
*/
CameraFX.prototype.configure = function(o)
{
	this.enabled = !!o.enabled;
	this.use_viewport_size = !!o.use_viewport_size;
	this.use_high_precision = !!o.use_high_precision;

	if(o.fx)
		this.fx = o.fx.concat();

}

CameraFX.prototype.serialize = function()
{
	return { 
		enabled: this.enabled,
		use_antialiasing: this.use_antialiasing,
		use_high_precision: this.use_high_precision,
		use_viewport_size: this.use_viewport_size,
		fx: this.fx.concat()
	};
}

CameraFX.prototype.getResources = function(res)
{
	//TODO
	return res;
}

CameraFX.prototype.addFX = function(name)
{
	if(!name)
		return;

	this.fx.push({ name: name });
}

CameraFX.prototype.getFX = function(index)
{
	return this.fx[index];
}

CameraFX.prototype.removeFX = function( fx )
{
	for(var i = 0; i &lt; this.fx.length; i++)
	{
		if(this.fx[i] !== fx)
			continue;

		this.fx.splice(i,1);
		return;
	}
}

CameraFX.prototype.onAddedToScene = function( scene )
{
	LEvent.bind( scene, &quot;enableFrameBuffer&quot;, this.onBeforeRender, this );
	LEvent.bind( scene, &quot;showFrameBuffer&quot;, this.onAfterRender, this );
}

CameraFX.prototype.onRemovedFromScene = function( scene )
{
	LEvent.unbind( scene, &quot;enableFrameBuffer&quot;, this.onBeforeRender, this );
	LEvent.unbind( scene, &quot;showFrameBuffer&quot;, this.onAfterRender, this );
}

//hook the RFC
CameraFX.prototype.onBeforeRender = function(e, render_options)
{
	if(!this.enabled)
	{
		if( this._binded_camera )
		{
			LEvent.unbindAll( this._binded_camera, this );
			this._binded_camera = null;
		}
		return;
	}

	//FBO for one camera
	if(this.use_node_camera)
	{
		var camera = this._root.camera;
		if(camera &amp;&amp; camera != this._binded_camera)
		{
			if(this._binded_camera)
				LEvent.unbindAll( this._binded_camera, this );
			LEvent.bind( camera, &quot;enableFrameBuffer&quot;, this.enableCameraFBO, this );
			LEvent.bind( camera, &quot;showFrameBuffer&quot;, this.showCameraFBO, this );
		}
		this._binded_camera = camera;
		return;
	}
	else if( this._binded_camera )
	{
		LEvent.unbindAll( this._binded_camera, this );
		this._binded_camera = null;
	}

	this.enableGlobalFBO( render_options );
}

CameraFX.prototype.onAfterRender = function(e, render_options )
{
	if(!this.enabled)
		return;

	if(this.use_node_camera)
		return;

	this.showFBO();
}

CameraFX.prototype.enableCameraFBO = function(e, render_options )
{
	if(!this.enabled)
		return;

	var RFC = this._renderFrameContainer;
	if(!RFC)
		RFC = this._renderFrameContainer = new LS.RenderFrameContainer();
	var camera = this._binded_camera;
	
	var viewport = this._viewport = camera.getLocalViewport( null, this._viewport );
	RFC.setSize( viewport[2], viewport[3] );
	RFC.use_high_precision = this.use_high_precision;
	RFC.preRender( render_options );

	render_options.ignore_viewports = true;
}

CameraFX.prototype.showCameraFBO = function(e, render_options )
{
	if(!this.enabled)
		return;
	render_options.ignore_viewports = false;
	this.showFBO();
}

CameraFX.prototype.enableGlobalFBO = function( render_options )
{
	if(!this.enabled)
		return;

	var RFC = this._renderFrameContainer;
	if(!RFC)
		RFC = this._renderFrameContainer = new LS.RenderFrameContainer();

	//configure
	if(this.use_viewport_size)
		RFC.useCanvasSize();
	RFC.use_high_precision = this.use_high_precision;

	RFC.preRender( render_options );
}

CameraFX.prototype.showFBO = function()
{
	if(!this.enabled)
		return;

	this._renderFrameContainer.endFBO();

	if(this.use_node_camera &amp;&amp; this._viewport)
	{
		gl.setViewport( this._viewport );
		this.applyFX();
		gl.setViewport( this._renderFrameContainer._fbo._old_viewport );
	}
	else
		this.applyFX();
}

CameraFX.prototype.applyFX = function()
{
	var RFC = this._renderFrameContainer;

	var color_texture = RFC.color_texture;
	var depth_texture = RFC.depth_texture;

	var fxs = this.fx;

	//shadercode: TODO, do this in a lazy way
	var key = &quot;&quot;;
	var update_shader = true;
	for(var i = 0; i &lt; fxs.length; i++)
		key += fxs[i] + &quot;|&quot;;
	if(key == this._last_shader_key)
		update_shader = false;
	this._last_shader_key = key;

	var uv_code = &quot;&quot;;
	var color_code = &quot;&quot;;
	var included_functions = {};
	var uniforms_code = &quot;&quot;;

	var uniforms = this._uniforms;
	uniforms.u_viewport[0] = color_texture.width;
	uniforms.u_viewport[1] = color_texture.height;
	uniforms.u_iviewport[0] = 1 / color_texture.width;
	uniforms.u_iviewport[1] = 1 / color_texture.height;
	uniforms.u_aspect = color_texture.width / color_texture.height;

	var fx_id = 0;
	for(var i = 0; i &lt; fxs.length; i++)
	{
		var fx = fxs[i];
		fx_id = i;
		var fx_info = CameraFX.available_fx[ fx.name ];
		if(!fx_info)
			continue;
		if(update_shader)
		{
			if(fx_info.functions)
				for(var z in fx_info.functions)
					included_functions[ fx_info.functions[z] ] = true;
			if( fx_info.code )
				color_code += fx_info.code.split(&quot;@&quot;).join( fx_id ) + &quot;;\n&quot;;
			if( fx_info.uv_code )
				uv_code += fx_info.uv_code.split(&quot;@&quot;).join( fx_id ) + &quot;;\n&quot;;
		}
		if(fx_info.uniforms)
			for(var j in fx_info.uniforms)
			{
				var uniform = fx_info.uniforms[j];
				var varname = uniform.name + fx_id;
				if(update_shader)
				{
					uniforms_code += &quot;uniform &quot; + uniform.type + &quot; &quot; + varname + &quot;;\n&quot;;
				}
				uniforms[ varname ] = fx[j] !== undefined ? fx[j] : uniform.value;
			}
	}


	var shader = null;
	if(update_shader)
	{
		var functions_code = &quot;&quot;;
		for(var i in included_functions)
		{
			var func = CameraFX.available_functions[ i ];
			if(!func)
			{
				console.error(&quot;CameraFX: Function not found: &quot; + i);
				continue;
			}
			functions_code += func + &quot;\n&quot;;
		}

		var fullcode = &quot;\n\
			#extension GL_OES_standard_derivatives : enable\n\
			precision highp float;\n\
			#define color3 vec3\n\
			#define color4 vec4\n\
			uniform sampler2D u_texture;\n\
			uniform sampler2D u_texture_depth;\n\
			varying vec2 v_coord;\n\
			uniform vec2 u_viewport;\n\
			uniform vec2 u_iviewport;\n\
			uniform float u_aspect;\n\
			&quot; + uniforms_code + &quot;\n\
			&quot; + functions_code + &quot;\n\
			void main() {\n\
				vec2 uv = v_coord;\n\
				&quot; + uv_code + &quot;\n\
				vec4 color = texture2D(u_texture, uv);\n\
				float temp = 0.0;\n\
				&quot; + color_code + &quot;\n\
				gl_FragColor = color;\n\
			}\n\
			&quot;;

		this._last_shader = new GL.Shader( GL.Shader.SCREEN_VERTEX_SHADER, fullcode );
	}

	shader = this._last_shader;

	if(shader.hasUniform(&quot;u_texture_depth&quot;))
		depth_texture.bind(1);

	color_texture.toViewport( shader, uniforms );
}

LS.registerComponent( CameraFX );
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
