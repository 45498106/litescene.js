<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../src/components/script.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/LS.Animation.html">LS.Animation</a></li>
            
                <li><a href="../classes/LS.Animation.Track.html">LS.Animation.Track</a></li>
            
                <li><a href="../classes/LS.Collision.html">LS.Collision</a></li>
            
                <li><a href="../classes/LS.Component.html">LS.Component</a></li>
            
                <li><a href="../classes/LS.ComponentContainer.html">LS.ComponentContainer</a></li>
            
                <li><a href="../classes/LS.Components.Camera.html">LS.Components.Camera</a></li>
            
                <li><a href="../classes/LS.Components.CameraController.html">LS.Components.CameraController</a></li>
            
                <li><a href="../classes/LS.Components.CameraFX.html">LS.Components.CameraFX</a></li>
            
                <li><a href="../classes/LS.Components.CustomData.html">LS.Components.CustomData</a></li>
            
                <li><a href="../classes/LS.Components.FollowNode.html">LS.Components.FollowNode</a></li>
            
                <li><a href="../classes/LS.Components.FXGraphComponent.html">LS.Components.FXGraphComponent</a></li>
            
                <li><a href="../classes/LS.Components.GeometricPrimitive.html">LS.Components.GeometricPrimitive</a></li>
            
                <li><a href="../classes/LS.Components.GraphComponent.html">LS.Components.GraphComponent</a></li>
            
                <li><a href="../classes/LS.Components.Knob.html">LS.Components.Knob</a></li>
            
                <li><a href="../classes/LS.Components.Light.html">LS.Components.Light</a></li>
            
                <li><a href="../classes/LS.Components.LightFX.html">LS.Components.LightFX</a></li>
            
                <li><a href="../classes/LS.Components.NodeManipulator.html">LS.Components.NodeManipulator</a></li>
            
                <li><a href="../classes/LS.Components.PlayAnimation.html">LS.Components.PlayAnimation</a></li>
            
                <li><a href="../classes/LS.Components.Poser.html">LS.Components.Poser</a></li>
            
                <li><a href="../classes/LS.Components.RealtimeReflector.html">LS.Components.RealtimeReflector</a></li>
            
                <li><a href="../classes/LS.Components.Script.html">LS.Components.Script</a></li>
            
                <li><a href="../classes/LS.Components.Spherize.html">LS.Components.Spherize</a></li>
            
                <li><a href="../classes/LS.Components.Target.html">LS.Components.Target</a></li>
            
                <li><a href="../classes/LS.Components.Transform.html">LS.Components.Transform</a></li>
            
                <li><a href="../classes/LS.CompositePattern.html">LS.CompositePattern</a></li>
            
                <li><a href="../classes/LS.Draw.html">LS.Draw</a></li>
            
                <li><a href="../classes/LS.Formats.html">LS.Formats</a></li>
            
                <li><a href="../classes/LS.LS.html">LS.LS</a></li>
            
                <li><a href="../classes/LS.LScript.html">LS.LScript</a></li>
            
                <li><a href="../classes/LS.LSQ.html">LS.LSQ</a></li>
            
                <li><a href="../classes/LS.Material.html">LS.Material</a></li>
            
                <li><a href="../classes/LS.Physics.html">LS.Physics</a></li>
            
                <li><a href="../classes/LS.PhysicsInstance.html">LS.PhysicsInstance</a></li>
            
                <li><a href="../classes/LS.Picking.html">LS.Picking</a></li>
            
                <li><a href="../classes/LS.Player.html">LS.Player</a></li>
            
                <li><a href="../classes/LS.Prefab.html">LS.Prefab</a></li>
            
                <li><a href="../classes/LS.Project.html">LS.Project</a></li>
            
                <li><a href="../classes/LS.Renderer.html">LS.Renderer</a></li>
            
                <li><a href="../classes/LS.RenderInstance.html">LS.RenderInstance</a></li>
            
                <li><a href="../classes/LS.RenderSettings.html">LS.RenderSettings</a></li>
            
                <li><a href="../classes/LS.ResourcesManager.html">LS.ResourcesManager</a></li>
            
                <li><a href="../classes/LS.SceneNode.html">LS.SceneNode</a></li>
            
                <li><a href="../classes/LS.SceneTree.html">LS.SceneTree</a></li>
            
                <li><a href="../classes/LS.ShaderQuery.html">LS.ShaderQuery</a></li>
            
                <li><a href="../classes/LS.ShadersManager.html">LS.ShadersManager</a></li>
            
                <li><a href="../classes/LS.StandardMaterial.html">LS.StandardMaterial</a></li>
            
                <li><a href="../classes/LS.TextureFX.html">LS.TextureFX</a></li>
            
                <li><a href="../classes/LS.WBin.html">LS.WBin</a></li>
            
                <li><a href="../classes/Rotator.html">Rotator</a></li>
            
                <li><a href="../classes/VRCameraController.html">VRCameraController</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ../src/components/script.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

/** Script is the component in charge of executing scripts to control the behaviour of the application.
* Script must be coded in Javascript and they have full access to all the engine, so one script could replace the behaviour of any part of the engine.
* Scripts are executed inside their own context, the context is local to the script so any variable defined in the context that is not attached to the context wont be accessible from other parts of the engine.
* To interact with the engine Scripts must bind callback to events so the callbacks will be called when those events are triggered, however, there are some generic methods that will be called
* @class Script
* @constructor
* @param {Object} object to configure from
*/
function Script(o)
{
	this.enabled = true;
	this._name = &quot;Unnamed&quot;;
	this.code = &quot;this.update = function(dt)\n{\n\t//node.scene.refresh();\n}&quot;;

	this._script = new LScript();

	this._script.extra_methods = {
		getComponent: (function() { return this; }).bind(this),
		getLocator: function() { return this.getComponent().getLocator() + &quot;/context&quot;; },
		createProperty: LS.Component.prototype.createProperty,
		bind: LS.Component.prototype.bind,
		unbind: LS.Component.prototype.unbind,
		unbindAll: LS.Component.prototype.unbindAll
	};

	this._script.catch_exceptions = false; //during execution
	this._script.onerror = this.onError.bind(this);
	this._script.exported_callbacks = [];//this.constructor.exported_callbacks;
	this._last_error = null;

	if(o)
		this.configure(o);

	/* code must not be executed if it is not attached to the scene
	if(this.code)
	{
		try
		{
			//just in case the script saved had an error, do not block the flow
			this.processCode();
		}
		catch (err)
		{
			console.error(err);
		}
	}
	*/
}

Script.secure_module = false; //this module is not secure (it can execute code)
Script.block_execution = false; //avoid executing code
Script.catch_important_exceptions = true; //catch exception during parsing, otherwise configuration could fail

Script.icon = &quot;mini-icon-script.png&quot;;

Script[&quot;@code&quot;] = {type:&#x27;script&#x27;};

Script.exported_callbacks = [&quot;start&quot;,&quot;update&quot;,&quot;trigger&quot;,&quot;sceneRender&quot;, &quot;render&quot;,&quot;afterRender&quot;,&quot;renderGUI&quot;,&quot;finish&quot;,&quot;collectRenderInstances&quot;];
Script.translate_events = {
	&quot;sceneRender&quot;: &quot;beforeRender&quot;,
	&quot;beforeRender&quot;: &quot;sceneRender&quot;,
	&quot;render&quot;: &quot;renderInstances&quot;, 
	&quot;renderInstances&quot;: &quot;render&quot;,
	&quot;afterRender&quot;:&quot;afterRenderInstances&quot;, 
	&quot;afterRenderInstances&quot;: &quot;afterRender&quot;};

Script.coding_help = &quot;\n\
Global vars:\n\
 + node : represent the node where this component is attached.\n\
 + component : represent the component.\n\
 + this : represents the script context\n\
\n\
Exported functions:\n\
 + start: when the Scene starts\n\
 + update: when updating\n\
 + trigger : if this node is triggered\n\
 + render : before rendering the node\n\
 + getRenderInstances: when collecting instances\n\
 + afterRender : after rendering the node\n\
 + finish : when the scene finished (mostly used for editor stuff)\n\
\n\
Remember, all basic vars attached to this will be exported as global.\n\
&quot;;

Script.active_scripts = {};

Object.defineProperty( Script.prototype, &quot;name&quot;, {
	set: function(v){ 
		if( LS.Script.active_scripts[ this._name ] )
			delete LS.Script.active_scripts[ this._name ];
		this._name = v;
		if( this._name &amp;&amp; !LS.Script.active_scripts[ this._name ] )
			LS.Script.active_scripts[ this._name ] = this;
	},
	get: function() { return this._name; },
	enumerable: true
});

Object.defineProperty( Script.prototype, &quot;context&quot;, {
	set: function(v){ 
		console.error(&quot;Script: context cannot be assigned&quot;);
	},
	get: function() { 
		if(this._script)
				return this._script._context;
		return null;
	},
	enumerable: false //if it was enumerable it would be serialized
});


Script.prototype.getContext = function()
{
	if(this._script)
			return this._script._context;
	return null;
}

Script.prototype.getCode = function()
{
	return this.code;
}

Script.prototype.setCode = function( code, skip_events )
{
	this.code = code;
	this.processCode( skip_events );
}

/**
* This is the method in charge of compiling the code and executing the constructor, which also creates the context.
* It is called everytime the code is modified, that implies that the context is created when the component is configured.
* @method processCode
*/
Script.prototype.processCode = function( skip_events )
{
	this._script.code = this.code;
	if(this._root &amp;&amp; !LS.Script.block_execution )
	{
		//unbind old stuff
		if(this._script &amp;&amp; this._script._context)
			this._script._context.unbindAll();

		//compiles and executes the context
		var ret = this._script.compile({component:this, node: this._root, scene: this._root.scene });
		/*
		if(	this._script._context )
		{
			this._script._context.__proto__.getComponent = (function() { return this; }).bind(this);
			this._script._context.__proto__.getLocator = function() { return this.getComponent().getLocator() + &quot;/context&quot;; };
			this._script._context.__proto__.createProperty = LS.Component.prototype.createProperty;
		}
		*/
		if(!skip_events)
			this.hookEvents();
		return ret;
	}
	return true;
}

//used for graphs
Script.prototype.setProperty = function(name, value)
{
	var ctx = this.getContext();

	if( ctx &amp;&amp; ctx[name] !== undefined )
	{
		if(ctx[name].set)
			ctx[name](value);
		else
			ctx[name] = value;
	}
	else if(this[name])
		this[name] = value;
}


Script.prototype.getProperties = function()
{
	var ctx = this.getContext();

	if(!ctx)
		return {enabled:&quot;boolean&quot;};

	var attrs = LS.getObjectProperties( ctx );
	attrs.enabled = &quot;boolean&quot;;
	return attrs;
}

/*
Script.prototype.getPropertyValue = function( property )
{
	var ctx = this.getContext();
	if(!ctx)
		return;

	return ctx[ property ];
}

Script.prototype.setPropertyValue = function( property, value )
{
	var context = this.getContext();
	if(!context)
		return;

	if( context[ property ] === undefined )
		return;

	if(context[ property ] &amp;&amp; context[ property ].set)
		context[ property ].set( value );
	else
		context[ property ] = value;

	return true;
}
*/

//used for animation tracks
Script.prototype.getPropertyInfoFromPath = function( path )
{
	if(path[0] != &quot;context&quot;)
		return;

	var context = this.getContext();

	if(path.length == 1)
		return {
			node: this._root,
			target: context,
			type: &quot;object&quot;
		};

	var varname = path[1];
	if(!context || context[ varname ] === undefined )
		return;

	var value = context[ varname ];
	var extra_info = context[ &quot;@&quot; + varname ];

	var type = &quot;&quot;;
	if(extra_info)
		type = extra_info.type;


	if(!type &amp;&amp; value !== null &amp;&amp; value !== undefined)
	{
		if(value.constructor === String)
			type = &quot;string&quot;;
		else if(value.constructor === Boolean)
			type = &quot;boolean&quot;;
		else if(value.length)
			type = &quot;vec&quot; + value.length;
		else if(value.constructor === Number)
			type = &quot;number&quot;;
	}

	return {
		node: this._root,
		target: context,
		name: varname,
		value: value,
		type: type
	};
}

Script.prototype.setPropertyValueFromPath = function( path, value )
{
	if(path.length &lt; 1)
		return;

	if(path[0] != &quot;context&quot; )
		return;

	var context = this.getContext();
	var varname = path[1];
	if(!context || context[ varname ] === undefined )
		return;

	if( context[ varname ] === undefined )
		return;

	if(context[ varname ] &amp;&amp; context[ varname ].set)
		context[ varname ].set( value );
	else
		context[ varname ] = value;
}

Script.prototype.hookEvents = function()
{
	var hookable = LS.Script.exported_callbacks;
	var root = this._root;
	var scene = root.scene;
	if(!scene)
		scene = LS.GlobalScene; //hack

	//script context
	var context = this.getContext();
	if(!context)
		return;

	//hook events
	for(var i in hookable)
	{
		var name = hookable[i];
		var event_name = LS.Script.translate_events[name] || name;
		var target = event_name == &quot;trigger&quot; ? root : scene; //some events are triggered in the scene, others in the node
		if( context[name] &amp;&amp; context[name].constructor === Function )
		{
			if( !LEvent.isBind( target, event_name, this.onScriptEvent, this )  )
				LEvent.bind( target, event_name, this.onScriptEvent, this );
		}
		else
			LEvent.unbind( target, event_name, this.onScriptEvent, this );
	}
}

Script.prototype.onAddedToNode = function( node )
{
	if(node.script)
		node.script = this;
}

Script.prototype.onRemovedFromNode = function( node )
{
	if(node.script == this)
		delete node.script;
}

Script.prototype.onAddedToScene = function( scene )
{
	if( this._name &amp;&amp; !LS.Script.active_scripts[ this._name ] )
		LS.Script.active_scripts[ this._name ] = this;

	if( !this.constructor.catch_important_exceptions )
	{
		this.processCode();
		return;
	}

	//catch
	try
	{
		//careful, if the code saved had an error, do not block the flow of the configure or the rest will be lost
		this.processCode();
	}
	catch (err)
	{
		console.error(err);
	}
}

Script.prototype.onRemovedFromScene = function(scene)
{
	if( this._name &amp;&amp; LS.Script.active_scripts[ this._name ] )
		delete LS.Script.active_scripts[ this._name ];

	//ensures no binded events
	if(this._context)
		LEvent.unbindAll( scene, this._context, this );

	//unbind evends
	LEvent.unbindAll( scene, this );
}


//TODO stuff ***************************************
Script.prototype.onAddedToProject = function( project )
{
	try
	{
		//just in case the script saved had an error, do not block the flow
		this.processCode();
	}
	catch (err)
	{
		console.error(err);
	}
}

Script.prototype.onRemovedFromProject = function( project )
{
	//ensures no binded events
	if(this._context)
		LEvent.unbindAll( project, this._context, this );

	//unbind evends
	LEvent.unbindAll( project, this );
}
//*******************************



Script.prototype.onScriptEvent = function(event_type, params)
{
	//this.processCode(true); //�?

	if(!this.enabled)
		return;

	var method_name = LS.Script.translate_events[ event_type ] || event_type;
	this._script.callMethod( method_name, params );
}

Script.prototype.runStep = function(method, args)
{
	this._script.callMethod(method,args);
}

Script.prototype.onError = function(err)
{
	var scene = this._root.scene;
	if(!scene)
		return;

	LEvent.trigger(this,&quot;code_error&quot;,err);
	LEvent.trigger(scene,&quot;code_error&quot;,[this,err]);
	LEvent.trigger(Script,&quot;code_error&quot;,[this,err]);
	console.log(&quot;app finishing due to error in script&quot;);
	scene.finish();
}

//called from the editor?
Script.prototype.onCodeChange = function(code)
{
	this.processCode();
}

Script.prototype.getResources = function(res)
{
	var ctx = this.getContext();

	if(!ctx || !ctx.getResources )
		return;
	
	ctx.getResources( res );
}

LS.registerComponent( Script );
LS.Script = Script;


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
